========================================
 InfraCore FULL PROJECT EXPORT
 Generated: 01/09/2026 18:57:47
 Root: C:\Users\Benz\Desktop\InfraCore
========================================

===== FOLDER STRUCTURE =====
.\app
.\data
.\docs
.\scripts
.\venv
.\app\core
.\app\db
.\app\models
.\app\repositories
.\app\routes
.\app\schemas
.\app\services
.\app\static
.\app\templates
.\app\tests
.\app\utils
.\app\__pycache__
.\app\db\__pycache__
.\app\models\__pycache__
.\app\routes\__pycache__
.\app\services\__pycache__
.\app\static\css
.\app\static\images
.\app\static\js
.\app\templates\admin
.\app\templates\auth
.\app\templates\reports
.\app\utils\__pycache__
.\data\backups
.\data\processed
.\data\raw

===== FILE CONTENTS =====

----------------------------------------
FILE: .\.env
----------------------------------------

----------------------------------------
FILE: .\InfraCore_FULL_EXPORT.txt
----------------------------------------

----------------------------------------
FILE: .\New Text Document.txt
----------------------------------------
# ================================
# InfraCore - Project Export Script
# ================================

$Root = Get-Location
$OutFile = "$Root\InfraCore_FULL_EXPORT.txt"

# Remove old export if exists
if (Test-Path $OutFile) {
    Remove-Item $OutFile
}

# Folders to exclude
$Exclude = @(
    "\__pycache__\",
    "\.git\",
    "\.venv\",
    "\venv\",
    "\env\",
    "\node_modules\",
    "\.idea\",
    "\.vscode\"
)

# File extensions to include
$Extensions = @(
    ".py",
    ".html",
    ".css",
    ".js",
    ".sql",
    ".txt",
    ".md",
    ".env"
)

# Header
Add-Content $OutFile "========================================"
Add-Content $OutFile " InfraCore FULL PROJECT EXPORT"
Add-Content $OutFile " Generated: $(Get-Date)"
Add-Content $OutFile " Root: $Root"
Add-Content $OutFile "========================================`n"

# -------------------------
# Folder Structure
# -------------------------
Add-Content $OutFile "===== FOLDER STRUCTURE ====="

Get-ChildItem -Recurse -Directory | ForEach-Object {
    $Path = $_.FullName.Replace($Root, ".")
    $Skip = $false

    foreach ($ex in $Exclude) {
        if ($Path -like "*$ex*") {
            $Skip = $true
            break
        }
    }

    if (-not $Skip) {
        Add-Content $OutFile $Path
    }
}

# -------------------------
# File Contents
# -------------------------
Add-Content $OutFile "`n===== FILE CONTENTS ====="

Get-ChildItem -Recurse -File | ForEach-Object {

    $Ext = $_.Extension.ToLower()
    if ($Extensions -notcontains $Ext) { return }

    $Path = $_.FullName.Replace($Root, ".")
    foreach ($ex in $Exclude) {
        if ($Path -like "*$ex*") { return }
    }

    Add-Content $OutFile "`n----------------------------------------"
    Add-Content $OutFile "FILE: $Path"
    Add-Content $OutFile "----------------------------------------"

    try {
        Get-Content $_.FullName -Raw | Add-Content $OutFile
    }
    catch {
        Add-Content $OutFile "[ERROR: Unable to read file]"
    }
}

Add-Content $OutFile "`n========= END OF EXPORT ========="

Write-Host ""
Write-Host "âœ… InfraCore export completed successfully"
Write-Host "ðŸ“„ Output file: InfraCore_FULL_EXPORT.txt"


----------------------------------------
FILE: .\notepad requirements.txt
----------------------------------------
fastapi
uvicorn
sqlalchemy
jinja2
python-dotenv
passlib[bcrypt]
python-multipart


----------------------------------------
FILE: .\README.md
----------------------------------------

----------------------------------------
FILE: .\requirements.txt
----------------------------------------
fastapi
uvicorn
sqlalchemy
jinja2
python-dotenv
passlib[bcrypt]
python-multipart


----------------------------------------
FILE: .\app\lifespan.py
----------------------------------------

----------------------------------------
FILE: .\app\main.py
----------------------------------------
from fastapi import FastAPI, Request, Form, Depends
from fastapi.responses import RedirectResponse, HTMLResponse, PlainTextResponse
from fastapi.templating import Jinja2Templates
from fastapi.staticfiles import StaticFiles
from starlette.middleware.sessions import SessionMiddleware
from sqlalchemy.orm import Session
import hashlib
import traceback
from datetime import datetime

from app.db.session import engine, get_db
from app.db.base import Base
import app.db.models  # âœ… REGISTER ALL MODELS

from app.models.user import User
from app.models.user_session import UserSession

# ======================================================
# ROUTERS
# ======================================================

from app.routes.dashboard import router as dashboard_router
from app.routes.projects import router as projects_router
from app.routes.reports import router as reports_router
from app.routes.users import router as users_router

# ADMIN
from app.routes.admin import router as admin_router

# PROJECT USERS
from app.routes.project_users import router as project_users_router

# PROJECT ACTIVITY PLANNING
from app.routes.project_activity_plan import router as project_activity_plan_router

# PROJECT ACTIVITIES
from app.routes.project_activities import router as project_activities_router

# ACTIVITY PROGRESS
from app.routes.activity_progress import router as activity_progress_router

# CORE DOMAIN
from app.routes.activity import router as activity_router
from app.routes.activities import router as activities_router
from app.routes.materials import router as materials_router
from app.routes.activity_materials import router as activity_materials_router

# INVENTORY
from app.routes.material_stock import router as material_stock_router
from app.routes.material_daily_usage import router as material_daily_usage_router
from app.routes.inventory import router as inventory_router
from app.routes.material_requirements import router as material_requirements_router

# SCHEDULE
from app.routes.schedule import router as schedule_router

# ðŸ”¥ DAILY EXECUTION (ORDER MATTERS)
from app.routes.daily_entry_ui import router as daily_entry_ui_router   # UI (GET)
from app.routes.daily_entry import router as daily_entry_router         # API (POST)

# ANALYTICS
from app.routes.material_progress import router as material_progress_router
from app.routes.project_dashboard import router as project_dashboard_router

# FLASH
from app.utils.flash import get_flashed_messages, flash

# ======================================================
# APP
# ======================================================
app = FastAPI(
    title="InfraCore",
    debug=False   # ðŸ”¥ IMPORTANT: prevents raw code leakage
)

# ---------------- TEMPLATES & STATIC ----------------
templates = Jinja2Templates(directory="app/templates")
app.mount("/static", StaticFiles(directory="app/static"), name="static")

# ---------------- SESSION ----------------
app.add_middleware(
    SessionMiddleware,
    secret_key="infracore-secret-key",
    same_site="lax",
    https_only=False,
)

# ---------------- FLASH MIDDLEWARE ----------------
@app.middleware("http")
async def flash_middleware(request: Request, call_next):
    try:
        response = await call_next(request)
        request.state.flashes = get_flashed_messages(request)
        return response
    except Exception:
        return PlainTextResponse(
            traceback.format_exc(),
            status_code=500
        )

# ======================================================
# ROUTER REGISTRATION (STRICT ORDER)
# ======================================================

# Core UI
app.include_router(dashboard_router)
app.include_router(projects_router)
app.include_router(reports_router, prefix="/reports")
app.include_router(users_router, prefix="/users")
app.include_router(admin_router)

# Project Management
app.include_router(project_users_router)
app.include_router(project_activities_router)
app.include_router(project_activity_plan_router)
app.include_router(activity_progress_router)

# Core Domain
app.include_router(activity_router)
app.include_router(activities_router)
app.include_router(materials_router)
app.include_router(activity_materials_router)

# Inventory
app.include_router(material_stock_router)
app.include_router(material_daily_usage_router)
app.include_router(inventory_router)
app.include_router(material_requirements_router)

# Schedule
app.include_router(schedule_router)

# ðŸ”¥ DAILY EXECUTION (FIXED & WORKING)
app.include_router(daily_entry_ui_router)   # /execution (GET)
app.include_router(daily_entry_router)      # /daily-entry (POST)

# Analytics
app.include_router(material_progress_router)
app.include_router(project_dashboard_router)

# ======================================================
# HELPERS
# ======================================================
def hash_password(password: str) -> str:
    return hashlib.sha256(password.encode()).hexdigest()

# ======================================================
# STARTUP
# ======================================================
@app.on_event("startup")
def startup_tasks():
    Base.metadata.create_all(bind=engine)

    db: Session = next(get_db())

    if not db.query(User).filter(User.username == "admin").first():
        db.add(
            User(
                username="admin",
                password_hash=hash_password("admin123"),
                role="admin",
                is_active=True,
            )
        )
        db.commit()

# ======================================================
# AUTH
# ======================================================
@app.get("/login", response_class=HTMLResponse)
def login_page(request: Request):
    if request.session.get("user"):
        return RedirectResponse("/dashboard", status_code=302)

    return templates.TemplateResponse(
        "login.html",
        {"request": request, "user": None}
    )

@app.post("/login")
def login_action(
    request: Request,
    username: str = Form(...),
    password: str = Form(...),
    db: Session = Depends(get_db),
):
    user = db.query(User).filter(User.username == username).first()

    if not user or user.password_hash != hash_password(password):
        flash(request, "Invalid username or password", "error")
        return templates.TemplateResponse(
            "login.html",
            {"request": request, "user": None}
        )

    if not user.is_active:
        flash(request, "Your account is disabled. Contact admin.", "error")
        return templates.TemplateResponse(
            "login.html",
            {"request": request, "user": None}
        )

    request.session["user"] = {
        "id": user.id,
        "username": user.username,
        "role": user.role,
    }

    session_log = UserSession(
        user_id=user.id,
        login_time=datetime.utcnow()
    )
    db.add(session_log)
    db.commit()

    request.session["session_log_id"] = session_log.id

    flash(request, "Logged in successfully", "success")
    return RedirectResponse("/dashboard", status_code=302)

@app.get("/logout")
def logout(request: Request, db: Session = Depends(get_db)):
    session_log_id = request.session.get("session_log_id")

    if session_log_id:
        session_log = db.query(UserSession).filter(
            UserSession.id == session_log_id
        ).first()

        if session_log and session_log.logout_time is None:
            session_log.logout_time = datetime.utcnow()
            session_log.session_duration = int(
                (session_log.logout_time - session_log.login_time).total_seconds()
            )
            db.commit()

    request.session.clear()
    return RedirectResponse("/login", status_code=302)

# ======================================================
# ROOT
# ======================================================
@app.get("/")
def root():
    return RedirectResponse("/dashboard", status_code=302)


----------------------------------------
FILE: .\app\__init__.py
----------------------------------------

----------------------------------------
FILE: .\app\core\config.py
----------------------------------------

----------------------------------------
FILE: .\app\core\dependencies.py
----------------------------------------

----------------------------------------
FILE: .\app\core\exceptions.py
----------------------------------------

----------------------------------------
FILE: .\app\core\middleware.py
----------------------------------------

----------------------------------------
FILE: .\app\core\security.py
----------------------------------------
import hashlib


def hash_password(password: str) -> str:
    """
    Hash password using SHA-256 (development-safe).
    """
    return hashlib.sha256(password.encode("utf-8")).hexdigest()


def verify_password(plain_password: str, hashed_password: str) -> bool:
    """
    Verify password by comparing SHA-256 hashes.
    """
    return hash_password(plain_password) == hashed_password


----------------------------------------
FILE: .\app\db\base.py
----------------------------------------
from sqlalchemy.orm import declarative_base

Base = declarative_base()


----------------------------------------
FILE: .\app\db\create_admin.py
----------------------------------------
from app.db.session import SessionLocal, engine
from app.db.base import Base
from app.models.user import User
from app.core.security import hash_password

def create_admin():
    # make sure tables exist
    Base.metadata.create_all(bind=engine)

    db = SessionLocal()

    username = "admin"
    password = "admin123"

    existing = db.query(User).filter(User.username == username).first()
    if existing:
        print("âš ï¸ Admin already exists")
        return

    user = User(
        username=username,
        password_hash=hash_password(password),
        role="admin"
    )

    db.add(user)
    db.commit()

    print("âœ… Admin user created")
    print("Username:", username)
    print("Password:", password)

if __name__ == "__main__":
    create_admin()


----------------------------------------
FILE: .\app\db\models.py
----------------------------------------
# This file ONLY imports models so SQLAlchemy can see them
# DO NOT add logic here

# -------- USER & AUTH --------
from app.models.user import User
from app.models.user_session import UserSession   # âœ… ADDED

# -------- CORE PROJECT (PLANNED CONTAINER) --------
from app.models.project import Project
from app.models.road_type import RoadType

# -------- ACTIVITIES --------
from app.models.activity import Activity
from app.models.project_activity import ProjectActivity
from app.models.activity_progress import ActivityProgress

# -------- MATERIAL & INVENTORY (PLANNED + ACTUAL) --------
from app.models.material import Material
from app.models.planned_material import PlannedMaterial   # âœ… ADDED (CRITICAL)
from app.models.inventory import Inventory
from app.models.activity_material import ActivityMaterial

# -------- DAILY & ACTUAL USAGE --------
from app.models.daily_entry import DailyEntry
from app.models.material_usage import MaterialUsage
from app.models.material_usage_daily import MaterialUsageDaily

# -------- REPORTS & LOGS --------
from app.models.report import Report
from app.models.activity_log import ActivityLog
from app.models.project_user import ProjectUser


----------------------------------------
FILE: .\app\db\seed_data.py
----------------------------------------
from datetime import date
from app.db.session import SessionLocal
from app.models.report import Report

def seed_reports():
    db = SessionLocal()

    reports = [
        Report(
            report_type="Labour Attendance",
            description="45 workers present on site",
            report_date=date.today()
        ),
        Report(
            report_type="Machinery Usage",
            description="Excavator operated for 6 hours",
            report_date=date.today()
        ),
        Report(
            report_type="Material",
            description="Cement and steel delivered",
            report_date=date.today()
        ),
    ]

    db.add_all(reports)
    db.commit()
    db.close()

    print("? Sample reports inserted")

if __name__ == "__main__":
    seed_reports()


----------------------------------------
FILE: .\app\db\session.py
----------------------------------------
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, Session
from typing import Generator
import os

# ======================================================
# FIXED DATABASE PATH (ABSOLUTE & STABLE)
# ======================================================

BASE_DIR = os.path.dirname(
    os.path.dirname(
        os.path.dirname(os.path.abspath(__file__))
    )
)

DATABASE_URL = f"sqlite:///{os.path.join(BASE_DIR, 'infra.db')}"

# ======================================================
# ENGINE
# ======================================================

engine = create_engine(
    DATABASE_URL,
    connect_args={"check_same_thread": False},
    pool_pre_ping=True,
)

SessionLocal = sessionmaker(
    autocommit=False,
    autoflush=False,
    bind=engine,
)

# ======================================================
# DB DEPENDENCY
# ======================================================

def get_db() -> Generator[Session, None, None]:
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


----------------------------------------
FILE: .\app\db\__init__.py
----------------------------------------

----------------------------------------
FILE: .\app\models\activity.py
----------------------------------------
from sqlalchemy import Column, Integer, String, Boolean, DateTime, ForeignKey
from sqlalchemy.orm import relationship
from datetime import datetime

from app.db.base import Base


class Activity(Base):
    __tablename__ = "activities"

    id = Column(Integer, primary_key=True, index=True)

    name = Column(String(150), nullable=False)

    # True = standard (Earthwork, WMM, DBM)
    # False = user-created
    is_standard = Column(Boolean, default=False, nullable=False)

    # ðŸ”´ PROJECT SCOPE
    project_id = Column(Integer, ForeignKey("projects.id"), nullable=False)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)

    # ================= RELATIONSHIPS =================

    # Project â†’ Activities
    project = relationship(
        "Project",
        back_populates="activities"
    )

    # Activity â†’ ProjectActivity (ðŸ”¥ CRITICAL)
    project_activities = relationship(
        "ProjectActivity",
        back_populates="activity",
        cascade="all, delete-orphan"
    )


----------------------------------------
FILE: .\app\models\activity_log.py
----------------------------------------
from sqlalchemy import Column, Integer, String, DateTime
from datetime import datetime

from app.db.base import Base


class ActivityLog(Base):
    __tablename__ = "activity_logs"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, nullable=True)
    username = Column(String, nullable=False)
    action = Column(String, nullable=False)
    details = Column(String, nullable=True)
    timestamp = Column(DateTime, default=datetime.utcnow)


----------------------------------------
FILE: .\app\models\activity_material.py
----------------------------------------
from sqlalchemy import Column, Integer, Float, ForeignKey, DateTime
from datetime import datetime

from app.db.base import Base


class ActivityMaterial(Base):
    __tablename__ = "activity_materials"

    id = Column(Integer, primary_key=True, index=True)

    activity_id = Column(Integer, ForeignKey("activities.id"), nullable=False)
    material_id = Column(Integer, ForeignKey("materials.id"), nullable=False)

    # Consumption of material per 1 unit of activity
    # Example: 1.25 ton of aggregate per 1 km of GSB
    consumption_rate = Column(Float, nullable=False)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)


----------------------------------------
FILE: .\app\models\activity_progress.py
----------------------------------------
from sqlalchemy import Column, Integer, Date, DateTime, ForeignKey, String
from sqlalchemy.sql import func
from sqlalchemy.orm import relationship

from app.db.base import Base


class ActivityProgress(Base):
    __tablename__ = "activity_progress"

    id = Column(Integer, primary_key=True, index=True)

    project_id = Column(Integer, ForeignKey("projects.id"), nullable=False)
    activity_id = Column(Integer, ForeignKey("activities.id"), nullable=False)

    planned_start = Column(Date, nullable=False)
    planned_end = Column(Date, nullable=False)

    actual_start = Column(Date, nullable=True)
    actual_end = Column(Date, nullable=True)

    progress_percent = Column(Integer, nullable=False, default=0)

    # NOT_STARTED | IN_PROGRESS | COMPLETED | DELAYED
    status = Column(String, nullable=False, default="NOT_STARTED")

    last_updated = Column(
        DateTime(timezone=True),
        server_default=func.now(),
        onupdate=func.now()
    )

    # Optional relationships (safe, no logic)
    project = relationship("Project")
    activity = relationship("Activity")


----------------------------------------
FILE: .\app\models\audit_log.py
----------------------------------------

----------------------------------------
FILE: .\app\models\daily_entry.py
----------------------------------------
from sqlalchemy import Column, Integer, Float, Date, ForeignKey, DateTime
from datetime import datetime

from app.db.base import Base


class DailyEntry(Base):
    __tablename__ = "daily_entries"

    id = Column(Integer, primary_key=True, index=True)

    project_id = Column(Integer, ForeignKey("projects.id"), nullable=False)
    activity_id = Column(Integer, ForeignKey("activities.id"), nullable=False)

    quantity_done = Column(Float, nullable=False)

    entry_date = Column(Date, nullable=False)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)


----------------------------------------
FILE: .\app\models\inventory.py
----------------------------------------
from sqlalchemy import Column, Integer, Float, ForeignKey, DateTime
from datetime import datetime

from app.db.base import Base


class Inventory(Base):
    __tablename__ = "inventory"

    id = Column(Integer, primary_key=True, index=True)

    material_id = Column(Integer, ForeignKey("materials.id"), nullable=False)

    quantity_available = Column(Float, nullable=False)

    last_updated = Column(DateTime, default=datetime.utcnow, nullable=False)


----------------------------------------
FILE: .\app\models\labour.py
----------------------------------------

----------------------------------------
FILE: .\app\models\machinery.py
----------------------------------------

----------------------------------------
FILE: .\app\models\material.py
----------------------------------------
from sqlalchemy import Column, Integer, String, Float, DateTime
from datetime import datetime

from app.db.base import Base


class Material(Base):
    __tablename__ = "materials"

    id = Column(Integer, primary_key=True, index=True)

    name = Column(String(150), nullable=False, unique=True)
    unit = Column(String(50), nullable=False)          # m3, MT, bags

    # âœ… FIX: make optional for MVP
    lead_time_days = Column(Integer, nullable=True, default=0)

    minimum_stock = Column(Float, nullable=False, default=0)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)


----------------------------------------
FILE: .\app\models\material_stock.py
----------------------------------------
from sqlalchemy import Column, Integer, Float, ForeignKey, DateTime, Boolean, String
from datetime import datetime

from app.db.base import Base


class MaterialStock(Base):
    __tablename__ = "material_stocks"

    id = Column(Integer, primary_key=True, index=True)

    project_id = Column(Integer, ForeignKey("projects.id"), nullable=False)
    material_id = Column(Integer, ForeignKey("materials.id"), nullable=False)

    quantity_available = Column(Float, nullable=False, default=0)

    # Optional future use (multiple yards / godowns)
    location = Column(String(100), nullable=True)

    last_updated = Column(DateTime, default=datetime.utcnow, nullable=False)

    is_active = Column(Boolean, default=True)


----------------------------------------
FILE: .\app\models\material_usage.py
----------------------------------------
from sqlalchemy import Column, Integer, Float, ForeignKey, DateTime
from datetime import datetime

from app.db.base import Base


class MaterialUsage(Base):
    __tablename__ = "material_usages"

    id = Column(Integer, primary_key=True, index=True)

    project_id = Column(Integer, ForeignKey("projects.id"), nullable=False)
    activity_id = Column(Integer, ForeignKey("activities.id"), nullable=False)
    material_id = Column(Integer, ForeignKey("materials.id"), nullable=False)

    quantity_used = Column(Float, nullable=False)

    usage_date = Column(DateTime, default=datetime.utcnow, nullable=False)


----------------------------------------
FILE: .\app\models\material_usage_daily.py
----------------------------------------
from sqlalchemy import Column, Integer, Float, ForeignKey, Date, DateTime
from sqlalchemy.orm import relationship
from datetime import datetime, date

from app.db.base import Base


class MaterialUsageDaily(Base):
    __tablename__ = "material_usage_daily"

    id = Column(Integer, primary_key=True, index=True)

    project_id = Column(Integer, ForeignKey("projects.id"), nullable=False)
    material_id = Column(Integer, ForeignKey("materials.id"), nullable=False)

    usage_date = Column(Date, nullable=False, default=date.today)
    quantity_used = Column(Float, nullable=False)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)

    # ---------- RELATIONSHIPS ----------
    project = relationship("Project", back_populates="material_usage_daily")
    material = relationship("Material")


----------------------------------------
FILE: .\app\models\planned_material.py
----------------------------------------
from sqlalchemy import Column, Integer, Float, ForeignKey
from sqlalchemy.orm import relationship
from app.db.base import Base


class PlannedMaterial(Base):
    __tablename__ = "planned_materials"

    id = Column(Integer, primary_key=True, index=True)

    project_id = Column(Integer, ForeignKey("projects.id"), nullable=False)
    material_id = Column(Integer, ForeignKey("materials.id"), nullable=False)

    planned_quantity = Column(Float, nullable=False)

    # Relationships
    project = relationship("Project", back_populates="planned_materials")
    material = relationship("Material")


----------------------------------------
FILE: .\app\models\project.py
----------------------------------------
from sqlalchemy import (
    Column, Integer, String, Float, Date, DateTime, Boolean
)
from sqlalchemy.orm import relationship
from datetime import datetime

from app.db.base import Base


class Project(Base):
    __tablename__ = "projects"

    id = Column(Integer, primary_key=True, index=True)

    # ---------- BASIC INFO ----------
    name = Column(String(255), nullable=False)

    project_code = Column(String(100), nullable=True)
    client_authority = Column(String(255), nullable=True)
    contractor = Column(String(255), nullable=True)
    consultant_pmc = Column(String(255), nullable=True)

    is_active = Column(Boolean, default=True, nullable=False)

    status = Column(String(20), default="active", nullable=False)

    # ---------- ROAD TYPE ----------
    road_type = Column(String(100), nullable=False)
    lanes = Column(Integer, nullable=False)
    road_width = Column(Float, nullable=False)
    road_length_km = Column(Float, nullable=False)

    carriageway_width = Column(Float, nullable=True)
    shoulder_type = Column(String(100), nullable=True)
    median_type = Column(String(100), nullable=True)

    # ---------- LOCATION ----------
    country = Column(String(100), nullable=False)
    state = Column(String(100), nullable=True)
    district = Column(String(100), nullable=True)
    city = Column(String(100), nullable=False)

    chainage_start = Column(String(50), nullable=True)
    chainage_end = Column(String(50), nullable=True)

    # ---------- PLANNED TIMELINE ----------
    planned_start_date = Column(Date, nullable=False)
    planned_end_date = Column(Date, nullable=False)

    # ---------- OWNERSHIP ----------
    created_by = Column(Integer, nullable=False)

    # ---------- META ----------
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
    )

    completed_at = Column(DateTime, nullable=True)

    # ================= RELATIONSHIPS =================

    # Project â†’ Activities (definition)
    activities = relationship(
        "Activity",
        back_populates="project",
        cascade="all, delete-orphan"
    )

    # ðŸ”¥ Project â†’ ProjectActivity (planning + execution)
    project_activities = relationship(
        "ProjectActivity",
        back_populates="project",
        cascade="all, delete-orphan"
    )

    planned_materials = relationship(
        "PlannedMaterial",
        back_populates="project",
        cascade="all, delete-orphan"
    )

    material_usage_daily = relationship(
        "MaterialUsageDaily",
        back_populates="project",
        cascade="all, delete-orphan"
    )


----------------------------------------
FILE: .\app\models\project_activity.py
----------------------------------------
from sqlalchemy import (
    Column,
    Integer,
    Float,
    String,
    Date,
    DateTime,
    ForeignKey,
)
from sqlalchemy.orm import relationship
from datetime import datetime

from app.db.base import Base


class ProjectActivity(Base):
    __tablename__ = "project_activities"

    id = Column(Integer, primary_key=True, index=True)

    project_id = Column(Integer, ForeignKey("projects.id"), nullable=False)
    activity_id = Column(Integer, ForeignKey("activities.id"), nullable=False)

    planned_quantity = Column(Float, nullable=False)
    unit = Column(String(50), nullable=False)

    start_date = Column(Date, nullable=False)
    end_date = Column(Date, nullable=False)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)

    # âœ… RELATIONSHIPS (CRITICAL FIX)
    project = relationship(
        "Project",
        back_populates="project_activities"
    )

    activity = relationship(
        "Activity",
        back_populates="project_activities"
    )


----------------------------------------
FILE: .\app\models\project_user.py
----------------------------------------
from sqlalchemy import Column, Integer, ForeignKey, String, DateTime
from sqlalchemy.orm import relationship
from datetime import datetime

from app.db.base import Base


class ProjectUser(Base):
    __tablename__ = "project_users"

    id = Column(Integer, primary_key=True, index=True)

    project_id = Column(Integer, ForeignKey("projects.id"), nullable=False)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)

    # Role INSIDE the project (different from system role)
    role_in_project = Column(String(50), default="member", nullable=False)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)

    # Optional relationships (safe to add later)
    project = relationship("Project", backref="project_users")
    user = relationship("User", backref="project_users")


----------------------------------------
FILE: .\app\models\report.py
----------------------------------------
from sqlalchemy import Column, Integer, String, Date
from app.db.base import Base

class Report(Base):
    __tablename__ = "reports"

    id = Column(Integer, primary_key=True, index=True)
    report_type = Column(String, nullable=False)
    description = Column(String, nullable=False)
    report_date = Column(Date, nullable=False)


----------------------------------------
FILE: .\app\models\road_type.py
----------------------------------------
from sqlalchemy import Column, Integer, String, DateTime
from datetime import datetime

from app.db.base import Base


class RoadType(Base):
    __tablename__ = "road_types"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), nullable=False, unique=True)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)


----------------------------------------
FILE: .\app\models\schedule.py
----------------------------------------

----------------------------------------
FILE: .\app\models\site.py
----------------------------------------

----------------------------------------
FILE: .\app\models\user.py
----------------------------------------
from sqlalchemy import Column, Integer, String, Boolean, DateTime
from datetime import datetime

from app.db.base import Base


class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)

    username = Column(String, unique=True, index=True, nullable=False)
    password_hash = Column(String, nullable=False)

    # EXISTING (UNCHANGED)
    role = Column(String, default="user")

    # âœ… NEW: ENABLE / DISABLE USER
    is_active = Column(Boolean, default=True, nullable=False)

    # âœ… NEW: AUDIT FIELDS (SAFE, OPTIONAL)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False
    )


----------------------------------------
FILE: .\app\models\user_session.py
----------------------------------------
from sqlalchemy import Column, Integer, DateTime, ForeignKey
from datetime import datetime

from app.db.base import Base


class UserSession(Base):
    __tablename__ = "user_sessions"

    id = Column(Integer, primary_key=True, index=True)

    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)

    login_time = Column(DateTime, default=datetime.utcnow, nullable=False)
    logout_time = Column(DateTime, nullable=True)

    # total session duration in seconds
    session_duration = Column(Integer, nullable=True)


----------------------------------------
FILE: .\app\models\__init__.py
----------------------------------------
from app.models.user import User


----------------------------------------
FILE: .\app\repositories\base_repository.py
----------------------------------------

----------------------------------------
FILE: .\app\repositories\cache_repository.py
----------------------------------------

----------------------------------------
FILE: .\app\repositories\csv_repository.py
----------------------------------------

----------------------------------------
FILE: .\app\repositories\db_repository.py
----------------------------------------

----------------------------------------
FILE: .\app\routes\activities.py
----------------------------------------
# app/routes/activities.py
# --------------------------------------------------
# Project-Scoped Activity CRUD (FIXED PROPERLY)
# InfraCore
# --------------------------------------------------

from fastapi import APIRouter, Depends, HTTPException, Request, Form
from fastapi.responses import RedirectResponse, HTMLResponse
from fastapi.templating import Jinja2Templates
from sqlalchemy.orm import Session

from app.db.session import get_db
from app.models.activity import Activity
from app.models.project import Project
from app.models.project_user import ProjectUser

router = APIRouter(
    prefix="/projects",
    tags=["Project Activities"]
)

templates = Jinja2Templates(directory="app/templates")


# ==================================================
# ACCESS GUARD
# ==================================================
def require_project_access(db: Session, user: dict, project_id: int):
    if user["role"] == "admin":
        return True

    project = db.query(Project).filter(Project.id == project_id).first()
    if project and project.created_by == user["id"]:
        return True

    pu = (
        db.query(ProjectUser)
        .filter(
            ProjectUser.project_id == project_id,
            ProjectUser.user_id == user["id"]
        )
        .first()
    )

    if pu and pu.role_in_project in ("owner", "admin", "manager"):
        return True

    return False


# ==================================================
# LIST ACTIVITIES (PER PROJECT)
# ==================================================
@router.get("/{project_id}/activities", response_class=HTMLResponse)
def list_project_activities(
    project_id: int,
    request: Request,
    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    if not user:
        return RedirectResponse("/login", status_code=302)

    if not require_project_access(db, user, project_id):
        return RedirectResponse("/dashboard", status_code=302)

    project = db.query(Project).filter(Project.id == project_id).first()

    activities = (
        db.query(Activity)
        .filter(Activity.project_id == project_id)
        .order_by(Activity.id)
        .all()
    )

    return templates.TemplateResponse(
        "project_activities_list.html",
        {
            "request": request,
            "project": project,
            "activities": activities,
            "user": user,
        }
    )


# ==================================================
# ADD ACTIVITY PAGE
# ==================================================
@router.get("/{project_id}/activities/new", response_class=HTMLResponse)
def new_activity_page(
    project_id: int,
    request: Request,
    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    if not user:
        return RedirectResponse("/login", status_code=302)

    if not require_project_access(db, user, project_id):
        return RedirectResponse("/dashboard", status_code=302)

    project = db.query(Project).filter(Project.id == project_id).first()

    return templates.TemplateResponse(
        "activity_form.html",
        {
            "request": request,
            "project": project,
            "user": user,
        }
    )


# ==================================================
# CREATE ACTIVITY (PROJECT-SCOPED)
# ==================================================
@router.post("/{project_id}/activities/create")
def create_activity(
    project_id: int,
    request: Request,
    name: str = Form(...),
    is_standard: bool = Form(False),
    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    if not user:
        return RedirectResponse("/login", status_code=302)

    if not require_project_access(db, user, project_id):
        return RedirectResponse("/dashboard", status_code=302)

    # Prevent duplicate activity in same project
    existing = (
        db.query(Activity)
        .filter(
            Activity.project_id == project_id,
            Activity.name == name
        )
        .first()
    )
    if existing:
        raise HTTPException(
            status_code=400,
            detail="Activity already exists for this project"
        )

    activity = Activity(
        name=name,
        is_standard=is_standard,
        project_id=project_id,
    )

    db.add(activity)
    db.commit()

    return RedirectResponse(
        f"/project-activity-plan/{project_id}",
        status_code=302
    )


----------------------------------------
FILE: .\app\routes\activity.py
----------------------------------------
from fastapi import APIRouter, Request, Depends
from fastapi.responses import HTMLResponse, RedirectResponse
from fastapi.templating import Jinja2Templates
from sqlalchemy.orm import Session

from app.db.session import SessionLocal
from app.services.activity_service import get_recent_activities

router = APIRouter()
templates = Jinja2Templates(directory="app/templates")


def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


@router.get("/activity", response_class=HTMLResponse)
def activity_page(request: Request, db: Session = Depends(get_db)):
    user = request.session.get("user")
    if user is None or user["role"] != "admin":
        return RedirectResponse("/dashboard", status_code=302)

    logs = get_recent_activities(db)

    return templates.TemplateResponse(
        "activity.html",
        {
            "request": request,
            "user": user,
            "logs": logs,
        }
    )


----------------------------------------
FILE: .\app\routes\activity_materials.py
----------------------------------------
# app/routes/activity_materials.py
# --------------------------------------------------
# Activity-Material Mapping CRUD API (FIXED)
# InfraCore
# --------------------------------------------------

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session

from app.db.session import SessionLocal
from app.models.activity_material import ActivityMaterial
from app.models.activity import Activity
from app.models.material import Material

router = APIRouter(
    prefix="/activity-materials",
    tags=["Activity Materials"]
)

# ---------------- DB DEPENDENCY ----------------
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


# ---------------- CREATE MAPPING ----------------
@router.post("/")
def create_activity_material(
    activity_id: int,
    material_id: int,
    consumption_rate: float,
    db: Session = Depends(get_db),
):
    """
    Map material consumption to an activity.
    consumption_rate = material required per 1 unit of activity
    """

    # Validate Activity
    activity = db.query(Activity).filter(Activity.id == activity_id).first()
    if not activity:
        raise HTTPException(status_code=404, detail="Activity not found")

    # Validate Material
    material = db.query(Material).filter(Material.id == material_id).first()
    if not material:
        raise HTTPException(status_code=404, detail="Material not found")

    # ðŸ”’ Prevent duplicate mapping
    existing = (
        db.query(ActivityMaterial)
        .filter(
            ActivityMaterial.activity_id == activity_id,
            ActivityMaterial.material_id == material_id
        )
        .first()
    )
    if existing:
        raise HTTPException(
            status_code=400,
            detail="Mapping already exists"
        )

    mapping = ActivityMaterial(
        activity_id=activity_id,
        material_id=material_id,
        consumption_rate=consumption_rate,
    )

    db.add(mapping)
    db.commit()
    db.refresh(mapping)

    return {
        "id": mapping.id,
        "activity": activity.name,
        "material": material.name,
        "consumption_rate": mapping.consumption_rate,
    }


# ---------------- LIST MAPPINGS ----------------
@router.get("/")
def list_activity_materials(db: Session = Depends(get_db)):
    """
    List all activity-material mappings (JOINED).
    """

    mappings = (
        db.query(ActivityMaterial, Activity, Material)
        .join(Activity, Activity.id == ActivityMaterial.activity_id)
        .join(Material, Material.id == ActivityMaterial.material_id)
        .order_by(ActivityMaterial.id)
        .all()
    )

    return [
        {
            "id": am.id,
            "activity_id": act.id,
            "activity": act.name,
            "material_id": mat.id,
            "material": mat.name,
            "material_unit": mat.unit,
            "consumption_rate": am.consumption_rate,
        }
        for am, act, mat in mappings
    ]


----------------------------------------
FILE: .\app\routes\activity_progress.py
----------------------------------------
# app/routes/activity_progress.py
# --------------------------------------------------
# Project Activity Progress (Role-Protected)
# InfraCore
# --------------------------------------------------

from fastapi import APIRouter, Request, Depends, Form, HTTPException
from fastapi.responses import RedirectResponse
from sqlalchemy.orm import Session
from datetime import datetime

from app.db.session import get_db
from app.models.project_activity import ProjectActivity
from app.models.activity_progress import ActivityProgress
from app.models.project_user import ProjectUser

router = APIRouter(prefix="/projects", tags=["Activity Progress"])


# ==================================================
# HELPERS
# ==================================================

def get_project_role(db: Session, user: dict, project_id: int):
    """
    Returns:
    - 'admin' if system admin
    - role_in_project if assigned
    - None if no access
    """
    if user["role"] == "admin":
        return "admin"

    pu = (
        db.query(ProjectUser)
        .filter(
            ProjectUser.project_id == project_id,
            ProjectUser.user_id == user["id"]
        )
        .first()
    )

    return pu.role_in_project if pu else None


def require_progress_update_permission(role: str):
    """
    Admin / Manager / Member can update progress.
    Viewer cannot.
    """
    if role not in ("admin", "manager", "member"):
        raise HTTPException(
            status_code=403,
            detail="You do not have permission to update progress"
        )


# ==================================================
# UPDATE ACTIVITY PROGRESS
# ==================================================
@router.post("/{project_id}/activities/{project_activity_id}/progress")
def update_activity_progress(
    project_id: int,
    project_activity_id: int,
    request: Request,
    progress_percent: float = Form(...),
    remarks: str | None = Form(None),
    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    if not user:
        return RedirectResponse("/login", status_code=302)

    # ---------- PROJECT ROLE ----------
    role = get_project_role(db, user, project_id)
    if role is None:
        raise HTTPException(status_code=403, detail="No access to this project")

    require_progress_update_permission(role)

    # ---------- VALIDATE PROJECT ACTIVITY ----------
    pa = (
        db.query(ProjectActivity)
        .filter(
            ProjectActivity.id == project_activity_id,
            ProjectActivity.project_id == project_id
        )
        .first()
    )

    if not pa:
        raise HTTPException(status_code=404, detail="Project activity not found")

    # ---------- CREATE PROGRESS ENTRY ----------
    progress = ActivityProgress(
        project_activity_id=project_activity_id,
        progress_percent=progress_percent,
        remarks=remarks,
        updated_at=datetime.utcnow(),
    )

    db.add(progress)
    db.commit()

    return RedirectResponse(
        f"/projects/{project_id}/activities",
        status_code=302
    )


----------------------------------------
FILE: .\app\routes\admin.py
----------------------------------------
from fastapi import APIRouter, Request, Form, Depends
from fastapi.responses import RedirectResponse, HTMLResponse
from fastapi.templating import Jinja2Templates
from sqlalchemy.orm import Session
import hashlib

from app.db.session import get_db
from app.models.user import User
from app.models.user_session import UserSession

# ðŸ”¹ ADDED (DO NOT REMOVE EXISTING IMPORTS)
from app.models.project import Project
from app.models.project_user import ProjectUser

router = APIRouter(prefix="/admin", tags=["Admin"])
templates = Jinja2Templates(directory="app/templates")


def admin_guard(request: Request):
    user = request.session.get("user")
    if not user or user["role"] != "admin":
        return None
    return user


def hash_password(p: str):
    return hashlib.sha256(p.encode()).hexdigest()


# ================= ADMIN: USER LIST =================
@router.get("/users", response_class=HTMLResponse)
def users_list(request: Request, db: Session = Depends(get_db)):

    admin = admin_guard(request)
    if not admin:
        return RedirectResponse("/dashboard", status_code=302)

    users = db.query(User).order_by(User.id.desc()).all()

    html = templates.get_template("admin/users_list.html").render(
        request=request,
        title="User Management",
        users=users,
        user=admin,
    )

    return HTMLResponse(content=html)


# ================= ADMIN: CREATE USER =================
@router.get("/users/new", response_class=HTMLResponse)
def new_user_page(request: Request):

    admin = admin_guard(request)
    if not admin:
        return RedirectResponse("/dashboard", status_code=302)

    html = templates.get_template("admin/user_form.html").render(
        request=request,
        title="Create User",
        user_data=None,
        project_users=[],
        all_projects=[],
        user=admin,
    )

    return HTMLResponse(content=html)


@router.post("/users/create")
def create_user(
    request: Request,
    username: str = Form(...),
    password: str = Form(...),
    role: str = Form(...),
    db: Session = Depends(get_db),
):

    admin = admin_guard(request)
    if not admin:
        return RedirectResponse("/dashboard", status_code=302)

    existing = db.query(User).filter(User.username == username).first()
    if existing:
        return RedirectResponse("/admin/users", status_code=302)

    user = User(
        username=username,
        password_hash=hash_password(password),
        role=role,
        is_active=True
    )

    db.add(user)
    db.commit()

    return RedirectResponse("/admin/users", status_code=302)


# ================= ADMIN: EDIT USER =================
@router.get("/users/{user_id}/edit", response_class=HTMLResponse)
def edit_user_page(
    user_id: int,
    request: Request,
    db: Session = Depends(get_db),
):

    admin = admin_guard(request)
    if not admin:
        return RedirectResponse("/dashboard", status_code=302)

    user_obj = db.query(User).filter(User.id == user_id).first()
    if not user_obj:
        return RedirectResponse("/admin/users", status_code=302)

    # ðŸ”¹ ADDED: ALL PROJECTS
    all_projects = (
        db.query(Project)
        .order_by(Project.name.asc())
        .all()
    )

    # ðŸ”¹ ADDED: PROJECT ASSIGNMENTS FOR USER
    project_users = (
        db.query(ProjectUser)
        .filter(ProjectUser.user_id == user_id)
        .all()
    )

    html = templates.get_template("admin/user_form.html").render(
        request=request,
        title="Edit User",
        user_data=user_obj,
        project_users=project_users,
        all_projects=all_projects,
        user=admin,
    )

    return HTMLResponse(content=html)


@router.post("/users/{user_id}/update")
def update_user(
    user_id: int,
    request: Request,
    role: str = Form(...),
    password: str | None = Form(None),
    db: Session = Depends(get_db),
):

    admin = admin_guard(request)
    if not admin:
        return RedirectResponse("/dashboard", status_code=302)

    user_obj = db.query(User).filter(User.id == user_id).first()
    if not user_obj:
        return RedirectResponse("/admin/users", status_code=302)

    user_obj.role = role

    if password:
        user_obj.password_hash = hash_password(password)

    db.commit()

    return RedirectResponse("/admin/users", status_code=302)


# ================= ADMIN: ENABLE / DISABLE USER =================
@router.post("/users/{user_id}/toggle")
def toggle_user_status(
    user_id: int,
    request: Request,
    db: Session = Depends(get_db),
):

    admin = admin_guard(request)
    if not admin:
        return RedirectResponse("/dashboard", status_code=302)

    if admin["id"] == user_id:
        return RedirectResponse("/admin/users", status_code=302)

    user_obj = db.query(User).filter(User.id == user_id).first()
    if not user_obj:
        return RedirectResponse("/admin/users", status_code=302)

    user_obj.is_active = not user_obj.is_active
    db.commit()

    return RedirectResponse("/admin/users", status_code=302)


# ================= ADMIN: USER LOGIN HISTORY =================
@router.get("/users/{user_id}/sessions", response_class=HTMLResponse)
def user_login_history(
    user_id: int,
    request: Request,
    db: Session = Depends(get_db),
):

    admin = admin_guard(request)
    if not admin:
        return RedirectResponse("/dashboard", status_code=302)

    user_obj = db.query(User).filter(User.id == user_id).first()
    if not user_obj:
        return RedirectResponse("/admin/users", status_code=302)

    sessions = (
        db.query(UserSession)
        .filter(UserSession.user_id == user_id)
        .order_by(UserSession.login_time.desc())
        .all()
    )

    total_logged_in_seconds = sum(
        s.session_duration or 0 for s in sessions
    )

    html = templates.get_template("admin/user_sessions.html").render(
        request=request,
        title=f"Login History â€“ {user_obj.username}",
        user_obj=user_obj,
        sessions=sessions,
        total_logged_in_seconds=total_logged_in_seconds,
        user=admin,
    )

    return HTMLResponse(content=html)


----------------------------------------
FILE: .\app\routes\ai.py
----------------------------------------

----------------------------------------
FILE: .\app\routes\auth.py
----------------------------------------
from fastapi import APIRouter, Request, Form, Depends
from fastapi.responses import RedirectResponse, HTMLResponse
from fastapi.templating import Jinja2Templates
from sqlalchemy.orm import Session
import hashlib

from app.db.session import SessionLocal
from app.models.user import User

router = APIRouter()
templates = Jinja2Templates(directory="app/templates")

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

def hash_password(p: str):
    return hashlib.sha256(p.encode()).hexdigest()

@router.get("/login", response_class=HTMLResponse)
def login_page(request: Request):
    return templates.TemplateResponse(
        "login.html", {"request": request, "user": None}
    )

@router.post("/login")
def login_action(
    request: Request,
    username: str = Form(...),
    password: str = Form(...),
    db: Session = Depends(get_db),
):
    user = db.query(User).filter(User.username == username).first()
    if not user or user.password != hash_password(password):
        return templates.TemplateResponse(
            "login.html",
            {"request": request, "user": None, "error": "Invalid credentials"},
        )

    request.session["user"] = {
        "id": user.id,
        "username": user.username,
        "role": user.role,
    }

    return RedirectResponse("/reports", status_code=302)

@router.get("/logout")
def logout(request: Request):
    request.session.clear()
    return RedirectResponse("/login", status_code=302)


----------------------------------------
FILE: .\app\routes\daily_entry.py
----------------------------------------
# app/routes/daily_entry.py
# --------------------------------------------------
# Daily Activity Execution (Quantity-Based Progress)
# --------------------------------------------------

from datetime import date
from fastapi import APIRouter, Depends, HTTPException, Form
from fastapi.responses import RedirectResponse
from sqlalchemy.orm import Session
from sqlalchemy import func

from app.db.session import get_db
from app.models.daily_entry import DailyEntry
from app.models.project_activity import ProjectActivity
from app.models.activity_progress import ActivityProgress

router = APIRouter(
    prefix="/daily-entry",
    tags=["Daily Activity Execution"]
)


# ==================================================
# SAFETY GET HANDLER
# ==================================================
@router.get("/")
def daily_entry_guard():
    return RedirectResponse("/execution", status_code=302)


# ==================================================
# ADD DAILY EXECUTION ENTRY (FORM SAFE)
# ==================================================
@router.post("/")
def add_daily_entry(
    project_id: int = Form(...),
    activity_id: int = Form(...),
    quantity_done: float = Form(...),
    entry_date: date = Form(...),
    db: Session = Depends(get_db)
):
    pa = (
        db.query(ProjectActivity)
        .filter(
            ProjectActivity.project_id == project_id,
            ProjectActivity.activity_id == activity_id
        )
        .first()
    )

    if not pa:
        raise HTTPException(status_code=400, detail="Activity not planned")

    entry = DailyEntry(
        project_id=project_id,
        activity_id=activity_id,
        quantity_done=quantity_done,
        entry_date=entry_date
    )
    db.add(entry)
    db.commit()

    cumulative_qty = (
        db.query(func.sum(DailyEntry.quantity_done))
        .filter(
            DailyEntry.project_id == project_id,
            DailyEntry.activity_id == activity_id
        )
        .scalar()
        or 0.0
    )

    progress = int(min((cumulative_qty / pa.planned_quantity) * 100, 100))

    ap = (
        db.query(ActivityProgress)
        .filter(
            ActivityProgress.project_id == project_id,
            ActivityProgress.activity_id == activity_id
        )
        .first()
    )

    if not ap:
        raise HTTPException(status_code=400, detail="Progress row missing")

    ap.progress_percent = progress

    if progress > 0 and ap.actual_start is None:
        ap.actual_start = entry_date

    if progress == 100:
        ap.actual_end = entry_date
        ap.status = "COMPLETED"
    else:
        ap.status = "DELAYED" if entry_date > ap.planned_end else "IN_PROGRESS"

    db.commit()

    return RedirectResponse(
        f"/execution/{project_id}",
        status_code=302
    )


----------------------------------------
FILE: .\app\routes\daily_entry_ui.py
----------------------------------------
# app/routes/daily_entry_ui.py
# --------------------------------------------------
# Daily Activity Execution (UI)
# --------------------------------------------------

from datetime import date
from fastapi import APIRouter, Request, Depends
from fastapi.responses import RedirectResponse, HTMLResponse
from fastapi.templating import Jinja2Templates
from sqlalchemy.orm import Session

from app.db.session import get_db
from app.models.project import Project
from app.models.project_activity import ProjectActivity
from app.models.project_user import ProjectUser

router = APIRouter(
    prefix="/execution",
    tags=["Daily Execution UI"]
)

templates = Jinja2Templates(directory="app/templates")


# =====================================================
# PROJECT SELECTION
# =====================================================
@router.get("/", response_class=HTMLResponse)
def execution_project_select(
    request: Request,
    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    if not user:
        return RedirectResponse("/login", status_code=302)

    if user["role"] == "admin":
        projects = db.query(Project).all()
    else:
        projects = (
            db.query(Project)
            .join(ProjectUser)
            .filter(ProjectUser.user_id == user["id"])
            .all()
        )

    return templates.TemplateResponse(
        "daily_execution_projects.html",
        {
            "request": request,
            "user": user,
            "projects": projects,
        }
    )


# =====================================================
# DAILY EXECUTION PAGE
# =====================================================
@router.get("/{project_id}", response_class=HTMLResponse)
def daily_execution_page(
    project_id: int,
    request: Request,
    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    if not user:
        return RedirectResponse("/login", status_code=302)

    project = db.query(Project).filter(Project.id == project_id).first()
    if not project:
        return RedirectResponse("/execution", status_code=302)

    # âŒ NO JOIN (because relationship does not exist)
    activities = (
        db.query(ProjectActivity)
        .filter(ProjectActivity.project_id == project_id)
        .all()
    )

    return templates.TemplateResponse(
        "daily_entry.html",
        {
            "request": request,
            "user": user,
            "project": project,
            "activities": activities,
            "today": date.today(),
        }
    )


----------------------------------------
FILE: .\app\routes\dashboard.py
----------------------------------------
from fastapi import APIRouter, Request, Depends
from fastapi.responses import HTMLResponse, RedirectResponse
from fastapi.templating import Jinja2Templates
from sqlalchemy.orm import Session
from sqlalchemy import or_

from app.db.session import get_db
from app.models.project import Project
from app.models.project_user import ProjectUser
from app.services.report_service import get_summary
from app.utils.flash import flash

router = APIRouter()
templates = Jinja2Templates(directory="app/templates")


@router.get("/dashboard", response_class=HTMLResponse)
async def dashboard(
    request: Request,
    project_id: int | None = None,
    db: Session = Depends(get_db)
):
    # =====================================================
    # AUTH CHECK
    # =====================================================
    user = request.session.get("user")
    if user is None:
        flash(request, "Please login to access dashboard", "warning")
        return RedirectResponse("/login", status_code=302)

    user_id = user["id"]

    # =====================================================
    # PROJECT VISIBILITY (LOCKED)
    # =====================================================
    if user["role"] == "admin":
        base_query = db.query(Project)
    else:
        assigned_project_ids = (
            db.query(ProjectUser.project_id)
            .filter(ProjectUser.user_id == user_id)
            .subquery()
        )

        base_query = (
            db.query(Project)
            .filter(
                or_(
                    Project.created_by == user_id,
                    Project.id.in_(assigned_project_ids)
                )
            )
        )

    projects = base_query.order_by(Project.id.desc()).all()
    has_projects = len(projects) > 0

    # =====================================================
    # SAFE PROJECT SELECTION
    # =====================================================
    project = None

    if has_projects:
        # ðŸ”’ Explicit project_id only if allowed
        if project_id:
            project = base_query.filter(Project.id == project_id).first()

        # ðŸ” Fallback: active project
        if project is None:
            project = (
                base_query
                .filter(Project.is_active == True)
                .order_by(Project.id.desc())
                .first()
            )

        # ðŸ” Final fallback: any project
        if project is None:
            project = base_query.order_by(Project.id.desc()).first()

    # =====================================================
    # PROJECT ROLE RESOLUTION
    # =====================================================
    project_role = "viewer"

    if user["role"] == "admin":
        project_role = "admin"
    elif project:
        pu = (
            db.query(ProjectUser)
            .filter(
                ProjectUser.project_id == project.id,
                ProjectUser.user_id == user_id
            )
            .first()
        )
        if pu:
            project_role = pu.role_in_project

    # =====================================================
    # SUMMARY (SAFE WHEN NO PROJECT)
    # =====================================================
    summary = (
        get_summary(project_id=project.id)
        if project else
        {
            "total_reports": 0,
            "reports_today": 0,
        }
    )

    # =====================================================
    # RENDER
    # =====================================================
    return templates.TemplateResponse(
        "dashboard.html",
        {
            "request": request,
            "title": "Dashboard",

            # USER CONTEXT
            "user": user,
            "is_admin": user["role"] == "admin",

            # PROJECT CONTEXT
            "projects": projects,
            "project": project,
            "project_id": project.id if project else None,
            "has_projects": has_projects,
            "project_role": project_role,

            # KPI / SUMMARY
            "summary": summary,
        }
    )


----------------------------------------
FILE: .\app\routes\home.py
----------------------------------------
from fastapi import APIRouter, Request
from fastapi.responses import HTMLResponse
from fastapi.templating import Jinja2Templates

router = APIRouter()

templates = Jinja2Templates(directory="app/templates")

@router.get("/", response_class=HTMLResponse)
async def home(request: Request):
    return templates.TemplateResponse(
        "home.html",
        {"request": request}
    )


----------------------------------------
FILE: .\app\routes\inventory.py
----------------------------------------
# app/routes/inventory.py
# --------------------------------------------------
# Inventory Routes
# InfraCore
# --------------------------------------------------

from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from app.db.session import SessionLocal
from app.services.inventory_service import get_inventory_summary

router = APIRouter(
    prefix="/inventory",
    tags=["Inventory"]
)


def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


@router.get("/summary/{project_id}")
def inventory_summary(
    project_id: int,
    db: Session = Depends(get_db)
):
    """
    Inventory summary for a project
    """
    return {
        "project_id": project_id,
        "inventory": get_inventory_summary(db, project_id)
    }


----------------------------------------
FILE: .\app\routes\labour.py
----------------------------------------
from fastapi import APIRouter, Request
from fastapi.responses import HTMLResponse
from fastapi.templating import Jinja2Templates
from app.services.labour_service import get_labour

router = APIRouter()
templates = Jinja2Templates(directory="app/templates")


@router.get("/labour", response_class=HTMLResponse)
async def labour(request: Request):
    return templates.TemplateResponse(
        "labour.html",
        {"request": request, "title": "Labour", "labour": get_labour()}
    )


----------------------------------------
FILE: .\app\routes\machinery.py
----------------------------------------
from fastapi import APIRouter, Request
from fastapi.responses import HTMLResponse
from fastapi.templating import Jinja2Templates
from app.services.machinery_service import get_machinery

router = APIRouter()
templates = Jinja2Templates(directory="app/templates")


@router.get("/machinery", response_class=HTMLResponse)
async def machinery(request: Request):
    return templates.TemplateResponse(
        "machinery.html",
        {"request": request, "title": "Machinery", "machinery": get_machinery()}
    )


----------------------------------------
FILE: .\app\routes\materials.py
----------------------------------------
# app/routes/materials.py
# --------------------------------------------------
# Material CRUD API (FIXED)
# InfraCore
# --------------------------------------------------

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session

from app.db.session import SessionLocal
from app.models.material import Material

router = APIRouter(
    prefix="/materials",
    tags=["Materials"]
)

# ---------------- DB DEPENDENCY ----------------
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


# ---------------- CREATE MATERIAL ----------------
@router.post("/")
def create_material(
    name: str,
    unit: str,
    lead_time_days: int,
    minimum_stock: float = 0,
    db: Session = Depends(get_db),
):
    """
    Create a material.
    Example: Aggregate, Bitumen, Cement
    """

    material = Material(
        name=name,
        unit=unit,
        lead_time_days=lead_time_days,
        minimum_stock=minimum_stock,
    )

    try:
        db.add(material)
        db.commit()
        db.refresh(material)
    except Exception as e:
        db.rollback()
        raise HTTPException(
            status_code=400,
            detail="Material creation failed (duplicate or DB constraint)"
        )

    return {
        "status": "success",
        "material_id": material.id,
        "name": material.name,
        "unit": material.unit,
        "lead_time_days": material.lead_time_days,
        "minimum_stock": material.minimum_stock,
    }


# ---------------- LIST MATERIALS ----------------
@router.get("/")
def list_materials(db: Session = Depends(get_db)):
    """
    List all materials.
    """

    materials = db.query(Material).all()

    return [
        {
            "id": m.id,
            "name": m.name,
            "unit": m.unit,
            "lead_time_days": m.lead_time_days,
            "minimum_stock": m.minimum_stock,
        }
        for m in materials
    ]


----------------------------------------
FILE: .\app\routes\material_daily_usage.py
----------------------------------------
# app/routes/material_daily_usage.py
# --------------------------------------------------
# Daily Material Usage (Service-based Inventory Deduction)
# InfraCore
# --------------------------------------------------

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session

from app.db.session import SessionLocal
from app.models.material_usage_daily import MaterialUsageDaily
from app.services.inventory_service import deduct_inventory

router = APIRouter(
    prefix="/daily-material-usage",
    tags=["Daily Material Usage"]
)

# ---------------- DB DEP ----------------
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


# ---------------- ADD DAILY USAGE ----------------
@router.post("/")
def add_daily_usage(
    project_id: int,
    material_id: int,
    quantity_used: float,
    db: Session = Depends(get_db)
):
    """
    Record daily material usage and auto-deduct inventory
    """

    # 1ï¸âƒ£ Deduct inventory using service
    remaining_stock = deduct_inventory(
        db=db,
        project_id=project_id,
        material_id=material_id,
        quantity_used=quantity_used
    )

    # 2ï¸âƒ£ Record daily usage
    usage = MaterialUsageDaily(
        project_id=project_id,
        material_id=material_id,
        quantity_used=quantity_used
    )

    db.add(usage)
    db.commit()
    db.refresh(usage)

    return {
        "status": "success",
        "message": "Daily material usage recorded & inventory updated",
        "usage_id": usage.id,
        "remaining_stock": remaining_stock
    }


# ---------------- LIST DAILY USAGE ----------------
@router.get("/")
def list_daily_usage(db: Session = Depends(get_db)):
    usages = db.query(MaterialUsageDaily).all()

    return [
        {
            "id": u.id,
            "project_id": u.project_id,
            "material_id": u.material_id,
            "quantity_used": u.quantity_used,
            "date": u.created_at
        }
        for u in usages
    ]


----------------------------------------
FILE: .\app\routes\material_progress.py
----------------------------------------
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session

from app.db.session import get_db
from app.services.material_progress_analytics import (
    get_material_progress_analytics
)

router = APIRouter(
    prefix="/analytics",
    tags=["Material Progress Analytics"]
)


@router.get("/material-progress/{project_id}/{activity_id}")
def material_progress_analytics(
    project_id: int,
    activity_id: int,
    db: Session = Depends(get_db)
):
    """
    Get planned vs actual material usage based on activity progress %
    """
    try:
        return get_material_progress_analytics(
            db=db,
            project_id=project_id,
            activity_id=activity_id
        )
    except ValueError as e:
        raise HTTPException(status_code=404, detail=str(e))


----------------------------------------
FILE: .\app\routes\material_requirements.py
----------------------------------------
# app/routes/material_requirements.py
# --------------------------------------------------
# Material Requirement Routes (FINAL)
# InfraCore
# --------------------------------------------------

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session

from app.db.session import SessionLocal
from app.services.material_calculator import MaterialRequirementCalculator

router = APIRouter(
    prefix="/material-requirements",
    tags=["Material Requirements"]
)

# ---------------- DB DEPENDENCY ----------------
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


@router.post("/calculate/{project_id}")
def calculate_material_requirements(
    project_id: int,
    db: Session = Depends(get_db)
):
    """
    Trigger planned material requirement calculation
    for a given project.
    """
    try:
        calculator = MaterialRequirementCalculator(db)
        result = calculator.calculate_for_project(project_id)

        if not result:
            return {
                "status": "success",
                "message": "No activities found for project",
                "data": {}
            }

        return {
            "status": "success",
            "message": "Material requirement calculated successfully",
            "data": result
        }

    except ValueError as e:
        db.rollback()
        raise HTTPException(status_code=404, detail=str(e))

    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=500, detail=str(e))


----------------------------------------
FILE: .\app\routes\material_stock.py
----------------------------------------
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session

from app.db.session import SessionLocal
from app.models.material_stock import MaterialStock

router = APIRouter(
    prefix="/material-stock",
    tags=["Material Stock"]
)

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


@router.post("/")
def add_material_stock(
    project_id: int,
    material_id: int,
    quantity_available: float,
    location: str | None = None,
    db: Session = Depends(get_db)
):
    if quantity_available < 0:
        raise HTTPException(status_code=400, detail="Quantity cannot be negative")

    stock = MaterialStock(
        project_id=project_id,
        material_id=material_id,
        quantity_available=quantity_available,
        location=location
    )

    db.add(stock)
    db.commit()
    db.refresh(stock)

    return {
        "status": "success",
        "message": "Material stock added",
        "stock_id": stock.id
    }


----------------------------------------
FILE: .\app\routes\projects.py
----------------------------------------
# app/routes/projects.py
# --------------------------------------------------
# Project CRUD + Management (ROLE-SECURED)
# InfraCore
# --------------------------------------------------

from fastapi import APIRouter, Depends, Form, Request
from fastapi.responses import RedirectResponse, HTMLResponse
from fastapi.templating import Jinja2Templates
from sqlalchemy.orm import Session
from datetime import date

from app.db.session import SessionLocal
from app.models.project import Project
from app.models.project_user import ProjectUser

router = APIRouter(prefix="/projects", tags=["Projects"])
templates = Jinja2Templates(directory="app/templates")

# ---------------- DB DEPENDENCY ----------------
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


# ---------------- PROJECT ACCESS GUARD ----------------
def get_project_access(db, project_id, user):
    project = db.query(Project).filter(Project.id == project_id).first()
    if not project:
        return None, None

    if user["role"] == "admin":
        return project, "admin"

    if project.created_by == user["id"]:
        return project, "owner"

    pu = (
        db.query(ProjectUser)
        .filter(
            ProjectUser.project_id == project_id,
            ProjectUser.user_id == user["id"]
        )
        .first()
    )

    if pu:
        return project, pu.role_in_project

    return None, None


# =================================================
# PAGE: LIST PROJECTS
# =================================================
@router.get("", response_class=HTMLResponse)
def projects_page(request: Request, db: Session = Depends(get_db)):
    user = request.session.get("user")
    if not user:
        return RedirectResponse("/login", status_code=302)

    projects = (
        db.query(Project)
        .outerjoin(ProjectUser, Project.id == ProjectUser.project_id)
        .filter(
            (Project.created_by == user["id"]) |
            (ProjectUser.user_id == user["id"])
        )
        .distinct()
        .order_by(Project.id.desc())
        .all()
    )

    return templates.TemplateResponse(
        "projects.html",
        {
            "request": request,
            "title": "Projects",
            "projects": projects,
            "user": user,
        }
    )


# =================================================
# PAGE: MANAGE PROJECTS
# =================================================
@router.get("/manage", response_class=HTMLResponse)
def manage_projects_page(
    request: Request,
    view: str | None = "active",
    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    if not user:
        return RedirectResponse("/login", status_code=302)

    query = db.query(Project).filter(Project.created_by == user["id"])

    if view == "archived":
        query = query.filter(Project.is_active == False)
    else:
        query = query.filter(Project.is_active == True)

    projects = query.order_by(Project.created_at.desc()).all()

    return templates.TemplateResponse(
        "projects_manage.html",
        {
            "request": request,
            "title": "Manage Projects",
            "projects": projects,
            "view": view,
            "user": user,
        }
    )


# =================================================
# PAGE: CREATE PROJECT
# =================================================
@router.get("/new", response_class=HTMLResponse)
def new_project_page(request: Request):
    user = request.session.get("user")
    if not user:
        return RedirectResponse("/login", status_code=302)

    return templates.TemplateResponse(
        "new_project.html",
        {
            "request": request,
            "title": "Create New Project",
            "user": user,
        }
    )


# =================================================
# CREATE PROJECT
# =================================================
@router.post("/create")
def create_project_form(
    request: Request,
    name: str = Form(...),
    project_code: str | None = Form(None),
    client_authority: str | None = Form(None),
    contractor: str | None = Form(None),
    consultant_pmc: str | None = Form(None),

    road_type: str = Form(...),
    lanes: int = Form(...),
    road_width: float = Form(...),
    carriageway_width: float | None = Form(None),
    road_length_km: float = Form(...),
    shoulder_type: str | None = Form(None),
    median_type: str | None = Form(None),

    country: str = Form(...),
    state: str | None = Form(None),
    district: str | None = Form(None),
    city: str = Form(...),
    chainage_start: str | None = Form(None),
    chainage_end: str | None = Form(None),

    planned_start_date: date = Form(...),
    planned_end_date: date = Form(...),

    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    if not user:
        return RedirectResponse("/login", status_code=302)

    project = Project(
        name=name,
        project_code=project_code,
        client_authority=client_authority,
        contractor=contractor,
        consultant_pmc=consultant_pmc,

        road_type=road_type,
        lanes=lanes,
        road_width=road_width,
        carriageway_width=carriageway_width,
        road_length_km=road_length_km,
        shoulder_type=shoulder_type,
        median_type=median_type,

        country=country,
        state=state,
        district=district,
        city=city,
        chainage_start=chainage_start,
        chainage_end=chainage_end,

        planned_start_date=planned_start_date,
        planned_end_date=planned_end_date,
        created_by=user["id"],
        is_active=True,
        status="active",
    )

    db.add(project)
    db.commit()

    return RedirectResponse("/projects/manage", status_code=302)


# =================================================
# EDIT PROJECT
# =================================================
@router.get("/{project_id}/edit", response_class=HTMLResponse)
def edit_project_page(project_id: int, request: Request, db: Session = Depends(get_db)):
    user = request.session.get("user")
    project, role = get_project_access(db, project_id, user)

    if not project or role not in ["owner", "admin", "manager"]:
        return RedirectResponse("/dashboard", status_code=302)

    return templates.TemplateResponse(
        "edit_project.html",
        {
            "request": request,
            "title": "Edit Project",
            "project": project,
            "user": user,
        }
    )


# =================================================
# UPDATE PROJECT
# =================================================
@router.post("/{project_id}/update")
def update_project_form(
    project_id: int,
    request: Request,

    name: str = Form(...),
    project_code: str | None = Form(None),
    client_authority: str | None = Form(None),
    contractor: str | None = Form(None),
    consultant_pmc: str | None = Form(None),

    road_type: str = Form(...),
    lanes: int = Form(...),
    road_width: float = Form(...),
    carriageway_width: float | None = Form(None),
    road_length_km: float = Form(...),
    shoulder_type: str | None = Form(None),
    median_type: str | None = Form(None),

    country: str = Form(...),
    state: str | None = Form(None),
    district: str | None = Form(None),
    city: str = Form(...),
    chainage_start: str | None = Form(None),
    chainage_end: str | None = Form(None),

    planned_start_date: date = Form(...),
    planned_end_date: date = Form(...),

    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    project, role = get_project_access(db, project_id, user)

    if not project or role not in ["owner", "admin", "manager"]:
        return RedirectResponse("/dashboard", status_code=302)

    project.name = name
    project.project_code = project_code
    project.client_authority = client_authority
    project.contractor = contractor
    project.consultant_pmc = consultant_pmc

    project.road_type = road_type
    project.lanes = lanes
    project.road_width = road_width
    project.carriageway_width = carriageway_width
    project.road_length_km = road_length_km
    project.shoulder_type = shoulder_type
    project.median_type = median_type

    project.country = country
    project.state = state
    project.district = district
    project.city = city
    project.chainage_start = chainage_start
    project.chainage_end = chainage_end

    project.planned_start_date = planned_start_date
    project.planned_end_date = planned_end_date

    db.commit()

    return RedirectResponse("/projects/manage", status_code=302)


# =================================================
# ARCHIVE PROJECT
# =================================================
@router.post("/{project_id}/archive")
def archive_project(project_id: int, request: Request, db: Session = Depends(get_db)):
    user = request.session.get("user")
    project, role = get_project_access(db, project_id, user)

    if not project or role not in ["owner", "admin"]:
        return RedirectResponse("/dashboard", status_code=302)

    project.is_active = not project.is_active
    project.status = "archived" if not project.is_active else "active"
    db.commit()

    return RedirectResponse("/projects/manage", status_code=302)


# =================================================
# DELETE PROJECT
# =================================================
@router.post("/{project_id}/delete")
def delete_project(project_id: int, request: Request, db: Session = Depends(get_db)):
    user = request.session.get("user")
    project, role = get_project_access(db, project_id, user)

    if not project or role not in ["owner", "admin"]:
        return RedirectResponse("/dashboard", status_code=302)

    db.delete(project)
    db.commit()

    return RedirectResponse("/projects/manage", status_code=302)


----------------------------------------
FILE: .\app\routes\project_activities.py
----------------------------------------
# app/routes/project_activities.py
# --------------------------------------------------
# Project Activities (Project-Scoped with Role Guard)
# InfraCore
# --------------------------------------------------

from fastapi import APIRouter, Request, Depends, Form, HTTPException
from fastapi.responses import RedirectResponse, HTMLResponse
from fastapi.templating import Jinja2Templates
from sqlalchemy.orm import Session

from app.db.session import get_db
from app.models.project import Project
from app.models.activity import Activity
from app.models.project_activity import ProjectActivity
from app.models.project_user import ProjectUser

router = APIRouter(prefix="/projects", tags=["Project Activities"])
templates = Jinja2Templates(directory="app/templates")


# ==================================================
# HELPERS
# ==================================================

def get_project_role(db: Session, user: dict, project_id: int):
    if user["role"] == "admin":
        return "admin"

    pu = (
        db.query(ProjectUser)
        .filter(
            ProjectUser.project_id == project_id,
            ProjectUser.user_id == user["id"]
        )
        .first()
    )

    return pu.role_in_project if pu else None


def require_project_access(db, user, project_id):
    role = get_project_role(db, user, project_id)
    if role is None:
        raise HTTPException(status_code=403, detail="No access to this project")
    return role


# ==================================================
# VIEW PROJECT ACTIVITIES
# ==================================================
@router.get("/{project_id}/activities", response_class=HTMLResponse)
def view_project_activities(
    project_id: int,
    request: Request,
    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    if not user:
        return RedirectResponse("/login", status_code=302)

    role = require_project_access(db, user, project_id)

    project = db.query(Project).filter(Project.id == project_id).first()
    if not project:
        return RedirectResponse("/projects/manage", status_code=302)

    activities = (
        db.query(Activity)
        .filter(Activity.project_id == project_id)
        .order_by(Activity.id)
        .all()
    )

    return templates.TemplateResponse(
        "project_activities.html",
        {
            "request": request,
            "user": user,
            "project": project,
            "activities": activities,
            "project_role": role,
        }
    )


# ==================================================
# NEW ACTIVITY FORM
# ==================================================
@router.get("/{project_id}/activities/new", response_class=HTMLResponse)
def new_activity_page(
    project_id: int,
    request: Request,
    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    if not user:
        return RedirectResponse("/login", status_code=302)

    role = require_project_access(db, user, project_id)
    if role not in ("admin", "manager"):
        raise HTTPException(status_code=403, detail="Permission denied")

    project = db.query(Project).filter(Project.id == project_id).first()
    if not project:
        return RedirectResponse("/projects/manage", status_code=302)

    return templates.TemplateResponse(
        "activity_form.html",
        {
            "request": request,
            "project": project,
            "user": user,
        }
    )


# ==================================================
# CREATE ACTIVITY (PROJECT-SCOPED) âœ… FIXED
# ==================================================
@router.post("/{project_id}/activities/create")
def create_activity_for_project(
    project_id: int,
    request: Request,
    name: str = Form(...),
    is_standard: str = Form("false"),  # ðŸ‘ˆ FIXED (string)
    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    if not user:
        return RedirectResponse("/login", status_code=302)

    role = require_project_access(db, user, project_id)
    if role not in ("admin", "manager"):
        raise HTTPException(status_code=403, detail="Permission denied")

    exists = (
        db.query(Activity)
        .filter(
            Activity.project_id == project_id,
            Activity.name == name
        )
        .first()
    )
    if exists:
        raise HTTPException(status_code=400, detail="Activity already exists")

    activity = Activity(
        name=name,
        is_standard=(is_standard == "true"),  # ðŸ‘ˆ FIXED
        project_id=project_id,
    )

    db.add(activity)
    db.commit()

    return RedirectResponse(
        f"/project-activity-plan/{project_id}",
        status_code=302
    )


----------------------------------------
FILE: .\app\routes\project_activity_plan.py
----------------------------------------
# app/routes/project_activity_plan.py
# --------------------------------------------------
# Project Activity Planning (Schedule + Quantity)
# --------------------------------------------------

from fastapi import APIRouter, Request, Depends, Form
from fastapi.responses import HTMLResponse, RedirectResponse
from fastapi.templating import Jinja2Templates
from sqlalchemy.orm import Session
from datetime import date  # âœ… FIX

from app.db.session import get_db
from app.models.project import Project
from app.models.activity import Activity
from app.models.project_activity import ProjectActivity
from app.models.activity_progress import ActivityProgress

router = APIRouter(
    prefix="/project-activity-plan",
    tags=["Project Activity Planning"]
)

templates = Jinja2Templates(directory="app/templates")


# --------------------------------------------------
# VIEW PLANNING PAGE
# --------------------------------------------------
@router.get("/{project_id}", response_class=HTMLResponse)
def plan_activities_page(
    project_id: int,
    request: Request,
    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    if not user:
        return RedirectResponse("/login", status_code=302)

    project = db.query(Project).filter(Project.id == project_id).first()
    if not project:
        return RedirectResponse("/dashboard", status_code=302)

    activities = (
        db.query(Activity)
        .filter(Activity.project_id == project_id)
        .order_by(Activity.id)
        .all()
    )

    planned = (
        db.query(ProjectActivity)
        .filter(ProjectActivity.project_id == project_id)
        .all()
    )

    planned_map = {p.activity_id: p for p in planned}

    return templates.TemplateResponse(
        "project_activity_plan.html",
        {
            "request": request,
            "project": project,
            "activities": activities,
            "planned_map": planned_map,
            "user": user,
        }
    )


# --------------------------------------------------
# SAVE / UPDATE PLAN (âœ… DATE FIXED)
# --------------------------------------------------
@router.post("/save")
def save_activity_plan(
    request: Request,
    project_id: int = Form(...),
    activity_id: int = Form(...),
    planned_quantity: float = Form(...),
    unit: str = Form(...),
    start_date: str = Form(...),
    end_date: str = Form(...),
    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    if not user:
        return RedirectResponse("/login", status_code=302)

    # âœ… CONVERT STRING â†’ date
    start_date_obj = date.fromisoformat(start_date)
    end_date_obj = date.fromisoformat(end_date)

    pa = (
        db.query(ProjectActivity)
        .filter(
            ProjectActivity.project_id == project_id,
            ProjectActivity.activity_id == activity_id
        )
        .first()
    )

    if pa:
        pa.planned_quantity = planned_quantity
        pa.unit = unit
        pa.start_date = start_date_obj
        pa.end_date = end_date_obj
    else:
        pa = ProjectActivity(
            project_id=project_id,
            activity_id=activity_id,
            planned_quantity=planned_quantity,
            unit=unit,
            start_date=start_date_obj,
            end_date=end_date_obj,
        )
        db.add(pa)

        # ðŸ”‘ Auto-create ActivityProgress (FIXED)
        db.add(
            ActivityProgress(
                project_id=project_id,
                activity_id=activity_id,
                planned_start=start_date_obj,
                planned_end=end_date_obj,
                progress_percent=0,
                status="NOT_STARTED"
            )
        )

    db.commit()

    return RedirectResponse(
        f"/project-activity-plan/{project_id}",
        status_code=302
    )


----------------------------------------
FILE: .\app\routes\project_dashboard.py
----------------------------------------
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session

from app.db.session import get_db
from app.services.project_dashboard_analytics import (
    get_project_dashboard_analytics
)

router = APIRouter(
    prefix="/analytics",
    tags=["Project Dashboard Analytics"]
)


@router.get("/project-dashboard/{project_id}")
def project_dashboard(
    project_id: int,
    db: Session = Depends(get_db)
):
    """
    Get project-level dashboard KPIs:
    - Activity status summary
    - Overall progress %
    - Material health
    - Risk flags
    """
    try:
        return get_project_dashboard_analytics(
            db=db,
            project_id=project_id
        )
    except ValueError as e:
        raise HTTPException(status_code=404, detail=str(e))


----------------------------------------
FILE: .\app\routes\project_users.py
----------------------------------------
from fastapi import APIRouter, Request, Form, Depends
from fastapi.responses import RedirectResponse, HTMLResponse
from fastapi.templating import Jinja2Templates
from sqlalchemy.orm import Session

from app.db.session import get_db
from app.models.project import Project
from app.models.user import User
from app.models.project_user import ProjectUser


router = APIRouter(
    prefix="/admin/projects",
    tags=["Project Users"]
)

templates = Jinja2Templates(directory="app/templates")


# --------------------------------------------------
# GUARD: ADMIN / MANAGER ONLY
# --------------------------------------------------
def project_admin_guard(request: Request):
    user = request.session.get("user")
    if not user:
        return None

    if user["role"] not in ["admin", "manager"]:
        return None

    return user


# --------------------------------------------------
# VIEW & MANAGE USERS OF A PROJECT
# --------------------------------------------------
@router.get("/{project_id}/users", response_class=HTMLResponse)
def project_users_page(
    project_id: int,
    request: Request,
    db: Session = Depends(get_db),
):
    current_user = project_admin_guard(request)
    if not current_user:
        return RedirectResponse("/dashboard", status_code=302)

    project = db.query(Project).filter(Project.id == project_id).first()
    if not project:
        return RedirectResponse("/projects/manage", status_code=302)

    # Assigned users
    project_users = (
        db.query(ProjectUser)
        .filter(ProjectUser.project_id == project_id)
        .all()
    )

    assigned_user_ids = [pu.user_id for pu in project_users]

    # Available users (active + not assigned)
    available_users = (
        db.query(User)
        .filter(User.is_active == True)
        .filter(~User.id.in_(assigned_user_ids))
        .all()
    )

    return templates.TemplateResponse(
        "admin/project_users.html",
        {
            "request": request,
            "title": f"Project Users â€“ {project.name}",
            "project": project,
            "project_users": project_users,
            "available_users": available_users,
            "user": current_user,
        }
    )


# --------------------------------------------------
# ADD USER TO PROJECT
# --------------------------------------------------
@router.post("/{project_id}/users/add")
def add_user_to_project(
    project_id: int,
    request: Request,
    user_id: int = Form(...),
    role_in_project: str = Form(...),
    db: Session = Depends(get_db),
):
    current_user = project_admin_guard(request)
    if not current_user:
        return RedirectResponse("/dashboard", status_code=302)

    exists = (
        db.query(ProjectUser)
        .filter(
            ProjectUser.project_id == project_id,
            ProjectUser.user_id == user_id,
        )
        .first()
    )

    if not exists:
        db.add(
            ProjectUser(
                project_id=project_id,
                user_id=user_id,
                role_in_project=role_in_project,
            )
        )
        db.commit()

    return RedirectResponse(
        f"/admin/projects/{project_id}/users",
        status_code=302
    )


# --------------------------------------------------
# REMOVE USER FROM PROJECT
# --------------------------------------------------
@router.post("/{project_id}/users/{user_id}/remove")
def remove_user_from_project(
    project_id: int,
    user_id: int,
    request: Request,
    db: Session = Depends(get_db),
):
    current_user = project_admin_guard(request)
    if not current_user:
        return RedirectResponse("/dashboard", status_code=302)

    project_user = (
        db.query(ProjectUser)
        .filter(
            ProjectUser.project_id == project_id,
            ProjectUser.user_id == user_id,
        )
        .first()
    )

    if project_user:
        db.delete(project_user)
        db.commit()

    return RedirectResponse(
        f"/admin/projects/{project_id}/users",
        status_code=302
    )
# --------------------------------------------------
# ASSIGN USER TO PROJECT (FROM USER PAGE)
# --------------------------------------------------
@router.post("/assign-user")
def assign_user_to_project(
    request: Request,
    user_id: int = Form(...),
    project_id: int = Form(...),
    role_in_project: str = Form(...),
    db: Session = Depends(get_db),
):
    current_user = project_admin_guard(request)
    if not current_user:
        return RedirectResponse("/dashboard", status_code=302)

    exists = (
        db.query(ProjectUser)
        .filter(
            ProjectUser.user_id == user_id,
            ProjectUser.project_id == project_id
        )
        .first()
    )

    if not exists:
        db.add(
            ProjectUser(
                user_id=user_id,
                project_id=project_id,
                role_in_project=role_in_project
            )
        )
        db.commit()

    return RedirectResponse(
        f"/admin/users/{user_id}/edit",
        status_code=302
    )


----------------------------------------
FILE: .\app\routes\reports.py
----------------------------------------
from fastapi import APIRouter, Request, Depends, Form
from fastapi.responses import HTMLResponse, RedirectResponse, StreamingResponse
from fastapi.templating import Jinja2Templates
from sqlalchemy.orm import Session
from datetime import datetime
import csv, io

from app.db.session import SessionLocal
from app.models.report import Report
from app.utils.flash import flash

# âœ… ACTIVITY LOG SERVICE
from app.services.activity_service import log_activity


# ---------------- ROUTER ----------------
router = APIRouter(tags=["Reports"])
templates = Jinja2Templates(directory="app/templates")


# ---------------- DB ----------------
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


# ---------------- LIST ----------------
@router.get("/", response_class=HTMLResponse)
def reports_page(
    request: Request,
    report_type: str | None = None,
    report_date: str | None = None,
    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    if user is None:
        flash(request, "Please login to continue", "warning")
        return RedirectResponse("/login", status_code=302)

    query = db.query(Report)

    if report_type:
        query = query.filter(Report.report_type == report_type)

    if report_date:
        query = query.filter(
            Report.report_date == datetime.strptime(report_date, "%Y-%m-%d").date()
        )

    reports = query.order_by(Report.report_date.desc()).all()

    return templates.TemplateResponse(
        "reports.html",
        {
            "request": request,
            "user": user,
            "reports": reports,
            "selected_type": report_type,
            "selected_date": report_date,
        },
    )


# ---------------- ADD ----------------
@router.get("/new", response_class=HTMLResponse)
def add_report_page(request: Request):
    user = request.session.get("user")
    if user is None:
        flash(request, "Please login to add a report", "warning")
        return RedirectResponse("/login", status_code=302)

    return templates.TemplateResponse(
        "add_report.html",
        {"request": request, "user": user},
    )


@router.post("/new")
def create_report(
    request: Request,
    report_type: str = Form(...),
    description: str = Form(...),
    report_date: str = Form(...),
    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    if user is None:
        flash(request, "Session expired. Please login again.", "warning")
        return RedirectResponse("/login", status_code=302)

    db.add(
        Report(
            report_type=report_type,
            description=description,
            report_date=datetime.strptime(report_date, "%Y-%m-%d").date(),
        )
    )
    db.commit()

    # âœ… LOG CREATE
    log_activity(
        db,
        user,
        action="CREATE_REPORT",
        details=f"Created report: {report_type}",
    )

    flash(request, "Report added successfully", "success")
    return RedirectResponse("/reports", status_code=303)


# ---------------- EDIT ----------------
@router.get("/edit/{report_id}", response_class=HTMLResponse)
def edit_report_page(
    report_id: int,
    request: Request,
    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    if user is None:
        flash(request, "Please login to edit reports", "warning")
        return RedirectResponse("/login", status_code=302)

    report = db.query(Report).filter(Report.id == report_id).first()
    if report is None:
        flash(request, "Report not found", "error")
        return RedirectResponse("/reports", status_code=302)

    return templates.TemplateResponse(
        "edit_report.html",
        {"request": request, "user": user, "report": report},
    )


@router.post("/edit/{report_id}")
def update_report(
    report_id: int,
    request: Request,
    report_type: str = Form(...),
    description: str = Form(...),
    report_date: str = Form(...),
    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    if user is None:
        flash(request, "Session expired. Please login again.", "warning")
        return RedirectResponse("/login", status_code=302)

    report = db.query(Report).filter(Report.id == report_id).first()
    if report:
        report.report_type = report_type
        report.description = description
        report.report_date = datetime.strptime(report_date, "%Y-%m-%d").date()
        db.commit()

        # âœ… LOG UPDATE
        log_activity(
            db,
            user,
            action="UPDATE_REPORT",
            details=f"Updated report ID {report_id}",
        )

        flash(request, "Report updated successfully", "success")
    else:
        flash(request, "Report not found", "error")

    return RedirectResponse("/reports", status_code=303)


# ---------------- DELETE (CONFIRM PAGE) ----------------
@router.get("/delete/{report_id}", response_class=HTMLResponse)
def confirm_delete_report(
    report_id: int,
    request: Request,
    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    if user is None:
        flash(request, "Please login to delete reports", "warning")
        return RedirectResponse("/login", status_code=302)

    report = db.query(Report).filter(Report.id == report_id).first()
    if report is None:
        flash(request, "Report not found", "error")
        return RedirectResponse("/reports", status_code=302)

    return templates.TemplateResponse(
        "delete_confirm.html",
        {
            "request": request,
            "user": user,
            "report": report,
        },
    )


@router.post("/delete/{report_id}")
def delete_report_confirmed(
    report_id: int,
    request: Request,
    db: Session = Depends(get_db),
):
    user = request.session.get("user")
    if user is None:
        flash(request, "Session expired. Please login again.", "warning")
        return RedirectResponse("/login", status_code=302)

    report = db.query(Report).filter(Report.id == report_id).first()
    if report:
        db.delete(report)
        db.commit()

        # âœ… LOG DELETE
        log_activity(
            db,
            user,
            action="DELETE_REPORT",
            details=f"Deleted report ID {report_id}",
        )

        flash(request, "Report deleted successfully", "success")
    else:
        flash(request, "Report not found", "error")

    return RedirectResponse("/reports", status_code=303)


# ---------------- EXPORT ----------------
@router.get("/export")
def export_excel(db: Session = Depends(get_db)):
    output = io.StringIO()
    writer = csv.writer(output)
    writer.writerow(["Date", "Type", "Description"])

    for r in db.query(Report).order_by(Report.report_date.desc()).all():
        writer.writerow([r.report_date, r.report_type, r.description])

    output.seek(0)

    return StreamingResponse(
        output,
        media_type="text/csv",
        headers={"Content-Disposition": "attachment; filename=reports.csv"},
    )


----------------------------------------
FILE: .\app\routes\schedule.py
----------------------------------------
from datetime import date
from fastapi import APIRouter, Depends, HTTPException, Request
from pydantic import BaseModel
from sqlalchemy.orm import Session

from app.db.session import get_db
from app.services import schedule_service


router = APIRouter(
    prefix="/schedule",
    tags=["Schedule"]
)

# ============================================================
# REQUEST SCHEMAS (ROUTE LAYER ONLY)
# ============================================================

class SchedulePlanCreate(BaseModel):
    project_id: int
    activity_id: int
    planned_start: date
    planned_end: date


# ============================================================
# ROUTES
# ============================================================

@router.post("/plan")
def set_planned_schedule(
    payload: SchedulePlanCreate,
    db: Session = Depends(get_db)
):
    """
    Create / update planned schedule baseline
    """
    try:
        return schedule_service.set_planned_schedule(
            db=db,
            project_id=payload.project_id,
            activity_id=payload.activity_id,
            planned_start=payload.planned_start,
            planned_end=payload.planned_end
        )
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))


# ============================================================
# ðŸ”’ MANUAL PROGRESS UPDATE â€” DISABLED (INTENTIONAL)
# ============================================================

@router.put("/progress")
def update_activity_progress():
    """
    âŒ MANUAL PROGRESS UPDATE DISABLED

    Progress is now **quantity-driven only**
    via `/daily-entry`.

    This endpoint is intentionally blocked
    to prevent fake or manual progress.
    """
    raise HTTPException(
        status_code=403,
        detail="Manual progress updates are disabled. Use daily execution entries."
    )


# ============================================================
# FETCH PROJECT SCHEDULE
# ============================================================

@router.get("/project/{project_id}")
def get_project_schedule(
    project_id: int,
    db: Session = Depends(get_db)
):
    """
    Read-only schedule + delay analytics
    """
    return schedule_service.get_project_schedule(
        db=db,
        project_id=project_id
    )


----------------------------------------
FILE: .\app\routes\settings.py
----------------------------------------
from fastapi import APIRouter, Request
from fastapi.responses import HTMLResponse
from fastapi.templating import Jinja2Templates

router = APIRouter()

templates = Jinja2Templates(directory="app/templates")

@router.get("/settings", response_class=HTMLResponse)
async def settings(request: Request):
    return templates.TemplateResponse(
        "settings.html",
        {"request": request, "title": "Settings"}
    )


----------------------------------------
FILE: .\app\routes\site_operations.py
----------------------------------------
from fastapi import APIRouter, Request
from fastapi.responses import HTMLResponse
from fastapi.templating import Jinja2Templates

router = APIRouter()

templates = Jinja2Templates(directory="app/templates")

@router.get("/site-operations", response_class=HTMLResponse)
async def site_operations(request: Request):
    return templates.TemplateResponse(
        "site_operations.html",
        {"request": request, "title": "Site Operations"}
    )


----------------------------------------
FILE: .\app\routes\users.py
----------------------------------------
from fastapi import APIRouter, Request, Depends
from fastapi.responses import HTMLResponse, RedirectResponse
from fastapi.templating import Jinja2Templates
from sqlalchemy.orm import Session

from app.db.session import SessionLocal
from app.models.user import User

router = APIRouter()
templates = Jinja2Templates(directory="app/templates")


def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


@router.get("/", response_class=HTMLResponse)
def users_page(request: Request, db: Session = Depends(get_db)):
    session_user = request.session.get("user")

    if session_user is None:
        return RedirectResponse("/login", status_code=302)

    if session_user.get("role") != "admin":
        return RedirectResponse("/reports", status_code=302)

    users = db.query(User).order_by(User.username).all()

    return templates.TemplateResponse(
        "users.html",
        {
            "request": request,
            "user": session_user,
            "users": users,
        },
    )


----------------------------------------
FILE: .\app\routes\__init__.py
----------------------------------------

----------------------------------------
FILE: .\app\schemas\auth_schema.py
----------------------------------------

----------------------------------------
FILE: .\app\schemas\inventory_schema.py
----------------------------------------

----------------------------------------
FILE: .\app\schemas\labour_schema.py
----------------------------------------

----------------------------------------
FILE: .\app\schemas\project_schema.py
----------------------------------------

----------------------------------------
FILE: .\app\schemas\report_schema.py
----------------------------------------

----------------------------------------
FILE: .\app\schemas\schedule_schema.py
----------------------------------------

----------------------------------------
FILE: .\app\services\activity_dashboard_service.py
----------------------------------------

----------------------------------------
FILE: .\app\services\activity_service.py
----------------------------------------
from sqlalchemy.orm import Session

from app.models.activity_log import ActivityLog


def log_activity(
    db: Session,
    user: dict,
    action: str,
    details: str | None = None,
):
    log = ActivityLog(
        user_id=user.get("id"),
        username=user.get("username"),
        action=action,
        details=details,
    )

    db.add(log)
    db.commit()


def get_recent_activities(db: Session, limit: int = 50):
    return (
        db.query(ActivityLog)
        .order_by(ActivityLog.timestamp.desc())
        .limit(limit)
        .all()
    )


----------------------------------------
FILE: .\app\services\ai_service.py
----------------------------------------

----------------------------------------
FILE: .\app\services\calendar_service.py
----------------------------------------
from typing import List
from datetime import date

def get_holidays(year: int) -> List[date]:
    return []


----------------------------------------
FILE: .\app\services\costing_service.py
----------------------------------------

----------------------------------------
FILE: .\app\services\inventory_service.py
----------------------------------------
# app/services/inventory_service.py
# --------------------------------------------------
# Inventory Service Logic
# InfraCore
# --------------------------------------------------

from sqlalchemy.orm import Session
from sqlalchemy import func
from fastapi import HTTPException

from app.models.material_stock import MaterialStock
from app.models.material_usage import MaterialUsage
from app.models.material_usage_daily import MaterialUsageDaily
from app.models.material import Material


# ==================================================
# INVENTORY SUMMARY (READ-ONLY)
# ==================================================
def get_inventory_summary(db: Session, project_id: int):
    """
    Inventory summary per material for a project
    """

    materials = db.query(Material).all()
    result = []

    for material in materials:

        # Available stock
        stock = (
            db.query(MaterialStock.quantity_available)
            .filter(
                MaterialStock.project_id == project_id,
                MaterialStock.material_id == material.id,
                MaterialStock.is_active == True
            )
            .scalar()
        ) or 0

        # Planned requirement
        planned = (
            db.query(func.sum(MaterialUsage.quantity))
            .filter(
                MaterialUsage.project_id == project_id,
                MaterialUsage.material_id == material.id,
                MaterialUsage.is_planned == True
            )
            .scalar()
        ) or 0

        # Used till date (actual)
        used = (
            db.query(func.sum(MaterialUsageDaily.quantity_used))
            .filter(
                MaterialUsageDaily.project_id == project_id,
                MaterialUsageDaily.material_id == material.id
            )
            .scalar()
        ) or 0

        remaining = max(planned - used, 0)

        if stock >= remaining:
            status = "OK"
        elif stock > 0:
            status = "WARNING"
        else:
            status = "CRITICAL"

        result.append({
            "material_id": material.id,
            "material": material.name,
            "unit": material.unit,
            "available_stock": stock,
            "planned_required": planned,
            "used_till_date": used,
            "remaining_required": remaining,
            "status": status
        })

    return result


# ==================================================
# INVENTORY DEDUCTION (WRITE LOGIC)
# ==================================================
def deduct_inventory(
    db: Session,
    project_id: int,
    material_id: int,
    quantity_used: float
):
    """
    Deduct material from inventory when daily usage is recorded
    """

    if quantity_used <= 0:
        raise HTTPException(
            status_code=400,
            detail="Quantity used must be greater than zero"
        )

    stock = (
        db.query(MaterialStock)
        .filter(
            MaterialStock.project_id == project_id,
            MaterialStock.material_id == material_id,
            MaterialStock.is_active == True
        )
        .first()
    )

    if not stock:
        raise HTTPException(
            status_code=404,
            detail="Material stock not found for this project"
        )

    if stock.quantity_available < quantity_used:
        raise HTTPException(
            status_code=400,
            detail=f"Insufficient stock. Available: {stock.quantity_available}"
        )

    # Deduct stock
    stock.quantity_available -= quantity_used
    db.add(stock)

    return stock.quantity_available


----------------------------------------
FILE: .\app\services\labour_service.py
----------------------------------------
import csv
from pathlib import Path

DATA_FILE = Path("data/raw/labour.csv")


def get_labour():
    if not DATA_FILE.exists():
        return []
    with open(DATA_FILE, newline="", encoding="utf-8") as f:
        return list(csv.DictReader(f))


----------------------------------------
FILE: .\app\services\machinery_service.py
----------------------------------------
import csv
from pathlib import Path

DATA_FILE = Path("data/raw/machinery.csv")


def get_machinery():
    if not DATA_FILE.exists():
        return []
    with open(DATA_FILE, newline="", encoding="utf-8") as f:
        return list(csv.DictReader(f))


----------------------------------------
FILE: .\app\services\material_calculator.py
----------------------------------------
# app/services/material_calculator.py
# --------------------------------------------------
# Auto Material Requirement Calculator (FINAL)
# InfraCore - Construction Planning Logic
# --------------------------------------------------

from sqlalchemy.orm import Session
from sqlalchemy import func

from app.models.project import Project
from app.models.project_activity import ProjectActivity
from app.models.activity_material import ActivityMaterial
from app.models.material import Material
from app.models.material_usage import MaterialUsage


class MaterialRequirementCalculator:
    """
    Calculates planned material requirement for a project
    based on:
    - Project Activities
    - Activity-Material consumption rates
    - Planned quantities
    """

    def __init__(self, db: Session):
        self.db = db

    def calculate_for_project(self, project_id: int) -> dict:
        """
        Main entry point.
        Returns material-wise total required quantity
        and stores results in DB.
        """

        # ------------------------------
        # 1. Validate Project
        # ------------------------------
        project = self.db.query(Project).filter(Project.id == project_id).first()
        if not project:
            raise ValueError("Project not found")

        # ------------------------------
        # 2. Fetch Project Activities
        # ------------------------------
        project_activities = (
            self.db.query(ProjectActivity)
            .filter(ProjectActivity.project_id == project_id)
            .all()
        )

        if not project_activities:
            return {}

        # ------------------------------
        # 3. Clear old planned data
        # ------------------------------
        self.db.query(MaterialUsage).filter(
            MaterialUsage.project_id == project_id,
            MaterialUsage.is_planned == True
        ).delete()

        # ------------------------------
        # 4. Calculation Container
        # ------------------------------
        material_totals = {}

        # ------------------------------
        # 5. Core Calculation Loop
        # ------------------------------
        for pa in project_activities:
            planned_qty = pa.planned_quantity

            if planned_qty is None or planned_qty <= 0:
                continue

            activity_materials = (
                self.db.query(ActivityMaterial)
                .filter(ActivityMaterial.activity_id == pa.activity_id)
                .all()
            )

            for am in activity_materials:
                if am.consumption_rate is None or am.consumption_rate <= 0:
                    continue

                required_qty = planned_qty * am.consumption_rate

                material_totals[am.material_id] = (
                    material_totals.get(am.material_id, 0) + required_qty
                )

        # ------------------------------
        # 6. Persist Planned Usage
        # ------------------------------
        for material_id, qty in material_totals.items():
            usage = MaterialUsage(
                project_id=project_id,
                material_id=material_id,
                quantity=qty,
                is_planned=True
            )
            self.db.add(usage)

        self.db.commit()

        # ------------------------------
        # 7. Human-Readable Output
        # ------------------------------
        result = (
            self.db.query(
                Material.name,
                MaterialUsage.quantity
            )
            .join(MaterialUsage, Material.id == MaterialUsage.material_id)
            .filter(
                MaterialUsage.project_id == project_id,
                MaterialUsage.is_planned == True
            )
            .order_by(Material.name)
            .all()
        )

        return {
            row.name: row.quantity for row in result
        }


----------------------------------------
FILE: .\app\services\material_progress_analytics.py
----------------------------------------
from typing import List, Dict
from sqlalchemy.orm import Session
from sqlalchemy import func

from app.models.activity_progress import ActivityProgress
from app.models.material_usage import MaterialUsage
from app.models.material_usage_daily import MaterialUsageDaily
from app.models.material import Material


BUFFER_RATIO = 0.05  # 5% allowable buffer


def get_material_progress_analytics(
    db: Session,
    project_id: int,
    activity_id: int
) -> Dict:
    """
    Compare planned vs actual material usage based on activity progress %
    """

    # ------------------ Get progress ------------------
    progress = (
        db.query(ActivityProgress)
        .filter(
            ActivityProgress.project_id == project_id,
            ActivityProgress.activity_id == activity_id
        )
        .first()
    )

    if not progress:
        raise ValueError("Activity progress not found")

    progress_percent = progress.progress_percent or 0

    # ------------------ Planned materials ------------------
    planned_materials = (
        db.query(
            MaterialUsage.material_id,
            MaterialUsage.quantity.label("planned_total")
        )
        .filter(
            MaterialUsage.project_id == project_id,
            MaterialUsage.activity_id == activity_id
        )
        .all()
    )

    results: List[Dict] = []

    for pm in planned_materials:
        planned_total = float(pm.planned_total or 0)
        planned_till_date = planned_total * (progress_percent / 100.0)

        # ------------------ Actual usage ------------------
        actual_used = (
            db.query(func.coalesce(func.sum(MaterialUsageDaily.quantity), 0))
            .filter(
                MaterialUsageDaily.project_id == project_id,
                MaterialUsageDaily.activity_id == activity_id,
                MaterialUsageDaily.material_id == pm.material_id
            )
            .scalar()
        )

        variance = actual_used - planned_till_date

        # ------------------ Status logic ------------------
        if actual_used <= planned_till_date:
            status = "OK"
        elif actual_used <= planned_till_date * (1 + BUFFER_RATIO):
            status = "WARNING"
        else:
            status = "OVER_CONSUMPTION"

        # Optional: material name for readability
        material = db.query(Material).get(pm.material_id)

        results.append({
            "material_id": pm.material_id,
            "material_name": material.name if material else None,
            "planned_total": round(planned_total, 3),
            "planned_till_date": round(planned_till_date, 3),
            "actual_used": round(actual_used, 3),
            "variance": round(variance, 3),
            "status": status
        })

    return {
        "project_id": project_id,
        "activity_id": activity_id,
        "progress_percent": progress_percent,
        "materials": results
    }


----------------------------------------
FILE: .\app\services\material_service.py
----------------------------------------

----------------------------------------
FILE: .\app\services\notification_service.py
----------------------------------------

----------------------------------------
FILE: .\app\services\progress_service.py
----------------------------------------

----------------------------------------
FILE: .\app\services\project_dashboard_analytics.py
----------------------------------------
from typing import Dict, List
from datetime import date
from sqlalchemy.orm import Session
from sqlalchemy import func

from app.models.activity_progress import ActivityProgress
from app.models.project_activity import ProjectActivity
from app.models.daily_entry import DailyEntry
from app.services.material_progress_analytics import get_material_progress_analytics


def get_project_dashboard_analytics(db: Session, project_id: int) -> Dict:
    """
    Aggregate project-level KPIs (TRUTH-BASED + HYBRID CRITICAL PATH):
    - Activity status counts
    - Quantity-weighted overall progress %
    - Material health summary
    - Risk flags (delays & over-consumption)
    - Critical path (hybrid)
    - Delay heatmap
    """

    today = date.today()

    # ------------------ Fetch planned activities ------------------
    planned_activities: List[ProjectActivity] = (
        db.query(ProjectActivity)
        .filter(ProjectActivity.project_id == project_id)
        .all()
    )

    total_activities = len(planned_activities)

    status_counts = {
        "not_started": 0,
        "in_progress": 0,
        "completed": 0,
        "delayed": 0,
    }

    delayed_activities: List[int] = []
    over_consumption_activities: List[int] = []

    # ðŸ”¥ NEW
    critical_activities: List[int] = []
    delay_heatmap: Dict[int, str] = {}

    # ------------------ Quantity-weighted progress ------------------
    total_planned_qty = sum(pa.planned_quantity for pa in planned_activities)

    total_executed_qty = (
        db.query(func.sum(DailyEntry.quantity_done))
        .filter(DailyEntry.project_id == project_id)
        .scalar()
        or 0.0
    )

    overall_progress_percent = (
        round((total_executed_qty / total_planned_qty) * 100, 2)
        if total_planned_qty > 0 else 0.0
    )

    # ------------------ Activity evaluation ------------------
    for pa in planned_activities:

        ap = (
            db.query(ActivityProgress)
            .filter(
                ActivityProgress.project_id == project_id,
                ActivityProgress.activity_id == pa.activity_id
            )
            .first()
        )

        # ---------- Status counters ----------
        if not ap or ap.progress_percent == 0:
            status_counts["not_started"] += 1
            delay_heatmap[pa.activity_id] = "ON_TRACK"
            continue

        if ap.status == "IN_PROGRESS":
            status_counts["in_progress"] += 1
        elif ap.status == "COMPLETED":
            status_counts["completed"] += 1
        elif ap.status == "DELAYED":
            status_counts["delayed"] += 1
            delayed_activities.append(pa.activity_id)

        # ---------- Delay heatmap ----------
        if ap.status == "DELAYED":
            delay_heatmap[pa.activity_id] = "DELAYED"
        elif today >= ap.planned_end:
            delay_heatmap[pa.activity_id] = "AT_RISK"
        else:
            delay_heatmap[pa.activity_id] = "ON_TRACK"

        # ---------- Hybrid critical path ----------
        qty_weight = (
            pa.planned_quantity / total_planned_qty
            if total_planned_qty > 0 else 0
        )

        if (
            ap.status == "DELAYED"
            or (
                ap.progress_percent < 60
                and qty_weight >= 0.15
            )
        ):
            critical_activities.append(pa.activity_id)

    # ------------------ Material health summary ------------------
    material_health = {
        "ok": 0,
        "warning": 0,
        "over_consumption": 0,
    }

    for pa in planned_activities:
        try:
            analytics = get_material_progress_analytics(
                db=db,
                project_id=project_id,
                activity_id=pa.activity_id
            )

            for m in analytics.get("materials", []):
                status = m.get("status")
                if status == "OK":
                    material_health["ok"] += 1
                elif status == "WARNING":
                    material_health["warning"] += 1
                elif status == "OVER_CONSUMPTION":
                    material_health["over_consumption"] += 1
                    over_consumption_activities.append(pa.activity_id)

        except ValueError:
            continue

    # ------------------ FINAL RESPONSE ------------------
    return {
        "project_id": project_id,

        # âœ… EXISTING (UNCHANGED)
        "activities": {
            "total": total_activities,
            **status_counts
        },

        "overall_progress_percent": overall_progress_percent,

        "material_health": material_health,

        "risk_flags": {
            "delayed_activities": list(set(delayed_activities)),
            "over_consumption_activities": list(set(over_consumption_activities)),
        },

        # ðŸ”¥ NEW (SAFE ADDITIONS)
        "critical_path": {
            "critical_activities": list(set(critical_activities)),
            "count": len(set(critical_activities)),
        },

        "delay_heatmap": delay_heatmap,
    }


----------------------------------------
FILE: .\app\services\project_service.py
----------------------------------------
from typing import List, Dict

def get_projects() -> List[Dict]:
    """
    Return list of projects
    """
    return []

def add_project(project: Dict) -> bool:
    """
    Add a new project
    """
    return True


----------------------------------------
FILE: .\app\services\report_service.py
----------------------------------------
from sqlalchemy.orm import Session
from sqlalchemy import func
from datetime import date

from app.models.report import Report
from app.db.session import SessionLocal


# ================= REPORT CRUD =================

def get_all_reports(db: Session):
    return (
        db.query(Report)
        .order_by(Report.report_date.desc().nullslast())
        .all()
    )


def get_report(db: Session, report_id: int):
    return db.query(Report).filter(Report.id == report_id).first()


def create_report(
    db: Session,
    report_type: str,
    description: str,
    report_date,
):
    report = Report(
        report_type=report_type,
        description=description,
        report_date=report_date,
    )

    try:
        db.add(report)
        db.commit()
        db.refresh(report)
        return report
    except Exception:
        db.rollback()
        raise


def update_report(
    db: Session,
    report_id: int,
    report_type: str,
    description: str,
    report_date,
):
    report = get_report(db, report_id)
    if not report:
        return None

    report.report_type = report_type
    report.description = description
    report.report_date = report_date

    try:
        db.commit()
        db.refresh(report)
        return report
    except Exception:
        db.rollback()
        raise


def delete_report(db: Session, report_id: int):
    report = get_report(db, report_id)
    if not report:
        return None

    try:
        db.delete(report)
        db.commit()
        return True
    except Exception:
        db.rollback()
        raise


# ================= DASHBOARD SUMMARY =================
def get_summary(project_id: int | None = None):
    """
    Dashboard summary.
    NOTE:
    - Reports are GLOBAL right now
    - project_id is ignored (kept for future upgrade)
    """

    db = SessionLocal()
    try:
        base_query = db.query(Report)

        # âŒ DO NOT FILTER BY project_id (column does not exist)

        total_reports = (
            base_query.with_entities(func.count(Report.id)).scalar() or 0
        )

        reports_today = (
            base_query
            .filter(Report.report_date == date.today())
            .with_entities(func.count(Report.id))
            .scalar()
            or 0
        )

        reports_by_type = (
            base_query
            .with_entities(
                Report.report_type.label("type"),
                func.count(Report.id).label("count")
            )
            .group_by(Report.report_type)
            .all()
        )

        recent_reports = (
            base_query
            .order_by(Report.report_date.desc())
            .limit(5)
            .all()
        )

        return {
            "total_reports": total_reports,
            "reports_today": reports_today,
            "reports_by_type": reports_by_type,
            "recent_reports": recent_reports,
        }

    finally:
        db.close()


----------------------------------------
FILE: .\app\services\schedule_service.py
----------------------------------------
from datetime import date
from typing import List, Dict
from sqlalchemy.orm import Session

from app.models.activity_progress import ActivityProgress


# ============================================================
# Schedule & Progress Service
# ============================================================

def set_planned_schedule(
    db: Session,
    project_id: int,
    activity_id: int,
    planned_start: date,
    planned_end: date
) -> ActivityProgress:
    """
    Create or update planned schedule for a project activity
    """

    if planned_end < planned_start:
        raise ValueError("Planned end date cannot be before planned start date")

    record = (
        db.query(ActivityProgress)
        .filter(
            ActivityProgress.project_id == project_id,
            ActivityProgress.activity_id == activity_id
        )
        .first()
    )

    if record:
        record.planned_start = planned_start
        record.planned_end = planned_end
    else:
        record = ActivityProgress(
            project_id=project_id,
            activity_id=activity_id,
            planned_start=planned_start,
            planned_end=planned_end,
            progress_percent=0,
            status="NOT_STARTED"
        )
        db.add(record)

    db.commit()
    db.refresh(record)
    return record


# ------------------------------------------------------------

def update_progress(
    db: Session,
    project_id: int,
    activity_id: int,
    progress_percent: int
) -> ActivityProgress:
    """
    Update progress percentage for a project activity
    """

    if progress_percent < 0 or progress_percent > 100:
        raise ValueError("Progress percent must be between 0 and 100")

    record = (
        db.query(ActivityProgress)
        .filter(
            ActivityProgress.project_id == project_id,
            ActivityProgress.activity_id == activity_id
        )
        .first()
    )

    if not record:
        raise ValueError("Planned schedule not found for this activity")

    today = date.today()
    record.progress_percent = progress_percent

    # Auto actual start
    if progress_percent > 0 and record.actual_start is None:
        record.actual_start = today

    # Auto actual end
    if progress_percent == 100:
        record.actual_end = today
        record.status = "COMPLETED"
    else:
        record.status = _calculate_status(record, today)

    db.commit()
    db.refresh(record)
    return record


# ------------------------------------------------------------

def get_project_schedule(
    db: Session,
    project_id: int
) -> List[Dict]:
    """
    Get full schedule & delay analytics for a project
    """

    today = date.today()

    records = (
        db.query(ActivityProgress)
        .filter(ActivityProgress.project_id == project_id)
        .all()
    )

    response: List[Dict] = []

    for r in records:
        planned_duration = (r.planned_end - r.planned_start).days

        if r.actual_start:
            actual_end = r.actual_end or today
            actual_duration = (actual_end - r.actual_start).days
        else:
            actual_duration = 0

        delay_days = actual_duration - planned_duration if r.actual_start else 0
        status = _calculate_status(r, today)

        response.append({
            "project_id": r.project_id,
            "activity_id": r.activity_id,
            "planned_start": r.planned_start,
            "planned_end": r.planned_end,
            "actual_start": r.actual_start,
            "actual_end": r.actual_end,
            "progress_percent": r.progress_percent,
            "planned_duration_days": planned_duration,
            "actual_duration_days": actual_duration,
            "delay_days": delay_days,
            "status": status
        })

    return response


# ============================================================
# INTERNAL UTIL
# ============================================================

def _calculate_status(record: ActivityProgress, today: date) -> str:
    """
    Derive status based on dates & progress
    """

    if record.progress_percent == 0:
        return "NOT_STARTED"

    if record.progress_percent == 100:
        if record.actual_end and record.actual_end > record.planned_end:
            return "DELAYED"
        return "COMPLETED"

    if today > record.planned_end:
        return "DELAYED"

    return "IN_PROGRESS"


----------------------------------------
FILE: .\app\services\user_service.py
----------------------------------------
from sqlalchemy.orm import Session

from app.models.user import User
from app.core.security import verify_password


def authenticate_user(db: Session, username: str, password: str) -> User | None:
    """
    Authenticate user by username and password.
    Returns User if valid, otherwise None.
    """

    if not username or not password:
        return None

    # Normalize username (optional but recommended)
    username = username.strip()

    user = db.query(User).filter(User.username == username).first()

    if not user:
        return None

    # IMPORTANT: this field name MUST match your User model
    if not verify_password(password, user.password_hash):
        return None

    return user


----------------------------------------
FILE: .\app\static\css\base.css
----------------------------------------
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f3f4f6;
}

.layout {
    display: flex;
    height: 100vh;
}

.sidebar {
    width: 220px;
    background: #111827;
    color: white;
    padding: 20px;
}

.sidebar h2 {
    margin-bottom: 30px;
}

.sidebar a {
    display: block;
    color: #d1d5db;
    text-decoration: none;
    margin-bottom: 15px;
}

.sidebar a:hover {
    color: white;
}

.content {
    flex: 1;
    padding: 30px;
    background: #ffffff;
}


----------------------------------------
FILE: .\app\static\css\dashboard.css
----------------------------------------
.cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.card {
    background: #f9fafb;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.value {
    font-size: 28px;
    font-weight: bold;
}

.alert {
    color: #dc2626;
}


----------------------------------------
FILE: .\app\static\css\layout.css
----------------------------------------
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f4f6f8;
}

.app-container {
    display: flex;
    height: 100vh;
}

/* SIDEBAR */
.sidebar {
    width: 220px;
    background: #111827;
    color: #fff;
    padding: 20px;
}

.sidebar .logo {
    font-size: 22px;
    font-weight: bold;
    margin-bottom: 30px;
}

.sidebar nav a {
    display: block;
    color: #d1d5db;
    text-decoration: none;
    margin-bottom: 15px;
}

.sidebar nav a:hover {
    color: #fff;
}

/* MAIN */
.main {
    flex: 1;
    background: #fff;
}

.topbar {
    background: #f9fafb;
    padding: 15px 20px;
    border-bottom: 1px solid #e5e7eb;
}

.page-title {
    font-size: 18px;
    font-weight: bold;
}

.content {
    padding: 20px;
}

/* DASHBOARD */
.subtitle {
    color: #6b7280;
    margin-bottom: 20px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: #f9fafb;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.stat-number {
    font-size: 28px;
    font-weight: bold;
    margin-top: 10px;
}

.quick-actions {
    margin-bottom: 30px;
}

.btn-primary,
.btn-secondary {
    display: inline-block;
    padding: 10px 15px;
    border-radius: 6px;
    text-decoration: none;
    margin-right: 10px;
}

.btn-primary {
    background: #2563eb;
    color: #fff;
}

.btn-secondary {
    background: #e5e7eb;
    color: #111;
}

.recent-reports ul {
    list-style: none;
    padding: 0;
}

.recent-reports li {
    background: #f9fafb;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 10px;
}

.muted {
    color: #6b7280;
    font-size: 14px;
}
/* ================= AUTH / LOGIN ================= */

.auth-body {
    background: linear-gradient(135deg, #1f2933, #111827);
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

.login-container {
    width: 100%;
    max-width: 400px;
    padding: 20px;
}

.login-card {
    background: #ffffff;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    text-align: center;
}

.login-title {
    font-size: 28px;
    margin-bottom: 5px;
    color: #111827;
}

.login-subtitle {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 25px;
}

.login-form {
    text-align: left;
}

.login-form label {
    display: block;
    font-size: 14px;
    margin-bottom: 5px;
    color: #374151;
}

.login-form input {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    font-size: 14px;
}

.login-form input:focus {
    outline: none;
    border-color: #2563eb;
}

.btn-login {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 8px;
    background: #2563eb;
    color: #fff;
    font-size: 16px;
    cursor: pointer;
}

.btn-login:hover {
    background: #1e40af;
}

.error-message {
    background: #fee2e2;
    color: #991b1b;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 15px;
    font-size: 14px;
}

.login-footer {
    margin-top: 20px;
    font-size: 12px;
    color: #9ca3af;
}
/* ================= TOPBAR ================= */

.topbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: #111827;
    color: #fff;
}

.page-title {
    font-size: 18px;
    font-weight: 600;
}

.topbar-actions {
    display: flex;
    align-items: center;
    gap: 15px;
}

.username {
    font-size: 14px;
    color: #d1d5db;
}

.btn-logout {
    padding: 8px 14px;
    background: #ef4444;
    color: #fff;
    border-radius: 6px;
    font-size: 14px;
    text-decoration: none;
}

.btn-logout:hover {
    background: #b91c1c;
}


----------------------------------------
FILE: .\app\static\css\reports.css
----------------------------------------
.report-form {
    max-width: 400px;
    margin-bottom: 30px;
}

.report-form input,
.report-form textarea,
.report-form button {
    width: 100%;
    padding: 8px;
    margin-bottom: 10px;
}

.report-form button {
    background: #007bff;
    color: white;
    border: none;
}

.reports-container {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}

.report-card {
    border: 1px solid #ccc;
    padding: 15px;
    width: 250px;
    border-radius: 5px;
}


----------------------------------------
FILE: .\app\static\css\style.css
----------------------------------------
/* =========================
   BASE
   ========================= */

body {
    font-family: Arial, Helvetica, sans-serif;
    margin: 0;
    background-color: var(--bg);
    color: var(--text);
}

.container {
    padding: 20px;
}

/* =========================
   FILTER BAR
   ========================= */

.filter-bar {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 15px;
}

/* =========================
   FORMS
   ========================= */

input, select, textarea {
    padding: 6px;
    border-radius: 4px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
}

/* =========================
   TABLE
   ========================= */

table {
    width: 100%;
    border-collapse: collapse;
    background: var(--card);
}

th {
    background: rgba(0,0,0,0.05);
    text-align: left;
}

th, td {
    padding: 10px;
    border-bottom: 1px solid var(--border);
}

/* =========================
   BUTTONS
   ========================= */

button,
.button {
    padding: 6px 12px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    background: var(--btn);
    color: white;
    text-decoration: none;
}

.button.secondary {
    background: #6b7280;
}

.button.danger {
    background: #dc2626;
}

/* =========================
   THEME VARIABLES
   ========================= */

:root {
    --bg: #f5f7fa;
    --bg-secondary: #ffffff;
    --bg-primary: #f5f7fa;

    --text: #111827;
    --text-muted: #6b7280;

    --card: #ffffff;
    --nav: #1f2937;

    --border: #e5e7eb;
    --border-color: #e5e7eb;

    --btn: #2563eb;
    --hover-bg: rgba(37, 99, 235, 0.1);
    --accent-color: #2563eb;
}

.dark {
    --bg: #0f172a;
    --bg-secondary: #020617;
    --bg-primary: #020617;

    --text: #e5e7eb;
    --text-muted: #94a3b8;

    --card: #020617;
    --nav: #020617;

    --border: #334155;
    --border-color: #334155;

    --btn: #3b82f6;
    --hover-bg: rgba(59, 130, 246, 0.2);
    --accent-color: #3b82f6;
}

/* =========================
   THEME BUTTON
   ========================= */

.theme-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 16px;
    color: var(--text);
}

/* =========================
   THEME TRANSITION
   ========================= */

html, body, table, th, td, input, select, textarea, button, .button {
    transition:
        background-color 0.3s ease,
        color 0.3s ease,
        border-color 0.3s ease;
}

/* ================= FLASH MESSAGES ================= */

.flash-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.flash {
    padding: 12px 16px;
    border-radius: 6px;
    font-size: 14px;
    min-width: 260px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: slideIn 0.3s ease, fadeOut 0.5s ease 3.5s forwards;
}

.flash-success { background: #2e7d32; color: #fff; }
.flash-error   { background: #c62828; color: #fff; }
.flash-warning { background: #ed6c02; color: #fff; }
.flash-info    { background: #1565c0; color: #fff; }

@keyframes slideIn {
    from { opacity: 0; transform: translateX(20px); }
    to   { opacity: 1; transform: translateX(0); }
}

@keyframes fadeOut {
    to { opacity: 0; transform: translateX(20px); }
}

/* ================= LAYOUT ================= */

.layout {
    display: flex;
    min-height: 100vh;
}

.sidebar {
    width: 240px;
    background: var(--bg-secondary);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
}

.sidebar-header {
    padding: 16px;
    font-size: 18px;
    font-weight: bold;
    border-bottom: 1px solid var(--border-color);
}

.sidebar-user {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
    font-size: 14px;
}

.sidebar-user .role {
    display: block;
    font-size: 12px;
    color: var(--text-muted);
}

.sidebar-nav {
    flex: 1;
    padding: 8px;
}

.sidebar-nav a {
    display: block;
    padding: 10px 12px;
    margin-bottom: 4px;
    border-radius: 6px;
    color: var(--text);
    text-decoration: none;
}

.sidebar-nav a:hover {
    background: var(--hover-bg);
}

.sidebar-nav a.active {
    background: var(--accent-color);
    color: #ffffff;
    font-weight: 600;
}

.sidebar-nav a.danger {
    color: #c62828;
}

.sidebar-footer {
    padding: 12px;
    border-top: 1px solid var(--border-color);
}

.main {
    flex: 1;
    background: var(--bg-primary);
}

/* ================= RESPONSIVE ================= */

@media (max-width: 768px) {
    .sidebar {
        display: none;
    }
}
/* ================= DASHBOARD UI ================= */

.page-title {
    margin-bottom: 20px;
    font-size: 26px;
    font-weight: 600;
}

.section-title {
    margin: 30px 0 12px;
    font-size: 18px;
    font-weight: 600;
}

/* KPI Cards */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.kpi-card {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px;
    border-radius: 12px;
    text-decoration: none;
    color: #ffffff;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.kpi-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.kpi-icon {
    font-size: 32px;
}

.kpi-content {
    display: flex;
    flex-direction: column;
}

.kpi-value {
    font-size: 28px;
    font-weight: 700;
}

.kpi-label {
    font-size: 14px;
    opacity: 0.9;
}

/* KPI Colors */
.kpi-primary {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
}

.kpi-success {
    background: linear-gradient(135deg, #16a34a, #15803d);
}

/* Dashboard Card Wrapper */
.card {
    background: var(--card);
    border-radius: 10px;
    padding: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}
/* ================= PROJECT PROGRESS BAR ================= */
.progress-bar-container {
    width: 100%;
    background: #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
    height: 26px;
    margin-top: 10px;
}

.progress-bar {
    height: 100%;
    width: 0%;
    background: #2563eb;
    color: white;
    text-align: center;
    line-height: 26px;
    font-weight: 600;
    transition: width 0.6s ease;
}

/* KPI COLOR VARIANTS */
.kpi-warning {
    background: #facc15;
    color: #000;
}

.kpi-danger {
    background: #dc2626;
    color: #fff;
}
/* ================= ACTIVITY TABLE ROW COLORS ================= */
tr.status-NOT_STARTED {
    background-color: #f3f4f6;
}

tr.status-IN_PROGRESS {
    background-color: #fef3c7;
}

tr.status-COMPLETED {
    background-color: #dcfce7;
}

tr.status-DELAYED {
    background-color: #fee2e2;
    font-weight: 600;
}

/* Small progress bar inside table */
.table-progress {
    background: #e5e7eb;
    border-radius: 6px;
    height: 18px;
    overflow: hidden;
}

.table-progress-bar {
    height: 100%;
    background: #2563eb;
    color: white;
    font-size: 12px;
    text-align: center;
}
/* ================= MODAL ================= */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 1000;
}

.modal-content {
    background: #fff;
    width: 80%;
    max-width: 900px;
    margin: 5% auto;
    border-radius: 10px;
    padding: 20px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-close {
    font-size: 24px;
    cursor: pointer;
}

.status-OK {
    color: #16a34a;
    font-weight: 600;
}

.status-WARNING {
    color: #ca8a04;
    font-weight: 600;
}

.status-OVER_CONSUMPTION {
    color: #dc2626;
    font-weight: 700;
}
/* ================= MODAL OVERRIDES (DASHBOARD FIX) ================= */

.modal {
    display: none; /* JS will control */
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.65);
}

.modal.show {
    display: flex;
}

.modal-content {
    background: var(--bg-secondary);
    color: var(--text);
    width: 520px;
    max-width: 95%;
    margin: 0;
    border-radius: 12px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.45);
    animation: modalFade 0.25s ease-out;
}

.modal-header {
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
}

.modal-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
}

.modal-close {
    color: var(--text-muted);
}

.modal-close:hover {
    color: #ef4444;
}

.modal-body {
    padding: 18px;
}

.modal-body form {
    display: grid;
    gap: 14px;
}

.modal-body label {
    font-size: 13px;
    color: var(--text-muted);
}

.modal-body input,
.modal-body select {
    width: 100%;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text);
}

@keyframes modalFade {
    from {
        opacity: 0;
        transform: translateY(-12px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 16px;
}

.form-grid label {
    font-size: 13px;
    opacity: 0.9;
}

.form-grid input {
    width: 100%;
}
/* ================= ADD PROJECT FLOAT BUTTON ================= */
.floating-add-project {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: linear-gradient(135deg, #2563eb, #1e40af);
    color: #ffffff;
    padding: 12px 18px;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    z-index: 1000;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.floating-add-project:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.6);
}
.badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
}

.badge-success {
    background: #1f9d55;
    color: #fff;
}

.badge-danger {
    background: #e3342f;
    color: #fff;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}


----------------------------------------
FILE: .\app\static\css\themes.css
----------------------------------------
/* -------- REPORTS UI -------- */

.muted {
    color: #666;
    margin-bottom: 20px;
}

/* REPORTS PAGE */
.reports-page {
    padding: 24px;
}

.reports-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.reports-filters {
    display: flex;
    gap: 10px;
}

/* SEARCH + FILTER */
.search-input,
.reports-filters select {
    padding: 8px 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
}

/* GRID */
.reports-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
}

/* CARD */
.report-card {
    background: #ffffff;
    border-radius: 10px;
    padding: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.report-card-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.report-body p {
    margin: 0;
    font-size: 14px;
    color: #333;
}

/* BADGES */
.badge {
    padding: 4px 10px;
    font-size: 12px;
    border-radius: 12px;
    color: #fff;
}

.badge-labour {
    background: #007bff;
}

.badge-machinery {
    background: #28a745;
}

.badge-material {
    background: #ff9800;
}

.report-date {
    font-size: 12px;
    color: #666;
}

/* ACTIONS */
.report-actions {
    margin-top: 12px;
    display: flex;
    gap: 12px;
}

.btn-edit {
    color: #007bff;
    text-decoration: none;
}

.btn-delete {
    color: #dc3545;
    text-decoration: none;
}

/* EMPTY STATE */
.empty-state {
    text-align: center;
    padding: 60px;
    color: #666;
}

/* ADD REPORT BUTTON */
.add-btn {
    background: #2563eb;
    color: white;
    padding: 8px 14px;
    border-radius: 6px;
    text-decoration: none;
    font-size: 14px;
}

.add-btn:hover {
    background: #1e40af;
}


----------------------------------------
FILE: .\app\static\js\api.js
----------------------------------------
console.log("InfraCore API JS loaded");


----------------------------------------
FILE: .\app\static\js\charts.js
----------------------------------------
console.log("Charts module placeholder");


----------------------------------------
FILE: .\app\static\js\dashboard.js
----------------------------------------
document.addEventListener("DOMContentLoaded", () => {

    /* ================= PROJECT CONTEXT ================= */
    const projectId =
        typeof window.PROJECT_ID !== "undefined" && window.PROJECT_ID !== null
            ? Number(window.PROJECT_ID)
            : null;

    /* ================= DOM REFERENCES ================= */

    const totalActivities = document.getElementById("totalActivities");
    const inProgressActivities = document.getElementById("inProgressActivities");
    const completedActivities = document.getElementById("completedActivities");
    const delayedActivities = document.getElementById("delayedActivities");
    const overallProgressBar = document.getElementById("overallProgressBar");

    const activityTableBody = document.getElementById("activityTableBody");
    const addActivityBtn = document.getElementById("addActivityBtn");

    const progressModal = document.getElementById("progressModal");
    const progressForm = document.getElementById("progressForm");
    const progressActivityId = document.getElementById("progressActivityId");
    const progressPercentInput = document.getElementById("progressPercentInput");

    const planModal = document.getElementById("planModal");
    const planForm = document.getElementById("planForm");
    const planActivitySelect = document.getElementById("planActivitySelect");
    const planStart = document.getElementById("planStart");
    const planEnd = document.getElementById("planEnd");

    const materialUsageModal = document.getElementById("materialUsageModal");
    const materialUsageForm = document.getElementById("materialUsageForm");
    const usageActivityId = document.getElementById("usageActivityId");
    const usageMaterialSelect = document.getElementById("usageMaterialSelect");
    const usageQty = document.getElementById("usageQty");
    const usageDate = document.getElementById("usageDate");

    /* ================= BUTTON BINDINGS ================= */

    if (addActivityBtn) {
        addActivityBtn.addEventListener("click", openPlanModal);
    }

    /* ================= INITIAL LOAD ================= */

    if (!projectId) {
        if (activityTableBody) {
            activityTableBody.innerHTML =
                `<tr><td colspan="8">Create a project to start planning</td></tr>`;
        }
        return;
    }

    loadDashboard();
    loadActivities();

    /* ================= DASHBOARD ================= */

    function loadDashboard() {
        fetch(`/analytics/project-dashboard/${projectId}`)
            .then(r => r.ok ? r.json() : Promise.reject())
            .then(d => {
                totalActivities.innerText = d.activities.total;
                inProgressActivities.innerText = d.activities.in_progress;
                completedActivities.innerText = d.activities.completed;
                delayedActivities.innerText = d.activities.delayed;

                const progress = d.overall_progress_percent || 0;
                overallProgressBar.style.width = progress + "%";
                overallProgressBar.innerText = progress + "%";
            })
            .catch(() => {
                console.warn("Dashboard analytics not available yet");
            });
    }

    /* ================= ACTIVITIES ================= */

    function loadActivities() {
        fetch(`/schedule/project/${projectId}`)
            .then(r => r.ok ? r.json() : [])
            .then(rows => {
                activityTableBody.innerHTML = "";

                if (!rows || rows.length === 0) {
                    activityTableBody.innerHTML =
                        `<tr><td colspan="8">No activities planned</td></tr>`;
                    return;
                }

                rows.forEach(r => {
                    activityTableBody.insertAdjacentHTML("beforeend", `
                        <tr>
                            <td>${r.activity_id}</td>
                            <td>${r.planned_start}</td>
                            <td>${r.planned_end}</td>
                            <td>${r.progress_percent}%</td>
                            <td>${r.status}</td>
                            <td>${r.delay_days}</td>
                            <td>
                                <button onclick="openMaterialUsageModal(${r.activity_id})">
                                    Add Usage
                                </button>
                            </td>
                            <td>
                                <button onclick="openProgressModal(${r.activity_id}, ${r.progress_percent})">
                                    Update
                                </button>
                            </td>
                        </tr>
                    `);
                });
            })
            .catch(() => {
                activityTableBody.innerHTML =
                    `<tr><td colspan="8">Failed to load activities</td></tr>`;
            });
    }

    /* ================= PLAN ACTIVITY ================= */

    window.openPlanModal = function () {
        if (!projectId) return;

        planModal.style.display = "block";
        planActivitySelect.innerHTML = `<option disabled selected>Loading...</option>`;

        fetch("/activities")
            .then(r => r.ok ? r.json() : [])
            .then(list => {
                planActivitySelect.innerHTML = "";
                list.forEach(a => {
                    planActivitySelect.insertAdjacentHTML(
                        "beforeend",
                        `<option value="${a.id}">${a.name}</option>`
                    );
                });
            });
    };

    window.closePlanModal = function () {
        planModal.style.display = "none";
    };

    planForm.addEventListener("submit", e => {
        e.preventDefault();

        fetch("/schedule/plan", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                project_id: projectId,
                activity_id: planActivitySelect.value,
                planned_start: planStart.value,
                planned_end: planEnd.value
            })
        })
        .then(() => {
            closePlanModal();
            loadDashboard();
            loadActivities();
        });
    });

    /* ================= MATERIAL USAGE ================= */

    window.openMaterialUsageModal = function (activityId) {
        materialUsageModal.style.display = "block";
        usageActivityId.value = activityId;
        usageQty.value = "";
        usageDate.valueAsDate = new Date();
        usageMaterialSelect.innerHTML = "";

        fetch("/materials")
            .then(r => r.ok ? r.json() : [])
            .then(list => {
                list.forEach(m => {
                    usageMaterialSelect.insertAdjacentHTML(
                        "beforeend",
                        `<option value="${m.id}">${m.name}</option>`
                    );
                });
            });
    };

    window.closeMaterialUsageModal = function () {
        materialUsageModal.style.display = "none";
    };

    materialUsageForm.addEventListener("submit", e => {
        e.preventDefault();

        fetch("/daily-material-usage", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                project_id: projectId,
                activity_id: usageActivityId.value,
                material_id: usageMaterialSelect.value,
                quantity_used: Number(usageQty.value),
                usage_date: usageDate.value
            })
        })
        .then(() => {
            closeMaterialUsageModal();
            loadDashboard();
        });
    });

    /* ================= PROGRESS ================= */

    window.openProgressModal = function (id, progress) {
        progressActivityId.value = id;
        progressPercentInput.value = progress;
        progressModal.style.display = "block";
    };

    window.closeProgressModal = function () {
        progressModal.style.display = "none";
    };

    progressForm.addEventListener("submit", e => {
        e.preventDefault();

        fetch("/schedule/progress", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                project_id: projectId,
                activity_id: progressActivityId.value,
                progress_percent: Number(progressPercentInput.value)
            })
        })
        .then(() => {
            closeProgressModal();
            loadDashboard();
            loadActivities();
        });
    });

});

/* ================= CREATE PROJECT (SAFE OVERRIDE) ================= */

/* ðŸ”¥ MODAL IS NO LONGER USED â€” REDIRECT INSTEAD */
window.openCreateProjectModal = function () {
    window.location.href = "/projects/new";
};

/* KEEPING THESE FOR SAFETY â€” NO REMOVAL */
const createProjectModal = document.getElementById("createProjectModal");
const createProjectForm = document.getElementById("createProjectForm");

window.closeCreateProjectModal = function () {
    if (createProjectModal) {
        createProjectModal.classList.remove("show");
    }
};

if (createProjectForm) {
    createProjectForm.addEventListener("submit", function (e) {
        e.preventDefault();
        window.location.href = "/projects/new";
    });
}


----------------------------------------
FILE: .\app\static\js\main.js
----------------------------------------
console.log("InfraCore frontend loaded");


----------------------------------------
FILE: .\app\static\js\reports.js
----------------------------------------
function filterReports() {
    const search = document.getElementById("searchInput").value.toLowerCase();
    const type = document.getElementById("typeFilter").value;

    const cards = document.querySelectorAll(".report-card");

    cards.forEach(card => {
        const text = card.dataset.text.toLowerCase();
        const cardType = card.dataset.type;

        const matchesSearch = text.includes(search);
        const matchesType = !type || cardType === type;

        card.style.display = (matchesSearch && matchesType)
            ? "block"
            : "none";
    });
}


----------------------------------------
FILE: .\app\static\js\validations.js
----------------------------------------
function notEmpty(val) {
    return val !== null && val !== "";
}


----------------------------------------
FILE: .\app\templates\activity.html
----------------------------------------
{% extends "base.html" %}

{% block content %}

<h1 class="page-title">Activity Log</h1>

<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>Time</th>
                <th>User</th>
                <th>Action</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td>{{ log.timestamp }}</td>
                <td>{{ log.username }}</td>
                <td>{{ log.action }}</td>
                <td>{{ log.details }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4">No activity recorded</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}


----------------------------------------
FILE: .\app\templates\activity_form.html
----------------------------------------
{% extends "base.html" %}
{% block content %}

<h1 class="page-title">
    Add Activity â€“ {{ project.name }}
</h1>

<div class="card" style="max-width:600px">

<form method="post" action="/projects/{{ project.id }}/activities/create">

    <!-- ACTIVITY NAME -->
    <div class="form-group">
        <label>Activity Name</label>
        <input
            type="text"
            name="name"
            placeholder="Earthwork / WMM / DBM / Custom"
            required
        >
    </div>

    <!-- STANDARD / CUSTOM -->
    <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" name="is_standard">
            Standard Activity
        </label>
        <small style="opacity:0.7">
            Check for standard activities like Earthwork, WMM, DBM
        </small>
    </div>

    <!-- ACTIONS -->
    <div style="margin-top:20px;display:flex;gap:12px">
        <button class="btn-primary" type="submit">
            âž• Create Activity
        </button>

        <a href="/projects/{{ project.id }}/activities" class="btn-secondary">
            Cancel
        </a>
    </div>

</form>

</div>

{% endblock %}


----------------------------------------
FILE: .\app\templates\add_report.html
----------------------------------------
{% extends "base.html" %}

{% block content %}
<h2>Add Report</h2>

<form method="post">
    <label>Type</label>
    <select name="report_type" required>
        <option value="">Select type</option>
        <option value="Labour">Labour</option>
        <option value="Machinery">Machinery</option>
        <option value="Material">Material</option>
    </select>

    <label>Description</label>
    <textarea name="description" rows="4" required></textarea>

    <label>Date</label>
    <input type="date" name="report_date" required>

    <button type="submit" class="button">Save Report</button>
    <a href="/reports" class="button secondary">Cancel</a>
</form>
{% endblock %}


----------------------------------------
FILE: .\app\templates\base.html
----------------------------------------
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>InfraCore</title>

    <!-- Main CSS -->
    <link rel="stylesheet" href="/static/css/style.css">

    <!-- Dark mode script (runs before page paint) -->
    <script>
        (function () {
            const theme = localStorage.getItem("theme");
            if (theme === "dark") {
                document.documentElement.classList.add("dark");
            } else if (!theme && window.matchMedia("(prefers-color-scheme: dark)").matches) {
                document.documentElement.classList.add("dark");
            }
        })();
    </script>
</head>
<body>

<div class="layout">

    <!-- ================= SIDEBAR ================= -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>InfraCore</h2>
        </div>

        {% if user is defined and user is not none %}
        <div class="sidebar-user">
            <strong>{{ user["username"] }}</strong>
            <span class="role">
                {{ user["role"] | upper }}
                {% if project_role %}
                    Â· {{ project_role | upper }}
                {% endif %}
            </span>
        </div>

        <nav class="sidebar-nav">

            <!-- ================= DASHBOARD ================= -->
            <a href="/dashboard"
               class="{% if request.url.path == '/dashboard' %}active{% endif %}">
                ðŸ“Š Dashboard
            </a>

            <!-- ================= PROJECTS ================= -->
            <a href="/projects"
               class="{% if request.url.path.startswith('/projects') %}active{% endif %}">
                ðŸ—ï¸ Projects
            </a>

            <!-- ================= DAILY EXECUTION ================= -->
            {% if project_role in ["admin", "manager", "member"] %}
            <a href="/daily-entry"
               class="{% if request.url.path.startswith('/daily-entry') %}active{% endif %}">
                ðŸ§¾ Daily Execution
            </a>
            {% endif %}

            <!-- ================= ACTIVITY PLANNING ================= -->
            {% if project_role in ["admin", "manager"] and project_id %}
            <a href="/project-activity-plan/{{ project_id }}"
               class="{% if request.url.path.startswith('/project-activity-plan') %}active{% endif %}">
                ðŸ—“ Activity Planning
            </a>
            {% endif %}

            <!-- ================= REPORTS ================= -->
            {% if project_role in ["admin", "manager"] %}
            <a href="/reports"
               class="{% if request.url.path.startswith('/reports') %}active{% endif %}">
                ðŸ“„ Reports
            </a>
            {% endif %}

            <!-- ================= ADMIN CONSOLE ================= -->
            {% if user["role"] == "admin" %}
            <a href="/admin/users"
               class="{% if request.url.path.startswith('/admin') %}active{% endif %}">
                ðŸ› ï¸ Admin Console
            </a>
            {% endif %}

            <!-- ================= LOGOUT ================= -->
            <a href="/logout" class="danger">
                ðŸšª Logout
            </a>
        </nav>

        <div class="sidebar-footer">
            <button onclick="toggleTheme()" class="theme-btn" title="Toggle theme">
                ðŸŒ“ Theme
            </button>
        </div>
        {% endif %}
    </aside>

    <!-- ================= MAIN ================= -->
    <main class="main">

        <!-- ================= FLASH MESSAGES ================= -->
        {% if request.state is defined and request.state.flashes is defined %}
        <div class="flash-container">
            {% for flash in request.state.flashes %}
                <div class="flash flash-{{ flash.category }}">
                    {{ flash.message }}
                </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="container">
            {% block content %}{% endblock %}
        </div>

    </main>

</div>

<script>
    function toggleTheme() {
        const html = document.documentElement;
        html.classList.add("theme-transition");

        if (html.classList.contains("dark")) {
            html.classList.remove("dark");
            localStorage.setItem("theme", "light");
        } else {
            html.classList.add("dark");
            localStorage.setItem("theme", "dark");
        }

        setTimeout(() => {
            html.classList.remove("theme-transition");
        }, 300);
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</body>
</html>


----------------------------------------
FILE: .\app\templates\daily_entry.html
----------------------------------------
{% extends "base.html" %}
{% block content %}

<h1 class="page-title">
    Daily Work Execution â€” {{ project.name }}
</h1>

<div class="card" style="max-width:900px;margin:auto;padding:24px">

{% if activities %}
<form method="post" action="/daily-entry">

    <!-- PROJECT CONTEXT -->
    <input type="hidden" name="project_id" value="{{ project.id }}">

    <!-- ACTIVITY -->
    <div class="form-group">
        <label>Activity</label>
        <select name="activity_id" required>
            {% for pa in activities %}
                <option value="{{ pa.activity_id }}">
                    {{ pa.activity.name }}
                    â€” Planned: {{ pa.planned_quantity }} {{ pa.unit }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- QUANTITY -->
    <div class="form-group">
        <label>Quantity Executed Today</label>
        <input
            type="number"
            step="0.01"
            name="quantity_done"
            required
        >
    </div>

    <!-- DATE -->
    <div class="form-group">
        <label>Date</label>
        <input
            type="date"
            name="entry_date"
            value="{{ today }}"
            required
        >
    </div>

    <button class="btn-success" type="submit">
        âœ… Submit Daily Entry
    </button>

</form>
{% else %}
    <p style="opacity:0.7">
        No planned activities found for this project.
        <br>
        Please plan activities first.
    </p>
{% endif %}

</div>

{% endblock %}


----------------------------------------
FILE: .\app\templates\daily_execution_projects.html
----------------------------------------
{% extends "base.html" %}
{% block content %}

<h1 class="page-title">Daily Execution</h1>

<div class="card" style="max-width:800px;margin:auto;padding:24px">

    <p style="opacity:0.8;margin-bottom:16px">
        Select a project to record daily work execution.
    </p>

    {% if projects %}
        <div style="display:flex;flex-direction:column;gap:12px">

            {% for p in projects %}
                <a
                    href="/execution/{{ p.id }}"
                    style="
                        display:flex;
                        justify-content:space-between;
                        align-items:center;
                        padding:14px 18px;
                        background:rgba(255,255,255,0.04);
                        border:1px solid rgba(255,255,255,0.08);
                        border-radius:10px;
                        text-decoration:none;
                        color:#fff;
                        transition:background 0.2s ease;
                    "
                    onmouseover="this.style.background='rgba(255,255,255,0.08)'"
                    onmouseout="this.style.background='rgba(255,255,255,0.04)'"
                >
                    <div>
                        <strong>{{ p.name }}</strong><br>
                        <span style="opacity:0.7;font-size:13px">
                            {{ p.city }}, {{ p.state }}
                        </span>
                    </div>

                    <span style="opacity:0.6">âžœ</span>
                </a>
            {% endfor %}

        </div>
    {% else %}
        <p>No projects available for execution.</p>
    {% endif %}

</div>

{% endblock %}


----------------------------------------
FILE: .\app\templates\dashboard.html
----------------------------------------
{% extends "base.html" %}
{% block content %}

<h1 class="page-title">{{ title }}</h1>

<!-- ================= PROJECT CONTEXT (SAFE GLOBAL) ================= -->
<script>
    window.PROJECT_ID = {{ project_id if project_id else "null" }};
</script>

<!-- ================= KPI / SUMMARY ================= -->
<div class="kpi-grid">
    <a href="/reports" class="kpi-card kpi-primary">
        <div class="kpi-icon">ðŸ“„</div>
        <div class="kpi-content">
            <div class="kpi-value">{{ summary.total_reports }}</div>
            <div class="kpi-label">Total Reports</div>
        </div>
    </a>

    <div class="kpi-card kpi-success">
        <div class="kpi-icon">ðŸ“…</div>
        <div class="kpi-content">
            <div class="kpi-value">{{ summary.reports_today }}</div>
            <div class="kpi-label">Reports Today</div>
        </div>
    </div>
</div>

<!-- ================= PROJECT OVERVIEW ================= -->
<h2 class="section-title">Project Overview</h2>

{% if not has_projects %}
<div class="card">
    <p style="margin:0;opacity:0.8">
        âš ï¸ You are not assigned to any project yet.<br>
        Please contact an administrator to assign you to a project.
    </p>
</div>

{% elif project %}
<div class="card" style="margin-bottom:20px">

    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
        <h3 style="margin:0">Active Project</h3>

        {% if projects|length > 1 %}
        <select
            class="form-select"
            onchange="if(this.value) window.location.href='?project_id=' + this.value"
        >
            {% for p in projects %}
                <option value="{{ p.id }}" {% if project.id == p.id %}selected{% endif %}>
                    {{ p.name }} â€” {{ p.city }}
                    {% if not p.is_active %}(Archived){% endif %}
                </option>
            {% endfor %}
        </select>
        {% endif %}
    </div>

    <hr style="margin:12px 0">

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px">

        <div>
            <strong>Project Name</strong><br>
            {{ project.name }}
        </div>

        <div>
            <strong>Location</strong><br>
            {{ project.city }}
            {% if project.state %}, {{ project.state }}{% endif %}
        </div>

        <div>
            <strong>Road Details</strong><br>
            {{ project.road_type }},
            {{ project.lanes }} lanes,
            {{ project.road_length_km }} km
        </div>

        <div>
            <strong>Status</strong><br>
            <span class="badge badge-info">
                {{ project.status|capitalize }}
            </span>
        </div>

        <div>
            <strong>Timeline</strong><br>
            {{ project.planned_start_date }} â†’ {{ project.planned_end_date }}
        </div>

    </div>
</div>
{% endif %}

<!-- ================= PROJECT KPI ================= -->
{% if project %}
<div class="kpi-grid">
    <div class="kpi-card kpi-primary">
        <div class="kpi-content">
            <div class="kpi-value" id="totalActivities">â€“</div>
            <div class="kpi-label">Total Activities</div>
        </div>
    </div>

    <div class="kpi-card kpi-warning">
        <div class="kpi-content">
            <div class="kpi-value" id="inProgressActivities">â€“</div>
            <div class="kpi-label">In Progress</div>
        </div>
    </div>

    <div class="kpi-card kpi-success">
        <div class="kpi-content">
            <div class="kpi-value" id="completedActivities">â€“</div>
            <div class="kpi-label">Completed</div>
        </div>
    </div>

    <div class="kpi-card kpi-danger">
        <div class="kpi-content">
            <div class="kpi-value" id="delayedActivities">â€“</div>
            <div class="kpi-label">Delayed</div>
        </div>
    </div>
</div>

<div class="card">
    <h3 style="margin-top:0">Overall Project Progress</h3>
    <div class="progress-bar-container">
        <div class="progress-bar" id="overallProgressBar">0%</div>
    </div>
</div>
{% endif %}

<!-- ================= ACTIVITIES ================= -->
{% if project %}
<h2 class="section-title">
    Project Activities

    {% if not project.is_active %}
        <span class="badge badge-warning" style="float:right">
            Archived Project
        </span>
    {% endif %}
</h2>

<div class="card">
<table class="table">
<thead>
<tr>
    <th>ID</th>
    <th>Start</th>
    <th>End</th>
    <th>Progress</th>
    <th>Status</th>
    <th>Delay</th>
    <th>Materials</th>
    <th>Update</th>
</tr>
</thead>
<tbody id="activityTableBody">
<tr>
    <td colspan="8" style="opacity:0.7">
        Loading activitiesâ€¦
    </td>
</tr>
</tbody>
</table>
</div>
{% endif %}

<script src="/static/js/dashboard.js"></script>

{% endblock %}


----------------------------------------
FILE: .\app\templates\delete_confirm.html
----------------------------------------
{% extends "base.html" %}

{% block content %}
<h2>Confirm Delete</h2>

<p style="color:#b00020; font-weight:bold;">
    This action cannot be undone.
</p>

<p>
    You are about to permanently delete the following report:
</p>

<ul>
    <li><strong>Date:</strong> {{ report.report_date }}</li>
    <li><strong>Type:</strong> {{ report.report_type }}</li>
    <li><strong>Description:</strong> {{ report.description }}</li>
</ul>

<form method="post">
    <button type="submit" class="button danger">
        Yes, Delete Report
    </button>
    <a href="/reports" class="button secondary">Cancel</a>
</form>
{% endblock %}


----------------------------------------
FILE: .\app\templates\edit_project.html
----------------------------------------
{% extends "base.html" %}
{% block content %}

<h1 class="page-title">Edit Project</h1>

<div class="card" style="max-width:1100px;margin:auto">

<form method="post" action="/projects/{{ project.id }}/update">

    <!-- ================= BASIC INFO ================= -->
    <h3 class="section-title">Basic Information</h3>

    <div class="form-grid">

        <div>
            <label>Project Name</label>
            <input type="text" name="name" value="{{ project.name }}" required>
        </div>

        <div>
            <label>Project Code / Package No</label>
            <input type="text" name="project_code" value="{{ project.project_code or '' }}">
        </div>

        <div>
            <label>Client / Authority</label>
            <input type="text" name="client_authority" value="{{ project.client_authority or '' }}">
        </div>

        <div>
            <label>Contractor</label>
            <input type="text" name="contractor" value="{{ project.contractor or '' }}">
        </div>

        <div>
            <label>Consultant / PMC</label>
            <input type="text" name="consultant_pmc" value="{{ project.consultant_pmc or '' }}">
        </div>

    </div>

    <hr>

    <!-- ================= ROAD DETAILS ================= -->
    <h3 class="section-title">Road Details</h3>

    <div class="form-grid">

        <div>
            <label>Road Type</label>
            <input type="text" name="road_type" value="{{ project.road_type }}" required>
        </div>

        <div>
            <label>Lanes</label>
            <input type="number" name="lanes" value="{{ project.lanes }}" required>
        </div>

        <div>
            <label>Road Width (m)</label>
            <input type="number" step="0.01" name="road_width"
                   value="{{ project.road_width }}" required>
        </div>

        <div>
            <label>Carriageway Width (m)</label>
            <input type="number" step="0.01" name="carriageway_width"
                   value="{{ project.carriageway_width or '' }}">
        </div>

        <div>
            <label>Road Length (km)</label>
            <input type="number" step="0.01" name="road_length_km"
                   value="{{ project.road_length_km }}" required>
        </div>

        <div>
            <label>Shoulder Type</label>
            <input type="text" name="shoulder_type"
                   value="{{ project.shoulder_type or '' }}">
        </div>

        <div>
            <label>Median Type</label>
            <input type="text" name="median_type"
                   value="{{ project.median_type or '' }}">
        </div>

    </div>

    <hr>

    <!-- ================= LOCATION ================= -->
    <h3 class="section-title">Location</h3>

    <div class="form-grid">

        <div>
            <label>Country</label>
            <input type="text" name="country" value="{{ project.country }}" required>
        </div>

        <div>
            <label>State</label>
            <input type="text" name="state" value="{{ project.state or '' }}">
        </div>

        <div>
            <label>District</label>
            <input type="text" name="district" value="{{ project.district or '' }}">
        </div>

        <div>
            <label>City</label>
            <input type="text" name="city" value="{{ project.city }}" required>
        </div>

        <div>
            <label>Chainage Start</label>
            <input type="text" name="chainage_start"
                   value="{{ project.chainage_start or '' }}">
        </div>

        <div>
            <label>Chainage End</label>
            <input type="text" name="chainage_end"
                   value="{{ project.chainage_end or '' }}">
        </div>

    </div>

    <hr>

    <!-- ================= TIMELINE ================= -->
    <h3 class="section-title">Timeline</h3>

    <div class="form-grid">

        <div>
            <label>Start Date</label>
            <input type="date" name="planned_start_date"
                   value="{{ project.planned_start_date }}" required>
        </div>

        <div>
            <label>End Date</label>
            <input type="date" name="planned_end_date"
                   value="{{ project.planned_end_date }}" required>
        </div>

    </div>

    <hr>

    <!-- ================= ACTIONS ================= -->
    <div style="display:flex;gap:12px;margin-top:20px">

        <button class="btn-primary" type="submit">
            Save Changes
        </button>

        <a href="/dashboard" class="btn-secondary">
            Cancel
        </a>

    </div>

</form>

</div>

{% endblock %}


----------------------------------------
FILE: .\app\templates\edit_report.html
----------------------------------------
{% extends "base.html" %}

{% block content %}
<h2>Edit Report</h2>

<form method="post">
    <label>Type</label>
    <select name="report_type" required>
        <option value="Labour" {% if report.report_type == "Labour" %}selected{% endif %}>Labour</option>
        <option value="Machinery" {% if report.report_type == "Machinery" %}selected{% endif %}>Machinery</option>
        <option value="Material" {% if report.report_type == "Material" %}selected{% endif %}>Material</option>
    </select>

    <label>Description</label>
    <textarea name="description" rows="4" required>{{ report.description }}</textarea>

    <label>Date</label>
    <input type="date" name="report_date" value="{{ report.report_date }}" required>

    <button type="submit" class="button">Update Report</button>
    <a href="/reports" class="button secondary">Cancel</a>
</form>
{% endblock %}


----------------------------------------
FILE: .\app\templates\home.html
----------------------------------------
{% extends "base.html" %}

{% block content %}
<h1>InfraCore Dashboard</h1>

<p>Infrastructure Planning & Control System</p>

<div class="cards">
    <div class="card">
        <h3>Active Projects</h3>
        <p class="value">5</p>
    </div>

    <div class="card">
        <h3>Sites Running</h3>
        <p class="value">8</p>
    </div>

    <div class="card">
        <h3>Inventory Alerts</h3>
        <p class="value alert">2</p>
    </div>

    <div class="card">
        <h3>Pending Reports</h3>
        <p class="value">3</p>
    </div>
</div>
{% endblock %}


----------------------------------------
FILE: .\app\templates\inventory.html
----------------------------------------
{% extends "base.html" %}
{% block content %}
<h1>Inventory</h1>

<table>
    <tr>
        <th>Material</th>
        <th>Quantity</th>
        <th>Unit</th>
    </tr>
    {% for row in inventory %}
    <tr>
        <td>{{ row.get("material","") }}</td>
        <td>{{ row.get("quantity","") }}</td>
        <td>{{ row.get("unit","") }}</td>
    </tr>
    {% endfor %}
</table>
{% endblock %}


----------------------------------------
FILE: .\app\templates\labour.html
----------------------------------------
{% extends "base.html" %}
{% block content %}
<h1>Labour</h1>

<table>
    <tr>
        <th>Category</th>
        <th>Count</th>
    </tr>
    {% for l in labour %}
    <tr>
        <td>{{ l.get("Category", "") }}</td>
        <td>{{ l.get("Count", "") }}</td>
    </tr>
    {% endfor %}
</table>
{% endblock %}


----------------------------------------
FILE: .\app\templates\login.html
----------------------------------------
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login â€“ InfraCore</title>

    <style>
        body {
            margin: 0;
            height: 100vh;
            background: linear-gradient(135deg, #020617, #020617);
            font-family: "Segoe UI", system-ui, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e5e7eb;
        }

        .login-card {
            background: #020617;
            border: 1px solid #1e293b;
            width: 360px;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }

        .login-title {
            text-align: center;
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .login-subtitle {
            text-align: center;
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 13px;
            margin-bottom: 6px;
            color: #cbd5f5;
        }

        input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #1e293b;
            background: #020617;
            color: #e5e7eb;
            outline: none;
        }

        input:focus {
            border-color: #2563eb;
        }

        .login-btn {
            width: 100%;
            padding: 11px;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .login-btn:hover {
            opacity: 0.95;
        }

        .flash {
            background: #7f1d1d;
            color: #fecaca;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
            text-align: center;
        }

        .footer-text {
            text-align: center;
            font-size: 11px;
            color: #64748b;
            margin-top: 18px;
        }
    </style>
</head>
<body>

<div class="login-card">

    <div class="login-title">InfraCore</div>
    <div class="login-subtitle">Construction ERP Login</div>

    {% if request.state.flashes %}
        {% for msg, category in request.state.flashes %}
            <div class="flash">{{ msg }}</div>
        {% endfor %}
    {% endif %}

    <form method="post" action="/login">
        <div class="form-group">
            <label>Username</label>
            <input type="text" name="username" required>
        </div>

        <div class="form-group">
            <label>Password</label>
            <input type="password" name="password" required>
        </div>

        <button class="login-btn" type="submit">Login</button>
    </form>

    <div class="footer-text">
        Â© InfraCore ERP
    </div>

</div>

</body>
</html>


----------------------------------------
FILE: .\app\templates\machinery.html
----------------------------------------
{% extends "base.html" %}
{% block content %}
<h1>Machinery</h1>

<table>
    <tr>
        <th>Machine</th>
        <th>Status</th>
    </tr>
    {% for m in machinery %}
    <tr>
        <td>{{ m.get("Machine_Name", "") }}</td>
        <td>{{ m.get("Status", "") }}</td>
    </tr>
    {% endfor %}
</table>
{% endblock %}


----------------------------------------
FILE: .\app\templates\new_project.html
----------------------------------------
{% extends "base.html" %}
{% block content %}

<h1 class="page-title">Create New Project</h1>

<div class="card" style="max-width:1100px;margin:auto">

<form method="post" action="/projects/create">

    <!-- ================= BASIC INFO ================= -->
    <h3 class="section-title">Basic Information</h3>

    <div class="form-grid">

        <div>
            <label>Project Name</label>
            <input type="text" name="name" required>
        </div>

        <div>
            <label>Project Code / Package No</label>
            <input type="text" name="project_code">
        </div>

        <div>
            <label>Client / Authority</label>
            <input type="text" name="client_authority">
        </div>

        <div>
            <label>Contractor</label>
            <input type="text" name="contractor">
        </div>

        <div>
            <label>Consultant / PMC</label>
            <input type="text" name="consultant_pmc">
        </div>

    </div>

    <hr>

    <!-- ================= ROAD DETAILS ================= -->
    <h3 class="section-title">Road Details</h3>

    <div class="form-grid">

        <div>
            <label>Road Type</label>
            <input type="text" name="road_type" required>
        </div>

        <div>
            <label>Lanes</label>
            <input type="number" name="lanes" required>
        </div>

        <div>
            <label>Road Width (m)</label>
            <input type="number" step="0.01" name="road_width" required>
        </div>

        <div>
            <label>Carriageway Width (m)</label>
            <input type="number" step="0.01" name="carriageway_width">
        </div>

        <div>
            <label>Road Length (km)</label>
            <input type="number" step="0.01" name="road_length_km" required>
        </div>

        <div>
            <label>Shoulder Type</label>
            <input type="text" name="shoulder_type">
        </div>

        <div>
            <label>Median Type</label>
            <input type="text" name="median_type">
        </div>

    </div>

    <hr>

    <!-- ================= LOCATION ================= -->
    <h3 class="section-title">Location</h3>

    <div class="form-grid">

        <div>
            <label>Country</label>
            <input type="text" name="country" required>
        </div>

        <div>
            <label>State</label>
            <input type="text" name="state">
        </div>

        <div>
            <label>District</label>
            <input type="text" name="district">
        </div>

        <div>
            <label>City</label>
            <input type="text" name="city" required>
        </div>

        <div>
            <label>Chainage Start</label>
            <input type="text" name="chainage_start" placeholder="0+000">
        </div>

        <div>
            <label>Chainage End</label>
            <input type="text" name="chainage_end" placeholder="5+250">
        </div>

    </div>

    <hr>

    <!-- ================= TIMELINE ================= -->
    <h3 class="section-title">Timeline</h3>

    <div class="form-grid">

        <div>
            <label>Start Date</label>
            <input type="date" name="planned_start_date" required>
        </div>

        <div>
            <label>End Date</label>
            <input type="date" name="planned_end_date" required>
        </div>

    </div>

    <hr>

    <!-- ================= ACTIONS ================= -->
    <div style="display:flex;gap:12px;margin-top:20px">
        <button class="btn-primary" type="submit">
            Create Project
        </button>

        <a href="/dashboard" class="btn-secondary">
            Cancel
        </a>
    </div>

</form>

</div>

{% endblock %}


----------------------------------------
FILE: .\app\templates\projects.html
----------------------------------------
{% extends "base.html" %}
{% block content %}

<!-- ================= PAGE HEADER ================= -->
<div class="page-header"
     style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px">

    <div>
        <h1 class="page-title">Projects</h1>
        <p style="opacity:0.7;margin-top:4px">
            Manage all projects: create, edit, archive, or delete
        </p>
    </div>

    <!-- âž• CREATE PROJECT (ADMIN + MANAGER ONLY) -->
    {% if user["role"] in ["admin", "manager"] %}
    <div style="display:flex;gap:10px">
        <a href="/projects/new" class="btn-primary">
            âž• Create New Project
        </a>
    </div>
    {% endif %}
</div>

<!-- ================= PROJECT LIST ================= -->
<div class="card">

    {% if projects %}
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Project Name</th>
                <th>Road Type</th>
                <th>City</th>
                <th>Country</th>
                <th>Start</th>
                <th>End</th>
                <th>Status</th>
                <th style="width:240px">Actions</th>
            </tr>
        </thead>

        <tbody>
        {% for project in projects %}
            <tr>
                <td>{{ project.id }}</td>

                <td>
                    <strong>{{ project.name }}</strong>
                </td>

                <td>{{ project.road_type }}</td>
                <td>{{ project.city }}</td>
                <td>{{ project.country }}</td>
                <td>{{ project.planned_start_date }}</td>
                <td>{{ project.planned_end_date }}</td>

                <td>
                    {% if project.is_active %}
                        <span class="badge badge-success">Active</span>
                    {% else %}
                        <span class="badge badge-danger">Archived</span>
                    {% endif %}
                </td>

                <td style="display:flex;gap:6px;flex-wrap:wrap">

                    <!-- âœï¸ EDIT (ADMIN + MANAGER ONLY) -->
                    {% if user["role"] in ["admin", "manager"] %}
                    <a href="/projects/{{ project.id }}/edit"
                       class="btn-secondary btn-sm">
                        âœï¸ Edit
                    </a>
                    {% endif %}

                    <!-- ðŸ“¦ ARCHIVE / RESTORE (ADMIN + MANAGER ONLY) -->
                    {% if user["role"] in ["admin", "manager"] %}
                    <form method="post"
                          action="/projects/{{ project.id }}/archive">
                        <button class="btn-warning btn-sm" type="submit">
                            {% if project.is_active %}
                                ðŸ“¦ Archive
                            {% else %}
                                â™» Restore
                            {% endif %}
                        </button>
                    </form>
                    {% endif %}

                    <!-- ðŸ—‘ DELETE (ADMIN ONLY) -->
                    {% if user["role"] == "admin" %}
                    <form method="post"
                          action="/projects/{{ project.id }}/delete"
                          onsubmit="return confirm('Delete this project permanently? This cannot be undone.')">
                        <button class="btn-danger btn-sm" type="submit">
                            ðŸ—‘ Delete
                        </button>
                    </form>
                    {% endif %}

                    <!-- ðŸ‘ VIEW ONLY -->
                    {% if user["role"] not in ["admin", "manager"] %}
                        <span class="badge badge-info">View Only</span>
                    {% endif %}

                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    {% else %}
    <!-- ================= EMPTY STATE ================= -->
    <div style="text-align:center;padding:48px">
        <h3>No projects found</h3>
        <p style="opacity:0.7;margin:8px 0 20px">
            Create your first project to start planning and tracking progress.
        </p>

        {% if user["role"] in ["admin", "manager"] %}
        <a href="/projects/new" class="btn-primary">
            âž• Create Project
        </a>
        {% else %}
        <span class="badge badge-info">No access to create projects</span>
        {% endif %}
    </div>
    {% endif %}

</div>

{% endblock %}


----------------------------------------
FILE: .\app\templates\projects_manage.html
----------------------------------------
{% extends "base.html" %}
{% block content %}

<h1 class="page-title">Manage Projects</h1>

<!-- ================= TABS ================= -->
<div style="display:flex;gap:10px;margin-bottom:20px">
    <a href="/projects/manage?status=active"
       class="btn-secondary {% if status=='active' %}btn-primary{% endif %}">
        Active
    </a>
    <a href="/projects/manage?status=completed"
       class="btn-secondary {% if status=='completed' %}btn-primary{% endif %}">
        Completed
    </a>
    <a href="/projects/manage?status=archived"
       class="btn-secondary {% if status=='archived' %}btn-primary{% endif %}">
        Archived
    </a>

    <!-- âœ… CREATE PROJECT (ADMIN + MANAGER ONLY) -->
    {% if user["role"] in ["admin", "manager"] %}
    <div style="margin-left:auto">
        <a href="/projects/new" class="btn-primary">
            + New Project
        </a>
    </div>
    {% endif %}
</div>

<!-- ================= PROJECT TABLE ================= -->
<div class="card">
<table class="table">
<thead>
<tr>
    <th>Name</th>
    <th>Location</th>
    <th>Status</th>
    <th>Timeline</th>
    <th>Actions</th>
</tr>
</thead>

<tbody>
{% for p in projects %}
<tr>
    <td>{{ p.name }}</td>
    <td>{{ p.city }}{% if p.state %}, {{ p.state }}{% endif %}</td>
    <td>{{ p.status|capitalize }}</td>
    <td>{{ p.planned_start_date }} â†’ {{ p.planned_end_date }}</td>

    <td style="display:flex;gap:8px;flex-wrap:wrap">

        <!-- âœï¸ EDIT (ADMIN + MANAGER ONLY) -->
        {% if user["role"] in ["admin", "manager"] %}
        <a href="/projects/{{ p.id }}/edit" class="btn-secondary">
            âœï¸ Edit
        </a>
        {% endif %}

        <!-- âœ… COMPLETE (ADMIN + MANAGER ONLY, ACTIVE ONLY) -->
        {% if user["role"] in ["admin", "manager"] and p.status == "active" %}
        <form method="post" action="/projects/{{ p.id }}/complete">
            <button class="btn-success">Complete</button>
        </form>
        {% endif %}

        <!-- ðŸ“¦ ARCHIVE (ADMIN ONLY) -->
        {% if user["role"] == "admin" and p.status != "archived" %}
        <form method="post" action="/projects/{{ p.id }}/archive">
            <button class="btn-warning">Archive</button>
        </form>
        {% endif %}

        <!-- ðŸ‘ VIEW ONLY -->
        {% if user["role"] not in ["admin", "manager"] %}
            <span class="badge badge-info">View Only</span>
        {% endif %}

    </td>
</tr>
{% else %}
<tr>
    <td colspan="5">No projects found.</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

{% endblock %}


----------------------------------------
FILE: .\app\templates\project_activities.html
----------------------------------------
{% extends "base.html" %}
{% block content %}

<div class="page-header"
     style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">

    <h1 class="page-title">Project Activities â€” {{ project.name }}</h1>

    <div style="display:flex;gap:10px;flex-wrap:wrap">
        <!-- ðŸ”¹ ADD ACTIVITY -->
        {% if project_role in ["admin", "manager"] %}
        <a href="/projects/{{ project.id }}/activities/new" class="btn-primary">
            âž• Add Activity
        </a>
        {% endif %}

        <!-- ðŸ”¹ PLAN ACTIVITIES -->
        {% if project_role in ["admin", "manager"] %}
        <a href="/project-activity-plan/{{ project.id }}" class="btn-info">
            ðŸ“‹ Plan Activities
        </a>
        {% endif %}

        <a href="/dashboard?project_id={{ project.id }}" class="btn-secondary">
            â† Back to Dashboard
        </a>
    </div>
</div>

<div class="card" style="margin-bottom:20px">
    <strong>Project:</strong> {{ project.name }}<br>
    <strong>Location:</strong>
    {{ project.city }}
    {% if project.state %}, {{ project.state }}{% endif %}
</div>

<div class="card" style="padding:0">
<table class="table" style="margin:0">
<thead>
<tr>
    <th>Activity</th>
    <th>Planned Qty</th>
    <th>Unit</th>
    <th>Start</th>
    <th>End</th>
    <th>Daily Execution</th>
</tr>
</thead>

<tbody>
{% for pa in activities %}
<tr>

    <!-- ACTIVITY -->
    <td>
        <strong>{{ pa.activity.name if pa.activity else "Activity #" ~ pa.activity_id }}</strong>
    </td>

    <td>{{ pa.planned_quantity }}</td>
    <td>{{ pa.unit }}</td>
    <td>{{ pa.start_date }}</td>
    <td>{{ pa.end_date }}</td>

    <!-- DAILY EXECUTION -->
    <td>
        {% if project_role in ["admin", "manager", "member"] %}
        <form
            method="post"
            action="/daily-entry"
            style="display:flex;gap:6px;align-items:center;flex-wrap:wrap"
        >
            <input type="hidden" name="project_id" value="{{ project.id }}">
            <input type="hidden" name="activity_id" value="{{ pa.activity_id }}">

            <input
                type="number"
                step="0.01"
                name="quantity_done"
                placeholder="Qty"
                required
                style="width:90px"
            >

            <input
                type="date"
                name="entry_date"
                required
            >

            <button class="btn-success btn-sm" type="submit">
                âž• Add
            </button>
        </form>
        {% else %}
            <span class="badge badge-info">View Only</span>
        {% endif %}
    </td>

</tr>
{% else %}
<tr>
    <td colspan="6" style="text-align:center;opacity:0.7">
        No activities planned for this project.
    </td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

{% endblock %}


----------------------------------------
FILE: .\app\templates\project_activity_plan.html
----------------------------------------
{% extends "base.html" %}
{% block content %}

<!-- ================= PAGE HEADER ================= -->
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
    <h1 class="page-title">
        Plan Activities â€“ {{ project.name }}
    </h1>

    <!-- âœ… ADD ACTIVITY ENTRY POINT -->
    <a
        href="/projects/{{ project.id }}/activities/new"
        class="btn-primary"
        style="display:inline-flex;align-items:center;gap:6px"
    >
        âž• Add Activity
    </a>
</div>

<div class="card" style="padding:0">

    <div style="padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.08)">
        <strong>Define quantities, units, and schedule for each activity</strong>
    </div>

    {% if activities %}
    <table class="table" style="margin:0">
        <thead>
            <tr>
                <th style="width:220px">Activity</th>
                <th style="width:140px">Planned Qty</th>
                <th style="width:120px">Unit</th>
                <th style="width:140px">Start</th>
                <th style="width:140px">End</th>
                <th style="width:120px">Action</th>
            </tr>
        </thead>

        <tbody>
        {% for a in activities %}
        <tr>
            <form method="post" action="/project-activity-plan/save">

                <!-- REQUIRED CONTEXT -->
                <input type="hidden" name="project_id" value="{{ project.id }}">
                <input type="hidden" name="activity_id" value="{{ a.id }}">

                <!-- ACTIVITY -->
                <td>
                    <strong>{{ a.name }}</strong>
                    {% if a.is_standard %}
                        <span class="badge badge-info" style="margin-left:6px">STD</span>
                    {% endif %}
                </td>

                <!-- PLANNED QUANTITY -->
                <td>
                    <input
                        type="number"
                        step="0.01"
                        name="planned_quantity"
                        value="{{ planned_map[a.id].planned_quantity if a.id in planned_map else '' }}"
                        required
                    >
                </td>

                <!-- UNIT -->
                <td>
                    <input
                        type="text"
                        name="unit"
                        value="{{ planned_map[a.id].unit if a.id in planned_map else '' }}"
                        placeholder="mÂ³ / km / MT"
                        required
                    >
                </td>

                <!-- START DATE -->
                <td>
                    <input
                        type="date"
                        name="start_date"
                        value="{{ planned_map[a.id].start_date if a.id in planned_map else '' }}"
                        required
                    >
                </td>

                <!-- END DATE -->
                <td>
                    <input
                        type="date"
                        name="end_date"
                        value="{{ planned_map[a.id].end_date if a.id in planned_map else '' }}"
                        required
                    >
                </td>

                <!-- ACTION -->
                <td>
                    <button class="btn-primary btn-sm" type="submit">
                        {% if a.id in planned_map %}
                            ðŸ”„ Update
                        {% else %}
                            ðŸ’¾ Save
                        {% endif %}
                    </button>
                </td>

            </form>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
        <!-- EMPTY STATE -->
        <div style="padding:24px;text-align:center;opacity:0.7">
            No activities added yet.<br>
            Click <strong>â€œAdd Activityâ€</strong> to begin planning.
        </div>
    {% endif %}

</div>

{% endblock %}


----------------------------------------
FILE: .\app\templates\reports.html
----------------------------------------
{% extends "base.html" %}

{% block content %}
<h1>Reports</h1>

<form method="get" class="filter-bar">
    <select name="report_type">
        <option value="">All Types</option>
        <option value="Labour" {% if selected_type == "Labour" %}selected{% endif %}>Labour</option>
        <option value="Machinery" {% if selected_type == "Machinery" %}selected{% endif %}>Machinery</option>
        <option value="Material" {% if selected_type == "Material" %}selected{% endif %}>Material</option>
    </select>

    <input
        type="date"
        name="report_date"
        value="{{ selected_date or '' }}"
    >

    <button type="submit">Filter</button>
    <a href="/reports" class="button secondary">Reset</a>

    <a href="/reports/new" class="button">âž• Add Report</a>

    <a
        href="/reports/export?report_type={{ selected_type or '' }}&report_date={{ selected_date or '' }}"
        class="button secondary"
    >
        â¬‡ Export Excel
    </a>
</form>

<table>
    <thead>
        <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Description</th>
            <th style="width: 160px;">Actions</th>
        </tr>
    </thead>

    <tbody>
        {% for r in reports %}
        <tr>
            <td>{{ r.report_date }}</td>
            <td>{{ r.report_type }}</td>
            <td>{{ r.description }}</td>
            <td>
                <a href="/reports/edit/{{ r.id }}" class="button secondary">Edit</a>
                <a href="/reports/delete/{{ r.id }}" class="button danger">Delete</a>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="4">No reports found</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}


----------------------------------------
FILE: .\app\templates\report_form.html
----------------------------------------
{% extends "base.html" %}

{% block content %}
<div class="form-page">

    <form method="post">

        <div class="form-group">
            <label>Report Type</label>
            <select name="report_type" required>
                <option value="Labour" {% if report and report.report_type == "Labour" %}selected{% endif %}>Labour</option>
                <option value="Machinery" {% if report and report.report_type == "Machinery" %}selected{% endif %}>Machinery</option>
                <option value="Material" {% if report and report.report_type == "Material" %}selected{% endif %}>Material</option>
            </select>
        </div>

        <div class="form-group">
            <label>Description</label>
            <textarea name="description" required>
{{ report.description if report else "" }}</textarea>
        </div>

        <div class="form-group">
            <label>Date</label>
            <input
                type="date"
                name="report_date"
                value="{{ report.report_date.strftime('%Y-%m-%d') if report and report.report_date else '' }}"
                required
            >
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-primary">Save</button>
            <a href="/reports" class="btn-secondary">Cancel</a>
        </div>

    </form>
</div>
{% endblock %}


----------------------------------------
FILE: .\app\templates\report_new.html
----------------------------------------
{% extends "base.html" %}

{% block content %}
<div class="form-page">
    <h1>New Report</h1>

    <form method="post" class="report-form">

        <label>Report Type</label>
        <select name="report_type" required>
            <option value="Labour">Labour</option>
            <option value="Machinery">Machinery</option>
            <option value="Material">Material</option>
        </select>

        <label>Description</label>
        <textarea name="description" required></textarea>

        <label>Date</label>
        <input type="date" name="report_date" required>

        <div class="form-actions">
            <button type="submit">Save</button>
            <a href="/" class="cancel-btn">Cancel</a>
        </div>

    </form>
</div>
{% endblock %}


----------------------------------------
FILE: .\app\templates\schedule.html
----------------------------------------
{% extends "base.html" %}
{% block content %}
<h1>Schedule</h1>

<table>
    <tr>
        <th>Task</th>
        <th>Status</th>
    </tr>
    {% for s in schedule %}
    <tr>
        <td>{{ s.get("Task_Name", "") }}</td>
        <td>{{ s.get("Status", "") }}</td>
    </tr>
    {% endfor %}
</table>
{% endblock %}


----------------------------------------
FILE: .\app\templates\settings.html
----------------------------------------
{% extends "base.html" %}

{% block content %}
<div class="settings-page">
    <p>Application configuration and preferences.</p>
</div>
{% endblock %}


----------------------------------------
FILE: .\app\templates\site_operations.html
----------------------------------------
{% extends "base.html" %}

{% block content %}
<div class="site-operations">

    <p>Manage on-site activities:</p>

    <ul>
        <li>Projects</li>
        <li>Schedule</li>
        <li>Labour</li>
        <li>Machinery</li>
    </ul>

</div>
{% endblock %}


----------------------------------------
FILE: .\app\templates\users.html
----------------------------------------
{% extends "base.html" %}

{% block content %}
<h2>Users</h2>

<table border="1" cellpadding="6">
    <tr>
        <th>ID</th>
        <th>Username</th>
        <th>Role</th>
    </tr>

    {% for u in users %}
    <tr>
        <td>{{ u.id }}</td>
        <td>{{ u.username }}</td>
        <td>{{ u.role }}</td>
    </tr>
    {% endfor %}
</table>

<a href="/reports">Back to Reports</a>
{% endblock %}


----------------------------------------
FILE: .\app\templates\admin\project_users.html
----------------------------------------
{% extends "base.html" %}
{% block content %}

<h1 class="page-title">{{ title }}</h1>

<!-- ================= PROJECT INFO ================= -->
<div class="card" style="margin-bottom:16px">
    <strong>Project:</strong> {{ project.name }} <br>
    <strong>Location:</strong>
    {{ project.city }}{% if project.state %}, {{ project.state }}{% endif %}
</div>

<!-- ================= ASSIGNED USERS ================= -->
<div class="card" style="margin-bottom:20px">
    <h3>Assigned Users</h3>

    {% if project_users %}
        <table class="table">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Role in Project</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
            {% for pu in project_users %}
                <tr>
                    <td>{{ pu.user.username }}</td>
                    <td>
                        <span class="badge badge-info">
                            {{ pu.role_in_project | upper }}
                        </span>
                    </td>
                    <td>
                        <form
                            method="post"
                            action="/admin/projects/{{ project.id }}/users/{{ pu.user.id }}/remove"
                        >
                            <button type="submit" class="btn-danger">
                                âŒ Remove
                            </button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No users assigned to this project.</p>
    {% endif %}
</div>

<!-- ================= ADD USER ================= -->
<div class="card">
    <h3>Add User to Project</h3>

    {% if available_users %}
        <form
            method="post"
            action="/admin/projects/{{ project.id }}/users/add"
            style="display:flex;gap:12px;flex-wrap:wrap"
        >

            <select name="user_id" class="form-select" required>
                <option value="">Select User</option>
                {% for u in available_users %}
                    <option value="{{ u.id }}">{{ u.username }}</option>
                {% endfor %}
            </select>

            <select name="role_in_project" class="form-select" required>
                <option value="manager">Manager</option>
                <option value="member" selected>Member</option>
                <option value="viewer">Viewer</option>
            </select>

            <button type="submit" class="btn-primary">
                âž• Assign User
            </button>
        </form>
    {% else %}
        <p>All active users are already assigned to this project.</p>
    {% endif %}
</div>

<div style="margin-top:16px">
    <a href="/projects/manage" class="btn-secondary">
        â† Back to Projects
    </a>
</div>

{% endblock %}


----------------------------------------
FILE: .\app\templates\admin\users_list.html
----------------------------------------
{% extends "base.html" %}
{% block content %}

<div class="page-header"
     style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">

    <h1 class="page-title">User Management</h1>

    <!-- ADD USER -->
    <a href="/admin/users/new"
       style="
           background:#1f6feb;
           color:#ffffff;
           padding:8px 14px;
           border-radius:6px;
           font-weight:600;
           text-decoration:none;
           display:inline-flex;
           align-items:center;
           gap:6px;
       ">
        âž• Add User
    </a>
</div>

<div class="card" style="padding:0">

    <div style="padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.08)">
        <h3 style="margin:0">All Users</h3>
    </div>

    <table class="table" style="margin:0">
        <thead>
            <tr style="background:rgba(255,255,255,0.04)">
                <th style="width:60px">ID</th>
                <th>Username</th>
                <th style="width:120px">Role</th>
                <th style="width:120px">Status</th>
                <th style="width:320px">Actions</th>
            </tr>
        </thead>

        <tbody>
        {% for u in users %}
            <tr style="border-bottom:1px solid rgba(255,255,255,0.05)">
                <td>{{ u.id }}</td>

                <td><strong>{{ u.username }}</strong></td>

                <!-- ROLE -->
                <td>
                    <span class="badge badge-info">
                        {{ u.role | upper }}
                    </span>
                </td>

                <!-- STATUS -->
                <td>
                    {% if u.is_active %}
                        <span class="badge badge-success">ACTIVE</span>
                    {% else %}
                        <span class="badge badge-danger">DISABLED</span>
                    {% endif %}
                </td>

                <!-- ACTIONS -->
                <td>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">

                        <!-- EDIT -->
                        <a href="/admin/users/{{ u.id }}/edit"
                           style="
                               background:#374151;
                               color:#ffffff;
                               padding:5px 10px;
                               border-radius:5px;
                               font-size:13px;
                               text-decoration:none;
                           ">
                            âœï¸ Edit
                        </a>

                        <!-- SESSIONS -->
                        <a href="/admin/users/{{ u.id }}/sessions"
                           style="
                               background:#0ea5a4;
                               color:#ffffff;
                               padding:5px 10px;
                               border-radius:5px;
                               font-size:13px;
                               text-decoration:none;
                           ">
                            ðŸ•’ Sessions
                        </a>

                        <!-- ENABLE / DISABLE -->
                        {% if user["id"] != u.id %}
                            <form
                                method="post"
                                action="/admin/users/{{ u.id }}/toggle"
                                style="display:inline"
                            >
                                {% if u.is_active %}
                                    <button type="submit"
                                        style="
                                            background:#dc2626;
                                            color:#ffffff;
                                            padding:5px 10px;
                                            border:none;
                                            border-radius:5px;
                                            font-size:13px;
                                            cursor:pointer;
                                        ">
                                        ðŸš« Disable
                                    </button>
                                {% else %}
                                    <button type="submit"
                                        style="
                                            background:#16a34a;
                                            color:#ffffff;
                                            padding:5px 10px;
                                            border:none;
                                            border-radius:5px;
                                            font-size:13px;
                                            cursor:pointer;
                                        ">
                                        âœ… Enable
                                    </button>
                                {% endif %}
                            </form>
                        {% else %}
                            <span class="badge badge-warning">
                                You
                            </span>
                        {% endif %}

                    </div>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}


----------------------------------------
FILE: .\app\templates\admin\user_form.html
----------------------------------------
{% extends "base.html" %}
{% block content %}

<div class="page-header" style="margin-bottom:24px">
    <h1 class="page-title">{{ title }}</h1>
</div>

<div class="card" style="max-width:1100px;margin:auto;padding:24px">

<!-- ================================================= -->
<!-- USER SAVE FORM (UNCHANGED LOGIC) -->
<!-- ================================================= -->
<form
    method="post"
    action="{% if user_data %}/admin/users/{{ user_data.id }}/update{% else %}/admin/users/create{% endif %}"
>

    <h3 class="section-title">User Details</h3>

    <div class="form-grid" style="margin-bottom:20px">

        <div>
            <label>Username</label>
            {% if user_data %}
                <input type="text" value="{{ user_data.username }}" disabled>
            {% else %}
                <input type="text" name="username" required>
            {% endif %}
        </div>

        <div>
            <label>Password {% if user_data %}(leave blank to keep same){% endif %}</label>
            <input type="password" name="password" {% if not user_data %}required{% endif %}>
        </div>

        <div>
            <label>System Role</label>
            <select name="role" required>
                <option value="user" {% if user_data and user_data.role == "user" %}selected{% endif %}>
                    User
                </option>
                <option value="admin" {% if user_data and user_data.role == "admin" %}selected{% endif %}>
                    Admin
                </option>
            </select>
        </div>

    </div>

    <div style="margin-top:28px;display:flex;gap:12px">
        <button
            type="submit"
            style="
                background:#16a34a;
                color:#fff;
                padding:10px 18px;
                border:none;
                border-radius:6px;
                font-weight:600;
                cursor:pointer;
            ">
            ðŸ’¾ Save User
        </button>

        <a href="/admin/users"
           style="
               background:#374151;
               color:#fff;
               padding:10px 18px;
               border-radius:6px;
               text-decoration:none;
               font-weight:500;
           ">
            Cancel
        </a>
    </div>

</form>

<!-- ================================================= -->
<!-- PROJECT ASSIGNMENTS -->
<!-- ================================================= -->
{% if user_data %}
<hr style="margin:32px 0">

<h3 class="section-title">Project Assignments</h3>

<!-- CURRENT ASSIGNMENTS -->
<div class="card" style="margin-bottom:20px;padding:16px">

    <h4 style="margin-top:0;margin-bottom:12px">Assigned Projects</h4>

    {% if project_users %}
    <table class="table">
        <thead>
            <tr>
                <th>Project</th>
                <th style="width:160px">Role</th>
                <th style="width:120px">Action</th>
            </tr>
        </thead>
        <tbody>
        {% for pu in project_users %}
            <tr>
                <td><strong>{{ pu.project.name }}</strong></td>
                <td>
                    <span class="badge badge-info">
                        {{ pu.role_in_project|capitalize }}
                    </span>
                </td>
                <td>
                    <form
                        method="post"
                        action="/admin/projects/{{ pu.project_id }}/users/{{ user_data.id }}/remove"
                    >
                        <button
                            style="
                                background:#dc2626;
                                color:#fff;
                                padding:5px 10px;
                                border:none;
                                border-radius:5px;
                                cursor:pointer;
                            ">
                            Remove
                        </button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p style="opacity:0.7">No project assignments.</p>
    {% endif %}
</div>

<!-- ADD TO PROJECT (âœ… FIXED & WORKING) -->
<div class="card" style="padding:16px">

    <h4 style="margin-top:0;margin-bottom:12px">Add to Project</h4>

    <form method="post" action="/admin/projects/assign-user">

        <!-- REQUIRED -->
        <input type="hidden" name="user_id" value="{{ user_data.id }}">

        <div class="form-grid">

            <div>
                <label>Project</label>
                <select name="project_id" required>
                    {% for p in all_projects %}
                        <option value="{{ p.id }}">{{ p.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label>Role in Project</label>
                <select name="role_in_project">
                    <option value="manager">Manager</option>
                    <option value="member" selected>Member</option>
                    <option value="viewer">Viewer</option>
                </select>
            </div>

        </div>

        <div style="margin-top:14px">
            <button
                type="submit"
                style="
                    background:#1f6feb;
                    color:#fff;
                    padding:8px 14px;
                    border:none;
                    border-radius:6px;
                    font-weight:600;
                    cursor:pointer;
                ">
                âž• Assign to Project
            </button>
        </div>

    </form>
</div>
{% endif %}

</div>

{% endblock %}


----------------------------------------
FILE: .\app\templates\admin\user_sessions.html
----------------------------------------
{% extends "base.html" %}
{% block content %}

<h1 class="page-title">{{ title }}</h1>

<div class="card" style="margin-bottom:16px">
    <strong>User:</strong> {{ user_obj.username }} <br>
    <strong>Role:</strong> {{ user_obj.role | upper }}
</div>

<!-- âœ… TOTAL LOGGED-IN TIME (ADDED) -->
<div class="card" style="margin-bottom:16px">
    <strong>Total Logged-in Time:</strong>
    {% if total_logged_in_seconds %}
        {{ (total_logged_in_seconds // 3600) }}h
        {{ ((total_logged_in_seconds % 3600) // 60) }}m
    {% else %}
        0h 0m
    {% endif %}
</div>

<div class="card">
    <h3>Login / Logout History</h3>

    {% if sessions %}
        <table class="table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Login Time</th>
                    <th>Logout Time</th>
                    <th>Session Duration</th>
                </tr>
            </thead>
            <tbody>
            {% for s in sessions %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ s.login_time }}</td>
                    <td>
                        {% if s.logout_time %}
                            {{ s.logout_time }}
                        {% else %}
                            <span class="badge badge-warning">Active Session</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if s.session_duration %}
                            {{ (s.session_duration // 3600) }}h
                            {{ ((s.session_duration % 3600) // 60) }}m
                        {% else %}
                            â€”
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No login history available.</p>
    {% endif %}
</div>

<div style="margin-top:16px">
    <a href="/admin/users" class="btn-secondary">
        â† Back to Users
    </a>
</div>

{% endblock %}


----------------------------------------
FILE: .\app\templates\auth\login.html
----------------------------------------

----------------------------------------
FILE: .\app\templates\auth\register.html
----------------------------------------

----------------------------------------
FILE: .\app\templates\reports\daily_progress.html
----------------------------------------

----------------------------------------
FILE: .\app\templates\reports\material_consumption.html
----------------------------------------

----------------------------------------
FILE: .\app\templates\reports\reports_table.html
----------------------------------------

----------------------------------------
FILE: .\app\tests\test_calendar.py
----------------------------------------

----------------------------------------
FILE: .\app\tests\test_inventory.py
----------------------------------------

----------------------------------------
FILE: .\app\tests\test_schedule.py
----------------------------------------

----------------------------------------
FILE: .\app\tests\test_services.py
----------------------------------------

----------------------------------------
FILE: .\app\utils\converters.py
----------------------------------------
def to_float(value, default=0.0):
    try:
        return float(value)
    except Exception:
        return default


----------------------------------------
FILE: .\app\utils\date_utils.py
----------------------------------------
from datetime import datetime


def today_str():
    return datetime.now().strftime("%Y-%m-%d")


----------------------------------------
FILE: .\app\utils\file_io.py
----------------------------------------
import csv
import os
from typing import List, Dict

DATA_ROOT = os.path.join(os.getcwd(), "data", "raw")


def _ensure_file(path: str, headers: List[str] = None):
    os.makedirs(os.path.dirname(path), exist_ok=True)
    if not os.path.exists(path):
        with open(path, "w", newline="", encoding="utf-8") as f:
            if headers:
                writer = csv.DictWriter(f, fieldnames=headers)
                writer.writeheader()


def read_csv(filename: str) -> List[Dict]:
    path = os.path.join(DATA_ROOT, filename)
    if not os.path.exists(path):
        return []
    with open(path, "r", newline="", encoding="utf-8") as f:
        reader = csv.DictReader(f)
        return list(reader)


def write_csv(filename: str, rows: List[Dict], headers: List[str] = None):
    path = os.path.join(DATA_ROOT, filename)
    _ensure_file(path, headers or (list(rows[0].keys()) if rows else []))
    with open(path, "w", newline="", encoding="utf-8") as f:
        writer = csv.DictWriter(f, fieldnames=headers or rows[0].keys())
        writer.writeheader()
        for r in rows:
            writer.writerow(r)


def append_csv(filename: str, row: Dict, headers: List[str]):
    path = os.path.join(DATA_ROOT, filename)
    _ensure_file(path, headers)
    with open(path, "a", newline="", encoding="utf-8") as f:
        writer = csv.DictWriter(f, fieldnames=headers)
        writer.writerow(row)
import csv
from pathlib import Path


def read_csv_safe(path: str):
    file = Path(path)
    if not file.exists():
        return []
    with open(file, newline="", encoding="utf-8") as f:
        return list(csv.DictReader(f))


----------------------------------------
FILE: .\app\utils\flash.py
----------------------------------------
def flash(request, message: str, category: str = "info"):
    """
    Store a flash message in session.
    category: success | error | warning | info
    """
    request.session.setdefault("_flashes", [])
    request.session["_flashes"].append({
        "message": message,
        "category": category
    })


def get_flashed_messages(request):
    """
    Retrieve and clear flash messages from session.
    """
    return request.session.pop("_flashes", [])


----------------------------------------
FILE: .\app\utils\logger.py
----------------------------------------
import logging

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)

logger = logging.getLogger("InfraCore")


----------------------------------------
FILE: .\app\utils\math_utils.py
----------------------------------------

----------------------------------------
FILE: .\app\utils\validators.py
----------------------------------------
def not_empty(value: str) -> bool:
    return value is not None and value.strip() != ""


----------------------------------------
FILE: .\docs\api_docs.md
----------------------------------------

----------------------------------------
FILE: .\docs\architecture.md
----------------------------------------

----------------------------------------
FILE: .\docs\data_dictionary.md
----------------------------------------

----------------------------------------
FILE: .\docs\user_manual.md
----------------------------------------

----------------------------------------
FILE: .\scripts\backup_data.py
----------------------------------------

----------------------------------------
FILE: .\scripts\init_db.py
----------------------------------------

----------------------------------------
FILE: .\scripts\migrate_csv_to_db.py
----------------------------------------

----------------------------------------
FILE: .\scripts\seed_data.py
----------------------------------------

========= END OF EXPORT =========

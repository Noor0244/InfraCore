<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Details - InfraCore</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ux.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ui_v2.css') }}">
    <style>
        .bill-detail-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .bill-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .bill-header h1 {
            grid-column: 1 / -1;
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-size: 1.8rem;
        }

        .bill-meta {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .bill-meta-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .bill-meta-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .bill-meta-value {
            color: var(--text-secondary);
        }

        .bill-status-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
        }

        .status-pending {
            background: var(--warning-bg, #fef3c7);
            color: var(--warning-text, #92400e);
        }

        .status-partial {
            background: var(--info-bg, #dbeafe);
            color: var(--info-text, #1e40af);
        }

        .status-paid {
            background: var(--success-bg, #dcfce7);
            color: var(--success-text, #166534);
        }

        .status-overdue {
            background: var(--error-bg, #fee2e2);
            color: var(--error-text, #991b1b);
        }

        .bill-items-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent-color);
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .items-table thead th {
            background: var(--hover-bg);
            color: var(--text-primary);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
        }

        .items-table tbody td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .items-table tbody tr:hover {
            background: var(--hover-bg);
        }

        .table-amount {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: 500;
        }

        .bill-totals {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--border-color);
            max-width: 400px;
            margin-left: auto;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
        }

        .total-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .total-value {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: var(--accent-color);
        }

        .total-row.final {
            background: var(--hover-bg);
            padding: 0.75rem;
            border-radius: 4px;
            font-size: 1.1rem;
        }

        .payment-history-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .payments-table {
            width: 100%;
            border-collapse: collapse;
        }

        .payments-table thead th {
            background: var(--hover-bg);
            color: var(--text-primary);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
        }

        .payments-table tbody td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .payments-table tbody tr:hover {
            background: var(--hover-bg);
        }

        .no-data-message {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 2rem;
            justify-content: center;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--hover-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-danger {
            background: var(--error-bg, #fee2e2);
            color: var(--error-text, #991b1b);
        }

        .btn-danger:hover {
            opacity: 0.8;
        }

        .add-item-form {
            background: var(--hover-bg);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 20%, transparent);
        }

        .two-column-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        @media (max-width: 768px) {
            .bill-header {
                grid-template-columns: 1fr;
            }

            .two-column-grid {
                grid-template-columns: 1fr;
            }

            .items-table thead {
                font-size: 0.85rem;
            }

            .items-table tbody td {
                padding: 0.5rem;
                font-size: 0.9rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="bill-detail-container">
        <!-- Bill Header -->
        <div class="bill-header">
            <h1>Bill Details</h1>
            
            <div class="bill-meta">
                <div class="bill-meta-row">
                    <span class="bill-meta-label">Bill Number:</span>
                    <span class="bill-meta-value" id="billNumber">-</span>
                </div>
                <div class="bill-meta-row">
                    <span class="bill-meta-label">Status:</span>
                    <span class="bill-status-badge" id="billStatus">PENDING</span>
                </div>
                <div class="bill-meta-row">
                    <span class="bill-meta-label">Vendor:</span>
                    <span class="bill-meta-value" id="billVendor">-</span>
                </div>
                <div class="bill-meta-row">
                    <span class="bill-meta-label">Project:</span>
                    <span class="bill-meta-value" id="billProject">-</span>
                </div>
            </div>

            <div class="bill-meta">
                <div class="bill-meta-row">
                    <span class="bill-meta-label">Bill Date:</span>
                    <span class="bill-meta-value" id="billDate">-</span>
                </div>
                <div class="bill-meta-row">
                    <span class="bill-meta-label">Due Date:</span>
                    <span class="bill-meta-value" id="billDueDate">-</span>
                </div>
                <div class="bill-meta-row">
                    <span class="bill-meta-label">Type:</span>
                    <span class="bill-meta-value" id="billType">-</span>
                </div>
                <div class="bill-meta-row">
                    <span class="bill-meta-label">Total Amount:</span>
                    <span class="bill-meta-value" id="billTotalAmount" style="font-weight: 600; color: var(--accent-color);">‚Çπ0.00</span>
                </div>
            </div>
        </div>

        <!-- Bill Items Section -->
        <div class="bill-items-section">
            <div class="section-title">Bill Items</div>
            
            <table class="items-table">
                <thead>
                    <tr>
                        <th>Material</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Line Total</th>
                        <th>GST %</th>
                        <th>GST Amount</th>
                        <th>Line Total (+GST)</th>
                        <th style="text-align: center;">Actions</th>
                    </tr>
                </thead>
                <tbody id="billItemsBody">
                    <tr><td colspan="8" class="no-data-message">No items added yet</td></tr>
                </tbody>
            </table>

            <div class="bill-totals">
                <div class="total-row">
                    <span class="total-label">Subtotal:</span>
                    <span class="total-value" id="subtotal">‚Çπ0.00</span>
                </div>
                <div class="total-row">
                    <span class="total-label">Total GST:</span>
                    <span class="total-value" id="totalGST">‚Çπ0.00</span>
                </div>
                <div class="total-row final">
                    <span class="total-label">Grand Total:</span>
                    <span class="total-value" id="grandTotal">‚Çπ0.00</span>
                </div>
            </div>

            <!-- Add Item Form -->
            <div class="add-item-form" id="addItemForm" style="display: none;">
                <h3 style="color: var(--text-primary); margin-bottom: 1rem;">Add Item to Bill</h3>
                <div class="two-column-grid">
                    <div class="form-group">
                        <label for="materialSelect">Material *</label>
                        <select id="materialSelect" required>
                            <option value="">Select Material...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="vendorSelect">Vendor *</label>
                        <select id="vendorSelect" required>
                            <option value="">Select Vendor...</option>
                        </select>
                    </div>
                </div>
                <div class="two-column-grid">
                    <div class="form-group">
                        <label for="quantityInput">Quantity *</label>
                        <input type="number" id="quantityInput" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="unitPriceInput">Unit Price ‚Çπ *</label>
                        <input type="number" id="unitPriceInput" placeholder="0.00" step="0.01" required>
                    </div>
                </div>
                <div class="two-column-grid">
                    <div class="form-group">
                        <label for="gstPercentInput">GST % *</label>
                        <input type="number" id="gstPercentInput" placeholder="18" value="18" step="0.01" required>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="toggleAddItemForm()">Cancel</button>
                    <button class="btn btn-primary" onclick="submitAddItem()">Add Item</button>
                </div>
            </div>

            <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="toggleAddItemForm()">+ Add Item</button>
        </div>

        <!-- Payment History Section -->
        <div class="payment-history-section">
            <div class="section-title">Payment History</div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="background: var(--hover-bg); padding: 1rem; border-radius: 4px;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Total Paid</div>
                    <div style="font-size: 1.5rem; font-weight: 600; color: var(--accent-color);" id="totalPaid">‚Çπ0.00</div>
                </div>
                <div style="background: var(--hover-bg); padding: 1rem; border-radius: 4px;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Outstanding</div>
                    <div style="font-size: 1.5rem; font-weight: 600; color: var(--error-text, #991b1b);" id="outstanding">‚Çπ0.00</div>
                </div>
            </div>

            <table class="payments-table">
                <thead>
                    <tr>
                        <th>Payment Number</th>
                        <th>Payment Date</th>
                        <th>Amount Paid</th>
                        <th>Payment Method</th>
                        <th>Reconciled</th>
                    </tr>
                </thead>
                <tbody id="paymentsBody">
                    <tr><td colspan="5" class="no-data-message">No payments recorded yet</td></tr>
                </tbody>
            </table>

            <button class="btn btn-primary" style="margin-top: 1rem;" onclick="openPaymentModal()">Record Payment</button>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="downloadPDF()">üìÑ Download PDF</button>
            <button class="btn btn-secondary" onclick="printBill()">üñ®Ô∏è Print Bill</button>
            <button class="btn btn-danger" onclick="confirmDeleteBill()">üóëÔ∏è Delete Bill</button>
            <button class="btn btn-secondary" onclick="goBack()">‚Üê Back to Bills</button>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">Record Payment</div>
            
            <div class="form-group">
                <label for="paymentAmount">Amount (‚Çπ) *</label>
                <input type="number" id="paymentAmount" placeholder="0.00" step="0.01" required>
                <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;" id="amountHint"></small>
            </div>

            <div class="form-group">
                <label for="paymentDate">Payment Date *</label>
                <input type="date" id="paymentDate" required>
            </div>

            <div class="form-group">
                <label for="paymentMethod">Payment Method *</label>
                <select id="paymentMethod" required>
                    <option value="">Select Method...</option>
                    <option value="CHEQUE">Cheque</option>
                    <option value="NEFT">NEFT</option>
                    <option value="RTGS">RTGS</option>
                    <option value="CASH">Cash</option>
                    <option value="UPI">UPI</option>
                    <option value="BANK_TRANSFER">Bank Transfer</option>
                </select>
            </div>

            <div class="form-group" id="chequeDetails" style="display: none;">
                <label for="chequeNumber">Cheque Number</label>
                <input type="text" id="chequeNumber" placeholder="CH123456">
            </div>

            <div class="form-group" id="bankDetails" style="display: none;">
                <label for="bankName">Bank Name</label>
                <input type="text" id="bankName" placeholder="Bank Name">
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="reconcilledCheckbox">
                    Mark as Reconciled
                </label>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitPayment()">Record Payment</button>
            </div>
        </div>
    </div>

    <script>
        const billId = new URLSearchParams(window.location.search).get('id');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadBillDetails();
            setPaymentDate();
            setupPaymentMethodListener();
        });

        function setPaymentDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('paymentDate').value = today;
        }

        function setupPaymentMethodListener() {
            const method = document.getElementById('paymentMethod');
            method.addEventListener('change', function() {
                document.getElementById('chequeDetails').style.display = 
                    this.value === 'CHEQUE' ? 'block' : 'none';
                document.getElementById('bankDetails').style.display = 
                    ['NEFT', 'RTGS', 'BANK_TRANSFER'].includes(this.value) ? 'block' : 'none';
            });
        }

        async function loadBillDetails() {
            try {
                const response = await fetch(`/api/billing/bills/${billId}`);
                if (!response.ok) throw new Error('Bill not found');
                
                const bill = await response.json();
                displayBillDetails(bill);
                loadBillItems(billId);
                loadPayments(billId);
            } catch (error) {
                console.error('Error loading bill:', error);
                alert('Failed to load bill details');
            }
        }

        function displayBillDetails(bill) {
            document.getElementById('billNumber').textContent = bill.bill_number;
            document.getElementById('billVendor').textContent = bill.vendor_name || 'N/A';
            document.getElementById('billProject').textContent = bill.project_name || 'N/A';
            document.getElementById('billDate').textContent = formatDate(bill.bill_date);
            document.getElementById('billDueDate').textContent = formatDate(bill.due_date);
            document.getElementById('billType').textContent = bill.bill_type || 'STANDARD';
            document.getElementById('billTotalAmount').textContent = formatCurrency(bill.total_amount);
            
            // Set status badge
            const statusEl = document.getElementById('billStatus');
            statusEl.textContent = bill.payment_status;
            statusEl.className = 'bill-status-badge status-' + bill.payment_status.toLowerCase();
            
            document.getElementById('totalPaid').textContent = formatCurrency(bill.paid_amount);
            document.getElementById('outstanding').textContent = formatCurrency(bill.outstanding_amount);
            
            // Update payment amount hint
            document.getElementById('amountHint').textContent = 
                `Outstanding: ${formatCurrency(bill.outstanding_amount)}`;
        }

        async function loadBillItems(billId) {
            try {
                const response = await fetch(`/api/billing/bills/${billId}/items`);
                if (!response.ok) throw new Error('Items not found');
                
                const items = await response.json();
                displayBillItems(items);
            } catch (error) {
                console.error('Error loading items:', error);
            }
        }

        function displayBillItems(items) {
            const tbody = document.getElementById('billItemsBody');
            
            if (!items || items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data-message">No items added yet</td></tr>';
                return;
            }
            
            let subtotal = 0;
            let totalGST = 0;
            
            tbody.innerHTML = items.map(item => {
                const lineTotal = item.quantity * item.unit_price;
                const gstAmount = lineTotal * (item.gst_percentage / 100);
                const lineTotalWithGST = lineTotal + gstAmount;
                
                subtotal += lineTotal;
                totalGST += gstAmount;
                
                return `
                    <tr>
                        <td>${item.material_name || 'N/A'}</td>
                        <td>${parseFloat(item.quantity).toFixed(2)}</td>
                        <td class="table-amount">‚Çπ${parseFloat(item.unit_price).toFixed(2)}</td>
                        <td class="table-amount">‚Çπ${lineTotal.toFixed(2)}</td>
                        <td>${parseFloat(item.gst_percentage).toFixed(2)}%</td>
                        <td class="table-amount">‚Çπ${gstAmount.toFixed(2)}</td>
                        <td class="table-amount" style="font-weight: 600; color: var(--accent-color);">‚Çπ${lineTotalWithGST.toFixed(2)}</td>
                        <td style="text-align: center;">
                            <button class="btn btn-secondary" onclick="removeItem(${item.id})" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">Remove</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('totalGST').textContent = formatCurrency(totalGST);
            document.getElementById('grandTotal').textContent = formatCurrency(subtotal + totalGST);
        }

        async function loadPayments(billId) {
            try {
                const response = await fetch(`/api/billing/payments/${billId}`);
                if (!response.ok) throw new Error('Payments not found');
                
                const payments = await response.json();
                displayPayments(payments);
            } catch (error) {
                console.error('Error loading payments:', error);
            }
        }

        function displayPayments(payments) {
            const tbody = document.getElementById('paymentsBody');
            
            if (!payments || payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data-message">No payments recorded yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = payments.map(payment => `
                <tr>
                    <td>${payment.payment_number}</td>
                    <td>${formatDate(payment.payment_date)}</td>
                    <td class="table-amount">‚Çπ${parseFloat(payment.amount_paid).toFixed(2)}</td>
                    <td>${payment.payment_method}</td>
                    <td>${payment.is_reconciled ? '‚úì Yes' : 'No'}</td>
                </tr>
            `).join('');
        }

        function toggleAddItemForm() {
            const form = document.getElementById('addItemForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        async function submitAddItem() {
            // Implementation will call the API
            alert('Add item functionality will be implemented');
        }

        function openPaymentModal() {
            document.getElementById('paymentModal').classList.add('active');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
        }

        async function submitPayment() {
            // Implementation will call the API
            alert('Payment recording functionality will be implemented');
        }

        function removeItem(itemId) {
            if (confirm('Remove this item from the bill?')) {
                // Implementation will call the API
                alert('Item removal functionality will be implemented');
            }
        }

        function downloadPDF() {
            alert('PDF download functionality will be implemented');
        }

        function printBill() {
            window.print();
        }

        function confirmDeleteBill() {
            if (confirm('Are you sure you want to delete this bill? This action cannot be undone.')) {
                // Implementation will call the API
                alert('Bill deletion functionality will be implemented');
            }
        }

        function goBack() {
            window.location.href = '/app/billing/dashboard';
        }

        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return '‚Çπ0.00';
            return '‚Çπ' + parseFloat(amount).toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
    </script>
</body>
</html>

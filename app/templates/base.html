<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>InfraCore</title>

    <!-- Viewport for mobile responsiveness -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <!-- Main CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- UI v2 overrides (modern spacing + polish) -->
    <link rel="stylesheet" href="/static/css/ui_v2.css">
    <!-- Small helper styles (use theme variables from style.css) -->
    <style>
        a, a:visited { color: var(--text); text-decoration: none; }
        a:hover, a:focus { color: var(--accent-color); text-decoration: underline; }
        label { color: var(--text); font-weight: 600; margin-bottom: 6px; }

        .form-section { padding: 14px 0; margin-bottom: 18px; }
        .section-title { font-size: 16px; color: var(--text); font-weight: 700; }
        .help-text { font-size: 12px; color: var(--text-muted); margin-top: 6px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 14px; }

        .btn-primary {
            background: var(--btn);
            color: #fff;
            padding: 9px 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }
        .btn-secondary {
            background: #6b7280;
            color: #fff;
            padding: 9px 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }
        .required { color: #dc2626; }
        .project-helper { font-size: 12px; color: var(--text-muted); margin-top: 6px; }
    </style>

    <!-- Dark mode script (runs before page paint) -->
    <script>
        (function () {
            const theme = localStorage.getItem("theme");
            if (theme === "dark") {
                document.documentElement.classList.add("dark");
                return;
            }

            if (theme === "light") {
                document.documentElement.classList.remove("dark");
                return;
            }

            // "system" or unset => follow OS preference
            if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
                document.documentElement.classList.add("dark");
            } else {
                document.documentElement.classList.remove("dark");
            }
        })();
    </script>
</head>
<body>


<div class="layout">
    <!-- Sidebar show/hide buttons (right side) -->
    <!-- Sidebar show button (left, at InfraCore logo position) -->
    <button id="sidebarShowBtn" style="display:none;position:fixed;top:32px;left:0;z-index:2000;background:yellow;color:#2563eb;border:2px solid red;padding:10px 14px 10px 6px;border-radius:0 8px 8px 0;box-shadow:0 2px 8px rgba(0,0,0,0.12);font-size:20px;" aria-label="Show sidebar">‚´∂</button>
    <!-- ================= SIDEBAR ================= -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-header-row">
                <h2 class="sidebar-title">InfraCore</h2>
                <button id="sidebarHideBtn" class="sidebar-toggle-btn" aria-label="Hide sidebar">‚Üê</button>
            </div>
        </div>
        {% if user is defined and user is not none %}
        <div class="sidebar-user">
            <strong class="sidebar-username">{{ user["username"] }}</strong>
            <span class="sidebar-role">
                {% if user["role"] == "superadmin" %}
                    SUPERADMIN
                {% else %}
                    {{ user["role"] | upper }}
                {% endif %}
            </span>
        </div>
        <nav class="sidebar-nav">
            {% if user["role"] == "superadmin" %}
                <!-- ================= ADMIN CONSOLE ================= -->
                <a href="/admin/users" class="{% if request.url.path.startswith('/admin') %}active{% endif %}"><span class="icon">üõ†Ô∏è</span>Admin Console</a>
                <!-- ================= DASHBOARD ================= -->
                <a href="/dashboard" class="{% if request.url.path == '/dashboard' %}active{% endif %}"><span class="icon">üìä</span>Dashboard</a>
                <!-- ================= PROJECTS ================= -->
                <a href="/projects" class="{% if request.url.path.startswith('/projects') %}active{% endif %}"><span class="icon">üèóÔ∏è</span>Projects</a>
                <!-- ================= PROCUREMENT ================= -->
                <a href="/procurement" class="{% if request.url.path.startswith('/procurement') %}active{% endif %}"><span class="icon">üì¶</span>Procurement</a>
                <!-- ================= REPORTS ================= -->
                <a href="/reports" class="{% if request.url.path.startswith('/reports') %}active{% endif %}"><span class="icon">üìÑ</span>Reports</a>
                <!-- ================= SETTINGS ================= -->
                <a href="/settings" class="{% if request.url.path == '/settings' %}active{% endif %}"><span class="icon">‚öôÔ∏è</span>Settings</a>
            {% elif user["role"] == "admin" %}
                <!-- ================= DASHBOARD ================= -->
                <a href="/dashboard" class="{% if request.url.path == '/dashboard' %}active{% endif %}"><span class="icon">üìä</span>Dashboard</a>
                <!-- ================= PROJECTS ================= -->
                <a href="/projects" class="{% if request.url.path.startswith('/projects') %}active{% endif %}"><span class="icon">üèóÔ∏è</span>Projects</a>
                <!-- ================= PROCUREMENT ================= -->
                <a href="/procurement" class="{% if request.url.path.startswith('/procurement') %}active{% endif %}"><span class="icon">üì¶</span>Procurement</a>
                <!-- ================= REPORTS ================= -->
                <a href="/reports" class="{% if request.url.path.startswith('/reports') %}active{% endif %}"><span class="icon">üìÑ</span>Reports</a>
            {% else %}
                <!-- ================= DASHBOARD ================= -->
                <a href="/dashboard" class="{% if request.url.path == '/dashboard' %}active{% endif %}"><span class="icon">üìä</span>Dashboard</a>
            {% endif %}
        </nav>
        <div class="sidebar-footer"></div>
        {% endif %}
    </aside>
        <a href="/logout" class="logout-top-btn" style="position:fixed;top:16px;right:24px;z-index:4000;">Logout</a>
    <!-- ================= MAIN ================= -->
    <main class="main">
        <!-- ================= FLASH MESSAGES ================= -->
        {% if request.state is defined and request.state.flashes is defined %}
        <div class="flash-container">
            {% for flash in request.state.flashes %}
                <div class="flash flash-{{ flash.category }}">
                    {{ flash.message }}
                </div>
            {% endfor %}
        </div>
        {% endif %}
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </main>
</div>

<!-- Sidebar show/hide script -->
<script>
    function updateSidebarButtons() {
        var sidebar = document.getElementById('sidebar');
        var showBtn = document.getElementById('sidebarShowBtn');
        var hideBtn = document.getElementById('sidebarHideBtn');
        if (!sidebar || !showBtn || !hideBtn) return;
        // Find the vertical position of the InfraCore logo
        var header = document.querySelector('.sidebar-header');
        if (header) {
            var rect = header.getBoundingClientRect();
            showBtn.style.top = rect.top + window.scrollY + 'px';
        }
        if (sidebar.style.display === 'none' || window.getComputedStyle(sidebar).display === 'none') {
            showBtn.style.display = 'block';
            hideBtn.style.display = 'none';
        } else {
            showBtn.style.display = 'none';
            hideBtn.style.display = 'block';
        }
    }
    function showSidebar() {
        var sidebar = document.getElementById('sidebar');
        var showBtn = document.getElementById('sidebarShowBtn');
        var hideBtn = document.getElementById('sidebarHideBtn');
        sidebar.style.display = 'block';
        showBtn.style.display = 'none';
        hideBtn.style.display = 'block';
        sidebar.style.position = '';
        sidebar.style.top = '';
        sidebar.style.left = '';
        sidebar.style.height = '';
        sidebar.style.zIndex = '';
        sidebar.style.background = '';
        sidebar.style.boxShadow = '';
    }
    function hideSidebar() {
        var sidebar = document.getElementById('sidebar');
        var showBtn = document.getElementById('sidebarShowBtn');
        var hideBtn = document.getElementById('sidebarHideBtn');
        sidebar.style.display = 'none';
        showBtn.style.display = 'block';
        hideBtn.style.display = 'none';
        // Move showBtn to the same vertical position as the InfraCore logo
        var header = document.querySelector('.sidebar-header');
        if (header) {
            var rect = header.getBoundingClientRect();
            showBtn.style.top = rect.top + window.scrollY + 'px';
        }
    }
    window.addEventListener('resize', updateSidebarButtons);
    window.addEventListener('DOMContentLoaded', function() {
        updateSidebarButtons();
        document.getElementById('sidebarShowBtn').onclick = showSidebar;
        document.getElementById('sidebarHideBtn').onclick = hideSidebar;
    });
</script>


<!-- Auto Units (material -> standard unit + allowed units dropdown) -->
<script src="/static/js/material_units.js"></script>

<!-- Global DD/MM/YYYY date input formatter -->
<script src="/static/js/date_input_format.js"></script>

<!-- Auto-logout after 30 minutes of inactivity -->
<script>
    let logoutTimer;
    function resetLogoutTimer() {
        clearTimeout(logoutTimer);
        // 30 minutes = 30 * 60 * 1000 ms
        logoutTimer = setTimeout(function() {
            window.location.href = "/logout";
        }, 30 * 60 * 1000);
    }
    // Reset timer on any user activity
    ["click", "mousemove", "keydown", "scroll", "touchstart"].forEach(function(event) {
        document.addEventListener(event, resetLogoutTimer, true);
    });
    resetLogoutTimer();
</script>

{% block scripts %}{% endblock %}

</body>
</html>

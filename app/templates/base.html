<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=5, user-scalable=yes, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="InfraCore">
    <meta name="theme-color" content="#2563eb">
    <title>InfraCore</title>

    <!-- Main CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- Dynamic Responsive CSS (device-aware) -->
    <link rel="stylesheet" href="/static/css/responsive.css">
    <!-- Mobile Optimization CSS -->
    <link rel="stylesheet" href="/static/css/mobile.css">
    <!-- UI v2 overrides (modern spacing + polish) -->
    <link rel="stylesheet" href="/static/css/ui_v2.css">
    
    <!-- Device Detection Script (loads before rendering) -->
    <script src="/static/js/device-detector.js"></script>
    <!-- Small helper styles (use theme variables from style.css) -->
    <style>
        a, a:visited { color: var(--text); text-decoration: none; }

        a:hover, a:focus { color: var(--accent-color); text-decoration: underline; }
        label { color: var(--text); font-weight: 600; margin-bottom: 6px; }

        .form-section { padding: 14px 0; margin-bottom: 18px; }
        .section-title { font-size: 16px; color: var(--text); font-weight: 700; }
        .help-text { font-size: 12px; color: var(--text-muted); margin-top: 6px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 14px; }

        .btn-primary {
            background: var(--btn);
            color: #fff;
            padding: 9px 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }
        .btn-secondary {
            background: #e5e7eb;
            color: #111827;
            padding: 9px 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }
        .required { color: #dc2626; }
        .project-helper { font-size: 12px; color: var(--text-muted); margin-top: 6px; }
    </style>

    <!-- Dark mode script (runs before page paint) -->
    <script>
        (function () {
            const html = document.documentElement;
            const darkModeQuery = window.matchMedia('(prefers-color-scheme: dark)');
            
            // Check initial system preference and apply it
            if (darkModeQuery.matches) {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
            
            // Listen for system theme changes
            darkModeQuery.addEventListener('change', (e) => {
                if (e.matches) {
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                }
            });
        })();
    </script>
</head>
<body>


<div class="layout">
    <!-- Sidebar show/hide buttons (right side) -->
    <!-- Sidebar show button (left, at InfraCore logo position) -->
    <button id="sidebarShowBtn" class="sidebar-show-btn" aria-label="Show sidebar">‚ò∞</button>
    <!-- ================= SIDEBAR ================= -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-header-row">
                <h2 class="sidebar-title">InfraCore</h2>
                <button id="sidebarHideBtn" class="sidebar-toggle-btn" aria-label="Hide sidebar">‚Üê</button>
            </div>
        </div>
        {% if user is defined and user is not none %}
        <div class="sidebar-user">
            <strong class="sidebar-username">{{ user["username"] }}</strong>
            <span class="sidebar-role">
                {% if user["role"] == "superadmin" %}
                    SUPERADMIN
                {% else %}
                    {{ user["role"] | upper }}
                {% endif %}
            </span>
        </div>
        <nav class="sidebar-nav">
            {% if user["role"] == "superadmin" %}
                <!-- ================= ADMIN CONSOLE ================= -->
                <a href="/admin/users" class="{% if request.url.path.startswith('/admin') %}active{% endif %}"><span class="icon">üõ†Ô∏è</span>Admin Console</a>
                <!-- ================= DASHBOARD ================= -->
                <a href="/dashboard" class="{% if request.url.path == '/dashboard' %}active{% endif %}"><span class="icon">üìä</span>Dashboard</a>
                <!-- ================= PROJECTS ================= -->
                <a href="/projects" class="{% if request.url.path.startswith('/projects') %}active{% endif %}"><span class="icon">üèóÔ∏è</span>Projects</a>
                <!-- ================= PROCUREMENT ================= -->
                <a href="/procurement" class="{% if request.url.path.startswith('/procurement') %}active{% endif %}"><span class="icon">üì¶</span>Procurement</a>
                <!-- ================= REPORTS ================= -->
                <a href="/reports" class="{% if request.url.path.startswith('/reports') %}active{% endif %}"><span class="icon">üìÑ</span>Reports</a>
                <!-- ================= SETTINGS ================= -->
                <a href="/settings" class="{% if request.url.path == '/settings' %}active{% endif %}"><span class="icon">‚öôÔ∏è</span>Settings</a>
            {% elif user["role"] == "admin" %}
                <!-- ================= DASHBOARD ================= -->
                <a href="/dashboard" class="{% if request.url.path == '/dashboard' %}active{% endif %}"><span class="icon">üìä</span>Dashboard</a>
                <!-- ================= PROJECTS ================= -->
                <a href="/projects" class="{% if request.url.path.startswith('/projects') %}active{% endif %}"><span class="icon">üèóÔ∏è</span>Projects</a>
                <!-- ================= PROCUREMENT ================= -->
                <a href="/procurement" class="{% if request.url.path.startswith('/procurement') %}active{% endif %}"><span class="icon">üì¶</span>Procurement</a>
                <!-- ================= CURRENT STOCK ================= -->
                <a href="/stock/current" class="{% if request.url.path.startswith('/stock/current') %}active{% endif %}"><span class="icon">üì¶</span>Current Stock</a>
                <!-- ================= REPORTS ================= -->
                <a href="/reports" class="{% if request.url.path.startswith('/reports') %}active{% endif %}"><span class="icon">üìÑ</span>Reports</a>
            {% else %}
                <!-- ================= DASHBOARD ================= -->
                <a href="/dashboard" class="{% if request.url.path == '/dashboard' %}active{% endif %}"><span class="icon">üìä</span>Dashboard</a>
            {% endif %}
        </nav>
        <div class="sidebar-footer"></div>
        {% endif %}
    </aside>
        <a href="/logout" class="logout-top-btn" style="position:fixed;top:16px;right:24px;z-index:4000;">Logout</a>
    <!-- ================= MAIN ================= -->
    <main class="main">
        <!-- ================= FLASH MESSAGES ================= -->
        {% if request.state is defined and request.state.flashes is defined %}
        <div class="flash-container">
            {% for flash in request.state.flashes %}
                <div class="flash flash-{{ flash.category }}">
                    {{ flash.message }}
                </div>
            {% endfor %}
        </div>
        {% endif %}
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </main>
</div>

<!-- Sidebar show/hide script -->
<script>
    (function() {
        const sidebar = document.getElementById('sidebar');
        const showBtn = document.getElementById('sidebarShowBtn');
        const hideBtn = document.getElementById('sidebarHideBtn');
        
        if (!sidebar || !showBtn || !hideBtn) return;
        
        // Check if device is mobile/tablet
        function isMobileOrTablet() {
            const width = window.innerWidth;
            return width <= 768;
        }
        
        // Initialize sidebar state based on screen size
        function initializeSidebar() {
            if (isMobileOrTablet()) {
                sidebar.classList.remove('visible');
                showBtn.style.display = 'block';
            } else {
                sidebar.classList.remove('visible');
                showBtn.style.display = 'none';
            }
        }
        
        // Show sidebar
        function showSidebar() {
            sidebar.classList.add('visible');
            showBtn.style.display = 'none';
        }
        
        // Hide sidebar
        function hideSidebar() {
            sidebar.classList.remove('visible');
            if (isMobileOrTablet()) {
                showBtn.style.display = 'block';
            }
        }
        
        // Handle resize events
        function handleResize() {
            if (!isMobileOrTablet()) {
                sidebar.classList.remove('visible');
                showBtn.style.display = 'none';
            } else {
                showBtn.style.display = sidebar.classList.contains('visible') ? 'none' : 'block';
            }
        }
        
        // Event listeners
        showBtn.addEventListener('click', showSidebar);
        hideBtn.addEventListener('click', hideSidebar);
        window.addEventListener('resize', handleResize);
        
        // Close sidebar when clicking on a navigation link (on mobile)
        const navLinks = sidebar.querySelectorAll('.sidebar-nav a');
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (isMobileOrTablet()) {
                    hideSidebar();
                }
            });
        });
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSidebar();
        });
        
        // Also initialize immediately in case DOM is already loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeSidebar);
        } else {
            initializeSidebar();
        }
    })();
</script>


<!-- Auto Units (material -> standard unit + allowed units dropdown) -->
<script src="/static/js/material_units.js"></script>

<!-- Global DD/MM/YYYY date input formatter -->
<script src="/static/js/date_input_format.js"></script>

<!-- Auto-logout after 30 minutes of inactivity -->
<script>
    let logoutTimer;
    function resetLogoutTimer() {
        clearTimeout(logoutTimer);
        // 30 minutes = 30 * 60 * 1000 ms
        logoutTimer = setTimeout(function() {
            window.location.href = "/logout";
        }, 30 * 60 * 1000);
    }
    // Reset timer on any user activity
    ["click", "mousemove", "keydown", "scroll", "touchstart"].forEach(function(event) {
        document.addEventListener(event, resetLogoutTimer, true);
    });
    resetLogoutTimer();
</script>

{% block scripts %}{% endblock %}

</body>
</html>

<!-- Real-Time Date & Time Widget -->
<div style="width:100%;background:#232946;color:#fff;text-align:center;padding:6px 0 4px 0;font-size:15px;letter-spacing:0.5px;z-index:2001;position:relative;">
    <span id="realtime-clock"></span>
    <a href="https://time.is/" target="_blank" style="color:#4f8cff;text-decoration:underline;margin-left:12px;font-size:13px;">(More at time.is)</a>
</div>
<script>
function updateClock() {
    const now = new Date();
    const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
    document.getElementById('realtime-clock').textContent = now.toLocaleString('en-US', options);
}
setInterval(updateClock, 1000);
updateClock();
</script>

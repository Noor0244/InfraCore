{% extends "base.html" %}
{% block content %}

<h1 class="page-title">Procurement Log — {{ project.name }}</h1>
<div class="help-text">Store promised lead time and actual delivery dates (vendor intelligence). This does not change planning baselines.</div>

{% if projects is defined and projects|length > 0 %}
<div style="margin-top:10px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
  <label style="margin:0;font-size:12px">Project:</label>
  <select onchange="if(this.value) window.location.href='/procurement/' + this.value" style="padding:6px 8px;font-size:13px;max-width:520px">
    {% for p in projects %}
      <option value="{{ p.id }}" {% if project.id == p.id %}selected{% endif %}>{{ p.name }} — {{ p.city }}</option>
    {% endfor %}
  </select>
</div>
{% endif %}

<div class="card" style="margin-top:14px">
  <h3 style="margin:0 0 8px 0">New procurement entry</h3>
  <form method="post" action="/procurement/logs/create" class="form-grid">
    <input type="hidden" name="project_id" value="{{ project.id }}">

    <div>
      <label for="pl_material">Material</label>
      <select id="pl_material" name="material_id" required>
        <option value="">(Select material)</option>
        {% for m in materials %}
          <option value="{{ m.id }}">{% if m.code %}{{ m.code }} — {% endif %}{{ m.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label for="pl_vendor">Vendor</label>
      <select id="pl_vendor" name="vendor_id">
        <option value="">(No vendor)</option>
      </select>
      <div class="help-text">If vendor is selected, we can score reliability later.</div>
    </div>

    <div>
      <label for="pl_activity">Activity (optional)</label>
      <select id="pl_activity" name="activity_id">
        <option value="">(Not linked to an activity)</option>
        {% for a in activities %}
          <option value="{{ a.id }}">{% if a.code %}{{ a.code }} — {% endif %}{{ a.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label for="pl_order_date">Order Date <span class="required">*</span></label>
      <!-- DD/MM/YYYY: Slashes auto-inserted, 4-digit year only -->
      <input id="pl_order_date" type="text" name="order_date" value="{{ today|ddmmyyyy }}" placeholder="DD/MM/YYYY" inputmode="numeric" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}" required>
    </div>

    <div>
      <label for="pl_promised">Promised Delivery Date</label>
      <!-- DD/MM/YYYY: Slashes auto-inserted, 4-digit year only -->
      <input id="pl_promised" type="text" name="promised_delivery_date" placeholder="DD/MM/YYYY" inputmode="numeric" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}">
    </div>

    <div>
      <label for="pl_delivered">Actual Delivered Date</label>
      <input id="pl_delivered" type="text" name="delivered_date" placeholder="DD/MM/YYYY" inputmode="numeric" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}">
    </div>

    <div>
      <label for="pl_qty">Quantity</label>
      <input id="pl_qty" type="number" step="0.001" min="0" name="quantity" placeholder="(optional)">
    </div>

    <div>
      <label for="pl_unit">Unit</label>
      <input id="pl_unit" type="text" name="unit" placeholder="e.g. bags / MT / m3">
    </div>

    <div style="grid-column: 1 / -1;">
      <label for="pl_notes">Notes</label>
      <textarea id="pl_notes" name="notes" rows="2" placeholder="PO #, driver name, issues, etc."></textarea>
    </div>

    <div style="display:flex; gap:10px; align-items:center">
      <button type="submit" class="btn-primary">Save entry</button>
      <a class="btn-secondary" href="/dashboard">Back to dashboard</a>
    </div>
  </form>
</div>

<div class="card" style="margin-top:14px">
  <h3 style="margin:0 0 10px 0">Recent entries</h3>
  {% if logs and logs|length > 0 %}
  <div style="overflow:auto">
    <table class="table" style="min-width: 1100px">
      <thead>
        <tr>
          <th>Order Date</th>
          <th>Material</th>
          <th>Vendor</th>
          <th>Promised Delivery</th>
          <th>Promised LT</th>
          <th>Delivered</th>
          <th>Actual LT</th>
          <th style="text-align:right">Qty</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        {% for row, m, v, a in logs %}
        <tr>
          <td>{{ row.order_date|ddmmyyyy }}</td>
          <td>
            {% if m.code %}<span class="badge">{{ m.code }}</span>{% endif %}
            {{ m.name }}
            {% if a %}<div class="meta">Activity: {% if a.code %}{{ a.code }} — {% endif %}{{ a.name }}</div>{% endif %}
          </td>
          <td>{% if v %}{{ v.vendor_name }}{% else %}—{% endif %}</td>
          <td>{{ (row.promised_delivery_date|ddmmyyyy) if row.promised_delivery_date else '—' }}</td>
          <td>{% if row.promised_lead_time_days is not none %}{{ row.promised_lead_time_days }}d{% else %}—{% endif %}</td>
          <td>{{ (row.delivered_date|ddmmyyyy) if row.delivered_date else '—' }}</td>
          <td>{% if row.actual_lead_time_days is not none %}{{ row.actual_lead_time_days }}d{% else %}—{% endif %}</td>
          <td style="text-align:right">{% if row.quantity is not none %}{{ row.quantity }}{% else %}—{% endif %} {% if row.unit %}<span class="meta">{{ row.unit }}</span>{% endif %}</td>
          <td style="max-width: 380px">{{ row.notes or '' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <div class="meta">No procurement entries yet.</div>
  {% endif %}
</div>

<script id="vendorsByMaterialJson" type="application/json">{{ vendors_by_material_json | tojson }}</script>

{% endblock %}

{% block scripts %}
<script>
  (function () {
    function parseJson(id) {
      const el = document.getElementById(id);
      if (!el) return {};
      try { return JSON.parse(el.textContent || '{}'); } catch { return {}; }
    }

    const vendorsByMaterial = parseJson('vendorsByMaterialJson');
    const materialSel = document.getElementById('pl_material');
    const vendorSel = document.getElementById('pl_vendor');

    function rebuild(materialId) {
      if (!vendorSel) return;
      const list = vendorsByMaterial[String(materialId)] || [];
      const options = ['<option value="">(No vendor)</option>'];
      list.forEach(v => {
        const inactive = v.is_active === false;
        const label = inactive ? `${v.vendor_name} (inactive)` : `${v.vendor_name} (LT ${Number(v.lead_time_days||0)}d)`;
        options.push(`<option value="${v.id}">${label}</option>`);
      });
      vendorSel.innerHTML = options.join('');
    }

    if (materialSel) {
      materialSel.addEventListener('change', function () {
        rebuild(materialSel.value);
      });
    }
  })();
</script>
{% endblock %}

{% extends "base.html" %}
{% block content %}

<h1 class="page-title">Procurement Log — {{ project.name }}</h1>
<div class="help-text">Store promised lead time and actual delivery dates (vendor intelligence). This does not change planning baselines.</div>

{% if projects is defined and projects|length > 0 %}
<div style="margin-top:10px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
  <label style="margin:0;font-size:12px">Project:</label>
  <select onchange="if(this.value) window.location.href='/procurement/' + this.value" style="padding:6px 8px;font-size:13px;max-width:520px">
    {% for p in projects %}
      <option value="{{ p.id }}" {% if project.id == p.id %}selected{% endif %}>{{ p.name }} — {{ p.city }}</option>
    {% endfor %}
  </select>
</div>
{% endif %}

<div class="card" style="margin-top:14px">
  <h3 style="margin:0 0 8px 0">New procurement entry</h3>
  <button type="button" class="btn" style="float:right;margin-top:-36px;margin-right:4px" onclick="document.getElementById('addVendorModal').style.display='block'">+ Add Vendor</button>
  <form method="post" action="/procurement/logs/create" class="form-grid">
        {% if stretches and stretches|length > 0 %}
        <div>
          <label for="pl_stretch">Stretch</label>
          <select id="pl_stretch" name="stretch_id">
            <option value="">(Select stretch)</option>
            {% for s in stretches %}
              <option value="{{ s.id }}">{{ s.stretch_code }} — {{ s.stretch_name }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
    <input type="hidden" name="project_id" value="{{ project.id }}">

    <div>
      <label for="pl_material">Material</label>
      <select id="pl_material" name="material_id" required>
        <option value="">(Select material)</option>
        {% for m in materials %}
          <option value="{{ m.id }}">{% if m.code %}{{ m.code }} — {% endif %}{{ m.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label for="pl_vendor">Vendor</label>
      <select id="pl_vendor" name="vendor_id">
        <option value="">(No vendor)</option>
        {% for v in vendors %}
          <option value="{{ v.id }}" data-material="{{ v.material_id }}">{{ v.vendor_name }}</option>
        {% endfor %}
      </select>
      <div class="help-text">If vendor is selected, we can score reliability later.</div>
      <div id="leadTimeDisplay" style="margin-top:4px;color:#7dd3fc;font-size:13px"></div>

      <!-- Add Vendor Modal -->
      <div id="addVendorModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
        <div style="background:#181f2a;padding:32px 24px 24px 24px;border-radius:12px;max-width:420px;margin:60px auto;position:relative;">
          <button onclick="document.getElementById('addVendorModal').style.display='none'" style="position:absolute;top:10px;right:14px;font-size:20px;background:none;border:none;color:#fff;cursor:pointer">&times;</button>
          <h3 style="margin-top:0">Add New Vendor</h3>
          <form method="post" action="/material-master/materials/add-vendor-from-procurement" id="addVendorForm">
            <div style="margin-bottom:10px">
              <label>Material</label>
              <select name="material_id" id="modal_material_id" required>
                {% for m in materials %}
                  <option value="{{ m.id }}">{% if m.code %}{{ m.code }} — {% endif %}{{ m.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div style="margin-bottom:10px">
              <label>Vendor Name</label>
              <input name="vendor_name" type="text" required style="width:100%" />
            </div>
            <div style="margin-bottom:10px">
              <label>Lead Time (days)</label>
              <input name="lead_time_days" type="number" min="0" value="0" required style="width:100%" />
            </div>
            <div style="margin-bottom:10px">
              <label>Contact Person</label>
              <input name="contact_person" type="text" style="width:100%" />
            </div>
            <div style="margin-bottom:10px">
              <label>Phone</label>
              <input name="phone" type="text" style="width:100%" />
            </div>
            <div style="margin-bottom:10px">
              <label>Email</label>
              <input name="email" type="email" style="width:100%" />
            </div>
            <div style="margin-bottom:10px">
              <label>Min Order Qty</label>
              <input name="min_order_qty" type="number" step="0.01" min="0" style="width:100%" />
            </div>
            <div style="text-align:right">
              <button type="submit" class="btn-primary">Add Vendor</button>
            </div>
          </form>
          <script>
          // On modal submit, use AJAX to add vendor and refresh dropdown
          document.getElementById('addVendorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const modalMat = document.getElementById('modal_material_id').value;
            const mainMat = document.getElementById('pl_material');
            fetch(form.action, {
              method: 'POST',
              body: formData,
            })
            .then(response => response.json())
            .then(data => {
              if (data && data.vendor_id) {
                document.getElementById('addVendorModal').style.display = 'none';
                if (mainMat && mainMat.value !== modalMat) {
                  mainMat.value = modalMat;
                }
                refreshVendorsDropdown(modalMat, data.vendor_id);
              } else {
                alert('Vendor added, but could not update dropdown. Please refresh.');
              }
            })
            .catch(() => alert('Error adding vendor. Please try again.'));
          });

          function refreshVendorsDropdown(materialId, newVendorId) {
            fetch(`/procurement/api/vendors?material_id=${materialId}`)
              .then(res => res.json())
              .then(vendors => {
                const vendorSelect = document.getElementById('pl_vendor');
                // Remove all except first option
                while (vendorSelect.options.length > 1) vendorSelect.remove(1);
                vendors.forEach(v => {
                  const opt = document.createElement('option');
                  opt.value = v.id;
                  opt.textContent = v.vendor_name;
                  opt.dataset.material = v.material_id;
                  vendorSelect.appendChild(opt);
                });
                vendorSelect.value = newVendorId;
                if (typeof updateLeadTime === 'function') updateLeadTime();
              });
          }
          </script>
        </div>
      </div>
    <script>
    // --- Vendor highlight/auto-select logic ---
    const allVendors = JSON.parse('{{ vendors|tojson }}');
    const assignments = JSON.parse('{{ project_material_vendor_assignments_json|tojson }}');
    const projectId = JSON.parse('{{ project.id|tojson }}');

    function updateVendors() {
      const matId = document.getElementById('pl_material').value;
      const vendorSelect = document.getElementById('pl_vendor');
      const leadTimeDisplay = document.getElementById('leadTimeDisplay');
      // projectId is now defined at the top
      // Clear all except first
      while (vendorSelect.options.length > 1) vendorSelect.remove(1);
      let highlighted = null;
      allVendors.forEach(v => {
        if (String(v.material_id) === String(matId)) {
          const opt = document.createElement('option');
          opt.value = v.id;
          opt.textContent = v.name;
          opt.dataset.material = v.material_id;
          // Highlight if assigned to this project/material
          const found = assignments.find(a => a.project_id === projectId && a.material_id === Number(matId) && a.vendor_id === v.id);
          if (found) {
            opt.style.background = '#bbf7d0';
            if (!highlighted) highlighted = v.id;
          }
          vendorSelect.appendChild(opt);
        }
      });
      if (highlighted) vendorSelect.value = highlighted;
      updateLeadTime();
    }
    function updateLeadTime() {
      const matId = document.getElementById('pl_material').value;
      const vendorId = document.getElementById('pl_vendor').value;
      // projectId is now defined at the top
      const found = assignments.find(a => a.project_id === projectId && a.material_id === Number(matId) && a.vendor_id === Number(vendorId));
      const leadTimeDisplay = document.getElementById('leadTimeDisplay');
      if (found && found.lead_time_days != null) {
        leadTimeDisplay.textContent = `Assigned Lead Time: ${found.lead_time_days} days`;
      } else {
        leadTimeDisplay.textContent = '';
      }
    }
    document.getElementById('pl_material').addEventListener('change', updateVendors);
    document.getElementById('pl_vendor').addEventListener('change', updateLeadTime);
    window.addEventListener('DOMContentLoaded', updateVendors);
    </script>
    </div>

    <div>
      <label for="pl_activity">Activity (optional)</label>
      <select id="pl_activity" name="activity_id">
        <option value="">(Not linked to an activity)</option>
        {% for a in activities %}
          <option value="{{ a.id }}">{% if a.code %}{{ a.code }} — {% endif %}{{ a.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label for="pl_order_date">Order Date <span class="required">*</span></label>
      <!-- DD/MM/YYYY: Slashes auto-inserted, 4-digit year only -->
      <input id="pl_order_date" type="text" name="order_date" value="{{ today|ddmmyyyy }}" placeholder="DD/MM/YYYY" inputmode="numeric" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}" required>
    <script>
    function autoFormatDateInput(input) {
      input.addEventListener('input', function(e) {
        let v = input.value.replace(/[^0-9]/g, '').slice(0,8);
        if (v.length > 4) v = v.slice(0,2) + '/' + v.slice(2,4) + '/' + v.slice(4,8);
        else if (v.length > 2) v = v.slice(0,2) + '/' + v.slice(2,4);
        input.value = v;
      });
      input.addEventListener('blur', function() {
        if (input.value.length !== 10) input.setCustomValidity('Enter date as DD/MM/YYYY');
        else input.setCustomValidity('');
      });
    }
    window.addEventListener('DOMContentLoaded', function() {
      ['pl_order_date','pl_promised','pl_delivered'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) autoFormatDateInput(el);
      });
    });
    </script>
    </div>

    <div>
      <label for="pl_promised">Promised Delivery Date</label>
      <!-- DD/MM/YYYY: Slashes auto-inserted, 4-digit year only -->
      <input id="pl_promised" type="text" name="promised_delivery_date" placeholder="DD/MM/YYYY" inputmode="numeric" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}">
      <!-- JS will auto-format and limit to 10 chars -->
    </div>

    <div>
      <label for="pl_delivered">Actual Delivered Date</label>
      <input id="pl_delivered" type="text" name="delivered_date" placeholder="DD/MM/YYYY" inputmode="numeric" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}">
      <!-- JS will auto-format and limit to 10 chars -->
    </div>

    <div>
      <label for="pl_qty">Quantity</label>
      <input id="pl_qty" type="number" step="0.001" min="0" name="quantity" placeholder="(optional)">
    </div>

    <div>
      <label for="pl_unit">Unit</label>
      <input id="pl_unit" type="text" name="unit" placeholder="e.g. bags / MT / m3">
    </div>

    <div style="grid-column: 1 / -1;">
      <label for="pl_notes">Notes</label>
      <textarea id="pl_notes" name="notes" rows="2" placeholder="PO #, driver name, issues, etc."></textarea>
    </div>

    <div style="display:flex; gap:10px; align-items:center">
      <button type="submit" class="btn-primary">Save entry</button>
      <a class="btn-secondary" href="/dashboard">Back to dashboard</a>
    </div>
  </form>
</div>

<div class="card" style="margin-top:14px">
  <h3 style="margin:0 0 10px 0">Recent entries</h3>
  {% if logs and logs|length > 0 %}
  <div style="overflow:auto">
    <table class="table" style="min-width: 1100px">
      <thead>
        <tr>
          <th>Order Date</th>
          <th>Material</th>
          <th>Vendor</th>
          <th>Promised Delivery</th>
          <th>Promised LT</th>
          <th>Delivered</th>
          <th>Actual LT</th>
          <th style="text-align:right">Qty</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        {% for row, m, v, a in logs %}
        <tr>
          <td>{{ row.order_date|ddmmyyyy }}</td>
          <td>
            {% if m.code %}<span class="badge">{{ m.code }}</span>{% endif %}
            {{ m.name }}
            {% if a %}<div class="meta">Activity: {% if a.code %}{{ a.code }} — {% endif %}{{ a.name }}</div>{% endif %}
          </td>
          <td>{% if v %}{{ v.vendor_name }}{% else %}—{% endif %}</td>
          <td>{{ (row.promised_delivery_date|ddmmyyyy) if row.promised_delivery_date else '—' }}</td>
          <td>{% if row.promised_lead_time_days is not none %}{{ row.promised_lead_time_days }}d{% else %}—{% endif %}</td>
          <td>{{ (row.delivered_date|ddmmyyyy) if row.delivered_date else '—' }}</td>
          <td>{% if row.actual_lead_time_days is not none %}{{ row.actual_lead_time_days }}d{% else %}—{% endif %}</td>
          <td style="text-align:right">{% if row.quantity is not none %}{{ row.quantity }}{% else %}—{% endif %} {% if row.unit %}<span class="meta">{{ row.unit }}</span>{% endif %}</td>
          <td style="max-width: 380px">{{ row.notes or '' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <div class="meta">No procurement entries yet.</div>
  {% endif %}
</div>

<script id="vendorsByMaterialJson" type="application/json">{{ vendors_by_material_json | tojson }}</script>

{% endblock %}

{% block scripts %}
<script>
  (function () {
    function parseJson(id) {
      const el = document.getElementById(id);
      if (!el) return {};
      try { return JSON.parse(el.textContent || '{}'); } catch { return {}; }
    }

    const vendorsByMaterial = parseJson('vendorsByMaterialJson');
    const materialSel = document.getElementById('pl_material');
    const vendorSel = document.getElementById('pl_vendor');

    function rebuild(materialId) {
      if (!vendorSel) return;
      const list = vendorsByMaterial[String(materialId)] || [];
      const options = ['<option value="">(No vendor)</option>'];
      list.forEach(v => {
        const inactive = v.is_active === false;
        const label = inactive ? `${v.vendor_name} (inactive)` : `${v.vendor_name} (LT ${Number(v.lead_time_days||0)}d)`;
        options.push(`<option value="${v.id}">${label}</option>`);
      });
      vendorSel.innerHTML = options.join('');
    }

    if (materialSel) {
      materialSel.addEventListener('change', function () {
        rebuild(materialSel.value);
      });
    }
  })();
</script>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<style>
    .card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: 0 4px 24px 0 rgba(0,0,0,0.13), 0 1.5px 6px 0 rgba(0,0,0,0.10);
        margin-bottom: 28px;
        padding: 0 0 18px 0;
        overflow: hidden;
        color: var(--text-primary);
    }
    .page-header {
        background: none;
        border-bottom: 1.5px solid var(--border-color);
        margin-bottom: 28px;
        padding-bottom: 10px;
    }
    .page-title {
        font-size: 2.1rem;
        font-weight: 700;
        color: var(--text-primary);
        letter-spacing: 0.01em;
    }
    .table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: var(--card-bg);
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 0;
        font-size: 1.04em;
    }
    .table th, .table td {
        padding: 12px 10px;
        text-align: left;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color);
    }
    .table th {
        background: rgba(0,0,0,0.03);
        font-weight: 700;
        font-size: 1.07em;
        letter-spacing: 0.01em;
        color: var(--text-secondary);
    }
    .table tr:nth-child(even) td {
        background: rgba(0,0,0,0.02);
    }
    .table tr:last-child td {
        border-bottom: none;
    }
    .badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 8px;
        font-size: 0.98em;
        font-weight: 600;
        letter-spacing: 0.01em;
        margin-right: 2px;
        margin-bottom: 2px;
    }
    .badge-info { background: #dbeafe; color: #0c4a6e; }
    .badge-success { background: #dcfce7; color: #166534; }
    .badge-danger { background: #fee2e2; color: #991b1b; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .dark .badge-info { background: #0c2a4722; color: #60a5fa; }
    .dark .badge-success { background: #16a34a22; color: #86efac; }
    .dark .badge-danger { background: #dc262622; color: #fca5a5; }
    .dark .badge-warning { background: #78350f33; color: #fbbf24; }
    .card h3, .card strong {
        font-size: 1.18rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 2px 0;
        letter-spacing: 0.01em;
    }
    .card .help-text {
        color: var(--text-secondary);
        font-size: 0.97em;
        margin-top: 2px;
    }
    .form-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 18px 24px;
        margin-bottom: 8px;
        align-items: flex-end;
    }
    .form-group {
        display: flex;
        flex-direction: column;
        min-width: 160px;
        margin-bottom: 0;
    }
    .form-group label {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2px;
        font-size: 1em;
    }
    .form-group input[type="text"], .form-group select {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1.5px solid #2a2e38;
        background: #232733;
        color: #fff;
        font-size: 1em;
        margin-top: 2px;
        transition: border-color 0.18s, box-shadow 0.18s;
        box-shadow: 0 1.5px 4px 0 rgba(0,0,0,0.07);
    }
    .form-group input[type="text"]:focus, .form-group select:focus {
        border-color: #3498db;
        outline: none;
        box-shadow: 0 0 0 2px rgba(52,152,219,0.18);
    }
    .btn-primary, .btn-secondary {
        border: none;
        border-radius: 8px;
        padding: 8px 18px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
        margin-right: 8px;
    }
    .btn-primary {
        background: linear-gradient(90deg, #3498db 60%, #217dbb 100%);
        color: #fff;
        box-shadow: 0 2px 8px 0 rgba(52,152,219,0.10);
    }
    .btn-primary:hover {
        background: linear-gradient(90deg, #217dbb 60%, #3498db 100%);
        box-shadow: 0 4px 16px 0 rgba(52,152,219,0.18);
        transform: translateY(-2px) scale(1.03);
    }
    .btn-secondary {
        background: linear-gradient(90deg, #444950 60%, #232733 100%);
        color: #fff;
    }
    .btn-secondary:hover {
        background: linear-gradient(90deg, #232733 60%, #444950 100%);
    }
    @media (max-width: 900px) {
        .page-header, .card { padding-left: 2vw; padding-right: 2vw; }
        .table th, .table td { font-size: 0.97em; }
        .page-title { font-size: 1.3rem; }
        .form-grid { flex-direction: column; gap: 10px; }
        .form-group { min-width: 0; }
    }
</style>

<div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;margin-bottom:16px">
    <div>
        <h1 class="page-title" style="margin-bottom:6px">Audit Logs</h1>
        <div class="help-text">Read-only. Latest first. Use filters to narrow results.</div>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a href="/admin/users" class="btn-secondary" style="text-decoration:none">‚Üê Users</a>
        <a href="/admin/presets/road" class="btn-secondary" style="text-decoration:none">üß© Road Presets</a>
    </div>
</div>

<div class="card" style="padding:16px;margin-bottom:16px">
    <form method="get" action="/admin/logs" class="form-grid">
        <div class="form-group">
            <label>Action</label>
            <select name="action">
                <option value="">All</option>
                {% for a in actions %}
                    <option value="{{ a }}" {% if filters.action == a %}selected{% endif %}>{{ a }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>Entity Type</label>
            <select name="entity_type">
                <option value="">All</option>
                {% for e in entity_types %}
                    <option value="{{ e }}" {% if filters.entity_type == e %}selected{% endif %}>{{ e }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>User</label>
            <select name="user_id">
                <option value="">All</option>
                {% for u in users %}
                    <option value="{{ u[0] }}" {% if filters.user_id|string == u[0]|string %}selected{% endif %}>{{ u[1] }} ({{ u[0] }})</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>Username Contains</label>
            <input type="text" name="username" value="{{ filters.username }}" placeholder="search‚Ä¶">
        </div>

        <div class="form-group">
            <label>Start Date</label>
            <input type="text" name="start_date" value="{{ filters.start_date|ddmmyyyy }}" placeholder="DD/MM/YYYY" inputmode="numeric" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}">
        </div>

        <div class="form-group">
            <label>End Date</label>
            <input type="text" name="end_date" value="{{ filters.end_date|ddmmyyyy }}" placeholder="DD/MM/YYYY" inputmode="numeric" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}">
        </div>

        <div class="form-group" style="display:flex;align-items:flex-end;gap:10px">
            <button class="btn-primary" type="submit">Apply</button>
            <a class="btn-secondary" href="/admin/logs" style="text-decoration:none">Reset</a>
        </div>
    </form>
</div>

<div class="card" style="padding:0">
    <div style="padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.08);display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <strong>Logs</strong>
        <span style="opacity:0.75;font-size:13px">
            Total: {{ total }}
        </span>
    </div>

    <table class="table" style="margin:0">
        <thead>
            <tr style="background:rgba(255,255,255,0.04)">
                <th style="width:170px">Date &amp; Time</th>
                <th style="width:140px">Username</th>
                <th style="width:110px">Role</th>
                <th style="width:90px">Action</th>
                <th style="width:140px">Entity</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            {% if logs and logs|length > 0 %}
                {% for l in logs %}
                    <tr style="border-bottom:1px solid rgba(255,255,255,0.05)">
                        <td style="white-space:nowrap">{{ l.created_at|local_dt('Asia/Kolkata') }}</td>
                        <td><strong>{{ l.username }}</strong></td>
                        <td>{{ l.role or "" }}</td>
                        <td>
                            <span class="badge badge-info">{{ l.action }}</span>
                        </td>
                        <td>
                            {{ l.entity_type or "" }}
                            {% if l.entity_id %}
                                #{{ l.entity_id }}
                            {% endif %}
                        </td>
                        <td style="opacity:0.9">{{ l.description or l.details or "" }}</td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="6" style="padding:24px;text-align:center;opacity:0.75">
                        No audit logs found for the selected filters.
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

{% set total_pages = (total // page_size) + (1 if total % page_size else 0) %}
{% if total_pages > 1 %}
<div style="display:flex;justify-content:center;gap:10px;margin-top:16px;flex-wrap:wrap">
    {% if page > 1 %}
        <a class="btn-secondary" style="text-decoration:none" href="/admin/logs?page={{ page - 1 }}&action={{ filters.action }}&entity_type={{ filters.entity_type }}&user_id={{ filters.user_id }}&username={{ filters.username }}&start_date={{ filters.start_date }}&end_date={{ filters.end_date }}">‚Üê Prev</a>
    {% endif %}

    <div style="align-self:center;opacity:0.8">Page {{ page }} / {{ total_pages }}</div>

    {% if page < total_pages %}
        <a class="btn-secondary" style="text-decoration:none" href="/admin/logs?page={{ page + 1 }}&action={{ filters.action }}&entity_type={{ filters.entity_type }}&user_id={{ filters.user_id }}&username={{ filters.username }}&start_date={{ filters.start_date }}&end_date={{ filters.end_date }}">Next ‚Üí</a>
    {% endif %}
</div>
{% endif %}

{% endblock %}

{% extends "base.html" %}
{% block content %}
{% include "new_project_clean.html" %}
{% endblock %}
{% if false %}
{% set fallback_project_types = ["Road", "Bridge", "Flyover", "Building", "Utility / Pipeline"] %}
{% set fallback_legacy_project_types = ["Residential", "Commercial", "Industrial", "Utility", "Other"] %}
{% set fallback_road_categories = ["Expressway", "National Highway (NH)", "State Highway (SH)", "Major District Road (MDR)", "Other District Road (ODR)", "Village / Rural Road (VR)", "Urban Road", "Service Road"] %}
{% set project_types = classification_metadata.get('project_types', []) %}
{% set legacy_project_types = classification_metadata.get('legacy_project_types', []) %}
{% set road_categories = classification_metadata.get('road_categories', []) %}
{% if not project_types %}{% set project_types = fallback_project_types %}{% endif %}
{% if not legacy_project_types %}{% set legacy_project_types = fallback_legacy_project_types %}{% endif %}
{% if not road_categories %}{% set road_categories = fallback_road_categories %}{% endif %}

<h1 class="page-title">Create New Project</h1>

<div class="help-text" style="margin:-6px 0 14px;opacity:0.9">
    Prefer a guided flow? <a href="/projects/wizard/start">Start the Project Wizard</a>
</div>

<div class="card card--page">

<style>
    .form-errors{display:none;margin:0 0 14px;padding:10px 12px;border:1px solid rgba(214,69,69,0.45);background:rgba(214,69,69,0.12);border-radius:8px;color:var(--text-primary)}
    .is-invalid{border-color: rgba(214,69,69,0.9) !important; box-shadow: 0 0 0 3px rgba(214,69,69,0.15)}
    .btn-primary[disabled]{opacity:0.65;cursor:not-allowed}
    .btn-primary.btn-needs-attention{opacity:0.85;box-shadow: 0 0 0 3px rgba(214,69,69,0.12)}

    /* Presets editor (Create Project) */
    .preset-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
    @media (max-width: 980px){.preset-grid{grid-template-columns:1fr}}
    .preset-card{border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02);border-radius:12px;padding:12px}
    .preset-header{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px}
    .preset-actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn-small{padding:7px 10px;font-size:12px;line-height:1}
    .preset-legend{font-size:12px;opacity:0.85;margin:-4px 0 10px;line-height:1.35}
    .preset-list{display:flex;flex-direction:column;gap:8px}
    .preset-row{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.15)}
    .preset-row input[type="text"]{flex:1;min-width:160px}
    .preset-row .pill{font-size:11px;opacity:0.8;border:1px solid rgba(255,255,255,0.12);padding:3px 8px;border-radius:999px}
    .icon-btn{border:1px solid rgba(255,255,255,0.12);background:transparent;color:var(--text-primary);border-radius:10px;padding:6px 10px;cursor:pointer}
    .icon-btn:hover{background:rgba(255,255,255,0.06)}
    .muted{opacity:0.85}

    .hidden{display:none !important}

    .date-dual{display:flex;gap:8px;align-items:center}
    .date-dual input[type="date"]{max-width:170px}
</style>

<form id="createProjectForm" method="post" action="/projects/create">

    <div id="formErrors" class="form-errors"></div>

    <!-- ================= BASIC INFO ================= -->
    <section class="form-section">
        <h3 class="section-title">Basic Information</h3>

        <div class="form-grid">

            <div>
                <label>Project Name <span class="required">*</span></label>
                <input type="text" name="name" required>
                <div class="help-text">Use a concise, descriptive name (e.g. NH-66 Upgrade)</div>
            </div>

            <div>
                <label>Project Code / Package No</label>
                <input type="text" name="project_code">
            </div>

            <div>
                <label>Client / Authority</label>
                <input type="text" name="client_authority">
            </div>

            <div>
                <label>Contractor</label>
                <input type="text" name="contractor">
            </div>

            <div>
                <label>Consultant / PMC</label>
                <input type="text" name="consultant_pmc">
            </div>

        </div>
    </section>

    <hr>

    <!-- ================= PROJECT CLASSIFICATION & ROAD DETAILS ================= -->
    <section class="form-section">
        <h3 class="section-title">Project Classification</h3>

        <div class="form-grid">
            <div style="min-width:260px">
                <label>Project Type <span class="required">*</span></label>
                <select name="project_type" id="project_type" required aria-describedby="project-type-help">
                    <option value="">-- Select project type --</option>
                    {% for pt in (project_types + legacy_project_types) %}
                        <option value="{{ pt }}">{{ pt }}</option>
                    {% endfor %}
                </select>
                <div id="project-type-help" class="help-text">This determines activities, materials & workflow presets. <span id="projectTypeLoaded" style="opacity:0.85"></span> <span style="opacity:0.75">(Server: <span id="projectTypeServerCount">{{ (project_types | length) + (legacy_project_types | length) }}</span>, DOM: <span id="projectTypeDomCount">0</span>, Bootstrap: <span id="projectTypeBootstrapCount">0</span>)</span></div>
            </div>
        </div>

        <!-- Road classification is shown only when Project Type == Road -->
        <div id="road_block" style="display:none">
            <h3 class="section-title" style="margin-top:14px">Road Classification</h3>

            <div id="road_classification" class="form-grid" style="display:none">

            <div id="road_category_field" style="display:none;min-width:260px">
                <label>Road Category <span class="required">*</span></label>
                <select id="road_category" name="road_category" disabled>
                    <option value="">-- Select road category --</option>
                    {% for rc in road_categories %}
                        <option value="{{ rc }}">{{ rc }}</option>
                    {% endfor %}
                </select>
                <div class="help-text">Functional class (NH/SH/MDR/Urban/etc.).</div>
            </div>

            <div id="road_engineering_field" style="display:none;min-width:320px">
                <label>Road Engineering Type <span class="required">*</span></label>
                <select id="road_engineering_type" name="road_engineering_type" disabled>
                    <option value="">-- Select engineering type --</option>
                </select>
                <div class="help-text">Drives presets (Flexible/Rigid/Urban/Rural variants).</div>
            </div>

            </div>

            <!-- Stretch System (optional) -->
            <div id="stretch_system_block" style="display:none;margin-top:14px">
                <h3 class="section-title" style="margin-top:0">Stretch System (Chainage)</h3>
                <div class="help-text" style="margin-top:-6px">
                    Optional: generate chainage-based stretches now (recommended for road projects). For full control, use the <a href="/projects/wizard/start">Project Wizard</a>.
                </div>

                <!-- Timeline will be moved here automatically for Road projects -->
                <div id="timeline_mount" style="margin-top:12px"></div>

                <div class="form-grid" style="margin-top:10px">
                    <div style="grid-column:1/-1">
                        <label style="display:flex;align-items:center;gap:10px;margin:0">
                            <input type="checkbox" name="stretch_enabled" value="1" id="stretch_enabled">
                            Enable Stretch System
                        </label>
                    </div>

                    <div id="stretch_options" class="hidden" style="grid-column:1/-1">
                        <div class="form-grid" style="margin-top:8px">
                            <div>
                                <label>Total Road Length (km) <span class="required">*</span></label>
                                <input type="number" id="stretch_total_length_km" step="0.01" min="0" placeholder="e.g. 12.50">
                                <div class="help-text">Used to split into stretches. This auto-fills Road Length (km).</div>
                            </div>

                            <div>
                                <label>Method</label>
                                <select name="stretch_method" id="stretch_method">
                                    <option value="count">Number of stretches</option>
                                    <option value="length">Length per stretch (m)</option>
                                </select>
                                <div class="help-text">Uses Road Length (km) to compute chainage segments.</div>
                            </div>

                            <div id="stretch_count_wrap">
                                <label>No. of stretches</label>
                                <input type="number" name="stretch_number_of_stretches" min="1" step="1" value="5">
                            </div>

                            <div id="stretch_len_wrap" class="hidden">
                                <label>Stretch length (m)</label>
                                <input type="number" name="stretch_length_m" min="1" step="1" value="200">
                            </div>
                        </div>

                        <div style="margin-top:10px">
                            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                <button type="button" class="icon-btn" id="btnGenerateStretches">Generate stretches</button>
                                <button type="button" class="icon-btn" id="btnResetStretches">Reset</button>
                                <button type="button" class="icon-btn" id="btnAddStretchRow">Add stretch</button>
                                <div class="help-text">Auto-generates stretches; you can edit each stretch below.</div>
                            </div>

                            <input type="hidden" name="stretch_segments_json" id="stretch_segments_json">

                            <div id="stretch_editor" class="hidden" style="margin-top:10px">
                                <div class="help-text" id="stretch_editor_hint" style="margin-bottom:8px"></div>
                                <div id="stretchSegmentList" class="preset-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="road_questions" class="form-grid" style="display:none;margin-top:10px">
                <div style="grid-column:1/-1">
                    <label>Additional Questions</label>
                    <div class="help-text">Smart questions based on Road Category.</div>
                </div>
                <div id="road_questions_container" style="grid-column:1/-1"></div>
                <input type="hidden" name="road_extras_json" id="road_extras_json">
            </div>

            <!-- Road presets editor (Engineering Type-specific) -->
            <div id="road_presets_panel" style="display:none;grid-column:1/-1">
                <label>Road Presets</label>
                <div class="project-helper muted">Standard presets load based on Road Engineering Type. You can add/rename/remove activities before creating the project.</div>
                <div class="help-text" style="margin-top:6px">If presets are not loading automatically, click <button type="button" id="btnLoadRoadPresets" class="btn-secondary btn-small" style="margin-left:6px">Load Road Presets</button>.</div>

                <div class="preset-grid">
                    <div class="preset-card">
                        <div class="preset-header">
                            <div>
                                <div style="font-weight:600">Activity Presets</div>
                                <div class="help-text">Choose which activities should be created for this project.</div>
                            </div>
                            <div class="preset-actions">
                                <button type="button" class="btn-secondary btn-small" id="btnResetActivities">Reset</button>
                                <button type="button" class="btn-primary btn-small" id="btnAddActivity">+ Add</button>
                            </div>
                        </div>
                        <div class="preset-legend">Columns: Include | Name | Start time | End time | Type | Reorder | Remove</div>
                        <div id="activityPresetList" class="preset-list"></div>
                    </div>

                    <div class="preset-card">
                        <div class="preset-header">
                            <div>
                                <div style="font-weight:600">Material Presets</div>
                                <div class="help-text">Optional materials to add as planned materials.</div>
                            </div>
var __userInitiatedRoadCategoryChange = false;
var __userInitiatedRoadEngineeringChange = false;

function _presetFetchGuard(kind, key){
    try{
        if(__disablePresetFetch) return false;
        if(!window.__presetFetchBudget) window.__presetFetchBudget = {};
        var now = Date.now();
        </script>
        try{ setTimeout(ensureProjectTypeOptions, 200); }catch(e){}
        try{ setTimeout(ensureProjectTypeOptions, 800); }catch(e){}
    }

    // If any script clears select options after render (common cause of "dropdown empty"),
    // self-heal from bootstrapped classification metadata.
    if(!__disableSelectHealing){
    (function(){
        if(window.__classificationHealObserverSetup){
            try{ healAll(); }catch(e){}
            return;
        }
        window.__classificationHealObserverSetup = true;
        function healSelect(selectEl, options){
            try{
                if(!selectEl) return;
                var n = selectEl.options ? selectEl.options.length : 0;
                if(n <= 1 && Array.isArray(options) && options.length){
                    populateSelect(selectEl, options);
                    try{ updateProjectTypeLoadedIndicator(); }catch(e){}
                }
            }catch(e){}
        }

        function healAll(){
            if(!__classification) return;
            if(window.__classificationHealDone) return;
            if(isProgrammaticChange) return;
            isProgrammaticChange = true;
            healSelect(projectType, (__classification.project_types || []).concat(__classification.legacy_project_types || []));
            healSelect(roadCategory, (__classification.road_categories || []));
            try{
                var ptCount = projectType && projectType.options ? projectType.options.length : 0;
                var rcCount = roadCategory && roadCategory.options ? roadCategory.options.length : 0;
                if(ptCount > 1 && rcCount > 1){
                    window.__classificationHealDone = true;
                    if(window.__projectTypeHealObserver2 && typeof window.__projectTypeHealObserver2.disconnect === 'function'){
                        window.__projectTypeHealObserver2.disconnect();
                        window.__projectTypeHealObserver2 = null;
                    }
                    if(window.__roadCategoryHealObserver2 && typeof window.__roadCategoryHealObserver2.disconnect === 'function'){
                        window.__roadCategoryHealObserver2.disconnect();
                        window.__roadCategoryHealObserver2 = null;
                    }
                }
            }catch(e){}
            isProgrammaticChange = false;
        }

        // Immediate heal
        try{ healAll(); }catch(e){}

        // Ongoing heal (MutationObserver)
        try{
            if(typeof MutationObserver === 'undefined') return;
            if(projectType){
                var obs = new MutationObserver(function(){
                    if(window.__classificationHealDone) return;
                    if(isProgrammaticChange) return;
                    if(projectType && projectType.__restoringOptions) return;
                    var cnt = projectType && projectType.options ? projectType.options.length : 0;
                    if(cnt > 1){
                        try{ obs.disconnect(); }catch(e){}
                        window.__projectTypeHealObserver2 = null;
                        return;
                    }
                    if(!_shouldHeal('projectType')){
                        try{ obs.disconnect(); }catch(e){}
                        window.__projectTypeHealObserver2 = null;
                        return;
                    }
                    try{ healAll(); }catch(e){}
                });
                obs.observe(projectType, { childList: true, subtree: true });
                window.__projectTypeHealObserver2 = obs;
            }
            if(roadCategory){
                var obs2 = new MutationObserver(function(){
                    if(window.__classificationHealDone) return;
                    if(isProgrammaticChange) return;
                    if(roadCategory && roadCategory.__restoringOptions) return;
                    var cnt2 = roadCategory && roadCategory.options ? roadCategory.options.length : 0;
                    if(cnt2 > 1){
                        try{ obs2.disconnect(); }catch(e){}
                        window.__roadCategoryHealObserver2 = null;
                        return;
                    }
                    if(!_shouldHeal('roadCategory')){
                        try{ obs2.disconnect(); }catch(e){}
                        window.__roadCategoryHealObserver2 = null;
                        return;
                    }
                    try{ healAll(); }catch(e){}
                });
                obs2.observe(roadCategory, { childList: true, subtree: true });
                window.__roadCategoryHealObserver2 = obs2;
            }
        }catch(e){}
    })();
    }

    // Optional debug mode: /projects/new?debug=1
    var __debug = false;
    try{ __debug = (new URLSearchParams(window.location.search || '')).get('debug') === '1'; }catch(e){ __debug = false; }

    // If native HTML validation blocks submit, the form's submit handler won't run.
    // Capture invalid events to show a clear summary + scroll to the first invalid field.
    if(form){
        form.addEventListener('invalid', function(ev){
            try{
                const t = ev.target;
                if(t && typeof t.classList !== 'undefined') t.classList.add('is-invalid');
                const info = collectInvalidFieldsSummary(form);
                if(info.labels && info.labels.length){
                    setFormError('Please fill required fields. Missing/invalid: ' + info.labels.join(', ') + '.');
                } else {
                    setFormError('Please fill required fields highlighted below.');
                }
                // Scroll to the actual invalid control (better than only the error box)
                if(t && _isVisibleForValidation(t) && typeof t.scrollIntoView === 'function'){
                    t.scrollIntoView({behavior:'smooth', block:'center'});
                }
            }catch(e){}
        }, true);
    }

    // Make the button behave even when the browser blocks submission.
    if(btn && form){
        btn.addEventListener('click', function(e){
            try{ setFormError(''); }catch(err){}
            try{ form.querySelectorAll('.is-invalid').forEach(function(el){ el.classList.remove('is-invalid'); }); }catch(err){}
            let ok = true;
            try{ ok = !!form.checkValidity(); }catch(err){ ok = true; }
            if(!ok){
                e.preventDefault();
                const info = collectInvalidFieldsSummary(form);
                if(info.labels && info.labels.length){
                    setFormError('Please fill required fields. Missing/invalid: ' + info.labels.join(', ') + '.');
                } else {
                    setFormError('Please fill all required fields highlighted below.');
                </script>
        let segments = [];
        if(method === 'length'){
            const per = Math.max(1, parseInt((lenInput && lenInput.value) ? lenInput.value : '0', 10) || 0);
            let cursor = 0;
            let seq = 1;
            while(cursor < total && seq <= 500){
                const end = Math.min(total, cursor + per);
                const length = Math.max(1, end - cursor);
                segments.push({
                    sequence_no: seq,
                    stretch_code: _defaultCode(seq),
                    stretch_name: 'Stretch ' + seq,
                    start_m: cursor,
                    end_m: end,
                    length_m: length,
                });
                cursor = end;
                seq += 1;
            }
        } else {
            const n = Math.max(1, parseInt((countInput && countInput.value) ? countInput.value : '0', 10) || 0);
            const base = Math.floor(total / n);
            let cursor = 0;
            for(let i=1;i<=n && i<=500;i++){
                const isLast = i === n;
                const end = isLast ? total : (cursor + base);
                const length = Math.max(1, end - cursor);
                segments.push({
                    sequence_no: i,
                    stretch_code: _defaultCode(i),
                    stretch_name: 'Stretch ' + i,
                    start_m: cursor,
                    end_m: end,
                    length_m: length,
                });
                cursor = end;
            }
        }

        __segments = segments;
        // Keep ends consistent and total matched.
        rebalanceAllEvenly();

        // Default planned dates (user can edit per stretch)
        const ps = (projStartInput && projStartInput.value) ? String(projStartInput.value) : '';
        const pe = (projEndInput && projEndInput.value) ? String(projEndInput.value) : '';
        __segments.forEach(function(s){
            if(!s.planned_start_date) s.planned_start_date = ps;
            if(!s.planned_end_date) s.planned_end_date = pe;
            if(s.details_open === undefined || s.details_open === null) s.details_open = false;
        });
    }

    function renderSegments(){
        if(!list || !editor) return;
        list.innerHTML = '';

        const on = !!(stretchEnabled && stretchEnabled.checked);
        const total = totalLengthM();

        if(!on){
            show(editor, false);
            if(hidden) hidden.value = '';
            return;
        }

        if(!__segments.length){
            show(editor, false);
            if(hint) hint.textContent = 'Click “Generate stretches” to preview and edit.';
            if(hidden) hidden.value = '';
            return;
        }

        show(editor, true);
        if(hint){
            hint.textContent = 'Total length: ' + chainageFromMeters(total) + '. Edit Code/Name/Length; Start/End update automatically.';
        }

        __segments.forEach(function(seg, idx){
            _syncSegWithPresets(seg);

            const row = document.createElement('div');
            row.className = 'preset-row';

            const seqPill = document.createElement('span');
            seqPill.className = 'pill';
            seqPill.textContent = '#' + String(idx + 1);

            const code = document.createElement('input');
            code.type = 'text';
            code.value = seg.stretch_code || '';
            code.placeholder = 'Code';
            code.style.maxWidth = '110px';
            code.setAttribute('data-kind', 'stretch-code');
            code.setAttribute('data-idx', String(idx));

            const name = document.createElement('input');
            name.type = 'text';
            name.value = seg.stretch_name || '';
            name.placeholder = 'Stretch name';
            name.setAttribute('data-kind', 'stretch-name');
            name.setAttribute('data-idx', String(idx));

            const len = document.createElement('input');
            len.type = 'number';
            len.min = '1';
            len.step = '1';
            len.value = String(seg.length_m || 0);
            len.title = 'Length (m)';
            len.style.maxWidth = '120px';
            len.setAttribute('data-kind', 'stretch-length');
            len.setAttribute('data-idx', String(idx));

            const startPill = document.createElement('span');
            startPill.className = 'pill';
            startPill.textContent = 'Start: ' + chainageFromMeters(seg.start_m);

            const endPill = document.createElement('span');
            endPill.className = 'pill';
            endPill.textContent = 'End: ' + chainageFromMeters(seg.end_m);

            const psd = document.createElement('input');
            psd.type = 'text';
            // DD/MM/YYYY: Slashes auto-inserted, 4-digit year only
            psd.placeholder = 'DD/MM/YYYY';
            psd.value = String(seg.planned_start_date || '');
            psd.inputMode = 'numeric';
            psd.setAttribute('pattern', '\\d{2}/\\d{2}/\\d{4}');
            psd.style.maxWidth = '160px';
            psd.setAttribute('data-kind', 'stretch-start-date');
            psd.setAttribute('data-idx', String(idx));

            const ped = document.createElement('input');
            ped.type = 'text';
            // DD/MM/YYYY: Slashes auto-inserted, 4-digit year only
            ped.placeholder = 'DD/MM/YYYY';
            ped.value = String(seg.planned_end_date || '');
            ped.inputMode = 'numeric';
            ped.setAttribute('pattern', '\\d{2}/\\d{2}/\\d{4}');
            ped.style.maxWidth = '160px';
            ped.setAttribute('data-kind', 'stretch-end-date');
            ped.setAttribute('data-idx', String(idx));

            const toggle = document.createElement('button');
            toggle.type = 'button';
            toggle.className = 'icon-btn';
            toggle.textContent = seg.details_open ? 'Hide' : 'Show';
            toggle.setAttribute('data-kind', 'stretch-toggle');
            toggle.setAttribute('data-idx', String(idx));

            const del = document.createElement('button');
            del.type = 'button';
            del.className = 'icon-btn';
            del.textContent = 'Remove';
            del.setAttribute('data-kind', 'stretch-remove');
            del.setAttribute('data-idx', String(idx));

            row.appendChild(seqPill);
            row.appendChild(code);
            row.appendChild(name);
            row.appendChild(len);
            row.appendChild(startPill);
            row.appendChild(endPill);
            row.appendChild(psd);
            row.appendChild(ped);
            row.appendChild(toggle);
            row.appendChild(del);
            list.appendChild(row);

            // ---- Stretch details: Activities + Materials ----
            const details = document.createElement('div');
            details.className = seg.details_open ? '' : 'hidden';
            details.style.gridColumn = '1 / -1';
            details.style.margin = '6px 0 14px 0';
            details.style.padding = '10px 12px';
            details.style.border = '1px solid rgba(255,255,255,0.10)';
            details.style.borderRadius = '10px';
            details.style.background = 'rgba(255,255,255,0.02)';

            const grid = document.createElement('div');
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = '1fr 1fr';
            grid.style.gap = '12px';

            // Activities panel
            const actPanel = document.createElement('div');
            const actHdr = document.createElement('div');
            actHdr.style.display = 'flex';
            actHdr.style.alignItems = 'center';
            actHdr.style.justifyContent = 'space-between';
            actHdr.style.gap = '10px';
            const actTitle = document.createElement('div');
            actTitle.style.fontWeight = '600';
            actTitle.textContent = 'Activities (STRETCH)';
            const actBtn = document.createElement('button');
            actBtn.type = 'button';
            actBtn.className = 'btn-secondary btn-small';
            actBtn.textContent = '+ Add';
            actBtn.setAttribute('data-kind', 'stretch-act-add');
            actBtn.setAttribute('data-idx', String(idx));
            actHdr.appendChild(actTitle);
            actHdr.appendChild(actBtn);
            actPanel.appendChild(actHdr);

            const actHelp = document.createElement('div');
            actHelp.className = 'help-text';
            actHelp.textContent = 'Set Start/End time and duration hours. Hours auto-fill from stretch dates + activity times (you can edit). Use Remove to exclude.';
            actPanel.appendChild(actHelp);

            // COMMON activities (project-wide) shown for context (read-only)
            const commonActs = _getBaseCommonActivities();
            if(commonActs.length){
                const commonBox = document.createElement('div');
                commonBox.style.marginTop = '10px';
                commonBox.style.padding = '8px 10px';
                commonBox.style.border = '1px dashed rgba(255,255,255,0.14)';
                commonBox.style.borderRadius = '10px';
                const commonHdr = document.createElement('div');
                commonHdr.style.fontWeight = '600';
                commonHdr.style.opacity = '0.95';
                commonHdr.textContent = 'COMMON activities (project-wide)';
                const commonHelp = document.createElement('div');
                commonHelp.className = 'help-text';
                commonHelp.textContent = 'These run once for the whole project (not per stretch). Edit them in Activity Presets.';
                const pills = document.createElement('div');
                pills.style.display = 'flex';
                pills.style.flexWrap = 'wrap';
                pills.style.gap = '6px';
                pills.style.marginTop = '8px';
                commonActs.forEach(function(a){
                    const p = document.createElement('span');
                    p.className = 'pill';
                    p.textContent = String(a.name || '');
                    pills.appendChild(p);
                });
                commonBox.appendChild(commonHdr);
                commonBox.appendChild(commonHelp);
                commonBox.appendChild(pills);
                actPanel.appendChild(commonBox);
            }

            (seg.activities || []).forEach(function(a, aidx){
                if(a && a.include === false) return;
                const arow = document.createElement('div');
                arow.style.display = 'grid';
                arow.style.gridTemplateColumns = 'minmax(220px, 1fr) 90px 90px 72px 90px auto';
                arow.style.alignItems = 'center';
                arow.style.gap = '8px';
                arow.style.marginTop = '8px';
                arow.style.minWidth = '0';

                const aname = document.createElement('input');
                aname.type = 'text';
                aname.value = String(a.name || '');
                aname.placeholder = 'Activity name';
                aname.setAttribute('data-kind', 'stretch-act-name');
                aname.setAttribute('data-idx', String(idx));
                aname.setAttribute('data-aidx', String(aidx));
                aname.style.width = '100%';
                aname.style.minWidth = '220px';

                const hrs = document.createElement('input');
                hrs.type = 'number';
                hrs.min = '0';
                hrs.step = '0.5';
                hrs.placeholder = 'Hours';
                hrs.value = (a.planned_duration_hours === '' || a.planned_duration_hours === null || a.planned_duration_hours === undefined) ? '' : String(a.planned_duration_hours);
                hrs.setAttribute('data-kind', 'stretch-act-hours');
                hrs.setAttribute('data-idx', String(idx));
                hrs.setAttribute('data-aidx', String(aidx));
                hrs.style.maxWidth = '110px';

                const daysPill = document.createElement('span');
                daysPill.className = 'pill';
                const d = (a && a._computed_days) ? a._computed_days : null;
                daysPill.textContent = d ? ('Days: ' + String(d)) : 'Days: —';
                daysPill.title = 'Computed from this stretch Start/End date';

                const st = document.createElement('input');
                st.type = 'time';
                st.value = String(a.start_time || '');
                st.title = 'Start time';
                st.setAttribute('data-kind', 'stretch-act-start-time');
                st.setAttribute('data-idx', String(idx));
                st.setAttribute('data-aidx', String(aidx));
                st.style.maxWidth = '100px';

                const et = document.createElement('input');
                et.type = 'time';
                et.value = String(a.end_time || '');
                et.title = 'End time';
                et.setAttribute('data-kind', 'stretch-act-end-time');
                et.setAttribute('data-idx', String(idx));
                et.setAttribute('data-aidx', String(aidx));
                et.style.maxWidth = '100px';

                const rm = document.createElement('button');
                rm.type = 'button';
                rm.className = 'icon-btn';
                rm.textContent = 'Remove';
                rm.setAttribute('data-kind', 'stretch-act-remove');
                rm.setAttribute('data-idx', String(idx));
                rm.setAttribute('data-aidx', String(aidx));

                arow.appendChild(aname);
                arow.appendChild(st);
                arow.appendChild(et);
                arow.appendChild(daysPill);
                arow.appendChild(hrs);
                arow.appendChild(rm);
                actPanel.appendChild(arow);
            });

            // Materials panel
            const matPanel = document.createElement('div');
            const matHdr = document.createElement('div');
            matHdr.style.display = 'flex';
            matHdr.style.alignItems = 'center';
            matHdr.style.justifyContent = 'space-between';
            matHdr.style.gap = '10px';
            const matTitle = document.createElement('div');
            matTitle.style.fontWeight = '600';
            matTitle.textContent = 'Materials';
            matHdr.appendChild(matTitle);
            matPanel.appendChild(matHdr);

            const matHelp = document.createElement('div');
            matHelp.className = 'help-text';
            matHelp.textContent = 'Remove materials you don\'t want for this stretch (used when computing stretch materials later).';
            matPanel.appendChild(matHelp);

            (seg.materials || []).forEach(function(m, midx){
                if(m && m.include === false) return;
                const mrow = document.createElement('div');
                mrow.style.display = 'grid';
                mrow.style.gridTemplateColumns = '1fr auto';
                mrow.style.alignItems = 'center';
                mrow.style.gap = '8px';
                mrow.style.marginTop = '8px';

                const label = document.createElement('div');
                label.textContent = String(m.name || '');
                label.style.opacity = '0.95';

                const rm = document.createElement('button');
                rm.type = 'button';
                rm.className = 'icon-btn';
                rm.textContent = 'Remove';
                rm.setAttribute('data-kind', 'stretch-mat-remove');
                rm.setAttribute('data-idx', String(idx));
                rm.setAttribute('data-midx', String(midx));

                mrow.appendChild(label);
                mrow.appendChild(rm);
                matPanel.appendChild(mrow);
            });

            grid.appendChild(actPanel);
            grid.appendChild(matPanel);
            details.appendChild(grid);
            list.appendChild(details);
        });

        if(typeof window.serializeStretchSegments === 'function'){
            window.serializeStretchSegments();
        }
    }

    window.serializeStretchSegments = function(){
        if(!hidden) return;
        const on = !!(stretchEnabled && stretchEnabled.checked);
        if(!on || !__segments.length){
            hidden.value = '';
            return;
        }
        const payload = __segments.map(function(s){
            _syncSegWithPresets(s);
            return {
                sequence_no: s.sequence_no,
                stretch_code: String(s.stretch_code || '').trim(),
                stretch_name: String(s.stretch_name || '').trim(),
                start_m: parseInt(s.start_m || 0, 10) || 0,
                end_m: parseInt(s.end_m || 0, 10) || 0,
                length_m: parseInt(s.length_m || 0, 10) || 0,
                planned_start_date: String(s.planned_start_date || '').trim(),
                planned_end_date: String(s.planned_end_date || '').trim(),
                activities: (Array.isArray(s.activities) ? s.activities : []).map(function(a){
                    return {
                        name: String((a && a.name) || '').trim(),
                        include: !!(a && a.include),
                        planned_duration_hours: (a && a.planned_duration_hours !== '' && a.planned_duration_hours !== null && a.planned_duration_hours !== undefined) ? (parseFloat(a.planned_duration_hours) || 0) : null,
                        start_time: String((a && a.start_time) || '').trim() || null,
                        end_time: String((a && a.end_time) || '').trim() || null,
                        standard: !!(a && a.standard),
                    };
                }).filter(function(a){ return !!a.name; }),
                materials: (Array.isArray(s.materials) ? s.materials : []).map(function(m){
                    return { name: String((m && m.name) || '').trim(), include: !!(m && m.include), standard: !!(m && m.standard) };
                }).filter(function(m){ return !!m.name; }),
            };
        });
        hidden.value = JSON.stringify(payload);
    };

    function syncTimelinePlacement(){
        if(!timelineContainer) return;
        const isRoad = !!(projectTypeSel && projectTypeSel.value === 'Road');
        if(isRoad && timelineMount){
            timelineMount.appendChild(timelineContainer);
        } else if(timelineOriginalParent){
            if(timelineOriginalNext && timelineOriginalNext.parentNode === timelineOriginalParent){
                timelineOriginalParent.insertBefore(timelineContainer, timelineOriginalNext);
            } else {
                timelineOriginalParent.appendChild(timelineContainer);
            }
        }
    }

    function syncTotalLengthToRoadLength(){
        if(!totalLenKmUi || !roadLenKmInput) return;
        const v = String(totalLenKmUi.value || '').trim();
        if(v && roadLenKmInput.value !== v){
            roadLenKmInput.value = v;
        }
    }

    function syncRoadLengthToTotalLength(){
        if(!totalLenKmUi || !roadLenKmInput) return;
        const v = String(roadLenKmInput.value || '').trim();
        if(v && totalLenKmUi.value !== v){
            totalLenKmUi.value = v;
        }
    }

    function syncMethod(){
        const m = String((methodSel && methodSel.value) || 'count');
        show(countWrap, m !== 'length');
        show(lenWrap, m === 'length');
    }

    function syncEnabled(){
        const on = !!(stretchEnabled && stretchEnabled.checked);
        show(stretchOptions, on);
        // If Stretch System is used, hide the Road Presets editor to reduce clutter.
        // Presets still load and are used for auto-generation.
        if(roadPresetsPanel){
            roadPresetsPanel.classList.toggle('hidden', on);
        }
        if(on){
            // Keep required Road Length satisfied
            try{ syncTotalLengthToRoadLength(); }catch(e){}
        }
        if(totalLenKmUi){
            if(on) totalLenKmUi.setAttribute('required', 'required'); else totalLenKmUi.removeAttribute('required');
        }
        if (on) syncMethod();
        if(!on){
            __segments = [];
            __dirty = false;
            renderSegments();
        }
    }

    function syncRoadVisibility(){
        if(!stretchBlock) return;
        // Use the source of truth: project type selection.
        const isRoad = !!(projectTypeSel && projectTypeSel.value === 'Road');
        stretchBlock.style.display = isRoad ? '' : 'none';
        if(!isRoad){
            try{
                if(stretchEnabled) stretchEnabled.checked = false;
                syncEnabled();
            }catch(e){}
        }
        syncTimelinePlacement();
    }

    // Keep stretch block visibility in sync with Project Type.
    if (projectTypeSel) projectTypeSel.addEventListener('change', syncRoadVisibility);
    if (projectTypeSel) projectTypeSel.addEventListener('change', syncTimelinePlacement);

    if (stretchEnabled) stretchEnabled.addEventListener('change', syncEnabled);
    if (methodSel) methodSel.addEventListener('change', syncMethod);
    if (btnGen) btnGen.addEventListener('click', function(){
        __dirty = false;
        generateSegments();
        renderSegments();
    });
    if (btnReset) btnReset.addEventListener('click', function(){
        __dirty = false;
        generateSegments();
        renderSegments();
    });
    if (btnAddRow) btnAddRow.addEventListener('click', function(){
        if(!(stretchEnabled && stretchEnabled.checked)){
            if(stretchEnabled) stretchEnabled.checked = true;
            syncEnabled();
        }
        if(!__segments.length){
            generateSegments();
        }
        const next = (__segments.length + 1);
        __segments.push({
            sequence_no: next,
            stretch_code: _defaultCode(next),
            stretch_name: 'Stretch ' + next,
            start_m: 0,
            end_m: 0,
            length_m: 1,
        });
        __dirty = true;
        rebalanceAllEvenly();
        renderSegments();
    });

    // Auto-generate when user changes method/count/length/road length.
    // Changing these is an explicit intent to regenerate, so we override prior edits.
    function maybeAutoGenerate(force){
        if(!force && __dirty) return;
        if(!(stretchEnabled && stretchEnabled.checked)) return;
        __dirty = false;
        generateSegments();
        renderSegments();
    }
    if (methodSel) methodSel.addEventListener('change', function(){ syncMethod(); maybeAutoGenerate(true); });
    if (countInput) countInput.addEventListener('change', function(){ maybeAutoGenerate(true); });
    if (lenInput) lenInput.addEventListener('change', function(){ maybeAutoGenerate(true); });
    if (roadLenKmInput) roadLenKmInput.addEventListener('change', function(){ maybeAutoGenerate(true); });
    if (roadLenKmInput) roadLenKmInput.addEventListener('input', function(){ syncRoadLengthToTotalLength(); });
    if (totalLenKmUi) totalLenKmUi.addEventListener('input', function(){ syncTotalLengthToRoadLength(); });
    if (totalLenKmUi) totalLenKmUi.addEventListener('change', function(){ syncTotalLengthToRoadLength(); maybeAutoGenerate(true); });

    if (projStartInput) projStartInput.addEventListener('change', function(){
        if(!__segments.length) return;
        __segments.forEach(function(s){ if(!s.planned_start_date) s.planned_start_date = String(projStartInput.value || ''); });
        renderSegments();
    });
    if (projEndInput) projEndInput.addEventListener('change', function(){
        if(!__segments.length) return;
        __segments.forEach(function(s){ if(!s.planned_end_date) s.planned_end_date = String(projEndInput.value || ''); });
        renderSegments();
    });

    if (stretchOptions){
        stretchOptions.addEventListener('input', function(e){
            const t = e.target;
            if(!t) return;
            const kind = t.getAttribute('data-kind');
            const idx = parseInt(t.getAttribute('data-idx') || '-1', 10);
            if(idx < 0 || idx >= __segments.length) return;
            if(kind === 'stretch-code'){
                __segments[idx].stretch_code = String(t.value || '').trim();
                __dirty = true;
                window.serializeStretchSegments();
            }
            if(kind === 'stretch-name'){
                __segments[idx].stretch_name = String(t.value || '').trim();
                __dirty = true;
                window.serializeStretchSegments();
            }
            if(kind === 'stretch-length'){
                __segments[idx].length_m = Math.max(1, parseInt(t.value || '0', 10) || 0);
                __dirty = true;
                // Auto-rebalance remaining segments to keep total consistent.
                rebalanceFromIndex(idx);
                renderSegments();
            }
            if(kind === 'stretch-start-date'){
                __segments[idx].planned_start_date = String(t.value || '').trim();
                __dirty = true;
                window.serializeStretchSegments();
            }
            if(kind === 'stretch-end-date'){
                __segments[idx].planned_end_date = String(t.value || '').trim();
                __dirty = true;
                window.serializeStretchSegments();
            }

            // Per-stretch activities
            const aidx = parseInt(t.getAttribute('data-aidx') || '-1', 10);
            if(kind === 'stretch-act-name' && aidx >= 0 && __segments[idx] && Array.isArray(__segments[idx].activities) && __segments[idx].activities[aidx]){
                const seg = __segments[idx];
                const act = seg.activities[aidx];
                const nextName = String(t.value || '').trim();
                if(!nextName) return;
                if(act.standard){
                    // Renaming a preloaded activity converts it into a custom activity for this stretch
                    // and disables the original preloaded one.
                    act.include = false;
                    const custom = {
                        name: nextName,
                        include: true,
                        planned_duration_hours: act.planned_duration_hours,
                        standard: false,
                        start_time: act.start_time,
                        end_time: act.end_time,
                        _hours_manual: !!String(act.planned_duration_hours || '').trim(),
                    };
                    seg.activities.unshift(custom);
                    __dirty = true;
                    renderSegments();
                    return;
                }
                act.name = nextName;
                __dirty = true;
                window.serializeStretchSegments();
            }
            if(kind === 'stretch-act-hours' && aidx >= 0 && __segments[idx] && Array.isArray(__segments[idx].activities) && __segments[idx].activities[aidx]){
                const seg = __segments[idx];
                const act = seg.activities[aidx];
                const v = String(t.value || '').trim();
                act.planned_duration_hours = v;
                act._hours_manual = !!v;
                __dirty = true;
                window.serializeStretchSegments();
            }
            if(kind === 'stretch-act-start-time' && aidx >= 0 && __segments[idx] && Array.isArray(__segments[idx].activities) && __segments[idx].activities[aidx]){
                __segments[idx].activities[aidx].start_time = String(t.value || '').trim();
                __dirty = true;
                _maybeAutofillActivityHours(__segments[idx]);
                renderSegments();
            }
            if(kind === 'stretch-act-end-time' && aidx >= 0 && __segments[idx] && Array.isArray(__segments[idx].activities) && __segments[idx].activities[aidx]){
                __segments[idx].activities[aidx].end_time = String(t.value || '').trim();
                __dirty = true;
                _maybeAutofillActivityHours(__segments[idx]);
                renderSegments();
            }
        });
        stretchOptions.addEventListener('click', function(e){
            const t = e.target;
            if(!t) return;
            const kind = t.getAttribute('data-kind');
            const idx = parseInt(t.getAttribute('data-idx') || '-1', 10);
            if(kind === 'stretch-remove' && idx >= 0 && idx < __segments.length){
                __dirty = true;
                __segments.splice(idx, 1);
                // After removal, auto-rebalance evenly.
                rebalanceAllEvenly();
                renderSegments();
                return;
            }

            if(kind === 'stretch-toggle' && idx >= 0 && idx < __segments.length){
                __segments[idx].details_open = !__segments[idx].details_open;
                renderSegments();
                return;
            }

            const aidx = parseInt(t.getAttribute('data-aidx') || '-1', 10);
            if(kind === 'stretch-act-add' && idx >= 0 && idx < __segments.length){
                __dirty = true;
                if(!Array.isArray(__segments[idx].activities)) __segments[idx].activities = [];
                __segments[idx].activities.unshift({ name: '', include: true, planned_duration_hours: '', standard: false, start_time: '', end_time: '', _hours_manual: false });
                renderSegments();
                return;
            }
            if(kind === 'stretch-act-remove' && idx >= 0 && idx < __segments.length && aidx >= 0){
                const seg = __segments[idx];
                if(seg && Array.isArray(seg.activities) && seg.activities[aidx]){
                    __dirty = true;
                    if(seg.activities[aidx].standard){
                        seg.activities[aidx].include = false;
                    } else {
                        seg.activities.splice(aidx, 1);
                    }
                    renderSegments();
                    return;
                }
            }

            const midx = parseInt(t.getAttribute('data-midx') || '-1', 10);
            if(kind === 'stretch-mat-remove' && idx >= 0 && idx < __segments.length && midx >= 0){
                const seg = __segments[idx];
                if(seg && Array.isArray(seg.materials) && seg.materials[midx]){
                    __dirty = true;
                    seg.materials[midx].include = false;
                    renderSegments();
                    return;
                }
            }
        });
    }

    syncEnabled();
    syncRoadVisibility();
    syncTimelinePlacement();
    syncRoadLengthToTotalLength();
    // Initial generate if enabled and road length already set
    maybeAutoGenerate(false);

    // Allow presets editor to trigger re-alignment of per-stretch panels.
    window.onPresetsSerialized = function(){
        try{
            if(stretchEnabled && stretchEnabled.checked && __segments.length){
                renderSegments();
            }
        }catch(e){}
    };
})();
 </script>
{% endif %}

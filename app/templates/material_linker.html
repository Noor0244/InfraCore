{% extends "base.html" %}
{% block content %}
<div class="linker-page">
  <div class="linker-header">
    <h1 class="page-title">Materialâ€“Stretch & Activity Linking</h1>
    <div class="linker-subtitle" style="font-size:16px; color:#a5b4fc; margin-bottom:18px;">
      Select a stretch, then choose a material, and link it to one or more activities. Assign quantities for each activity as needed. Click <b>Save Links</b> to save your changes.
    </div>
  </div>
  <form id="stretchActivityForm" class="linker-card">
    <div class="linker-grid">
      <section class="linker-section">
        <div class="linker-section-header">
          <div class="linker-section-title">Select Stretch</div>
          <span class="linker-count"><span id="stretchCount">0</span> selected</span>
        </div>
        <select id="stretchSelect" class="stretch-select" aria-label="Select stretch">
          <option value="">Select a stretch</option>
          {% for s in stretches %}
            <option value="{{ s.id }}">{{ s.stretch_name }}</option>
          {% endfor %}
        </select>
        <input type="hidden" id="stretchSelectedId" value="">
        <div class="linker-section-title" style="margin-top:18px;">Material</div>
        <select id="materialSelect" class="material-select" aria-label="Select material">
          {% for m in materials %}
            <option value="{{ m.id }}" data-name="{{ m.name }}" data-unit="{{ m.unit }}" {% if m.id == material.id %}selected{% endif %}>{{ m.name }}</option>
          {% endfor %}
        </select>
      </section>
      <section class="linker-section" id="activitySection" style="display:none;">
        <div class="linker-section-header">
          <div class="linker-section-title">Activities</div>
          <span class="linker-count"><span id="activityCount">0</span> selected</span>
        </div>
        <div class="linker-hint" id="activityGateHint">Select a stretch and material to load activities.</div>
        <input id="activityFilter" class="activity-filter" type="search" placeholder="Filter activities..." autocomplete="off" style="display:none;">
        <div class="linker-activities modal-grid modal-grid--activity modal-grid--activity-compact" id="activitiesList" style="display:none;">
        </div>
        <button type="button" id="assignQuantitiesBtn" class="btn-primary" style="display:none; margin-top: 16px;">Assign Quantities</button>
        <div id="assignQuantitiesModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.45); z-index:1000; align-items:center; justify-content:center;">
          <div class="modal-content" style="background:#181f3a; border-radius:14px; padding:32px; min-width:340px; max-width:90vw; box-shadow:0 8px 32px rgba(0,0,0,0.25);">
            <h2 style="color:#e2e8f0; font-size:20px; margin-bottom:18px;">Assign Material & Quantity</h2>
            <form id="assignQuantitiesForm">
              <script>
              let currentMaterialId = {{ material.id }};
              let currentMaterialUnit = "{{ material.unit }}";
              let currentMaterialActivityIds = [];
              let currentMaterialActivityQty = {};

              function showAssignQuantitiesButton() {
                const checked = document.querySelectorAll('#stretchActivityForm input[name="activities"]:checked').length;
                const btn = document.getElementById('assignQuantitiesBtn');
                if (btn) btn.style.display = checked > 0 ? '' : 'none';
              }

              function getStretchSelectionId() {
                const select = document.getElementById('stretchSelect');
                const input = document.getElementById('stretchSelectedId');
                const rawValue = select && select.value ? select.value : (input ? input.value : '');
                const value = rawValue ? parseInt(rawValue) : null;
                return Number.isNaN(value) ? null : value;
              }

              function setStretchSelection(id, name) {
                const select = document.getElementById('stretchSelect');
                const input = document.getElementById('stretchSelectedId');
                if (select) select.value = id ? String(id) : '';
                if (input) input.value = id ? String(id) : '';
                updateStretchCount();
              }

              function updateStretchCount() {
                const selectedId = getStretchSelectionId();
                const count = selectedId ? 1 : 0;
                const stretchCountEl = document.getElementById('stretchCount');
                if (stretchCountEl) stretchCountEl.textContent = count;
                toggleActivitiesEnabled(canShowActivities());
                if (canShowActivities()) {
                  loadStretchActivities();
                } else {
                  renderActivities([]);
                }
              }

              function updateActivityCount() {
                const count = document.querySelectorAll('#stretchActivityForm input[name="activities"]:checked').length;
                const activityCountEl = document.getElementById('activityCount');
                if (activityCountEl) activityCountEl.textContent = count;
              }

              function toggleActivitiesEnabled(enabled) {
                const section = document.getElementById('activitySection');
                const hint = document.getElementById('activityGateHint');
                const submitBtn = document.getElementById('stretchActivitySubmit');
                const activitiesList = document.getElementById('activitiesList');
                const activityFilter = document.getElementById('activityFilter');
                if (!section) return;
                if (enabled) {
                  section.style.display = '';
                  section.classList.remove('is-disabled');
                  if (hint) hint.style.display = 'none';
                  if (submitBtn) submitBtn.disabled = false;
                  if (activitiesList) activitiesList.style.display = '';
                  if (activityFilter) activityFilter.style.display = '';
                } else {
                  section.style.display = 'none';
                  section.classList.add('is-disabled');
                  if (hint) hint.style.display = 'block';
                  if (submitBtn) submitBtn.disabled = true;
                  if (activitiesList) activitiesList.style.display = 'none';
                  if (activityFilter) activityFilter.style.display = 'none';
                  document.querySelectorAll('#stretchActivityForm input[name="activities"]').forEach(cb => cb.checked = false);
                  updateActivityCount();
                  showAssignQuantitiesButton();
                }
              }

              function canShowActivities() {
                return Boolean(currentMaterialId) && Boolean(getStretchSelectionId());
              }

              function renderActivities(activities) {
                const list = document.getElementById('activitiesList');
                if (!list) return;
                list.innerHTML = '';

                if (!activities || activities.length === 0) {
                  list.innerHTML = '<div style="color:#94a3b8; font-size:13px; padding:12px 0; text-align:center;">No activities found for this stretch.</div>';
                  return;
                }

                activities.forEach(act => {
                  const id = act.id;
                  const name = act.name || act.activity_name || '';
                  const safeName = String(name);
                  list.insertAdjacentHTML('beforeend',
                    `<label class="select-card select-card--activity" data-activity-name="${safeName.toLowerCase()}">
                      <input type="checkbox" name="activities" value="${id}" onchange="updateActivityCount(); showAssignQuantitiesButton();">
                      <span class="select-card__text">${safeName}</span>
                    </label>`
                  );
                });

                applyCurrentMaterialActivities();
              }

              function applyCurrentMaterialActivities() {
                const ids = (currentMaterialActivityIds || []).map(id => parseInt(id));
                document.querySelectorAll('#stretchActivityForm input[name="activities"]').forEach(cb => {
                  cb.checked = ids.includes(parseInt(cb.value));
                });
                updateActivityCount();
                showAssignQuantitiesButton();
              }

              function loadStretchActivities() {
                const stretchId = getStretchSelectionId();
                if (!stretchId) {
                  renderActivities([]);
                  return;
                }
                fetch(`/activity-materials/api/stretches/${stretchId}/activities`)
                  .then(r => r.json())
                  .then(data => {
                    renderActivities(data || []);
                  })
                  .catch(() => {
                    renderActivities([]);
                  });
              }

              function loadCurrentLinks() {
                fetch(`/material/${currentMaterialId}/stretches`).then(r => r.json()).then(data => {
                  const ids = (data.stretch_ids || []).map(id => parseInt(id));
                  const existingSelection = getStretchSelectionId();
                  if (!existingSelection && ids.length > 0) {
                    const targetId = ids[0];
                    const stretchSelect = document.getElementById('stretchSelect');
                    if (stretchSelect) {
                      const targetOption = Array.from(stretchSelect.options).find(opt => parseInt(opt.value || '0') === targetId);
                      const label = targetOption ? targetOption.textContent : '';
                      setStretchSelection(targetId, label);
                    }
                  }
                  updateStretchCount();
                });

                fetch(`/material/${currentMaterialId}/activities`).then(r => r.json()).then(data => {
                  const activityIds = data.activity_ids || [];
                  const qtyMap = data.activity_quantities || {};
                  currentMaterialActivityIds = activityIds;
                  currentMaterialActivityQty = qtyMap || {};
                  updateActivityCount();
                  applyCurrentMaterialActivities();
                });
              }

              function bindStretchSelect() {
                const stretchSelect = document.getElementById('stretchSelect');
                if (!stretchSelect) return;
                stretchSelect.addEventListener('change', () => {
                  const id = parseInt(stretchSelect.value || '0');
                  setStretchSelection(id || null, stretchSelect.selectedOptions[0]?.textContent || '');
                });
              }

              function bindActivityFilter() {
                const activityFilter = document.getElementById('activityFilter');
                if (!activityFilter) return;
                activityFilter.addEventListener('input', () => {
                  const q = String(activityFilter.value || '').toLowerCase().trim();
                  document.querySelectorAll('#stretchActivityForm .select-card--activity').forEach(card => {
                    const name = String(card.getAttribute('data-activity-name') || '').toLowerCase();
                    card.style.display = (!q || name.includes(q)) ? '' : 'none';
                  });
                });
              }

              function bindForm() {
                const form = document.getElementById('stretchActivityForm');
                if (!form) return;
                form.addEventListener('submit', (e) => {
                  e.preventDefault();
                  const stretches = [];
                  const selectedId = getStretchSelectionId();
                  if (selectedId) stretches.push(selectedId);

                  const activities = Array.from(document.querySelectorAll('#stretchActivityForm input[name="activities"]:checked')).map(cb => parseInt(cb.value));
                  const activityQuantities = {};

                  if (stretches.length === 0) {
                    const warn = document.getElementById('stretchActivityModalWarning');
                    warn.textContent = 'Please select a stretch first.';
                    warn.style.display = 'block';
                    return;
                  }

                  const warn = document.getElementById('stretchActivityModalWarning');
                  warn.style.display = 'none';

                  const submitBtn = document.getElementById('stretchActivitySubmit');
                  const originalText = submitBtn.textContent;
                  submitBtn.disabled = true;
                  submitBtn.textContent = 'Saving...';

                  fetch(`/material/${currentMaterialId}/stretches`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stretch_ids: stretches })
                  })
                  .then(r => r.json())
                  .then(() => {
                    return fetch(`/material/${currentMaterialId}/activities`, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ activity_ids: activities, activity_quantities: activityQuantities })
                    });
                  })
                  .then(r => r.json())
                  .then(() => {
                    window.location.href = `/project/{{ project.id }}/materials`;
                  })
                  .catch(() => {
                    const warn = document.getElementById('stretchActivityModalWarning');
                    warn.textContent = 'Error saving links. Please try again.';
                    warn.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                  });
                });
              }

              document.addEventListener('DOMContentLoaded', () => {
                const materialSelect = document.getElementById('materialSelect');
                const assignBtn = document.getElementById('assignQuantitiesBtn');
                const closeAssignModal = document.getElementById('closeAssignQuantitiesModal');
                const assignForm = document.getElementById('assignQuantitiesForm');

                if (materialSelect) {
                  materialSelect.addEventListener('change', () => {
                    const opt = materialSelect.selectedOptions[0];
                    if (!opt) return;
                    const mid = opt.value;
                    if (!mid) return;

                    currentMaterialId = parseInt(mid);
                    currentMaterialUnit = opt.getAttribute('data-unit') || '';

                    history.replaceState(null, '', `/project/{{ project.id }}/materials/linker/${mid}`);
                    loadCurrentLinks();
                  });
                }

                if (assignBtn) {
                  assignBtn.addEventListener('click', () => {
                    const modal = document.getElementById('assignQuantitiesModal');
                    if (!modal) return;
                    modal.style.display = 'flex';
                    const list = document.getElementById('assignQuantitiesList');
                    if (!list) return;
                    list.innerHTML = '';
                    document.querySelectorAll('#stretchActivityForm input[name="activities"]:checked').forEach(cb => {
                      const aid = cb.value;
                      const name = cb.closest('.select-card').querySelector('.select-card__text').textContent;
                      list.insertAdjacentHTML('beforeend',
                        `<div style='margin-bottom:12px;'><label style='color:#e2e8f0;'>${name} <input type='number' step='0.01' min='0' name='qty_${aid}' placeholder='Enter quantity' style='margin-left:10px; width:120px; padding:6px 10px; border-radius:8px; border:1.5px solid #4f8cff; background:#232b4a; color:#e2e8f0; font-size:14px; font-weight:600;'></label></div>`
                      );
                    });
                  });
                }

                if (closeAssignModal) {
                  closeAssignModal.addEventListener('click', () => {
                    const modal = document.getElementById('assignQuantitiesModal');
                    if (modal) modal.style.display = 'none';
                  });
                }

                if (assignForm) {
                  assignForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const modal = document.getElementById('assignQuantitiesModal');
                    if (modal) modal.style.display = 'none';
                  });
                }

                bindStretchSelect();
                bindActivityFilter();
                bindForm();
                loadCurrentLinks();
              });
              </script>
      warn.style.display = 'block';
      return;
    }

    const warn = document.getElementById('stretchActivityModalWarning');
    warn.style.display = 'none';

    const submitBtn = document.getElementById('stretchActivitySubmit');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';

    fetch(`/material/${currentMaterialId}/stretches`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ stretch_ids: stretches })
    })
    .then(r => r.json())
    .then(() => {
      return fetch(`/material/${currentMaterialId}/activities`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ activity_ids: activities, activity_quantities: activityQuantities })
      });
    })
    .then(r => r.json())
    .then(() => {
      window.location.href = `/project/{{ project.id }}/materials`;
    })
    .catch(() => {
      const warn = document.getElementById('stretchActivityModalWarning');
      warn.textContent = 'Error saving links. Please try again.';
      warn.style.display = 'block';
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    });
  });
}

document.addEventListener('DOMContentLoaded', () => {
  const materialSelect = document.getElementById('materialSelect');
  if (materialSelect) {
    materialSelect.addEventListener('change', () => {
      const opt = materialSelect.selectedOptions[0];
      if (!opt) return;
      const mid = opt.value;
      if (!mid) return;

      currentMaterialId = parseInt(mid);
      currentMaterialUnit = opt.getAttribute('data-unit') || '';

      const nameText = document.getElementById('materialNameText');
      const unitText = document.getElementById('materialUnitText');
      if (nameText) nameText.textContent = opt.getAttribute('data-name') || opt.textContent.trim();
      if (unitText) unitText.textContent = currentMaterialUnit || '-';

      document.querySelectorAll('.activity-qty-unit').forEach(span => {
        span.textContent = currentMaterialUnit || '';
      });

      history.replaceState(null, '', `/project/{{ project.id }}/materials/linker/${mid}`);
      loadCurrentLinks();
    });
  }
  bindStretchDropdown();
  bindActivityFilter();
  bindForm();
  loadCurrentLinks();
});
</script>
{% endblock %}

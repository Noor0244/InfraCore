{% extends "base.html" %}
{% block content %}
{% set fallback_project_types = ["Road", "Bridge", "Flyover", "Building", "Utility / Pipeline"] %}
{% set fallback_legacy_project_types = ["Residential", "Commercial", "Industrial", "Utility", "Other"] %}
{% set fallback_road_categories = ["Expressway", "National Highway (NH)", "State Highway (SH)", "Major District Road (MDR)", "Other District Road (ODR)", "Village / Rural Road (VR)", "Urban Road", "Service Road"] %}
{% set project_types = classification_metadata.get('project_types', []) %}
{% set legacy_project_types = classification_metadata.get('legacy_project_types', []) %}
{% set road_categories = classification_metadata.get('road_categories', []) %}
{% if not project_types %}{% set project_types = fallback_project_types %}{% endif %}
{% if not legacy_project_types %}{% set legacy_project_types = fallback_legacy_project_types %}{% endif %}
{% if not road_categories %}{% set road_categories = fallback_road_categories %}{% endif %}

<h1 class="page-title">Edit Project</h1>

<div class="card card--page">

<style>
    .form-errors{display:none;margin:0 0 14px;padding:10px 12px;border:1px solid rgba(214,69,69,0.45);background:rgba(214,69,69,0.12);border-radius:8px;color:var(--text-primary)}
    .is-invalid{border-color: rgba(214,69,69,0.9) !important; box-shadow: 0 0 0 3px rgba(214,69,69,0.15)}
    .date-dual{display:flex;gap:8px;align-items:center}
    .date-dual input[type="date"]{max-width:170px}
    .material-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .material-chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.08);font-size:12px}
</style>

<form id="editProjectForm" method="post" action="/projects/{{ project.id }}/update">
    <div id="formErrors" class="form-errors"></div>

    <!-- ================= BASIC INFO ================= -->
    <section class="form-section">
        <h3 class="section-title">Basic Information</h3>
        <div class="form-grid">
            <div>
                <label>Project Name <span class="required">*</span></label>
                <input type="text" name="name" required value="{{ project.name }}">
                <div class="help-text">Use a concise, descriptive name (e.g. NH-66 Upgrade)</div>
            </div>
            <div>
                <label>Project Code / Package No</label>
                <input type="text" name="project_code" value="{{ project.project_code or '' }}">
            </div>
            <div>
                <label>Client / Authority</label>
                <input type="text" name="client_authority" value="{{ project.client_authority or '' }}">
            </div>
            <div>
                <label>Contractor</label>
                <input type="text" name="contractor" value="{{ project.contractor or '' }}">
            </div>
            <div>
                <label>Consultant / PMC</label>
                <input type="text" name="consultant_pmc" value="{{ project.consultant_pmc or '' }}">
            </div>
        </div>
    </section>

    <hr>

    <!-- ================= PROJECT TIMELINE ================= -->
    <section class="form-section">
        <h3 class="section-title">Project Timeline</h3>
        <div class="form-grid">
            <div>
                <label>Project Start Date <span class="required">*</span></label>
                <div class="date-dual">
                    <input type="text" name="planned_start_date" id="planned_start_date_text" required inputmode="numeric" pattern="\d{2}/\d{2}/\d{4}" value="{{ project.planned_start_date.strftime('%d/%m/%Y') if project.planned_start_date else '' }}" placeholder="DD/MM/YYYY">
                    <input type="date" id="planned_start_date_picker">
                </div>
                <div class="help-text">Use DD/MM/YYYY or pick from calendar.</div>
            </div>
            <div>
                <label>Project End Date <span class="required">*</span></label>
                <div class="date-dual">
                    <input type="text" name="planned_end_date" id="planned_end_date_text" required inputmode="numeric" pattern="\d{2}/\d{2}/\d{4}" value="{{ project.planned_end_date.strftime('%d/%m/%Y') if project.planned_end_date else '' }}" placeholder="DD/MM/YYYY">
                    <input type="date" id="planned_end_date_picker">
                </div>
                <div class="help-text">End date must be after start date.</div>
            </div>
        </div>
    </section>

    <hr>

    <!-- ================= PROJECT CLASSIFICATION & ROAD DETAILS ================= -->
    <section class="form-section">
        <h3 class="section-title">Project Classification & Road Details</h3>
        <div class="form-grid">
            <div style="min-width:260px">
                <label>Project Type <span class="required">*</span></label>
                <select name="project_type" id="project_type" disabled>
                    <option value="">-- Select project type --</option>
                    {% for pt in (project_types + legacy_project_types) %}
                        <option value="{{ pt }}" {% if pt == project.project_type %}selected{% endif %}>{{ pt }}</option>
                    {% endfor %}
                </select>
                <div class="help-text">Project Type is locked after creation.</div>
                <input type="hidden" name="project_type" value="{{ project.project_type }}">
            </div>
        </div>

        <div class="form-grid" id="road_fields_block" style="margin-top:10px;display:none">
            <div style="min-width:260px">
                <label>Road Category (locked)</label>
                <select name="road_category" id="road_category" disabled>
                    <option value="">-- Select road category --</option>
                    {% for rc in road_categories %}
                        <option value="{{ rc }}" {% if rc == project.road_category %}selected{% endif %}>{{ rc }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" name="road_category" value="{{ project.road_category or '' }}">
            </div>
            <div style="min-width:260px">
                <label>Road Engineering Type (locked)</label>
                <select name="road_engineering_type" id="road_engineering_type" disabled>
                    <option value="">-- Select engineering type --</option>
                    <option value="Flexible" {% if project.road_engineering_type == 'Flexible' %}selected{% endif %}>Flexible</option>
                    <option value="Rigid" {% if project.road_engineering_type == 'Rigid' %}selected{% endif %}>Rigid</option>
                    <option value="Overlay" {% if project.road_engineering_type == 'Overlay' %}selected{% endif %}>Overlay</option>
                    <option value="Urban" {% if project.road_engineering_type == 'Urban' %}selected{% endif %}>Urban</option>
                    <option value="Rural" {% if project.road_engineering_type == 'Rural' %}selected{% endif %}>Rural</option>
                    <option value="Composite" {% if project.road_engineering_type == 'Composite' %}selected{% endif %}>Composite</option>
                </select>
                <input type="hidden" name="road_engineering_type" value="{{ project.road_engineering_type or '' }}">
            </div>
        </div>

        {% if project.project_type == 'Road' %}
        <div style="margin-top:16px">
            <h4 class="section-title" style="font-size:14px">Road Details</h4>
            <div class="form-grid">
                <div>
                    <label>Lanes <span class="required">*</span></label>
                    <input type="number" name="lanes" min="1" value="{{ project.lanes }}">
                </div>
                <div>
                    <label>Road Width (m) <span class="required">*</span></label>
                    <input type="number" step="0.01" name="road_width" value="{{ project.road_width }}">
                </div>
                <div>
                    <label>Road Length (km) <span class="required">*</span></label>
                    <input type="number" step="0.01" name="road_length_km" value="{{ project.road_length_km }}">
                </div>
                <div>
                    <label>Carriageway Width (m)</label>
                    <input type="number" step="0.01" name="carriageway_width" value="{{ project.carriageway_width or '' }}">
                </div>
                <div>
                    <label>Shoulder Type</label>
                    <input type="text" name="shoulder_type" value="{{ project.shoulder_type or '' }}">
                </div>
                <div>
                    <label>Median Type</label>
                    <input type="text" name="median_type" value="{{ project.median_type or '' }}">
                </div>
            </div>
        </div>
        {% else %}
            <input type="hidden" name="lanes" value="{{ project.lanes }}">
            <input type="hidden" name="road_width" value="{{ project.road_width }}">
            <input type="hidden" name="road_length_km" value="{{ project.road_length_km }}">
            <input type="hidden" name="carriageway_width" value="{{ project.carriageway_width or '' }}">
            <input type="hidden" name="shoulder_type" value="{{ project.shoulder_type or '' }}">
            <input type="hidden" name="median_type" value="{{ project.median_type or '' }}">
        {% endif %}
    </section>

    <hr>

    <!-- ================= LOCATION ================= -->
    <section class="form-section">
        <h3 class="section-title">Location</h3>
        <div class="form-grid">
            <div>
                <label>Country <span class="required">*</span></label>
                <input type="text" name="country" required value="{{ project.country }}">
            </div>
            <div>
                <label>State / Province</label>
                <input type="text" name="state" value="{{ project.state or '' }}">
            </div>
            <div>
                <label>District</label>
                <input type="text" name="district" value="{{ project.district or '' }}">
            </div>
            <div>
                <label>City <span class="required">*</span></label>
                <input type="text" name="city" required value="{{ project.city }}">
            </div>
            <div>
                <label>Chainage Start</label>
                <input type="text" name="chainage_start" value="{{ project.chainage_start or '' }}">
            </div>
            <div>
                <label>Chainage End</label>
                <input type="text" name="chainage_end" value="{{ project.chainage_end or '' }}">
            </div>
        </div>
    </section>

    <hr>

    <!-- ================= STRETCHES ================= -->
    {% if project.project_type == 'Road' %}
    <section class="form-section">
        <h3 class="section-title">Stretches & Activities</h3>
        <div class="help-text">Edit stretch names and dates, and adjust activity dates.</div>

        <form id="editStretchesInlineForm" method="post" action="/projects/{{ project.id }}/stretches/update">
            <input type="hidden" name="stretch_segments_json" id="stretch_segments_json">

            <div class="stretch-card" id="stretchGenerator">
                <div style="font-weight:600">Generate Stretches</div>
                <div class="help-text">If no stretches exist, generate them here.</div>
                <div class="form-grid" style="margin-top:8px">
                    <div>
                        <label>Total Road Length (km)</label>
                        <input type="number" id="gen_total_km" step="0.01" min="0" value="{{ project.road_length_km or 0 }}">
                    </div>
                    <div>
                        <label>Number of Stretches</label>
                        <input type="number" id="gen_count" min="1" step="1" value="5">
                    </div>
                    <div style="display:flex;align-items:flex-end">
                        <button type="button" class="btn-secondary" id="btnGenerate">Generate</button>
                    </div>
                </div>
            </div>

            <div id="stretchContainer"></div>

            <div style="display:flex;gap:12px;margin-top:12px">
                <button class="btn-primary" type="submit">Save Stretch Changes</button>
                <a href="/projects/{{ project.id }}/stretches/edit" class="btn-secondary">Open Full Editor</a>
            </div>
        </form>
    </section>

    <hr>
    {% endif %}

    <div style="display:flex;gap:12px;margin-top:20px">
        <button id="saveProjectBtn" class="btn-primary" type="submit">Save Changes</button>
        <a href="/projects/{{ project.id }}/stretches/edit" class="btn-secondary">Edit Stretches</a>
        <a href="/projects/{{ project.id }}" class="btn-secondary">Cancel</a>
    </div>
</form>

</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
    const projectType = document.getElementById('project_type');
    const roadFields = document.getElementById('road_fields_block');
    const startText = document.getElementById('planned_start_date_text');
    const endText = document.getElementById('planned_end_date_text');
    const startPicker = document.getElementById('planned_start_date_picker');
    const endPicker = document.getElementById('planned_end_date_picker');

    function ddmmyyyyToIso(v){
        const s = String(v || '').trim();
        if(!s) return '';
        const parts = s.split('/');
        if(parts.length !== 3) return '';
        const [dd, mm, yyyy] = parts;
        if(!dd || !mm || !yyyy) return '';
        return `${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`;
    }

    function isoToDdmmyyyy(v){
        const s = String(v || '').trim();
        if(!s) return '';
        const parts = s.split('-');
        if(parts.length !== 3) return '';
        const [yyyy, mm, dd] = parts;
        return `${dd.padStart(2,'0')}/${mm.padStart(2,'0')}/${yyyy}`;
    }

    function isRoad(){
        return projectType && projectType.value === 'Road';
    }

    function toggleRoadFields(){
        if(!roadFields) return;
        roadFields.style.display = isRoad() ? '' : 'none';
    }

    function syncTimelineInputs(){
        if(startPicker && startText){
            startPicker.value = ddmmyyyyToIso(startText.value);
        }
        if(endPicker && endText){
            endPicker.value = ddmmyyyyToIso(endText.value);
        }
    }

    if(startPicker && startText){
        startPicker.addEventListener('change', function(){
            startText.value = isoToDdmmyyyy(startPicker.value);
        });
    }
    if(endPicker && endText){
        endPicker.addEventListener('change', function(){
            endText.value = isoToDdmmyyyy(endPicker.value);
        });
    }

    toggleRoadFields();
    syncTimelineInputs();
})();
</script>
{% if project.project_type == 'Road' %}
<script id="stretches-data" type="application/json">{{ stretches_json | default('[]') | safe }}</script>
<script>
(function(){
    const container = document.getElementById('stretchContainer');
    const hiddenInput = document.getElementById('stretch_segments_json');
    let stretches = [];

    function ddmmyyyyToIso(v){
        const s = String(v || '').trim();
        if(!s) return '';
        const parts = s.split('/');
        if(parts.length !== 3) return '';
        const [dd, mm, yyyy] = parts;
        if(!dd || !mm || !yyyy) return '';
        return `${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`;
    }

    function isoToDdmmyyyy(v){
        const s = String(v || '').trim();
        if(!s) return '';
        const parts = s.split('-');
        if(parts.length !== 3) return '';
        const [yyyy, mm, dd] = parts;
        return `${dd.padStart(2,'0')}/${mm.padStart(2,'0')}/${yyyy}`;
    }

    function serialize(){
        if(hiddenInput){
            hiddenInput.value = JSON.stringify(stretches || []);
        }
    }

    function render(){
        if(!container) return;
        container.innerHTML = '';
        const gen = document.getElementById('stretchGenerator');
        if(!(stretches || []).length){
            if(gen) gen.style.display = 'block';
            const empty = document.createElement('div');
            empty.className = 'stretch-card';
            empty.textContent = 'No stretches found. Use Generate Stretches above.';
            container.appendChild(empty);
            serialize();
            return;
        }
        if(gen) gen.style.display = 'none';
        (stretches || []).forEach((st, idx) => {
            const card = document.createElement('div');
            card.className = 'stretch-card';
            const showDetails = (st._showDetails === true);
            card.innerHTML = `
                <div class="stretch-header">
                    <div><strong>${st.stretch_name || ('Stretch ' + (idx+1))}</strong></div>
                    <div style="display:flex;gap:8px;align-items:center">
                        <button type="button" class="btn-secondary btn-small" data-kind="toggle-details" data-idx="${idx}">${showDetails ? 'Hide' : 'Show'}</button>
                        <div style="opacity:0.75">${st.stretch_code || ''}</div>
                    </div>
                </div>
                <div data-kind="details-body" data-idx="${idx}" style="display:${showDetails ? '' : 'none'}">
                <div class="form-grid" style="margin-top:10px">
                    <div>
                        <label>Stretch Name</label>
                        <input type="text" value="${st.stretch_name || ''}" data-kind="stretch-name" data-idx="${idx}">
                    </div>
                    <div>
                        <label>Start Date</label>
                        <div class="date-dual">
                            <input type="text" value="${st.planned_start_date || ''}" placeholder="DD/MM/YYYY" data-kind="stretch-start" data-idx="${idx}">
                            <input type="date" value="${ddmmyyyyToIso(st.planned_start_date || '')}" data-kind="stretch-start-picker" data-idx="${idx}">
                        </div>
                    </div>
                    <div>
                        <label>End Date</label>
                        <div class="date-dual">
                            <input type="text" value="${st.planned_end_date || ''}" placeholder="DD/MM/YYYY" data-kind="stretch-end" data-idx="${idx}">
                            <input type="date" value="${ddmmyyyyToIso(st.planned_end_date || '')}" data-kind="stretch-end-picker" data-idx="${idx}">
                        </div>
                    </div>
                </div>

                <div style="margin-top:12px">
                    <div style="font-weight:600">Activities</div>
                    <div class="help-text">Activity dates are clamped to stretch dates on save.</div>
                    ${(st.activities || []).map((a, aidx) => `
                        <div class="activity-row">
                            <input type="text" value="${a.name || ''}" disabled>
                            <div class="date-dual">
                                <input type="text" value="${a.planned_start_date || ''}" placeholder="DD/MM/YYYY" data-kind="act-start" data-idx="${idx}" data-aidx="${aidx}">
                                <input type="date" value="${ddmmyyyyToIso(a.planned_start_date || '')}" data-kind="act-start-picker" data-idx="${idx}" data-aidx="${aidx}">
                            </div>
                            <div class="date-dual">
                                <input type="text" value="${a.planned_end_date || ''}" placeholder="DD/MM/YYYY" data-kind="act-end" data-idx="${idx}" data-aidx="${aidx}">
                                <input type="date" value="${ddmmyyyyToIso(a.planned_end_date || '')}" data-kind="act-end-picker" data-idx="${idx}" data-aidx="${aidx}">
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div style="margin-top:12px">
                    <div style="font-weight:600">Materials</div>
                    <div class="help-text">Project planned materials available for this stretch.</div>
                    ${(st.materials || []).length ? `
                        <div class="material-list">
                            ${(st.materials || []).map(m => `<span class="material-chip">${m.name || ''} (${m.unit || ''})</span>`).join('')}
                        </div>
                    ` : `<div class="help-text">No materials configured.</div>`}
                </div>
                </div>
            `;
            container.appendChild(card);
        });
        serialize();
    }

    function handleInput(e){
        const t = e.target;
        if(!t) return;
        const kind = t.getAttribute('data-kind');
        const idx = parseInt(t.getAttribute('data-idx') || '-1', 10);
        if(idx < 0 || !stretches[idx]) return;

        const st = stretches[idx];
        const aidx = parseInt(t.getAttribute('data-aidx') || '-1', 10);

        if(kind === 'toggle-details'){
            st._showDetails = !(st._showDetails === true);
            render();
            return;
        }
        if(kind === 'stretch-name') st.stretch_name = String(t.value || '').trim();
        if(kind === 'stretch-start'){
            st.planned_start_date = String(t.value || '').trim();
            const picker = t.closest('.date-dual')?.querySelector('[data-kind="stretch-start-picker"]');
            if(picker) picker.value = ddmmyyyyToIso(st.planned_start_date);
        }
        if(kind === 'stretch-end'){
            st.planned_end_date = String(t.value || '').trim();
            const picker = t.closest('.date-dual')?.querySelector('[data-kind="stretch-end-picker"]');
            if(picker) picker.value = ddmmyyyyToIso(st.planned_end_date);
        }
        if(kind === 'stretch-start-picker'){
            const dd = isoToDdmmyyyy(String(t.value || '').trim());
            st.planned_start_date = dd;
            const text = t.closest('.date-dual')?.querySelector('[data-kind="stretch-start"]');
            if(text) text.value = dd;
        }
        if(kind === 'stretch-end-picker'){
            const dd = isoToDdmmyyyy(String(t.value || '').trim());
            st.planned_end_date = dd;
            const text = t.closest('.date-dual')?.querySelector('[data-kind="stretch-end"]');
            if(text) text.value = dd;
        }

        if(aidx >= 0 && st.activities && st.activities[aidx]){
            const a = st.activities[aidx];
            if(kind === 'act-start'){
                a.planned_start_date = String(t.value || '').trim();
                const picker = t.closest('.date-dual')?.querySelector('[data-kind="act-start-picker"]');
                if(picker) picker.value = ddmmyyyyToIso(a.planned_start_date);
            }
            if(kind === 'act-end'){
                a.planned_end_date = String(t.value || '').trim();
                const picker = t.closest('.date-dual')?.querySelector('[data-kind="act-end-picker"]');
                if(picker) picker.value = ddmmyyyyToIso(a.planned_end_date);
            }
            if(kind === 'act-start-picker'){
                const dd = isoToDdmmyyyy(String(t.value || '').trim());
                a.planned_start_date = dd;
                const text = t.closest('.date-dual')?.querySelector('[data-kind="act-start"]');
                if(text) text.value = dd;
            }
            if(kind === 'act-end-picker'){
                const dd = isoToDdmmyyyy(String(t.value || '').trim());
                a.planned_end_date = dd;
                const text = t.closest('.date-dual')?.querySelector('[data-kind="act-end"]');
                if(text) text.value = dd;
            }
        }
        serialize();
    }

    try{
        const raw = document.getElementById('stretches-data');
        stretches = JSON.parse(raw.textContent || '[]') || [];
    }catch(e){
        stretches = [];
    }

    const btnGenerate = document.getElementById('btnGenerate');
    if(btnGenerate){
        btnGenerate.addEventListener('click', function(){
            const totalKm = parseFloat(String(document.getElementById('gen_total_km')?.value || '0')) || 0;
            const count = parseInt(String(document.getElementById('gen_count')?.value || '0'), 10) || 0;
            if(totalKm <= 0 || count <= 0){
                return;
            }
            const totalM = Math.round(totalKm * 1000);
            const base = Math.floor(totalM / count);
            let cursor = 0;
            const startDate = "{{ project.planned_start_date.strftime('%d/%m/%Y') if project.planned_start_date else '' }}";
            const endDate = "{{ project.planned_end_date.strftime('%d/%m/%Y') if project.planned_end_date else '' }}";

            stretches = [];
            for(let i=1;i<=count;i++){
                const isLast = i === count;
                const end = isLast ? totalM : (cursor + base);
                stretches.push({
                    id: null,
                    sequence_no: i,
                    stretch_code: `ST-${String(i).padStart(3,'0')}`,
                    stretch_name: `Stretch ${i}`,
                    start_m: cursor,
                    end_m: end,
                    length_m: Math.max(end - cursor, 1),
                    planned_start_date: startDate,
                    planned_end_date: endDate,
                    activities: [],
                });
                cursor = end;
            }
            render();
        });
    }

    render();
    if(container){
        container.addEventListener('input', handleInput);
        container.addEventListener('change', handleInput);
        container.addEventListener('click', function(e){
            const t = e.target;
            if(!t) return;
            const kind = t.getAttribute('data-kind');
            if(kind === 'toggle-details'){
                handleInput(e);
            }
        });
    }
})();
</script>
{% endif %}
{% endblock %}
{# LEGACY TEMPLATE REMOVED
            'project_type': project.project_type or '',
            'road_category': project.road_category or project.road_type or '',
            'road_engineering_type': project.road_engineering_type or '',
            'road_extras_json': project.road_extras_json or '{}'
        } | tojson }}</script>
                ph.value = '';
                ph.textContent = '-- Select --';
                selectEl.appendChild(ph);
            }
            (options || []).forEach(function(opt){
                var o = document.createElement('option');
                o.value = opt;
                o.textContent = opt;
                selectEl.appendChild(o);
            });
        }

        function handleProjectTypeChange(){
            var projectType = document.getElementById('project_type');
            var roadBlock = document.getElementById('road_block');
            var roadClassification = document.getElementById('road_classification');
            var roadCategoryField = document.getElementById('road_category_field');
            var roadCategorySelect = document.getElementById('road_category');
            var roadEngineeringField = document.getElementById('road_engineering_field');
            var roadEngineeringSelect = document.getElementById('road_engineering_type');
            var presetsPanel = document.getElementById('road_presets_panel');
            var roadQuestions = document.getElementById('road_questions');
            var details1 = document.getElementById('road_details_fields');
            var details2 = document.getElementById('road_details_fields2');
            var details3 = document.getElementById('road_details_fields3');

            if(!projectType || !roadBlock || !roadClassification || !roadCategoryField || !roadCategorySelect || !roadEngineeringField || !roadEngineeringSelect || !presetsPanel || !roadQuestions || !details1 || !details2 || !details3) return;

            var isRoad = projectType.value === 'Road';
            roadBlock.style.display = isRoad ? 'block' : 'none';
            roadClassification.style.display = isRoad ? 'grid' : 'none';
            roadCategoryField.style.display = isRoad ? 'block' : 'none';
            roadEngineeringField.style.display = isRoad ? 'block' : 'none';

            presetsPanel.style.display = isRoad ? 'block' : 'none';
            details1.style.display = isRoad ? 'block' : 'none';
            details2.style.display = isRoad ? 'block' : 'none';
            details3.style.display = isRoad ? 'block' : 'none';

            document.querySelectorAll('[name="lanes"],[name="road_width"],[name="road_length_km"]').forEach(function(el){
                if(isRoad) el.setAttribute('required','required'); else el.removeAttribute('required');
            });
        }

        function updateEngineeringOptions(){
            var category = document.getElementById('road_category');
            var engineering = document.getElementById('road_engineering_type');
            if(!category || !engineering || !__classification) return;
            var map = __classification.engineering_types_by_category || {};
            var opts = map[category.value] || [];
            populateSelect(engineering, opts);
        }

        function renderConditionalQuestionsReadOnly(){
            var category = document.getElementById('road_category');
            var block = document.getElementById('road_questions');
            var container = document.getElementById('road_questions_container');
            if(!category || !block || !container || !__classification) return;

            var qsMap = __classification.conditional_questions_by_category || {};
            var qs = qsMap[category.value] || [];
            container.innerHTML = '';
            if(!qs.length){
                block.style.display = 'none';
                return;
            }
            block.style.display = 'block';

            var values = {};
            try { values = JSON.parse(__project.road_extras_json || '{}') || {}; } catch(e) { values = {}; }

            var grid = document.createElement('div');
            grid.className = 'form-grid';
            qs.forEach(function(q){
                var wrap = document.createElement('div');
                var label = document.createElement('label');
                label.textContent = q.label || q.key;
                wrap.appendChild(label);

                var inp = document.createElement('input');
                inp.type = 'text';
                inp.disabled = true;
                inp.value = (values[q.key] || '');
                wrap.appendChild(inp);
                grid.appendChild(wrap);
            });
            container.appendChild(grid);
        }

        function renderActivityPresets(){
            var list = _el('activityPresetList');
            if(!list) return;
            list.innerHTML = '';
            var items = (__currentRoadPresets && __currentRoadPresets.activities) ? __currentRoadPresets.activities : [];
            items.forEach(function(item, idx){
                var row = document.createElement('div');
                row.className = 'preset-row';

                var cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.checked = !!item.enabled;
                cb.disabled = true;

                var input = document.createElement('input');
                input.type = 'text';
                input.value = item.name || '';
                input.disabled = true;

                var pill = document.createElement('span');
                pill.className = 'pill';
                pill.textContent = (item.standard ? 'Standard' : 'Custom');

                row.appendChild(cb);
                row.appendChild(input);
                row.appendChild(pill);
                list.appendChild(row);
            });
        }

        function renderMaterialPresets(){
            var list = _el('materialPresetList');
            if(!list) return;
            list.innerHTML = '';

            var items = (__currentRoadPresets && __currentRoadPresets.materials) ? __currentRoadPresets.materials : [];
            items.forEach(function(item){
                var row = document.createElement('div');
                row.className = 'preset-row';

                var cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.checked = !!item.enabled;
                cb.disabled = true;

                var name = document.createElement('input');
                name.type = 'text';
                name.value = item.name || '';
                name.disabled = true;

                var pill = document.createElement('span');
                pill.className = 'pill';
                pill.textContent = 'Unit: ' + (item.unit || 'unit');

                row.appendChild(cb);
                row.appendChild(name);
                row.appendChild(pill);
                list.appendChild(row);
            });
        }

        function loadRoadPresets(engineeringType){
            if(!engineeringType){
                __roadPresetsCache = null;
                __currentRoadPresets = null;
                renderActivityPresets();
                renderMaterialPresets();
                return;
            }

            var url = '/projects/road-presets?engineering_type=' + encodeURIComponent(engineeringType);
            return fetch(url, { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' })
                .then(function(r){ return r.json(); })
                .then(function(data){
                    var defs = Array.isArray(data.activity_preset_defs) ? data.activity_preset_defs : null;
                    var activities = [];
                    if(defs && defs.length){
                        activities = defs.map(function(d){
                            var name = String((d && d.name) || '').trim();
                            var scope = String((d && (d.activity_scope || d.scope)) || '').trim();
                            if(scope){ scope = scope.toUpperCase(); }
                            if(scope !== 'COMMON' && scope !== 'STRETCH'){ scope = 'STRETCH'; }
                            return { name: name, enabled: true, standard: true, activity_scope: scope, phase: (d && d.phase) ? String(d.phase) : '' };
                        }).filter(function(a){ return !!(a && a.name); });
                    } else {
                        activities = (data.activities || []).map(function(n){
                            return { name: String(n || ''), enabled: true, standard: true, activity_scope: 'STRETCH', phase: '' };
                        });
                    }
                    var materials = (data.materials || []).map(function(m){
                        var defaultUnit = String(m.default_unit || 'unit');
                        var allowed = Array.isArray(m.allowed_units) ? m.allowed_units.map(function(u){ return String(u || '').trim(); }).filter(Boolean) : [];
                        if(!allowed.length) allowed = [defaultUnit];
                        return { name: String(m.name || ''), unit: defaultUnit, allowed_units: allowed, enabled: true, standard: true };
                    });

                    __roadPresetsCache = { engineering_type: data.engineering_type || engineeringType, activities: activities, materials: materials };
                    __currentRoadPresets = {
                        engineering_type: __roadPresetsCache.engineering_type,
                        activities: activities.map(function(a){ return { name: a.name, enabled: a.enabled, standard: a.standard, activity_scope: a.activity_scope, phase: a.phase }; }),
                        materials: materials.map(function(m){ return { name: m.name, unit: m.unit, allowed_units: (m.allowed_units || []), enabled: m.enabled, standard: m.standard }; }),
                    };

                    renderActivityPresets();
                    renderMaterialPresets();
                })
                .catch(function(){});
        }

        function loadClassificationMetadata(){
            return fetch('/projects/classification-metadata', { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' })
                .then(function(r){ return r.json(); })
                .then(function(data){
                    __classification = data;
                    populateSelect(_el('project_type'), (data.project_types || []).concat(data.legacy_project_types || []));
                    populateSelect(_el('road_category'), data.road_categories || []);
                })
                .catch(function(){});
        }

        document.addEventListener('DOMContentLoaded', function(){
            var form = _el('editProjectForm');
            var btn = _el('saveProjectBtn');

            loadClassificationMetadata().then(function(){
                var projectType = _el('project_type');
                var roadCategory = _el('road_category');
                var roadEngineering = _el('road_engineering_type');

                if(projectType){
                    projectType.value = __project.project_type || '';
                    projectType.disabled = true;
                }
                handleProjectTypeChange();

                if(roadCategory){
                    roadCategory.value = __project.road_category || '';
                    roadCategory.disabled = true;
                }
                updateEngineeringOptions();
                if(roadEngineering){
                    roadEngineering.value = __project.road_engineering_type || '';
                    roadEngineering.disabled = true;
                }

                renderConditionalQuestionsReadOnly();
                loadRoadPresets(__project.road_engineering_type || '');

                // Disable any interactive buttons in presets panel (reference-only)
                var presetsPanel = _el('road_presets_panel');
                if(presetsPanel){
                    presetsPanel.querySelectorAll('button,input,select,textarea').forEach(function(el){ el.disabled = true; });
                }
            });

            if(form){
                form.addEventListener('input', function(){
                    setFormError('');
                    updateSaveButtonState();
                });
                form.addEventListener('change', function(){
                    setFormError('');
                    updateSaveButtonState();
                });
                form.addEventListener('submit', function(e){
                    setFormError('');
                    form.querySelectorAll('.is-invalid').forEach(function(el){ el.classList.remove('is-invalid'); });
                    if(!form.checkValidity()){
                        e.preventDefault();
                        form.querySelectorAll('input,select,textarea').forEach(function(el){
                            if(typeof el.checkValidity === 'function' && !el.checkValidity()) el.classList.add('is-invalid');
                        });
                        setFormError('Please fill all required fields highlighted below.');
                        updateSaveButtonState();
                        return;
                    }
                    if(btn){
                        btn.disabled = true;
                        btn.textContent = 'Savingâ€¦';
                    }
                });
            }

            updateSaveButtonState();
        });
        </script>
        {% endblock %}
        #}

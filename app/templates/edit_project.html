{% extends "base.html" %}
{% block content %}
{% set fallback_project_types = ["Road", "Bridge", "Flyover", "Building", "Utility / Pipeline"] %}
{% set fallback_legacy_project_types = ["Residential", "Commercial", "Industrial", "Utility", "Other"] %}
{% set fallback_road_categories = ["Expressway", "National Highway (NH)", "State Highway (SH)", "Major District Road (MDR)", "Other District Road (ODR)", "Village / Rural Road (VR)", "Urban Road", "Service Road"] %}
{% set project_types = classification_metadata.get('project_types', []) %}
{% set legacy_project_types = classification_metadata.get('legacy_project_types', []) %}
{% set road_categories = classification_metadata.get('road_categories', []) %}
{% if not project_types %}{% set project_types = fallback_project_types %}{% endif %}
{% if not legacy_project_types %}{% set legacy_project_types = fallback_legacy_project_types %}{% endif %}
{% if not road_categories %}{% set road_categories = fallback_road_categories %}{% endif %}

<h1 class="page-title">Edit Project</h1>

<div class="card card--page">

<style>
    .form-errors{display:none;margin:0 0 14px;padding:10px 12px;border:1px solid rgba(214,69,69,0.45);background:rgba(214,69,69,0.12);border-radius:8px;color:var(--text-primary)}
    .is-invalid{border-color: rgba(214,69,69,0.9) !important; box-shadow: 0 0 0 3px rgba(214,69,69,0.15)}
    .date-dual{display:flex;gap:8px;align-items:center}
    .date-dual input[type="date"]{max-width:170px}
</style>

<form id="editProjectForm" method="post" action="/projects/{{ project.id }}/update">
    <div id="formErrors" class="form-errors"></div>

    <!-- ================= BASIC INFO ================= -->
    <section class="form-section">
        <h3 class="section-title">Basic Information</h3>
        <div class="form-grid">
            <div>
                <label>Project Name <span class="required">*</span></label>
                <input type="text" name="name" required value="{{ project.name }}">
                <div class="help-text">Use a concise, descriptive name (e.g. NH-66 Upgrade)</div>
            </div>
            <div>
                <label>Project Code / Package No</label>
                <input type="text" name="project_code" value="{{ project.project_code or '' }}">
            </div>
            <div>
                <label>Client / Authority</label>
                <input type="text" name="client_authority" value="{{ project.client_authority or '' }}">
            </div>
            <div>
                <label>Contractor</label>
                <input type="text" name="contractor" value="{{ project.contractor or '' }}">
            </div>
            <div>
                <label>Consultant / PMC</label>
                <input type="text" name="consultant_pmc" value="{{ project.consultant_pmc or '' }}">
            </div>
        </div>
    </section>

    <hr>


    <!-- ================= ROLE BASED USER ================= -->
    {% if user and user["role"] in ["admin", "superadmin"] %}
    <section class="form-section" id="project_team_section">
        <h3 class="section-title">Role Based User</h3>
        <div class="help-text">Assign users to this project and set their role.</div>
        <div class="card" style="margin-bottom:14px;padding:12px">
            <h4 class="section-title" style="font-size:14px;margin:0 0 8px 0">Create User</h4>
            <div class="help-text" style="margin-bottom:10px">Create a system user (Admin/Manager/User/Viewer).</div>
            <div class="form-grid">
                <div>
                    <label>Username</label>
                    <input type="text" name="username" form="createUserForm" required autocomplete="off" spellcheck="false">
                </div>
                <div>
                    <label>Email</label>
                    <input type="email" name="email" form="createUserForm" autocomplete="off">
                </div>
                <div>
                    <label>Password</label>
                    <input type="password" name="password" form="createUserForm" required autocomplete="new-password">
                </div>
                <div>
                    <label>System Role</label>
                    <select name="role" form="createUserForm" required autocomplete="off">
                        <option value="admin">Admin</option>
                        <option value="manager">Manager</option>
                        <option value="user" selected>User</option>
                        <option value="viewer">Viewer</option>
                    </select>
                </div>
            </div>
            <div style="margin-top:10px">
                <button type="submit" class="btn-primary" form="createUserForm">Create User</button>
            </div>
        </div>
        <div class="form-grid">
            <div>
                <label>User</label>
                <select id="project_team_user">
                    <option value="">Select User</option>
                    {% for u in (all_users or []) %}
                        {% if u.role != "superadmin" %}
                        <option value="{{ u.id }}">{{ u.username }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Role in Project</label>
                <select id="project_team_role">
                    <option value="admin">Admin</option>
                    <option value="manager">Manager</option>
                    <option value="viewer" selected>Viewer</option>
                    <option value="member">Member</option>
                </select>
            </div>
            <div style="display:flex;align-items:flex-end">
                <button type="button" class="btn-primary" id="add_project_team">Add User</button>
            </div>
        </div>
        <div id="project_team_list" style="margin-top:12px"></div>
        <input type="hidden" name="project_team_json" id="project_team_json" value="{{ project.project_team_json or '' }}">
    </section>
    <hr>
    {% endif %}
    <!-- ================= STRETCH SYSTEM (ROAD ONLY) ================= -->
    <section class="form-section" id="stretch_system_block" style="{% if project.project_type != 'Road' %}display:none{% endif %}">
        <h3 class="section-title">Stretch System (Road Projects)</h3>
        <div class="help-text">Mandatory for Road projects. Stretches remain editable after creation.</div>
        <input type="hidden" name="stretch_enabled" id="stretch_enabled" value="1">
        <div class="form-grid" style="margin-top:10px">
            <div>
                <label>Total Road Length (km) <span class="required">*</span></label>
                <input type="number" id="stretch_total_length_km" step="0.01" min="0" placeholder="e.g. 12.50" value="{{ project.road_length_km or '' }}">
                <input type="hidden" name="road_length_km" id="road_length_km" value="{{ project.road_length_km or '' }}">
            </div>
            <div>
                <label>Total Number of Stretches <span class="required">*</span></label>
                <input type="number" id="stretch_number_of_stretches" min="1" step="1" value="{{ project.stretch_number_of_stretches or '' }}">
            </div>
            <div style="display:flex;align-items:flex-end">
                <button type="button" class="btn-primary" id="btnGenerateStretches">Generate stretches</button>
            </div>
        </div>
        <input type="hidden" name="stretch_segments_json" id="stretch_segments_json" value="{{ project.stretch_segments_json or '' }}">
        <div id="stretch_editor" style="margin-top:14px;display:none">
            <div class="help-text">Edit stretch length to update chainage. Total length must equal the road length.</div>
            <div style="overflow:auto;border:1px solid rgba(255,255,255,0.08);border-radius:12px;margin-top:10px">
                <table class="table" style="margin:0;min-width:920px">
                    <thead>
                        <tr>
                            <th style="width:80px">No</th>
                            <th style="width:220px">Stretch Name</th>
                            <th style="width:140px">Start Chainage</th>
                            <th style="width:140px">End Chainage</th>
                            <th style="width:120px">Length (m)</th>
                            <th style="width:100px">Width (m)</th>
                            <th style="width:100px">Depth (m)</th>
                            <th style="width:170px">Start Date</th>
                            <th style="width:170px">End Date</th>
                        </tr>
                    </thead>
                    <tbody id="stretchSegmentList"></tbody>
                </table>
            </div>
            <div id="stretchDetailsList" style="margin-top:12px"></div>
        </div>
    </section>

    <script>
    // --- User/Team Section: Render existing users for editing ---
    document.addEventListener('DOMContentLoaded', function() {
        var teamJson = document.getElementById('project_team_json');
        var teamList = document.getElementById('project_team_list');
        if (teamJson && teamJson.value) {
            try {
                var users = JSON.parse(teamJson.value);
                if (Array.isArray(users) && users.length > 0) {
                    teamList.innerHTML = users.map(function(u, idx) {
                        return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                            <span><b>${u.username}</b> (${u.role})</span>
                            <button type="button" onclick="removeUser(${idx})" style="color:#fff;background:#d44545;border:none;padding:2px 8px;border-radius:4px;">Remove</button>
                        </div>`;
                    }).join('');
                }
            } catch(e) { /* ignore */ }
        }
        window.removeUser = function(idx) {
            var users = JSON.parse(teamJson.value);
            users.splice(idx, 1);
            teamJson.value = JSON.stringify(users);
            location.reload(); // quick way to refresh list; can be improved
        };
    });

    // --- Stretch System: Render existing stretches for editing ---
    document.addEventListener('DOMContentLoaded', function() {
        var stretchJson = document.getElementById('stretch_segments_json');
        var stretchList = document.getElementById('stretchSegmentList');
        if (stretchJson && stretchJson.value) {
            try {
                var stretches = JSON.parse(stretchJson.value);
                if (Array.isArray(stretches) && stretches.length > 0) {
                    stretchList.innerHTML = stretches.map(function(s, idx) {
                        return `<tr>
                            <td>${idx+1}</td>
                            <td><input type="text" name="stretch_name_${idx}" value="${s.name||''}" /></td>
                            <td><input type="text" name="stretch_start_chainage_${idx}" value="${s.start_chainage||''}" /></td>
                            <td><input type="text" name="stretch_end_chainage_${idx}" value="${s.end_chainage||''}" /></td>
                            <td><input type="number" name="stretch_length_${idx}" value="${s.length||''}" step="0.01" /></td>
                            <td><input type="number" name="stretch_width_${idx}" value="${s.width||''}" step="0.01" /></td>
                            <td><input type="number" name="stretch_depth_${idx}" value="${s.depth||''}" step="0.01" /></td>
                            <td><input type="text" name="stretch_start_date_${idx}" value="${s.start_date||''}" /></td>
                            <td><input type="text" name="stretch_end_date_${idx}" value="${s.end_date||''}" /></td>
                        </tr>`;
                    }).join('');
                }
            } catch(e) { /* ignore */ }
        }
    });
    </script>


    <!-- ================= PROJECT TIMELINE ================= -->
    <section class="form-section">
        <h3 class="section-title">Project Timeline</h3>
        <div class="form-grid">
            <div>
                <label>Project Start Date <span class="required">*</span></label>
                <input type="text" name="planned_start_date" id="planned_start_date" required placeholder="DD/MM/YYYY" maxlength="10" inputmode="numeric" pattern="\d{1,2}/\d{1,2}/\d{4}" value="{{ project.planned_start_date.strftime('%d/%m/%Y') if project.planned_start_date else '' }}">
                <div class="help-text">Pick from calendar. Format: <b>DD/MM/YYYY</b></div>
            </div>
            <div>
                <label>Project End Date <span class="required">*</span></label>
                <input type="text" name="planned_end_date" id="planned_end_date" required placeholder="DD/MM/YYYY" maxlength="10" inputmode="numeric" pattern="\d{1,2}/\d{1,2}/\d{4}" value="{{ project.planned_end_date.strftime('%d/%m/%Y') if project.planned_end_date else '' }}">
                <div class="help-text">End date must be after start date. Format: <b>DD/MM/YYYY</b></div>
            </div>
        </div>
    </section>

    <hr>

    <!-- ================= PROJECT CLASSIFICATION ================= -->
    <section class="form-section">
        <h3 class="section-title">Project Classification</h3>
        <div class="form-grid">
            <div style="min-width:260px">
                <label>Project Type <span class="required">*</span></label>
                <select name="project_type" id="project_type" required>
                    <option value="">-- Select project type --</option>
                    {% for pt in (project_types + legacy_project_types) %}
                        <option value="{{ pt }}" {% if project.project_type == pt %}selected{% endif %}>{{ pt }}</option>
                    {% endfor %}
                </select>
                <div class="help-text">Road projects must also fill Road Category and Road Engineering Type below.</div>
            </div>
        </div>
        <div class="form-grid" id="road_fields_block" style="margin-top:10px;{% if project.project_type != 'Road' %}display:none{% endif %}">
            <div style="min-width:260px">
                <label>Road Category (required only for Road)</label>
                <select name="road_category" id="road_category">
                    <option value="">-- Select road category --</option>
                    {% for rc in road_categories %}
                        <option value="{{ rc }}" {% if project.road_category == rc %}selected{% endif %}>{{ rc }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="min-width:260px">
                <label>Road Engineering Type (required only for Road)</label>
                <select name="road_engineering_type" id="road_engineering_type">
                    <option value="">-- Select engineering type --</option>
                    <option value="Flexible" {% if project.road_engineering_type == 'Flexible' %}selected{% endif %}>Flexible</option>
                    <option value="Rigid" {% if project.road_engineering_type == 'Rigid' %}selected{% endif %}>Rigid</option>
                    <option value="Overlay" {% if project.road_engineering_type == 'Overlay' %}selected{% endif %}>Overlay</option>
                    <option value="Urban" {% if project.road_engineering_type == 'Urban' %}selected{% endif %}>Urban</option>
                    <option value="Rural" {% if project.road_engineering_type == 'Rural' %}selected{% endif %}>Rural</option>
                    <option value="Composite" {% if project.road_engineering_type == 'Composite' %}selected{% endif %}>Composite</option>
                </select>
            </div>
            <div style="min-width:180px">
                <label>Lanes <span class="required">*</span></label>
                <input type="text" name="lanes" value="{{ project.lanes or '' }}" required>
            </div>
            <div style="min-width:180px">
                <label>Road Width (m) <span class="required">*</span></label>
                <input type="number" step="0.01" name="road_width" value="{{ project.road_width or '' }}" required>
            </div>
        </div>
    </section>

    <!-- ================= LOCATION ================= -->
    <section class="form-section">
        <h3 class="section-title">Location</h3>
        <div class="form-grid">
            <div>
                <label>Country <span class="required">*</span></label>
                <input type="text" name="country" value="{{ project.country or 'India' }}" required>
            </div>
            <div>
                <label>State / Province</label>
                <input type="text" name="state" value="{{ project.state or '' }}">
            </div>
            <div>
                <label>District</label>
                <input type="text" name="district" value="{{ project.district or '' }}">
            </div>
            <div>
                <label>City <span class="required">*</span></label>
                <input type="text" name="city" value="{{ project.city or '' }}" required>
            </div>
        </div>
        <div class="form-grid" style="margin-top:12px">
            <div>
                <label>Start Chainage</label>
                <input type="text" name="chainage_start" value="{{ project.chainage_start or '' }}">
            </div>
            <div>
                <label>End Chainage</label>
                <input type="text" name="chainage_end" value="{{ project.chainage_end or '' }}">
            </div>
        </div>
    </section>

    <!-- ================= HIDDEN PAYLOADS ================= -->
    <input type="hidden" name="activity_presets_json" value="{{ project.activity_presets_json or '' }}">
    <input type="hidden" name="activity_preset_defs_json" value="{{ project.activity_preset_defs_json or '' }}">
    <input type="hidden" name="material_presets_json" value="{{ project.material_presets_json or '' }}">
    <input type="hidden" name="material_preset_defs_json" value="{{ project.material_preset_defs_json or '' }}">
    <input type="hidden" name="project_team_json" value="{{ project.project_team_json or '' }}">
    <input type="hidden" name="road_extras_json" value="{{ project.road_extras_json or '' }}">

    <!-- ================= ACTIONS ================= -->
    <div style="display:flex;gap:12px;margin-top:20px">
        <button class="btn-primary" type="submit">Save Changes</button>
        <a href="/dashboard" class="btn-secondary">Cancel</a>
    </div>

    <!-- ...continue copying and adapting the rest of new_project_clean.html, pre-filling all fields with project values for editing... -->
</form>
</div>
{% endblock %}

    <hr>

    <!-- Removed top Project Classification & Road Details section -->

            <form id="editProjectForm" method="post" action="/projects/{{ project.id }}/update">
                <div id="formErrors" class="form-errors"></div>

                <!-- Removed duplicate Basic Information section -->

                <hr>

                <!-- ================= ROLE BASED USER ================= -->
                {% if user and user["role"] in ["admin", "superadmin"] %}
                <section class="form-section" id="project_team_section">
                    <h3 class="section-title">Role Based User</h3>
                    <div class="help-text">Assign users to this project and set their role.</div>
                    <div class="card" style="margin-bottom:14px;padding:12px">
                        <h4 class="section-title" style="font-size:14px;margin:0 0 8px 0">Create User</h4>
                        <div class="help-text" style="margin-bottom:10px">Create a system user (Admin/Manager/User/Viewer).</div>
                        <div class="form-grid">
                            <div>
                                <label>Username</label>
                                <input type="text" name="username" form="createUserForm" required autocomplete="off" spellcheck="false">
                            </div>
                            <div>
                                <label>Email</label>
                                <input type="email" name="email" form="createUserForm" autocomplete="off">
                            </div>
                            <div>
                                <label>Password</label>
                                <input type="password" name="password" form="createUserForm" required autocomplete="new-password">
                            </div>
                            <div>
                                <label>System Role</label>
                                <select name="role" form="createUserForm" required autocomplete="off">
                                    <option value="admin">Admin</option>
                                    <option value="manager">Manager</option>
                                    <option value="user" selected>User</option>
                                    <option value="viewer">Viewer</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top:10px">
                            <button type="submit" class="btn-primary" form="createUserForm">Create User</button>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div>
                            <label>User</label>
                            <select id="project_team_user">
                                <option value="">Select User</option>
                                {% for u in (all_users or []) %}
                                    {% if u.role != "superadmin" %}
                                    <option value="{{ u.id }}">{{ u.username }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label>Role in Project</label>
                            <select id="project_team_role">
                                <option value="admin">Admin</option>
                                <option value="manager">Manager</option>
                                <option value="viewer" selected>Viewer</option>
                                <option value="member">Member</option>
                            </select>
                        </div>
                        <div style="display:flex;align-items:flex-end">
                            <button type="button" class="btn-primary" id="add_project_team">Add User</button>
                        </div>
                    </div>
                    <div id="project_team_list" style="margin-top:12px"></div>
                </section>
                <hr>
                {% endif %}

                <!-- ================= PROJECT TIMELINE ================= -->
                <section class="form-section">
                    <h3 class="section-title">Project Timeline</h3>
                    <div class="form-grid">
                        <div>
                            <label>Project Start Date <span class="required">*</span></label>
                            <input type="text" name="planned_start_date" id="planned_start_date" required placeholder="DD/MM/YYYY" maxlength="10" inputmode="numeric" pattern="\d{1,2}/\d{1,2}/\d{4}" value="{{ project.planned_start_date.strftime('%d/%m/%Y') if project.planned_start_date else '' }}">
                            <div class="help-text">Pick from calendar. Format: <b>DD/MM/YYYY</b></div>
                        </div>
                        <div>
                            <label>Project End Date <span class="required">*</span></label>
                            <input type="text" name="planned_end_date" id="planned_end_date" required placeholder="DD/MM/YYYY" maxlength="10" inputmode="numeric" pattern="\d{1,2}/\d{1,2}/\d{4}" value="{{ project.planned_end_date.strftime('%d/%m/%Y') if project.planned_end_date else '' }}">
                            <script>
                                    function formatDateInput(input) {
                                        input.addEventListener('input', function(e) {
                                            let value = input.value.replace(/\D/g, '').slice(0, 8); // Only digits, max 8 (DDMMYYYY)
                                            let formatted = '';
                                            if (value.length > 0) {
                                                formatted += value.substring(0, 2);
                                            }
                                            if (value.length > 2) {
                                                formatted += '/' + value.substring(2, 4);
                                            }
                                            if (value.length > 4) {
                                                formatted += '/' + value.substring(4, 8);
                                            }
                                            input.value = formatted;
                                        });
                                    }
                                    formatDateInput(document.getElementById('planned_start_date'));
                                    formatDateInput(document.getElementById('planned_end_date'));
                                            if (value.length > 2) {
                                                formatted += '/' + value.substring(2, 4);
                                            }
                                            if (value.length > 4) {
                                                formatted += '/' + value.substring(4, 8);
                                            }
                                            input.value = formatted;
                                        });
                                    }
                                    formatDateInput(document.getElementById('planned_start_date'));
                                    formatDateInput(document.getElementById('planned_end_date'));
                                </script>
                            <div class="help-text">End date must be after start date. Format: <b>DD/MM/YYYY</b></div>
                        </div>
                    </div>
                </section>

                <hr>

                <!-- ================= ROAD SETUP ================= -->
                <section class="form-section">
                    <h3 class="section-title">Project Classification</h3>
                    <div class="form-grid">
                        <div style="min-width:260px">
                            <label>Project Type <span class="required">*</span></label>
                            <select name="project_type" id="project_type" required>
                                <option value="">-- Select project type --</option>
                                {% for pt in (project_types + legacy_project_types) %}
                                    <option value="{{ pt }}" {% if pt == project.project_type %}selected{% endif %}>{{ pt }}</option>
                                {% endfor %}
                            </select>
                            <div class="help-text">Road projects must also fill Road Category and Road Engineering Type below.</div>
                        </div>
                    </div>
                    <div class="form-grid" id="road_fields_block" style="margin-top:10px;display:none">
                        <div style="min-width:260px">
                            <label>Road Category (required only for Road)</label>
                            <select name="road_category" id="road_category">
                                <option value="">-- Select road category --</option>
                                {% for rc in road_categories %}
                                    <option value="{{ rc }}" {% if rc == project.road_category %}selected{% endif %}>{{ rc }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div style="min-width:260px">
                            <label>Road Engineering Type (required only for Road)</label>
                            <select name="road_engineering_type" id="road_engineering_type">
                                <option value="">-- Select engineering type --</option>
                                <option value="Flexible" {% if project.road_engineering_type == 'Flexible' %}selected{% endif %}>Flexible</option>
                                <option value="Rigid" {% if project.road_engineering_type == 'Rigid' %}selected{% endif %}>Rigid</option>
                                <option value="Overlay" {% if project.road_engineering_type == 'Overlay' %}selected{% endif %}>Overlay</option>
                                <option value="Urban" {% if project.road_engineering_type == 'Urban' %}selected{% endif %}>Urban</option>
                                <option value="Rural" {% if project.road_engineering_type == 'Rural' %}selected{% endif %}>Rural</option>
                                <option value="Composite" {% if project.road_engineering_type == 'Composite' %}selected{% endif %}>Composite</option>
                            </select>
                        </div>
                    </div>
                </section>

                <!-- ================= STRETCH SYSTEM (ROAD ONLY) ================= -->
                <section class="form-section" id="stretch_system_block" style="display:none">
                    <h3 class="section-title">Stretch System (Road Projects)</h3>
                    <div class="help-text">Mandatory for Road projects. Stretches remain editable after creation.</div>
                    <input type="hidden" name="stretch_enabled" id="stretch_enabled" value="1">
                    <div class="form-grid" style="margin-top:10px">
                        <div>
                            <label>Total Road Length (km) <span class="required">*</span></label>
                            <input type="number" id="stretch_total_length_km" step="0.01" min="0" placeholder="e.g. 12.50" value="{{ project.road_length_km }}">
                            <input type="hidden" name="road_length_km" id="road_length_km" value="{{ project.road_length_km }}">
                        </div>
                        <div>
                            <label>Total Number of Stretches <span class="required">*</span></label>
                            <input type="number" id="stretch_number_of_stretches" min="1" step="1" value="{{ project.stretch_count or '' }}">
                        </div>
                        <div style="display:flex;align-items:flex-end">
                            <button type="button" class="btn-primary" id="btnGenerateStretches">Generate stretches</button>
                        </div>
                    </div>
                    <input type="hidden" name="stretch_segments_json" id="stretch_segments_json" value="{{ project.stretch_segments_json or '' }}">
                    <div id="stretch_editor" style="margin-top:14px;display:none">
                        <div class="help-text">Edit stretch length to update chainage. Total length must equal the road length.</div>
                        <div style="overflow:auto;border:1px solid rgba(255,255,255,0.08);border-radius:12px;margin-top:10px">
                            <table class="table" style="margin:0;min-width:920px">
                                <thead>
                                    <tr>
                                        <th style="width:80px">No</th>
                                        <th style="width:220px">Stretch Name</th>
                                        <th style="width:140px">Start Chainage</th>
                                        <th style="width:140px">End Chainage</th>
                                        <th style="width:120px">Length (m)</th>
                                        <th style="width:100px">Width (m)</th>
                                        <th style="width:100px">Depth (m)</th>
                                        <th style="width:170px">Start Date</th>
                                        <th style="width:170px">End Date</th>
                                    </tr>
                                </thead>
                                <tbody id="stretchSegmentList"></tbody>
                            </table>
                        </div>
                        <div id="stretchDetailsList" style="margin-top:12px"></div>
                    </div>
                    <div style="margin-top:16px">
                        <h4 class="section-title" style="font-size:14px">Road Details (fill for Road projects)</h4>
                    <div class="form-grid">
                        <div>
                            <label>Lane Configuration</label>
                            <select name="lane_configuration" id="lane_configuration_select" onchange="document.getElementById('lane_configuration_custom').style.display = this.value === 'custom' ? '' : 'none';">
                                <option value="">-- Select --</option>
                                <option value="2L" {% if project.lane_configuration == '2L' %}selected{% endif %}>2L</option>
                                <option value="4L" {% if project.lane_configuration == '4L' %}selected{% endif %}>4L (2x2)</option>
                                <option value="6L" {% if project.lane_configuration == '6L' %}selected{% endif %}>6L (3x3)</option>
                                <option value="custom" {% if project.lane_configuration not in ['2L','4L','6L',''] %}selected{% endif %}>Custom</option>
                            </select>
                                {% set lane_config_display = 'block' if project.lane_configuration not in ['2L','4L','6L',''] else 'none' %}
                                <input type="text" name="lane_configuration" id="lane_configuration_custom" placeholder="e.g. 2x2, 8L divided" style="display:{{ lane_config_display }};margin-top:6px;" value="{{ project.lane_configuration if project.lane_configuration not in ['2L','4L','6L',''] else '' }}" />

                        </div>
                        <div>
                            <label>Road Width (m)</label>
                            <input type="number" step="0.01" name="road_width" value="{{ project.road_width }}">
                        </div>
                        <div>
                            <label>Carriageway Width (m)</label>
                            <input type="number" step="0.01" name="carriageway_width" value="{{ project.carriageway_width or '' }}">
                        </div>
                        <div>
                            <label>Shoulder Type</label>
                            <input type="text" name="shoulder_type" value="{{ project.shoulder_type or '' }}">
                        </div>
                        <div>
                            <label>Median Type</label>
                            <input type="text" name="median_type" value="{{ project.median_type or '' }}">
                        </div>
                    </div>
                    </div>
                </section>

                <!-- ================= LOCATION ================= -->
                <section class="form-section">
                    <h3 class="section-title">Location</h3>
                    <div class="form-grid">
                        <div>
                            <label>Country <span class="required">*</span></label>
                            <input type="text" name="country" required value="{{ project.country }}">
                        </div>
                        <div>
                            <label>State / Province</label>
                            <input type="text" name="state" value="{{ project.state or '' }}">
                        </div>
                        <div>
                            <label>District</label>
                            <input type="text" name="district" value="{{ project.district or '' }}">
                        </div>
                        <div>
                            <label>City</label>
                            <input type="text" name="city" value="{{ project.city or '' }}">
                        </div>
                        <div>
                            <label>Chainage Start</label>
                            <input type="text" name="chainage_start" value="{{ project.chainage_start or '' }}">
                        </div>
                        <div>
                            <label>Chainage End</label>
                            <input type="text" name="chainage_end" value="{{ project.chainage_end or '' }}">
                        </div>
                    </div>
                </section>

                <hr>

                <div style="margin-top:24px">
                    <button type="submit" class="btn-primary">Save Changes</button>
                    <a href="/projects/{{ project.id }}" class="btn-secondary">Cancel</a>
                </div>
            </form>

            </div>
            container.appendChild(empty);
            serialize();
            return;
        }
        if(gen) gen.style.display = 'none';
        (stretches || []).forEach((st, idx) => {
            const card = document.createElement('div');
            card.className = 'stretch-card';
            const showDetails = (st._showDetails === true);
            card.innerHTML = `
                <div class="stretch-header">
                    <div><strong>${st.stretch_name || ('Stretch ' + (idx+1))}</strong></div>
                    <div style="display:flex;gap:8px;align-items:center">
                        <button type="button" class="btn-secondary btn-small" data-kind="toggle-details" data-idx="${idx}">${showDetails ? 'Hide' : 'Show'}</button>
                        <div style="opacity:0.75">${st.stretch_code || ''}</div>
                    </div>
                </div>
                <!-- Details body block removed: invalid JS-style template. Add valid Jinja2 or HTML if needed. -->
                <div class="form-grid" style="margin-top:10px">
                    <div>
                        <label>Stretch Name</label>
                        <input type="text" value="${st.stretch_name || ''}" data-kind="stretch-name" data-idx="${idx}">
                    </div>
                    <div>
                        <label>Start Date</label>
                        <div class="date-dual">
                            <input type="text" value="${st.planned_start_date || ''}" placeholder="DD/MM/YYYY" data-kind="stretch-start" data-idx="${idx}">
                            <input type="date" value="${ddmmyyyyToIso(st.planned_start_date || '')}" data-kind="stretch-start-picker" data-idx="${idx}">
                        </div>
                    </div>
                    <div>
                        <label>End Date</label>
                        <div class="date-dual">
                            <input type="text" value="${st.planned_end_date || ''}" placeholder="DD/MM/YYYY" data-kind="stretch-end" data-idx="${idx}">
                            <input type="date" value="${ddmmyyyyToIso(st.planned_end_date || '')}" data-kind="stretch-end-picker" data-idx="${idx}">
                        </div>
                    </div>
                </div>

                <div style="margin-top:12px">
                    <div style="font-weight:600">Activities</div>
                    <div class="help-text">Activity dates are clamped to stretch dates on save.</div>
                    ${(st.activities || []).map((a, aidx) => `
                        <div class="activity-row">
                            <input type="text" value="${a.name || ''}" disabled>
                            <div class="date-dual">
                                <input type="text" value="${a.planned_start_date || ''}" placeholder="DD/MM/YYYY" data-kind="act-start" data-idx="${idx}" data-aidx="${aidx}">
                                <input type="date" value="${ddmmyyyyToIso(a.planned_start_date || '')}" data-kind="act-start-picker" data-idx="${idx}" data-aidx="${aidx}">
                            </div>
                            <div class="date-dual">
                                <input type="text" value="${a.planned_end_date || ''}" placeholder="DD/MM/YYYY" data-kind="act-end" data-idx="${idx}" data-aidx="${aidx}">
                                <input type="date" value="${ddmmyyyyToIso(a.planned_end_date || '')}" data-kind="act-end-picker" data-idx="${idx}" data-aidx="${aidx}">
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div style="margin-top:12px">
                    <div style="font-weight:600">Materials</div>
                    <div class="help-text">Project planned materials available for this stretch.</div>
                    ${(st.materials || []).length ? `
                        <div class="material-list">
                            ${(st.materials || []).map(m => `<span class="material-chip">${m.name || ''} (${m.unit || ''})</span>`).join('')}
                        </div>
                    ` : `<div class="help-text">No materials configured.</div>`}
                </div>
                </div>
            `;
            container.appendChild(card);
        });
        serialize();
    }

    function handleInput(e){
        const t = e.target;
        if(!t) return;
        const kind = t.getAttribute('data-kind');
        const idx = parseInt(t.getAttribute('data-idx') || '-1', 10);
        if(idx < 0 || !stretches[idx]) return;

        const st = stretches[idx];
        const aidx = parseInt(t.getAttribute('data-aidx') || '-1', 10);

        if(kind === 'toggle-details'){
            st._showDetails = !(st._showDetails === true);
            render();
            return;
        }
        if(kind === 'stretch-name') st.stretch_name = String(t.value || '').trim();
        if(kind === 'stretch-start'){
            st.planned_start_date = String(t.value || '').trim();
            const picker = t.closest('.date-dual')?.querySelector('[data-kind="stretch-start-picker"]');
            if(picker) picker.value = ddmmyyyyToIso(st.planned_start_date);
        }
        if(kind === 'stretch-end'){
            st.planned_end_date = String(t.value || '').trim();
            const picker = t.closest('.date-dual')?.querySelector('[data-kind="stretch-end-picker"]');
            if(picker) picker.value = ddmmyyyyToIso(st.planned_end_date);
        }
        if(kind === 'stretch-start-picker'){
            const dd = isoToDdmmyyyy(String(t.value || '').trim());
            st.planned_start_date = dd;
            const text = t.closest('.date-dual')?.querySelector('[data-kind="stretch-start"]');
            if(text) text.value = dd;
        }
        if(kind === 'stretch-end-picker'){
            const dd = isoToDdmmyyyy(String(t.value || '').trim());
            st.planned_end_date = dd;
            const text = t.closest('.date-dual')?.querySelector('[data-kind="stretch-end"]');
            if(text) text.value = dd;
        }

        if(aidx >= 0 && st.activities && st.activities[aidx]){
            const a = st.activities[aidx];
            if(kind === 'act-start'){
                a.planned_start_date = String(t.value || '').trim();
                const picker = t.closest('.date-dual')?.querySelector('[data-kind="act-start-picker"]');
                if(picker) picker.value = ddmmyyyyToIso(a.planned_start_date);
            }
            if(kind === 'act-end'){
                a.planned_end_date = String(t.value || '').trim();
                const picker = t.closest('.date-dual')?.querySelector('[data-kind="act-end-picker"]');
                if(picker) picker.value = ddmmyyyyToIso(a.planned_end_date);
            }
            if(kind === 'act-start-picker'){
                const dd = isoToDdmmyyyy(String(t.value || '').trim());
                a.planned_start_date = dd;
                const text = t.closest('.date-dual')?.querySelector('[data-kind="act-start"]');
                if(text) text.value = dd;
            }
            if(kind === 'act-end-picker'){
                const dd = isoToDdmmyyyy(String(t.value || '').trim());
                a.planned_end_date = dd;
                const text = t.closest('.date-dual')?.querySelector('[data-kind="act-end"]');
                if(text) text.value = dd;
            }
        }
        serialize();
    }

    try{
        const raw = document.getElementById('stretches-data');
        stretches = JSON.parse(raw.textContent || '[]') || [];
    }catch(e){
        stretches = [];
    }

    const btnGenerate = document.getElementById('btnGenerate');
    if(btnGenerate){
        btnGenerate.addEventListener('click', function(){
            const totalKm = parseFloat(String(document.getElementById('gen_total_km')?.value || '0')) || 0;
            const count = parseInt(String(document.getElementById('gen_count')?.value || '0'), 10) || 0;
            if(totalKm <= 0 || count <= 0){
                return;
            }
            const totalM = Math.round(totalKm * 1000);
            const base = Math.floor(totalM / count);
            let cursor = 0;
            const startDate = "{{ project.planned_start_date.strftime('%d/%m/%Y') if project.planned_start_date else '' }}";
            const endDate = "{{ project.planned_end_date.strftime('%d/%m/%Y') if project.planned_end_date else '' }}";

            stretches = [];
            for(let i=1;i<=count;i++){
                const isLast = i === count;
                const end = isLast ? totalM : (cursor + base);
                stretches.push({
                    id: null,
                    sequence_no: i,
                    stretch_code: `ST-${String(i).padStart(3,'0')}`,
                    stretch_name: `Stretch ${i}`,
                    start_m: cursor,
                    end_m: end,
                    length_m: Math.max(end - cursor, 1),
                    planned_start_date: startDate,
                    planned_end_date: endDate,
                    activities: [],
                });
                cursor = end;
            }
            render();
        });
    }

    render();
    if(container){
        container.addEventListener('input', handleInput);
        container.addEventListener('change', handleInput);
        container.addEventListener('click', function(e){
            const t = e.target;
            if(!t) return;
            const kind = t.getAttribute('data-kind');
            if(kind === 'toggle-details'){
                handleInput(e);
            }
        });
    }
})();
 </script>
{# LEGACY TEMPLATE REMOVED
            'project_type': project.project_type or '',
            'road_category': project.road_category or project.road_type or '',
            'road_engineering_type': project.road_engineering_type or '',
            'road_extras_json': project.road_extras_json or '{}'
        } | tojson }}</script>
                ph.value = '';
                ph.textContent = '-- Select --';
                selectEl.appendChild(ph);
            }
            (options || []).forEach(function(opt){
                var o = document.createElement('option');
                o.value = opt;
                o.textContent = opt;
                selectEl.appendChild(o);
            });
        }

        function handleProjectTypeChange(){
            var projectType = document.getElementById('project_type');
            var roadBlock = document.getElementById('road_block');
            var roadClassification = document.getElementById('road_classification');
            var roadCategoryField = document.getElementById('road_category_field');
            var roadCategorySelect = document.getElementById('road_category');
            var roadEngineeringField = document.getElementById('road_engineering_field');
            var roadEngineeringSelect = document.getElementById('road_engineering_type');
            var presetsPanel = document.getElementById('road_presets_panel');
            var roadQuestions = document.getElementById('road_questions');
            var details1 = document.getElementById('road_details_fields');
            var details2 = document.getElementById('road_details_fields2');
            var details3 = document.getElementById('road_details_fields3');

            if(!projectType || !roadBlock || !roadClassification || !roadCategoryField || !roadCategorySelect || !roadEngineeringField || !roadEngineeringSelect || !presetsPanel || !roadQuestions || !details1 || !details2 || !details3) return;

            var isRoad = projectType.value === 'Road';
            roadBlock.style.display = isRoad ? 'block' : 'none';
            roadClassification.style.display = isRoad ? 'grid' : 'none';
            roadCategoryField.style.display = isRoad ? 'block' : 'none';
            roadEngineeringField.style.display = isRoad ? 'block' : 'none';

            presetsPanel.style.display = isRoad ? 'block' : 'none';
            details1.style.display = isRoad ? 'block' : 'none';
            details2.style.display = isRoad ? 'block' : 'none';
            details3.style.display = isRoad ? 'block' : 'none';

            document.querySelectorAll('[name="lanes"],[name="road_width"],[name="road_length_km"]').forEach(function(el){
                if(isRoad) el.setAttribute('required','required'); else el.removeAttribute('required');
            });
        }

        function updateEngineeringOptions(){
            var category = document.getElementById('road_category');
            var engineering = document.getElementById('road_engineering_type');
            if(!category || !engineering || !__classification) return;
            var map = __classification.engineering_types_by_category || {};
            var opts = map[category.value] || [];
            populateSelect(engineering, opts);
        }

        function renderConditionalQuestionsReadOnly(){
            var category = document.getElementById('road_category');
            var block = document.getElementById('road_questions');
            var container = document.getElementById('road_questions_container');
            if(!category || !block || !container || !__classification) return;

            var qsMap = __classification.conditional_questions_by_category || {};
            var qs = qsMap[category.value] || [];
            container.innerHTML = '';
            if(!qs.length){
                block.style.display = 'none';
                return;
            }
            block.style.display = 'block';

            var values = {};
            try { values = JSON.parse(__project.road_extras_json || '{}') || {}; } catch(e) { values = {}; }

            var grid = document.createElement('div');
            grid.className = 'form-grid';
            qs.forEach(function(q){
                var wrap = document.createElement('div');
                var label = document.createElement('label');
                label.textContent = q.label || q.key;
                wrap.appendChild(label);

                var inp = document.createElement('input');
                inp.type = 'text';
                inp.disabled = true;
                inp.value = (values[q.key] || '');
                wrap.appendChild(inp);
                grid.appendChild(wrap);
            });
            container.appendChild(grid);
        }

        function renderActivityPresets(){
            var list = _el('activityPresetList');
            if(!list) return;
            list.innerHTML = '';
            var items = (__currentRoadPresets && __currentRoadPresets.activities) ? __currentRoadPresets.activities : [];
            items.forEach(function(item, idx){
                var row = document.createElement('div');
                row.className = 'preset-row';

                var cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.checked = !!item.enabled;
                cb.disabled = true;

                var input = document.createElement('input');
                input.type = 'text';
                input.value = item.name || '';
                input.disabled = true;

                var pill = document.createElement('span');
                pill.className = 'pill';
                pill.textContent = (item.standard ? 'Standard' : 'Custom');

                row.appendChild(cb);
                row.appendChild(input);
                row.appendChild(pill);
                list.appendChild(row);
            });
        }

        function renderMaterialPresets(){
            var list = _el('materialPresetList');
            if(!list) return;
            list.innerHTML = '';

            var items = (__currentRoadPresets && __currentRoadPresets.materials) ? __currentRoadPresets.materials : [];
            items.forEach(function(item){
                var row = document.createElement('div');
                row.className = 'preset-row';

                var cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.checked = !!item.enabled;
                cb.disabled = true;

                var name = document.createElement('input');
                name.type = 'text';
                name.value = item.name || '';
                name.disabled = true;

                var pill = document.createElement('span');
                pill.className = 'pill';
                pill.textContent = 'Unit: ' + (item.unit || 'unit');

                row.appendChild(cb);
                row.appendChild(name);
                row.appendChild(pill);
                list.appendChild(row);
            });
        }

        function loadRoadPresets(engineeringType){
            if(!engineeringType){
                __roadPresetsCache = null;
                __currentRoadPresets = null;
                renderActivityPresets();
                renderMaterialPresets();
                return;
            }

            var url = '/projects/road-presets?engineering_type=' + encodeURIComponent(engineeringType);
            return fetch(url, { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' })
                .then(function(r){ return r.json(); })
                .then(function(data){
                    var defs = Array.isArray(data.activity_preset_defs) ? data.activity_preset_defs : null;
                    var activities = [];
                    if(defs && defs.length){
                        activities = defs.map(function(d){
                            var name = String((d && d.name) || '').trim();
                            var scope = String((d && (d.activity_scope || d.scope)) || '').trim();
                            if(scope){ scope = scope.toUpperCase(); }
                            if(scope !== 'COMMON' && scope !== 'STRETCH'){ scope = 'STRETCH'; }
                            return { name: name, enabled: true, standard: true, activity_scope: scope, phase: (d && d.phase) ? String(d.phase) : '' };
                        }).filter(function(a){ return !!(a && a.name); });
                    } else {
                        activities = (data.activities || []).map(function(n){
                            return { name: String(n || ''), enabled: true, standard: true, activity_scope: 'STRETCH', phase: '' };
                        });
                    }
                    var materials = (data.materials || []).map(function(m){
                        var defaultUnit = String(m.default_unit || 'unit');
                        var allowed = Array.isArray(m.allowed_units) ? m.allowed_units.map(function(u){ return String(u || '').trim(); }).filter(Boolean) : [];
                        if(!allowed.length) allowed = [defaultUnit];
                        return { name: String(m.name || ''), unit: defaultUnit, allowed_units: allowed, enabled: true, standard: true };
                    });

                    __roadPresetsCache = { engineering_type: data.engineering_type || engineeringType, activities: activities, materials: materials };
                    __currentRoadPresets = {
                        engineering_type: __roadPresetsCache.engineering_type,
                        activities: activities.map(function(a){ return { name: a.name, enabled: a.enabled, standard: a.standard, activity_scope: a.activity_scope, phase: a.phase }; }),
                        materials: materials.map(function(m){ return { name: m.name, unit: m.unit, allowed_units: (m.allowed_units || []), enabled: m.enabled, standard: m.standard }; }),
                    };

                    renderActivityPresets();
                    renderMaterialPresets();
                })
                .catch(function(){});
        }

        function loadClassificationMetadata(){
            return fetch('/projects/classification-metadata', { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' })
                .then(function(r){ return r.json(); })
                .then(function(data){
                    __classification = data;
                    populateSelect(_el('project_type'), (data.project_types || []).concat(data.legacy_project_types || []));
                    populateSelect(_el('road_category'), data.road_categories || []);
                })
                .catch(function(){});
        }

        document.addEventListener('DOMContentLoaded', function(){
            var form = _el('editProjectForm');
            var btn = _el('saveProjectBtn');

            loadClassificationMetadata().then(function(){
                var projectType = _el('project_type');
                var roadCategory = _el('road_category');
                var roadEngineering = _el('road_engineering_type');

                if(projectType){
                    projectType.value = __project.project_type || '';
                    projectType.disabled = true;
                }
                handleProjectTypeChange();

                if(roadCategory){
                    roadCategory.value = __project.road_category || '';
                    roadCategory.disabled = true;
                }
                updateEngineeringOptions();
                if(roadEngineering){
                    roadEngineering.value = __project.road_engineering_type || '';
                    roadEngineering.disabled = true;
                }

                renderConditionalQuestionsReadOnly();
                loadRoadPresets(__project.road_engineering_type || '');

                // Disable any interactive buttons in presets panel (reference-only)
                var presetsPanel = _el('road_presets_panel');
                if(presetsPanel){
                    presetsPanel.querySelectorAll('button,input,select,textarea').forEach(function(el){ el.disabled = true; });
                }
            });

            if(form){
                form.addEventListener('input', function(){
                    setFormError('');
                    updateSaveButtonState();
                });
                form.addEventListener('change', function(){
                    setFormError('');
                    updateSaveButtonState();
                });
                form.addEventListener('submit', function(e){
                    setFormError('');
                    form.querySelectorAll('.is-invalid').forEach(function(el){ el.classList.remove('is-invalid'); });
                    if(!form.checkValidity()){
                        e.preventDefault();
                        form.querySelectorAll('input,select,textarea').forEach(function(el){
                            if(typeof el.checkValidity === 'function' && !el.checkValidity()) el.classList.add('is-invalid');
                        });
                        setFormError('Please fill all required fields highlighted below.');
                        updateSaveButtonState();
                        return;
                    }
                    if(btn){
                        btn.disabled = true;
                        btn.textContent = 'Saving';
                    }
                });
            }

            updateSaveButtonState();
        });
        </script>
        {% endblock %}
        #}

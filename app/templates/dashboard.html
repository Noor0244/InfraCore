{% extends "base.html" %}
{% block content %}
<style>
    /* ===== MAIN LAYOUT ===== */
    .dashboard-container {
        display: flex;
        flex-direction: column;
        gap: 24px;
        padding: 0;
    }

    /* ===== CARD STYLING ===== */
    .card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.07), 0 2px 6px rgba(0,0,0,0.04);
        padding: 24px;
        overflow: hidden;
        transition: box-shadow 0.2s ease, transform 0.2s ease;
    }

    .card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1), 0 4px 12px rgba(0,0,0,0.06);
    }

    /* ===== TYPOGRAPHY ===== */
    .page-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 24px;
        letter-spacing: -0.5px;
    }

    .section-title,
    h2.section-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin-top: 32px;
        margin-bottom: 16px;
        letter-spacing: -0.3px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    /* ===== KPI GRID ===== */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .kpi-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--border-color);
    }

    .kpi-card.kpi-primary::before {
        background: linear-gradient(90deg, #3498db 0%, #2980b9 100%);
    }

    .kpi-card.kpi-success::before {
        background: linear-gradient(90deg, #16a34a 0%, #15803d 100%);
    }

    .kpi-card:hover {
        box-shadow: 0 4px 12px rgba(52,152,219,0.15);
        transform: translateY(-2px);
    }

    .kpi-card.kpi-primary {
        background: linear-gradient(135deg, #3498db15 0%, #2980b915 100%);
    }

    .kpi-card.kpi-success {
        background: linear-gradient(135deg, #16a34a15 0%, #15803d15 100%);
    }

    .kpi-icon {
        font-size: 28px;
    }

    .kpi-content {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .kpi-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1;
    }

    .kpi-label {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* ===== TABLE STYLING ===== */
    .table {
        width: 100%;
        border-collapse: collapse;
        background: var(--card-bg);
        font-size: 13px;
    }

    .table th,
    .table td {
        padding: 14px 16px;
        text-align: left;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color);
    }

    .table th {
        background: var(--bg-800);
        font-weight: 700;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
    }

    .table tbody tr {
        transition: background-color 0.15s ease;
    }

    .table tbody tr:hover {
        background-color: var(--bg-800);
    }

    .table tr:last-child td {
        border-bottom: none;
    }
    /* ===== BADGES ===== */
    .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 0.3px;
        text-transform: uppercase;
        white-space: nowrap;
    }

    .badge-info {
        background: #d1e9ff;
        color: #0c4a6e;
    }

    .badge-success {
        background: #dcfce7;
        color: #166534;
    }

    .badge-danger {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-warning {
        background: #fef3c7;
        color: #92400e;
    }

    .dark .badge-info {
        background: #1e3a8a;
        color: #60a5fa;
    }

    .dark .badge-success {
        background: #166534;
        color: #86efac;
    }

    .dark .badge-danger {
        background: #7c2d12;
        color: #fca5a5;
    }

    .dark .badge-warning {
        background: #78350f;
        color: #fbbf24;
    }

    /* ===== BUTTONS ===== */
    .btn-primary,
    .btn-secondary {
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
    }

    .btn-primary {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: #fff;
        box-shadow: 0 2px 8px rgba(52,152,219,0.2);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
        box-shadow: 0 4px 12px rgba(52,152,219,0.3);
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: var(--bg-800);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
        background: var(--border-color);
        border-color: var(--text-secondary);
    }

    /* ===== FORM ELEMENTS ===== */
    .form-select,
    input[type="text"],
    input[type="email"],
    textarea,
    select {
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        color: var(--text-primary);
        font-size: 13px;
        transition: border-color 0.2s ease;
    }

    .form-select:focus,
    input:focus,
    textarea:focus,
    select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52,152,219,0.1);
    }

    .project-select-wrap {
        position: relative;
        max-width: 520px;
        z-index: 60;
    }

    .project-selector {
        position: relative;
        z-index: 60;
    }

    .project-overview-card {
        overflow: visible;
    }

    .project-select-btn {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        color: var(--text-primary);
        font-size: 13px;
        cursor: pointer;
    }

    .project-select-btn:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52,152,219,0.1);
    }

    .project-select-arrow {
        color: var(--text-secondary);
        font-size: 12px;
    }

    .project-select-menu {
        position: absolute;
        top: calc(100% + 6px);
        left: 0;
        right: 0;
        max-height: 240px;
        overflow: auto;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        background: var(--card-bg, var(--card));
        background-color: var(--card-bg, var(--card));
        box-shadow: 0 14px 28px rgba(0,0,0,0.25);
        padding: 6px;
        display: none;
        z-index: 2000;
        opacity: 1;
        mix-blend-mode: normal;
        isolation: isolate;
    }

    .project-select-menu.is-open {
        display: block;
    }

    .project-select-item {
        width: 100%;
        text-align: left;
        background: var(--card-bg, var(--card));
        background-color: var(--card-bg, var(--card));
        color: var(--text-primary);
        border: 1px solid transparent;
        border-radius: 8px;
        padding: 8px 10px;
        font-size: 13px;
        cursor: pointer;
    }

    .project-select-item:hover {
        background: rgba(52,152,219,0.12);
        border-color: rgba(52,152,219,0.35);
    }

    .project-select-item.is-selected {
        background: rgba(52,152,219,0.18);
        border-color: rgba(52,152,219,0.5);
        font-weight: 600;
    }

    /* ===== UTILITIES ===== */
    .meta {
        color: var(--text-secondary);
        font-size: 12px;
        line-height: 1.5;
    }

    .pill {
        display: inline-block;
        background: var(--bg-800);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        padding: 6px 12px;
        font-size: 12px;
        margin-right: 6px;
        margin-bottom: 6px;
        font-weight: 500;
    }

    .pill:hover {
        background: var(--border-color);
    }

    /* ===== PROGRESS BAR ===== */
    .progress-bar-container {
        background: var(--bg-800);
        border-radius: 8px;
        height: 24px;
        width: 100%;
        margin-bottom: 8px;
        overflow: hidden;
        border: 1px solid var(--border-color);
    }

    .progress-bar {
        background: linear-gradient(90deg, #3498db 0%, #2980b9 100%);
        color: #fff;
        height: 100%;
        border-radius: 8px;
        font-weight: 600;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: width 0.3s ease;
    }

    /* ===== STRETCH BAR ===== */
    .stretch-bar {
        display: flex;
        height: 20px;
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid var(--border-color);
        background: var(--bg-800);
    }

    .stretch-seg {
        height: 100%;
        transition: flex 0.2s ease;
    }

    .stretch-seg.not_started {
        background: #94a3b8;
    }

    .stretch-seg.in_progress {
        background: #3498db;
    }

    .stretch-seg.completed {
        background: #16a34a;
    }

    .stretch-seg.delayed {
        background: #f59e0b;
    }

    /* ===== SECTION HEADERS ===== */
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 16px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
    }

    .section-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
        .page-title {
            font-size: 22px;
        }

        .section-title {
            font-size: 16px;
        }

        .kpi-grid {
            grid-template-columns: 1fr;
        }

        .table {
            font-size: 12px;
        }

        .table th,
        .table td {
            padding: 10px 8px;
        }

        .btn-primary,
        .btn-secondary {
            padding: 8px 16px;
            font-size: 12px;
        }
    }

</style>

<h1 class="page-title">{{ title }}</h1>

<style>
    .dash-toggle {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin: 16px 0;
    }

    .dash-toggle a {
        padding: 10px 16px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        text-decoration: none;
        color: var(--text-primary);
        font-size: 13px;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .dash-toggle a:hover {
        border-color: #3498db;
        background: var(--bg-800);
    }

    .dash-toggle a.active {
        background: linear-gradient(135deg, #3498db15 0%, #2980b915 100%);
        border-color: #3498db;
        color: #3498db;
        font-weight: 700;
    }

    .stretch-filters {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        align-items: flex-end;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 16px;
    }

    .stretch-filters > div {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .stretch-filters label {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .stretch-filters select,
    .stretch-filters input {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        color: var(--text-primary);
        font-size: 13px;
        font-weight: 500;
    }

    .stretch-filters select:focus,
    .stretch-filters input:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52,152,219,0.1);
    }

    .stretch-alert,
    .stretch-alert.warning,
    .stretch-alert.info {
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--bg-800);
        color: var(--text-primary);
        font-size: 13px;
        line-height: 1.6;
        margin-bottom: 12px;
    }

    .stretch-alert.warning {
        border-color: #f59e0b;
        background: #f59e0b10;
        color: var(--text-primary);
    }

    .stretch-alert.info {
        border-color: #3498db;
        background: #3498db10;
        color: var(--text-primary);
    }

    hr {
        border: none;
        border-top: 1px solid var(--border-color);
        margin: 16px 0;
    }

    .grid-2-col {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
    }

    .grid-2-col > div {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .grid-2-col strong {
        font-size: 12px;
        font-weight: 700;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .grid-2-col > div > :not(strong) {
        font-size: 14px;
        color: var(--text-primary);
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
    }

    .project-selector {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 12px;
    }

    .project-selector h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .project-selector select {
        min-width: 240px;
    }

    .activity-table-wrapper {
        overflow-x: auto;
    }

    .empty-state {
        text-align: center;
        padding: 40px 24px;
        color: var(--text-secondary);
    }

    .empty-state p {
        margin: 0;
        font-size: 14px;
    }
</style>

<!-- ================= PROJECT CONTEXT ================= -->
<script id="projectIdJson" type="application/json">{{ project_id | tojson }}</script>

<!-- ================= KPI / SUMMARY ================= -->
<div class="kpi-grid">
    <a href="/reports" class="kpi-card kpi-primary">
        <div class="kpi-icon">üìÑ</div>
        <div class="kpi-content">
            <div class="kpi-value">{{ summary.total_reports }}</div>
            <div class="kpi-label">Total Reports</div>
        </div>
    </a>

    <div class="kpi-card kpi-success">
        <div class="kpi-icon">üìÖ</div>
        <div class="kpi-content">
            <div class="kpi-value">{{ summary.reports_today }}</div>
            <div class="kpi-label">Reports Today</div>
        </div>
    </div>
</div>

<!-- ================= PROJECT OVERVIEW ================= -->
<h2 class="section-title">Project Overview</h2>

{% if not has_projects %}
<div class="card project-overview-card">
    <div class="empty-state">
        <p>Create a project to get started.</p>
    </div>
</div>

{% elif project %}
<div class="card">
    <div class="project-selector">
        <h3>Active Project</h3>
        {% if projects|length > 1 %}
        <div class="project-select-wrap">
            <button
                type="button"
                class="project-select-btn"
                id="projectSelectBtn"
                aria-haspopup="listbox"
                aria-expanded="false"
            >
                <span class="project-select-label">{{ project.name }} ‚Äî {{ project.city }}</span>
                <span class="project-select-arrow">‚ñæ</span>
            </button>
            <div class="project-select-menu" id="projectSelectMenu" role="listbox">
                {% for p in projects %}
                    <button
                        type="button"
                        class="project-select-item{% if project.id == p.id %} is-selected{% endif %}"
                        data-value="{{ p.id }}"
                    >
                        {{ p.name }} ‚Äî {{ p.city }}{% if not p.is_active %} (Archived){% endif %}
                    </button>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <hr>

    <div class="grid-2-col">
        <div>
            <strong>Project Name</strong>
            <span>{{ project.name }}</span>
        </div>

        <div>
            <strong>Location</strong>
            <span>{{ project.city }}{% if project.state %}, {{ project.state }}{% endif %}</span>
        </div>

        <div>
            <strong>Road Details</strong>
            <span>{{ project.road_type }}, {{ project.lanes }} lanes, {{ project.road_length_km }} km</span>
        </div>

        <div>
            <strong>Status</strong>
            <span><span class="badge badge-info">{{ project.status|capitalize }}</span></span>
        </div>

        <div>
            <strong>Timeline</strong>
            <span>{{ project.planned_start_date|ddmmyyyy }} ‚Üí {{ project.planned_end_date|ddmmyyyy }}</span>
        </div>
    </div>

    <div class="action-buttons">
        <a class="btn-secondary" href="/project/{{ project.id }}/materials">üß± Material & Vendor</a>
        <a class="btn-secondary" href="/stock/current">üì¶ Current Stock</a>
        <a class="btn-secondary" href="/execution/{{ project.id }}">üßæ Daily Execution</a>
        <a class="btn-primary" href="/projects/{{ project.id }}/prediction">üîÆ Prediction</a>
    </div>
</div>

{% if project and has_stretches %}
    <div class="dash-toggle">
        <a class="{% if dash_view != 'stretch' %}active{% endif %}" href="/dashboard?project_id={{ project.id }}&view=project">üìä Project View</a>
        <a class="{% if dash_view == 'stretch' %}active{% endif %}" href="/dashboard?project_id={{ project.id }}&view=stretch">üöß Stretch View</a>
    </div>
{% endif %}
{% endif %}

<!-- ================= STRETCH INTELLIGENCE MODE ================= -->
{% if project and dash_view == 'stretch' %}
    {% if not has_stretches %}
        <div class="card">
            <div class="empty-state">
                <p>No stretches found for this project. Switch back to Project View.</p>
            </div>
        </div>
    {% else %}
        <h2 class="section-title">üöß Stretch Intelligence</h2>

        <div class="card">
            <div class="section-header">
                <div>
                    <h3>Stretch Overview</h3>
                    <div class="meta">Today: <strong>{{ (stretch_intel.today if stretch_intel else '') }}</strong>. Status and alerts are computed server-side.</div>
                </div>
            </div>

            <form method="get" action="/dashboard" class="stretch-filters">
                <input type="hidden" name="project_id" value="{{ project.id }}">
                <input type="hidden" name="view" value="stretch">

                <div>
                    <label>Lookahead Days</label>
                    <select name="lookahead_days">
                        {% set la = (stretch_intel.cfg.lookahead_days if stretch_intel else 30) %}
                        <option value="7" {% if la==7 %}selected{% endif %}>7 days</option>
                        <option value="14" {% if la==14 %}selected{% endif %}>14 days</option>
                        <option value="30" {% if la==30 %}selected{% endif %}>30 days</option>
                    </select>
                </div>

                <div>
                    <label>Stretch</label>
                    <select name="stretch_id">
                        <option value="">All Stretches</option>
                        {% for s in stretch_choices %}
                            <option value="{{ s.id }}" {% if stretch_intel and stretch_intel.filters.stretch_id==s.id %}selected{% endif %}>{{ s.stretch_code }} ({{ s.start_chainage }}‚Äì{{ s.end_chainage }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label>Status</label>
                    <select name="status">
                        <option value="">All Status</option>
                        <option value="NOT_STARTED" {% if stretch_intel and stretch_intel.filters.status=='NOT_STARTED' %}selected{% endif %}>Not Started</option>
                        <option value="IN_PROGRESS" {% if stretch_intel and stretch_intel.filters.status=='IN_PROGRESS' %}selected{% endif %}>In Progress</option>
                        <option value="DELAYED" {% if stretch_intel and stretch_intel.filters.status=='DELAYED' %}selected{% endif %}>Delayed</option>
                        <option value="COMPLETED" {% if stretch_intel and stretch_intel.filters.status=='COMPLETED' %}selected{% endif %}>Completed</option>
                    </select>
                </div>

                <div style="display: flex; gap: 8px; margin-top: 24px;">
                    <button type="submit" class="btn-primary">Apply Filters</button>
                    <a href="/dashboard?project_id={{ project.id }}&view=stretch" class="btn-secondary">Reset</a>
                </div>
            </form>

            {% if stretch_intel and stretch_intel.stretches and stretch_intel.stretches|length > 0 %}
                <div style="margin-top:14px">
                    <div class="meta" style="margin-bottom:8px">Chainage strip (hover for quick stats)</div>
                    <div class="stretch-bar">
                        {% set total_m = (stretch_intel.total_length_m or 0) %}
                        {% for st in stretch_intel.stretches %}
                            {% set w = (100.0 * (st.length_m or 0) / total_m) if total_m else 0 %}
                            {% set cls = (st.status_kind or 'NOT_STARTED')|lower %}
                            <div
                                class="stretch-seg {{ cls }}"
                                                                data-width="{{ w }}"
                                title="{{ st.stretch_code }} | {{ st.chainage }} | {{ st.status_label }} | {{ st.actual_progress }}%"
                            ></div>
                        {% endfor %}
                    </div>
                                        <script>
                                            (function(){
                                                try{
                                                    document.querySelectorAll('.stretch-seg[data-width]').forEach(function(el){
                                                        var w = parseFloat(el.getAttribute('data-width') || '0');
                                                        if (isNaN(w) || w < 0) w = 0;
                                                        el.style.width = w + '%';
                                                    });
                                                }catch(e){}
                                            })();
                                        </script>
                </div>

                <hr style="margin:14px 0; opacity:0.35">

                <div style="overflow:auto">
                    <table class="table" style="min-width:1060px">
                        <thead>
                            <tr>
                                <th>Stretch</th>
                                <th>Chainage</th>
                                <th>Planned Start ‚Äì End</th>
                                <th>Progress</th>
                                <th>Status</th>
                                <th>Critical Activity</th>
                                <th>Material Risk</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for st in stretch_intel.stretches %}
                                <tr>
                                    <td>
                                        <strong>{{ st.stretch_code }}</strong>
                                        <div class="meta">{{ st.stretch_name }}</div>
                                    </td>
                                    <td>{{ st.chainage }}</td>
                                    <td>
                                        {% if st.planned_start %}{{ st.planned_start }}{% else %}‚Äî{% endif %}
                                        ‚Äî
                                        {% if st.planned_end %}{{ st.planned_end }}{% else %}‚Äî{% endif %}
                                        {% if st.planned_progress is not none %}
                                            <div class="meta">Planned progress: {{ st.planned_progress }}%</div>
                                        {% endif %}
                                    </td>
                                    <td><strong>{{ st.actual_progress }}%</strong></td>
                                    <td>
                                        {% if st.status_kind == 'DELAYED' %}
                                            <span class="badge badge-warning">Delayed</span>
                                        {% elif st.status_kind == 'COMPLETED' %}
                                            <span class="badge badge-success">Completed</span>
                                        {% elif st.status_kind == 'IN_PROGRESS' %}
                                            <span class="badge badge-info">In Progress</span>
                                        {% else %}
                                            <span class="badge">Not Started</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if st.critical_activity %}
                                            {% if st.critical_activity.activity_code %}<span class="badge">{{ st.critical_activity.activity_code }}</span>{% endif %}
                                            <strong>{{ st.critical_activity.activity_name }}</strong>
                                            <div class="meta">Start: {{ st.critical_activity.start_date }} | Progress: {{ st.critical_activity.progress_percent }}%</div>
                                        {% else %}
                                            <span class="meta">‚Äî</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if st.material_risk_kind == 'SHORTAGE' %}
                                            <span class="badge badge-danger">Shortage</span>
                                        {% elif st.material_risk_kind == 'DUE_SOON' %}
                                            <span class="badge badge-warning">Due Soon</span>
                                        {% else %}
                                            <span class="badge badge-success">OK</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="meta">No stretch data available (check stretch activity mapping / planning).</div>
            {% endif %}
        </div>

        {% if stretch_intel and stretch_intel.alerts and stretch_intel.alerts|length > 0 %}
            <h2 class="section-title">Stretch Alerts</h2>
            <div class="stretch-grid">
                {% for a in stretch_intel.alerts %}
                    <div class="stretch-alert {% if a.severity=='warning' %}warning{% else %}info{% endif %}">
                        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
                            <div><strong>{{ a.title }}</strong></div>
                            <div class="meta">{{ a.kind }}</div>
                        </div>
                        {% if a.detail %}<div class="meta" style="margin-top:6px">{{ a.detail }}</div>{% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endif %}
{% endif %}

<!-- ================= INVENTORY PREDICTION & MONITORING ================= -->
{% if project %}
<h2 class="section-title">üìä Inventory Prediction & Monitoring</h2>

<div class="card">
    <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 700;">Material Forecasts (Stretch & Activity-wise)</h3>
    {% if inventory_prediction_data %}
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Stretch</th>
                        <th>Activity</th>
                        <th>Material</th>
                        <th>Predicted Qty</th>
                        <th>Unit</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in inventory_prediction_data %}
                    <tr>
                        <td>{{ row.stretch_name }}</td>
                        <td>{{ row.activity_name }}</td>
                        <td>{{ row.material_name }}</td>
                        <td>{{ row.predicted_qty }}</td>
                        <td>{{ row.unit|unit_sup }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="empty-state">
            <p>No prediction data available.</p>
        </div>
    {% endif %}

    <hr>

    <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 700;">Procurement Schedule (Order By Dates)</h3>
    {% if procurement_schedule %}
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Material</th>
                        <th>Activity</th>
                        <th>Required By</th>
                        <th>Order By</th>
                        <th>Lead Time (days)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in procurement_schedule %}
                    <tr>
                        <td>{{ row.material_name }}</td>
                        <td>{{ row.activity_name }}</td>
                        <td>{{ row.required_by }}</td>
                        <td>{{ row.order_by }}</td>
                        <td>{{ row.lead_time_days }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="empty-state">
            <p>No procurement schedule available.</p>
        </div>
    {% endif %}

    <hr>

    <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 700;">Real-time Inventory Status</h3>
    {% if inventory_status %}
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Material</th>
                        <th>Current Stock</th>
                        <th>Minimum Buffer</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mid, inv in inventory_status.items() %}
                    <tr>
                        <td>{{ inv.material_name }}</td>
                        <td>{{ inv.current_stock }}</td>
                        <td>{{ inv.minimum_stock }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="empty-state">
            <p>No inventory status available.</p>
        </div>
    {% endif %}

    <hr>

    <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 700;">Alerts & Warnings (Buffer/Risk)</h3>
    {% if buffer_alerts %}
        <div class="stretch-grid">
            {% for mid, alert in buffer_alerts.items() %}
                {% if alert %}
                <div class="stretch-alert warning">
                    <strong>{{ alert.material_name }}</strong>: {{ alert.alert_type|capitalize }} predicted on {{ alert.predicted_date }} (Stock: {{ alert.predicted_stock }})
                </div>
                {% endif %}
            {% endfor %}
        </div>
    {% else %}
        <div class="meta">No buffer alerts.</div>
    {% endif %}
</div>
{% endif %}

<!-- ================= ACTIVITIES PROGRESS ================= -->
{% if project %}
<div class="card">
    <h3 style="margin-top:0">Overall Project Progress</h3>
    <div class="meta" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px">
        <div>
            <strong>Time view:</strong>
            <select id="timeUnitSelect" style="padding:6px 8px">
                <option value="hours">Hours</option>
                <option value="days">Days</option>
            </select>
        </div>
        <div>
            <span class="pill">Planned: <span id="timePlanned">‚Äì</span> <span id="timeUnitLabel">hrs</span></span>
            <span class="pill">Executed: <span id="timeExecuted">‚Äì</span> <span id="timeUnitLabel2">hrs</span></span>
        </div>
    </div>
    <div class="progress-bar-container">
        <div class="progress-bar" id="overallProgressBar">0%</div>
    </div>
    <div class="meta" style="margin-top:8px">Time progress: <strong id="overallTimeProgress">0%</strong></div>
</div>

<!-- ================= WARNING / UPDATE SYSTEM ================= -->
{% if alerts %}
<h2 class="section-title">Upcoming Updates & Warnings</h2>

<div class="card" style="margin-bottom:20px">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
        <div>
            <h3 style="margin:0">What‚Äôs Next + What to Order</h3>
            <div class="meta" style="margin-top:6px">
                Based on plan (Activity & Materials) + current stock + lead time. Today: <strong>{{ alerts.today }}</strong>
            </div>
        </div>
        <div>
            {% if alerts.warnings_count and alerts.warnings_count > 0 %}
                <span class="badge badge-warning">{{ alerts.warnings_count }} urgent</span>
            {% else %}
                <span class="badge badge-success">No urgent warnings</span>
            {% endif %}
        </div>
    </div>

    <hr style="margin:14px 0; opacity:0.45">

    {% if alerts.next_activity %}
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <span class="badge badge-info">Next Activity</span>
            <span>
                {% if alerts.next_activity.activity_code %}<strong>{{ alerts.next_activity.activity_code }}</strong> ‚Äî{% endif %}
                <strong>{{ alerts.next_activity.activity_name }}</strong>
                <span class="meta">(Start: {{ alerts.next_activity.start_date }}, Progress: {{ alerts.next_activity.progress_percent }}%)</span>
            </span>
        </div>
    {% else %}
        <div class="meta">No upcoming activities found (check planning dates / progress).</div>
    {% endif %}

    <div style="margin-top:14px">
        {% if alerts.procurement_snapshot and alerts.procurement_snapshot|length > 0 %}
        <div style="margin: 0 0 12px 0;">
            <h4 style="margin:0 0 8px 0">Materials needing action this week</h4>
            <div class="meta" style="margin-bottom:8px">Compact summary for managers (urgent items only).</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
                {% for s in alerts.procurement_snapshot %}
                    <span class="pill" title="{{ s.status_label }}{% if s.earliest_order_by %} | Order-by: {{ s.earliest_order_by }}{% endif %}">
                        {% if s.material_code %}{{ s.material_code }} ‚Äî {% endif %}{{ s.material_name }}:
                        <strong>{{ "%.3f"|format(s.total_to_order_qty or 0) }}</strong> {{ s.unit|unit_sup }}
                        {% if s.earliest_order_by %}<span class="meta">(by {{ s.earliest_order_by }})</span>{% endif %}
                        {% if s.status_kind == 'LATE' %}<span class="badge badge-danger" style="margin-left:6px">Late</span>{% endif %}
                        {% if s.status_kind == 'DUE' %}<span class="badge badge-warning" style="margin-left:6px">Due</span>{% endif %}
                        {% if s.status_kind == 'DUE_SOON' %}<span class="badge badge-warning" style="margin-left:6px">Due Soon</span>{% endif %}
                    </span>
                {% endfor %}
            </div>
            <hr style="margin:14px 0; opacity:0.35">
        </div>
        {% endif %}

        <h4 style="margin:0 0 8px 0">Material Order Alerts (Top {{ alerts.cfg.max_rows }})</h4>

        {% if alerts.material_orders and alerts.material_orders|length > 0 %}
        <div style="overflow:auto">
            <table class="table" style="min-width:980px">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Order By</th>
                        <th>Supply Lead Time</th>
                        <th>Vendor</th>
                        <th>Usage</th>
                        <th>Stock Cover</th>
                        <th>Activity</th>
                        <th>Material</th>
                        <th style="text-align:right">Material Required</th>
                        <th style="text-align:right">In Stock</th>
                        <th style="text-align:right">Order Quantity</th>
                    </tr>
                </thead>
                <tbody>
                {% for r in alerts.material_orders %}
                    {% set urgent = r.status_kind in ['LATE','DUE','DUE_SOON'] and (r.to_order_qty or 0) > 0 %}
                    <tr {% if urgent %}style="background:rgba(245,158,11,0.10)"{% endif %}>
                        <td>
                            {% if r.status_kind == 'LATE' %}
                                <span class="badge badge-danger" title="{{ r.explain or '' }}">{{ r.status_label }}</span>
                            {% elif r.status_kind == 'DUE' %}
                                <span class="badge badge-warning" title="{{ r.explain or '' }}">{{ r.status_label }}</span>
                            {% elif r.status_kind == 'DUE_SOON' %}
                                <span class="badge badge-warning" title="{{ r.explain or '' }}">{{ r.status_label }}</span>
                            {% elif r.status_kind == 'OK' %}
                                <span class="badge badge-success" title="{{ r.explain or '' }}">{{ r.status_label }}</span>
                            {% else %}
                                <span class="badge" title="{{ r.explain or '' }}">{{ r.status_label }}</span>
                            {% endif %}
                        </td>
                        <td title="{{ r.explain or '' }}">{{ r.order_by }}</td>
                        <td title="{{ r.explain or '' }}">{{ r.lead_time_days }} day(s)</td>
                        <td>
                            {% if r.recommended_vendor %}
                                <div><strong>{{ r.recommended_vendor.vendor_name }}</strong></div>
                                <div class="meta">LT: {{ r.recommended_vendor.lead_time_days }}d{% if r.recommended_vendor.unit_price %} ¬∑ {{ r.recommended_vendor.unit_price }}/unit{% endif %}</div>
                            {% elif r.vendor_options and r.vendor_options|length > 0 %}
                                <div><strong>{{ r.vendor_options[0].vendor_name }}</strong></div>
                                <div class="meta">LT: {{ r.vendor_options[0].lead_time_days }}d{% if r.vendor_options[0].unit_price %} ¬∑ {{ r.vendor_options[0].unit_price }}/unit{% endif %}</div>
                            {% else %}
                                <span class="meta">No vendor</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if r.avg_daily_usage %}
                                {{ r.avg_daily_usage }} / day
                            {% else %}
                                <span class="meta">n/a</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if r.stock_days %}
                                {{ r.stock_days }} days
                            {% else %}
                                <span class="meta">n/a</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if r.activity_code %}<span class="badge">{{ r.activity_code }}</span>{% endif %}
                            {{ r.activity_name }}
                            <div class="meta">Start: {{ r.activity_start }}</div>
                        </td>
                        <td>
                            {% if r.material_code %}<span class="badge">{{ r.material_code }}</span>{% endif %}
                            {{ r.material_name }}
                            <div class="meta">Unit: {{ r.unit|unit_sup }}</div>
                        </td>
                        <td style="text-align:right">{{ r.required_qty }}</td>
                        <td style="text-align:right">{{ r.available_qty }}</td>
                        <td style="text-align:right">
                            {% if (r.to_order_qty or 0) > 0 %}
                                <strong>{{ r.to_order_qty }}</strong>
                            {% else %}
                                0
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="meta" style="margin-top:8px">
            Tip: Update stock in Inventory and consumption in Daily Execution to keep this accurate.
        </div>
        {% else %}
            <div class="meta">No material links found for upcoming activities (link materials in Activity & Materials page).</div>
        {% endif %}
    </div>
</div>
    {% endif %}
<!-- ================= ACTIVITIES ================= -->
<h2 class="section-title">
    üìã Project Activities
    {% if not project.is_active %}
        <span class="badge badge-warning">Archived Project</span>
    {% endif %}
</h2>

<div class="card">
    <div class="activity-table-wrapper">
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Progress</th>
                    <th>Status</th>
                    <th>Delay</th>
                    <th>Materials</th>
                    <th>Update</th>
                </tr>
            </thead>
            <tbody id="activityTableBody">
                <tr>
                    <td colspan="8" style="text-align: center; padding: 32px 16px;">
                        <span class="meta">‚è≥ Loading activities‚Ä¶</span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<script src="/static/js/dashboard.js"></script>

<script>
    (function () {
        const btn = document.getElementById('projectSelectBtn');
        const menu = document.getElementById('projectSelectMenu');
        if (!btn || !menu) return;

        const label = btn.querySelector('.project-select-label');

        function closeMenu() {
            menu.classList.remove('is-open');
            btn.setAttribute('aria-expanded', 'false');
        }

        function openMenu() {
            menu.classList.add('is-open');
            btn.setAttribute('aria-expanded', 'true');
        }

        btn.addEventListener('click', (event) => {
            event.stopPropagation();
            if (menu.classList.contains('is-open')) {
                closeMenu();
            } else {
                openMenu();
            }
        });

        menu.querySelectorAll('.project-select-item').forEach((item) => {
            item.addEventListener('click', () => {
                const value = item.getAttribute('data-value');
                if (!value) return;
                if (label) {
                    label.textContent = item.textContent.trim();
                }
                window.location.href = '?project_id=' + value;
            });
        });

        document.addEventListener('click', closeMenu);
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeMenu();
            }
        });
    })();
</script>

{% endblock %}

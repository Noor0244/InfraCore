{% extends "base.html" %}
{% block content %}

<h1 class="page-title">{{ title }}</h1>

<style>
    .dash-toggle{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px 0}
    .dash-toggle a{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.10);background:rgba(255,255,255,0.04);text-decoration:none;color:var(--text)}
    .dash-toggle a.active{background:rgba(30,111,216,0.18);border-color:rgba(30,111,216,0.35)}

    .stretch-bar{display:flex;height:16px;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,0.10);background:rgba(255,255,255,0.04)}
    .stretch-seg{height:100%}
    .stretch-seg.not_started{background:rgba(148,163,184,0.35)}
    .stretch-seg.in_progress{background:rgba(30,111,216,0.55)}
    .stretch-seg.completed{background:rgba(34,197,94,0.55)}
    .stretch-seg.delayed{background:rgba(245,158,11,0.65)}

    .stretch-grid{display:grid;grid-template-columns:1fr;gap:12px}
    .stretch-filters{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .stretch-filters label{font-size:12px;color:var(--text-muted)}
    .stretch-filters select,.stretch-filters input{padding:6px 8px}
    .stretch-alert{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.10);background:rgba(255,255,255,0.04)}
    .stretch-alert.warning{border-color:rgba(245,158,11,0.35);background:rgba(245,158,11,0.10)}
    .stretch-alert.info{border-color:rgba(30,111,216,0.35);background:rgba(30,111,216,0.10)}
</style>

<!-- ================= PROJECT CONTEXT ================= -->
<script id="projectIdJson" type="application/json">{{ project_id | tojson }}</script>

<!-- ================= KPI / SUMMARY ================= -->
<div class="kpi-grid">
    <a href="/reports" class="kpi-card kpi-primary">
        <div class="kpi-icon">ðŸ“„</div>
        <div class="kpi-content">
            <div class="kpi-value">{{ summary.total_reports }}</div>
            <div class="kpi-label">Total Reports</div>
        </div>
    </a>

    <div class="kpi-card kpi-success">
        <div class="kpi-icon">ðŸ“…</div>
        <div class="kpi-content">
            <div class="kpi-value">{{ summary.reports_today }}</div>
            <div class="kpi-label">Reports Today</div>
        </div>
    </div>
</div>

<!-- ================= PROJECT OVERVIEW ================= -->
<h2 class="section-title">Project Overview</h2>

{% if not has_projects %}
<div class="card">
    <p style="margin:0;opacity:0.8">
        Create a project to get started.
    </p>
</div>

{% elif project %}
<div class="card" style="margin-bottom:20px">

    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
        <h3 style="margin:0">Active Project</h3>

        {% if projects|length > 1 %}
        <select
            class="form-select"
            onchange="if(this.value) window.location.href='?project_id=' + this.value"
        >
            {% for p in projects %}
                <option value="{{ p.id }}" {% if project.id == p.id %}selected{% endif %}>
                    {{ p.name }} â€” {{ p.city }}
                    {% if not p.is_active %}(Archived){% endif %}
                </option>
            {% endfor %}
        </select>
        {% endif %}
    </div>

    <hr style="margin:12px 0">

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px">

        <div>
            <strong>Project Name</strong><br>
            {{ project.name }}
        </div>

        <div>
            <strong>Location</strong><br>
            {{ project.city }}
            {% if project.state %}, {{ project.state }}{% endif %}
        </div>

        <div>
            <strong>Road Details</strong><br>
            {{ project.road_type }},
            {{ project.lanes }} lanes,
            {{ project.road_length_km }} km
        </div>

        <div>
            <strong>Status</strong><br>
            <span class="badge badge-info">
                {{ project.status|capitalize }}
            </span>
        </div>

        <div>
            <strong>Timeline</strong><br>
            {{ project.planned_start_date|ddmmyyyy }} â†’ {{ project.planned_end_date|ddmmyyyy }}
        </div>

    </div>

    <hr style="margin:14px 0; opacity:0.45">
    <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn-primary" href="/projects/{{ project.id }}/prediction">ðŸ”® Prediction</a>
        <a class="btn-secondary" href="/execution/{{ project.id }}">ðŸ§¾ Daily Execution</a>
        <a class="btn-secondary" href="/activity-material-planning/{{ project.id }}">ðŸ—“ðŸ§± Activity & Materials</a>
    </div>
</div>

{% if project and has_stretches %}
    <div class="dash-toggle">
        <a class="{% if dash_view != 'stretch' %}active{% endif %}" href="/dashboard?project_id={{ project.id }}&view=project">Project View</a>
        <a class="{% if dash_view == 'stretch' %}active{% endif %}" href="/dashboard?project_id={{ project.id }}&view=stretch">Stretch View</a>
    </div>
{% endif %}
{% endif %}

<!-- ================= STRETCH INTELLIGENCE MODE ================= -->
{% if project and dash_view == 'stretch' %}
    {% if not has_stretches %}
        <div class="card"><div class="meta">No stretches found for this project. Switch back to Project View.</div></div>
    {% else %}
        <h2 class="section-title">Stretch Intelligence</h2>

        <div class="card" style="margin-bottom:14px">
            <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-start">
                <div>
                    <h3 style="margin:0">Stretch Overview</h3>
                    <div class="meta" style="margin-top:6px">Today: <strong>{{ (stretch_intel.today if stretch_intel else '') }}</strong>. Status and alerts are computed server-side.</div>
                </div>
            </div>

            <hr style="margin:14px 0; opacity:0.45">

            <form method="get" action="/dashboard" class="stretch-filters">
                <input type="hidden" name="project_id" value="{{ project.id }}">
                <input type="hidden" name="view" value="stretch">

                <div>
                    <label>Lookahead Days</label><br>
                    <select name="lookahead_days">
                        {% set la = (stretch_intel.cfg.lookahead_days if stretch_intel else 30) %}
                        <option value="7" {% if la==7 %}selected{% endif %}>7</option>
                        <option value="14" {% if la==14 %}selected{% endif %}>14</option>
                        <option value="30" {% if la==30 %}selected{% endif %}>30</option>
                    </select>
                </div>

                <div>
                    <label>Stretch</label><br>
                    <select name="stretch_id">
                        <option value="">All</option>
                        {% for s in stretch_choices %}
                            <option value="{{ s.id }}" {% if stretch_intel and stretch_intel.filters.stretch_id==s.id %}selected{% endif %}>{{ s.stretch_code }} ({{ s.start_chainage }}â€“{{ s.end_chainage }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label>Status</label><br>
                    <select name="status">
                        <option value="">All</option>
                        <option value="NOT_STARTED" {% if stretch_intel and stretch_intel.filters.status=='NOT_STARTED' %}selected{% endif %}>Not Started</option>
                        <option value="IN_PROGRESS" {% if stretch_intel and stretch_intel.filters.status=='IN_PROGRESS' %}selected{% endif %}>In Progress</option>
                        <option value="DELAYED" {% if stretch_intel and stretch_intel.filters.status=='DELAYED' %}selected{% endif %}>Delayed</option>
                        <option value="COMPLETED" {% if stretch_intel and stretch_intel.filters.status=='COMPLETED' %}selected{% endif %}>Completed</option>
                    </select>
                </div>

                <div>
                    <label>&nbsp;</label><br>
                    <button class="btn-primary" type="submit">Apply</button>
                </div>

                <div>
                    <label>&nbsp;</label><br>
                    <a class="btn-secondary" href="/dashboard?project_id={{ project.id }}&view=stretch">Reset</a>
                </div>
            </form>

            {% if stretch_intel and stretch_intel.stretches and stretch_intel.stretches|length > 0 %}
                <div style="margin-top:14px">
                    <div class="meta" style="margin-bottom:8px">Chainage strip (hover for quick stats)</div>
                    <div class="stretch-bar">
                        {% set total_m = (stretch_intel.total_length_m or 0) %}
                        {% for st in stretch_intel.stretches %}
                            {% set w = (100.0 * (st.length_m or 0) / total_m) if total_m else 0 %}
                            {% set cls = (st.status_kind or 'NOT_STARTED')|lower %}
                            <div
                                class="stretch-seg {{ cls }}"
                                                                data-width="{{ w }}"
                                title="{{ st.stretch_code }} | {{ st.chainage }} | {{ st.status_label }} | {{ st.actual_progress }}%"
                            ></div>
                        {% endfor %}
                    </div>
                                        <script>
                                            (function(){
                                                try{
                                                    document.querySelectorAll('.stretch-seg[data-width]').forEach(function(el){
                                                        var w = parseFloat(el.getAttribute('data-width') || '0');
                                                        if (isNaN(w) || w < 0) w = 0;
                                                        el.style.width = w + '%';
                                                    });
                                                }catch(e){}
                                            })();
                                        </script>
                </div>

                <hr style="margin:14px 0; opacity:0.35">

                <div style="overflow:auto">
                    <table class="table" style="min-width:1060px">
                        <thead>
                            <tr>
                                <th>Stretch</th>
                                <th>Chainage</th>
                                <th>Planned Start â€“ End</th>
                                <th>Progress</th>
                                <th>Status</th>
                                <th>Critical Activity</th>
                                <th>Material Risk</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for st in stretch_intel.stretches %}
                                <tr>
                                    <td>
                                        <strong>{{ st.stretch_code }}</strong>
                                        <div class="meta">{{ st.stretch_name }}</div>
                                    </td>
                                    <td>{{ st.chainage }}</td>
                                    <td>
                                        {% if st.planned_start %}{{ st.planned_start }}{% else %}â€”{% endif %}
                                        â€”
                                        {% if st.planned_end %}{{ st.planned_end }}{% else %}â€”{% endif %}
                                        {% if st.planned_progress is not none %}
                                            <div class="meta">Planned progress: {{ st.planned_progress }}%</div>
                                        {% endif %}
                                    </td>
                                    <td><strong>{{ st.actual_progress }}%</strong></td>
                                    <td>
                                        {% if st.status_kind == 'DELAYED' %}
                                            <span class="badge badge-warning">Delayed</span>
                                        {% elif st.status_kind == 'COMPLETED' %}
                                            <span class="badge badge-success">Completed</span>
                                        {% elif st.status_kind == 'IN_PROGRESS' %}
                                            <span class="badge badge-info">In Progress</span>
                                        {% else %}
                                            <span class="badge">Not Started</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if st.critical_activity %}
                                            {% if st.critical_activity.activity_code %}<span class="badge">{{ st.critical_activity.activity_code }}</span>{% endif %}
                                            <strong>{{ st.critical_activity.activity_name }}</strong>
                                            <div class="meta">Start: {{ st.critical_activity.start_date }} | Progress: {{ st.critical_activity.progress_percent }}%</div>
                                        {% else %}
                                            <span class="meta">â€”</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if st.material_risk_kind == 'SHORTAGE' %}
                                            <span class="badge badge-danger">Shortage</span>
                                        {% elif st.material_risk_kind == 'DUE_SOON' %}
                                            <span class="badge badge-warning">Due Soon</span>
                                        {% else %}
                                            <span class="badge badge-success">OK</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="meta">No stretch data available (check stretch activity mapping / planning).</div>
            {% endif %}
        </div>

        {% if stretch_intel and stretch_intel.alerts and stretch_intel.alerts|length > 0 %}
            <h2 class="section-title">Stretch Alerts</h2>
            <div class="stretch-grid">
                {% for a in stretch_intel.alerts %}
                    <div class="stretch-alert {% if a.severity=='warning' %}warning{% else %}info{% endif %}">
                        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
                            <div><strong>{{ a.title }}</strong></div>
                            <div class="meta">{{ a.kind }}</div>
                        </div>
                        {% if a.detail %}<div class="meta" style="margin-top:6px">{{ a.detail }}</div>{% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endif %}
{% endif %}

<!-- ================= PROJECT KPI ================= -->
{% if project %}
<div class="kpi-grid">
    <div class="kpi-card kpi-primary">
        <div class="kpi-content">
            <div class="kpi-value" id="totalActivities">â€“</div>
            <div class="kpi-label">Total Activities</div>
        </div>
    </div>

    <div class="kpi-card kpi-warning">
        <div class="kpi-content">
            <div class="kpi-value" id="inProgressActivities">â€“</div>
            <div class="kpi-label">In Progress</div>
        </div>
    </div>

    <div class="kpi-card kpi-success">
        <div class="kpi-content">
            <div class="kpi-value" id="completedActivities">â€“</div>
            <div class="kpi-label">Completed</div>
        </div>
    </div>

    <div class="kpi-card kpi-danger">
        <div class="kpi-content">
            <div class="kpi-value" id="delayedActivities">â€“</div>
            <div class="kpi-label">Delayed</div>
        </div>
    </div>

    <div class="kpi-card kpi-warning">
        <div class="kpi-content">
            <div class="kpi-value" id="materialRiskActivities">â€“</div>
            <div class="kpi-label">Material Risk</div>
        </div>
    </div>
</div>

<div class="card">
    <h3 style="margin-top:0">Overall Project Progress</h3>
    <div class="meta" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px">
        <div>
            <strong>Time view:</strong>
            <select id="timeUnitSelect" style="padding:6px 8px">
                <option value="hours">Hours</option>
                <option value="days">Days</option>
            </select>
        </div>
        <div>
            <span class="pill">Planned: <span id="timePlanned">â€“</span> <span id="timeUnitLabel">hrs</span></span>
            <span class="pill">Executed: <span id="timeExecuted">â€“</span> <span id="timeUnitLabel2">hrs</span></span>
        </div>
    </div>
    <div class="progress-bar-container">
        <div class="progress-bar" id="overallProgressBar">0%</div>
    </div>
    <div class="meta" style="margin-top:8px">Time progress: <strong id="overallTimeProgress">0%</strong></div>
</div>

<!-- ================= WARNING / UPDATE SYSTEM ================= -->
{% if alerts %}
<h2 class="section-title">Upcoming Updates & Warnings</h2>

<div class="card" style="margin-bottom:20px">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
        <div>
            <h3 style="margin:0">Whatâ€™s Next + What to Order</h3>
            <div class="meta" style="margin-top:6px">
                Based on plan (Activity & Materials) + current stock + lead time. Today: <strong>{{ alerts.today }}</strong>
            </div>
        </div>
        <div>
            {% if alerts.warnings_count and alerts.warnings_count > 0 %}
                <span class="badge badge-warning">{{ alerts.warnings_count }} urgent</span>
            {% else %}
                <span class="badge badge-success">No urgent warnings</span>
            {% endif %}
        </div>
    </div>

    <hr style="margin:14px 0; opacity:0.45">

    {% if alerts.next_activity %}
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <span class="badge badge-info">Next Activity</span>
            <span>
                {% if alerts.next_activity.activity_code %}<strong>{{ alerts.next_activity.activity_code }}</strong> â€”{% endif %}
                <strong>{{ alerts.next_activity.activity_name }}</strong>
                <span class="meta">(Start: {{ alerts.next_activity.start_date }}, Progress: {{ alerts.next_activity.progress_percent }}%)</span>
            </span>
        </div>
    {% else %}
        <div class="meta">No upcoming activities found (check planning dates / progress).</div>
    {% endif %}

    <div style="margin-top:14px">
        {% if alerts.procurement_snapshot and alerts.procurement_snapshot|length > 0 %}
        <div style="margin: 0 0 12px 0;">
            <h4 style="margin:0 0 8px 0">Materials needing action this week</h4>
            <div class="meta" style="margin-bottom:8px">Compact summary for managers (urgent items only).</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
                {% for s in alerts.procurement_snapshot %}
                    <span class="pill" title="{{ s.status_label }}{% if s.earliest_order_by %} | Order-by: {{ s.earliest_order_by }}{% endif %}">
                        {% if s.material_code %}{{ s.material_code }} â€” {% endif %}{{ s.material_name }}:
                        <strong>{{ "%.3f"|format(s.total_to_order_qty or 0) }}</strong> {{ s.unit }}
                        {% if s.earliest_order_by %}<span class="meta">(by {{ s.earliest_order_by }})</span>{% endif %}
                        {% if s.status_kind == 'LATE' %}<span class="badge badge-danger" style="margin-left:6px">Late</span>{% endif %}
                        {% if s.status_kind == 'DUE' %}<span class="badge badge-warning" style="margin-left:6px">Due</span>{% endif %}
                        {% if s.status_kind == 'DUE_SOON' %}<span class="badge badge-warning" style="margin-left:6px">Due Soon</span>{% endif %}
                    </span>
                {% endfor %}
            </div>
            <hr style="margin:14px 0; opacity:0.35">
        </div>
        {% endif %}

        <h4 style="margin:0 0 8px 0">Material Order Alerts (Top {{ alerts.cfg.max_rows }})</h4>

        {% if alerts.material_orders and alerts.material_orders|length > 0 %}
        <div style="overflow:auto">
            <table class="table" style="min-width:980px">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Order By</th>
                        <th>Supply Lead Time</th>
                        <th>Activity</th>
                        <th>Material</th>
                        <th style="text-align:right">Material Required</th>
                        <th style="text-align:right">In Stock</th>
                        <th style="text-align:right">Order Quantity</th>
                    </tr>
                </thead>
                <tbody>
                {% for r in alerts.material_orders %}
                    {% set urgent = r.status_kind in ['LATE','DUE','DUE_SOON'] and (r.to_order_qty or 0) > 0 %}
                    <tr {% if urgent %}style="background:rgba(245,158,11,0.10)"{% endif %}>
                        <td>
                            {% if r.status_kind == 'LATE' %}
                                <span class="badge badge-danger" title="{{ r.explain or '' }}">{{ r.status_label }}</span>
                            {% elif r.status_kind == 'DUE' %}
                                <span class="badge badge-warning" title="{{ r.explain or '' }}">{{ r.status_label }}</span>
                            {% elif r.status_kind == 'DUE_SOON' %}
                                <span class="badge badge-warning" title="{{ r.explain or '' }}">{{ r.status_label }}</span>
                            {% elif r.status_kind == 'OK' %}
                                <span class="badge badge-success" title="{{ r.explain or '' }}">{{ r.status_label }}</span>
                            {% else %}
                                <span class="badge" title="{{ r.explain or '' }}">{{ r.status_label }}</span>
                            {% endif %}
                        </td>
                        <td title="{{ r.explain or '' }}">{{ r.order_by }}</td>
                        <td title="{{ r.explain or '' }}">{{ r.lead_time_days }} day(s)</td>
                        <td>
                            {% if r.activity_code %}<span class="badge">{{ r.activity_code }}</span>{% endif %}
                            {{ r.activity_name }}
                            <div class="meta">Start: {{ r.activity_start }}</div>
                        </td>
                        <td>
                            {% if r.material_code %}<span class="badge">{{ r.material_code }}</span>{% endif %}
                            {{ r.material_name }}
                            <div class="meta">Unit: {{ r.unit }}</div>
                        </td>
                        <td style="text-align:right">{{ r.required_qty }}</td>
                        <td style="text-align:right">{{ r.available_qty }}</td>
                        <td style="text-align:right">
                            {% if (r.to_order_qty or 0) > 0 %}
                                <strong>{{ r.to_order_qty }}</strong>
                            {% else %}
                                0
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="meta" style="margin-top:8px">
            Tip: Update stock in Inventory and consumption in Daily Execution to keep this accurate.
        </div>
        {% else %}
            <div class="meta">No material links found for upcoming activities (link materials in Activity & Materials page).</div>
        {% endif %}
    </div>
</div>
{% endif %}
{% endif %}

<!-- ================= ACTIVITIES ================= -->
{% if project %}
<h2 class="section-title">
    Project Activities

    {% if not project.is_active %}
        <span class="badge badge-warning" style="float:right">
            Archived Project
        </span>
    {% endif %}
</h2>

<div class="card">
<table class="table">
<thead>
<tr>
    <th>ID</th>
    <th>Start</th>
    <th>End</th>
    <th>Progress</th>
    <th>Status</th>
    <th>Delay</th>
    <th>Materials</th>
    <th>Update</th>
</tr>
</thead>
<tbody id="activityTableBody">
<tr>
    <td colspan="8" style="opacity:0.7">
        Loading activitiesâ€¦
    </td>
</tr>
</tbody>
</table>
</div>
{% endif %}

<script src="/static/js/dashboard.js"></script>

{% endblock %}

{% extends "base.html" %}

{% block content %}

<style>
    :root {
        --dpr-surface: color-mix(in srgb, var(--card-bg) 92%, transparent);
        --dpr-border: color-mix(in srgb, var(--border-color) 70%, transparent);
        --dpr-muted: color-mix(in srgb, var(--text-secondary) 85%, transparent);
        --dpr-accent: #3b82f6;
        --dpr-warn: #f59e0b;
        --dpr-success: #10b981;
        --dpr-danger: #ef4444;
    }

    .dpr-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; }
    .dpr-card { max-width: 1180px; margin: 0 auto; padding: 20px 22px; background: var(--card-bg); border: 1px solid var(--dpr-border); border-radius: 16px; box-shadow: 0 12px 30px rgba(0,0,0,0.18); }
    .dpr-top { display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap: wrap; padding-bottom: 10px; border-bottom: 1px solid var(--dpr-border); margin-bottom: 12px; }
    .dpr-top .meta { color: var(--dpr-muted); font-size: 12.5px; }

    .dpr-intro { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; margin-bottom: 14px; }
    .intro-card { border: 1px solid var(--dpr-border); border-radius: 14px; padding: 14px 16px; background: var(--dpr-surface); }
    .intro-title { font-size: 11px; font-weight: 800; letter-spacing: 0.08em; text-transform: uppercase; color: var(--dpr-muted); }
    .intro-main { font-size: 16px; font-weight: 800; margin-top: 6px; color: var(--text-primary); }
    .intro-sub { font-size: 12px; color: var(--dpr-muted); margin-top: 4px; }
    .intro-actions { display:flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }

    .project-context { position: sticky; top: 0; z-index: 5; padding: 12px 14px; border: 1px solid var(--dpr-border); border-radius: 12px; background: color-mix(in srgb, var(--card-bg) 88%, transparent); backdrop-filter: blur(8px); }
    .project-context .title { font-weight: 800; font-size: 13px; color: var(--text-primary); }
    .project-context .kv { display:flex; flex-wrap: wrap; gap: 10px 16px; margin-top: 6px; }
    .project-context .kv div { color: var(--dpr-muted); font-size: 12px; }

    .dpr-table { width:100%; border-collapse: separate; border-spacing: 0; background: var(--card-bg); border: 1px solid var(--dpr-border); border-radius: 12px; overflow: hidden; }
    .dpr-table th, .dpr-table td { border-bottom: 1px solid var(--dpr-border); padding: 10px 10px; vertical-align: top; font-size: 12.5px; }
    .dpr-table th { background: color-mix(in srgb, var(--card-bg) 90%, black 10%); text-align:left; color: var(--text-secondary); font-weight: 700; }
    .dpr-table tr:last-child td { border-bottom: none; }

    .dpr-table input, .dpr-table select, .dpr-table textarea {
        width: 100%;
        background: color-mix(in srgb, var(--card-bg) 88%, transparent);
        border: 1px solid var(--dpr-border);
        color: var(--text-primary);
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 12.5px;
    }

    .pill { display:inline-flex; align-items:center; padding: 3px 8px; border-radius: 999px; font-size: 11px; background: color-mix(in srgb, var(--card-bg) 88%, transparent); border: 1px solid var(--dpr-border); color: var(--text-primary); }
    .pill.draft { border-color: color-mix(in srgb, var(--dpr-accent) 60%, transparent); color: var(--dpr-accent); }
    .pill.submitted { border-color: color-mix(in srgb, var(--dpr-warn) 60%, transparent); color: var(--dpr-warn); }
    .pill.approved { border-color: color-mix(in srgb, var(--dpr-success) 60%, transparent); color: var(--dpr-success); }
    .pill.rejected { border-color: color-mix(in srgb, var(--dpr-danger) 60%, transparent); color: var(--dpr-danger); }

    .invalid { border: 1px solid var(--dpr-danger) !important; }
    .disabled-section { opacity: 0.6; pointer-events: none; }

    details { border: 1px solid var(--dpr-border); border-radius: 12px; padding: 12px 14px; background: var(--dpr-surface); margin-top: 14px; }
    details > summary { cursor: pointer; font-weight: 700; color: var(--text-primary); }

    .btn-danger { background: var(--dpr-danger); color: #fff; padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; }
    .btn-success { background: var(--dpr-success); color: #fff; padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; }
    .btn-sm { padding: 6px 10px; font-size: 12px; }

    .btn-approve-activity { background: var(--dpr-accent); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; transition: all 160ms ease; }
    .btn-approve-activity:hover { opacity: 0.92; box-shadow: 0 4px 10px color-mix(in srgb, var(--dpr-accent) 30%, transparent); }
    .btn-update-activity { background: var(--dpr-warn); color: #111827; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; transition: all 160ms ease; }
    .btn-update-activity:hover { opacity: 0.92; box-shadow: 0 4px 10px color-mix(in srgb, var(--dpr-warn) 30%, transparent); }

    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.65); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--card-bg); border: 1px solid var(--dpr-border); border-radius: 14px; padding: 24px; max-width: 520px; width: 92%; box-shadow: 0 16px 40px rgba(0,0,0,0.45); }
    .modal-content .modal-title { font-size: 18px; font-weight: 800; margin-bottom: 16px; color: var(--text-primary); }
    .modal-content .form-group { margin-bottom: 16px; }
    .modal-content .form-group label { display: block; font-size: 12px; margin-bottom: 6px; color: var(--text-secondary); }
    .modal-content .form-group input, .modal-content .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--dpr-border); border-radius: 8px; background: var(--dpr-surface); color: var(--text-primary); font-size: 13px; }
    .modal-content .form-group textarea { resize: vertical; min-height: 90px; font-family: inherit; }
    .modal-content .modal-footer { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
    .modal-content .btn-modal-cancel { background: color-mix(in srgb, var(--card-bg) 85%, transparent); color: var(--text-primary); padding: 8px 16px; border: 1px solid var(--dpr-border); border-radius: 8px; cursor: pointer; }
    .modal-content .btn-modal-save { background: var(--dpr-accent); color: #fff; padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; }

    .download-option { display: flex; align-items: center; gap: 12px; padding: 14px; border: 1px solid var(--dpr-border); border-radius: 10px; background: var(--dpr-surface); cursor: pointer; transition: all 0.2s; text-decoration: none; color: var(--text-primary); }
    .download-option:hover { background: color-mix(in srgb, var(--card-bg) 88%, transparent); border-color: color-mix(in srgb, var(--dpr-accent) 40%, transparent); transform: translateX(4px); }
    .download-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: var(--dpr-accent); border-radius: 8px; font-size: 20px; }
    .download-info { flex: 1; }
    .download-title { font-weight: 700; font-size: 14px; margin-bottom: 2px; }
    .download-desc { font-size: 12px; color: var(--text-secondary); }

    .btn-download { background: var(--dpr-success); color: #fff; padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
    .btn-download:hover { opacity: 0.92; transform: translateY(-1px); box-shadow: 0 6px 14px rgba(16,185,129,0.25); }

    .project-select {
        width: 100%;
        max-width: 280px;
        padding: 8px 32px 8px 12px;
        border: 1px solid var(--dpr-border);
        border-radius: 8px;
        background: var(--dpr-surface) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' d='M6 9L1 4h10z'/%3E%3C/svg%3E") no-repeat right 10px center;
        background-size: 12px;
        color: var(--text-primary);
        font-size: 12.5px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
    }
    .project-select:hover {
        background-color: color-mix(in srgb, var(--card-bg) 85%, transparent);
        border-color: color-mix(in srgb, var(--dpr-accent) 40%, transparent);
    }
    .project-select:focus {
        outline: none;
        border-color: var(--dpr-accent);
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--dpr-accent) 18%, transparent);
    }
    .project-select option {
        background: var(--card-bg);
        color: var(--text-primary);
        padding: 10px;
        font-size: 12.5px;
    }


</style>

<h1 class="page-title">Daily Work Execution (DPR) ‚Äî {{ project.name }}</h1>

<div class="card dpr-card">
    <div class="dpr-intro">
        <div class="intro-card">
            <div class="intro-title">Project</div>
            <div class="intro-main">{{ project.name }}</div>
            <div class="intro-sub">ID #{{ project.id }} ¬∑ {{ project.city }}{% if project.state %}, {{ project.state }}{% endif %}</div>
            <div class="intro-actions">
                {% if all_projects|length > 1 %}
                <select class="project-select" id="projectSelector" onchange="changeProject(this.value)">
                    {% for proj in all_projects %}
                        <option value="{{ proj.id }}" {% if proj.id == project.id %}selected{% endif %}>
                            {{ proj.name }}
                        </option>
                    {% endfor %}
                </select>
                {% else %}
                <div style="padding: 8px; color: rgba(255,255,255,0.6); font-size: 12px; font-style: italic;">
                    Only one active project available
                </div>
                {% endif %}
            </div>
        </div>

        <div class="intro-card">
            <div class="intro-title">Current Stretch</div>
            {% if current_stretch %}
                <div class="intro-main">
                    {{ current_stretch.stretch_name or current_stretch.stretch_code or "Stretch" }}
                </div>
                <div class="intro-sub">
                    Chainage: {{ current_stretch.start_chainage or "‚Äî" }} ‚Üí {{ current_stretch.end_chainage or "‚Äî" }}
                </div>
                <div class="intro-sub">
                    Plan: {{ (current_stretch.start_date or current_stretch.planned_start_date)|ddmmyyyy }} ‚Üí {{ (current_stretch.end_date or current_stretch.planned_end_date)|ddmmyyyy }}
                </div>
            {% else %}
                <div class="intro-sub">No active stretch found for this date.</div>
            {% endif %}
        </div>
    </div>

    <div class="project-context">
        <div class="title">Project Context (read-only)</div>
        <div class="kv">
            <div><strong>Project:</strong> {{ project.name }}</div>
            <div><strong>Location:</strong> {{ project.city }}{% if project.state %}, {{ project.state }}{% endif %}</div>
            <div><strong>Type:</strong> {{ project.project_type or '‚Äî' }}</div>
            {% if project.project_type == 'Road' or project.road_type %}
                <div><strong>Road Type:</strong> {{ project.road_type or '‚Äî' }}</div>
            {% endif %}
            <div><strong>Chainage:</strong> {{ project.chainage_start or '‚Äî' }} ‚Üí {{ project.chainage_end or '‚Äî' }}</div>
            <div><strong>Contractor:</strong> {{ project.contractor or '‚Äî' }}</div>
            <div><strong>Client:</strong> {{ project.client_authority or '‚Äî' }}</div>
        </div>
    </div>

    <div class="dpr-top">
        <div>
            <div class="meta">
                Project ID: <span class="pill">#{{ project.id }}</span>
                {% if report %}
                    <span class="pill {% if report.status %}{{ report.status | lower }}{% endif %}">Status: {{ report.status }}</span>
                {% else %}
                    <span class="pill draft">Status: Draft</span>
                {% endif %}
            </div>
            <div class="meta">
                Selected date: <strong>{{ report_date }}</strong>
                ¬∑ <a href="/execution/{{ project.id }}?date={{ prev_date }}">‚Üê Prev</a>
                ¬∑ <a href="/execution/{{ project.id }}?date={{ next_date }}">Next ‚Üí</a>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
            <div class="meta">
                Prepared by: <strong>{{ user["username"] }}</strong>
            </div>
            <button type="button" class="btn-download" onclick="openDownloadModal()">
                <span>‚¨á</span> Download
            </button>
        </div>
    </div>

    {% if not planned or planned|length == 0 %}
        <div class="card" style="margin-top:14px; padding:16px;">
            <div style="font-weight:700; margin-bottom:8px;">Setup Checklist</div>
            <p style="opacity:0.8; margin:0 0 10px 0;">
                {% if activity_def_count and activity_def_count > 0 %}
                    Activities exist but are not planned yet.
                {% else %}
                    No activities exist for this project yet.
                {% endif %}
            </p>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <a class="btn-primary" href="/projects/{{ project.id }}/activities/new">Add Activity</a>
                <a class="btn-secondary" href="/project-activity-plan/{{ project.id }}">Plan Activities</a>
                <a class="btn-secondary" href="/activity-material-planning/{{ project.id }}">Activity & Materials</a>
                <a class="btn-secondary" href="/project/{{ project.id }}/materials">Materials & Vendors</a>
                <a class="btn-secondary" href="/stock/current?project_id={{ project.id }}">Current Stock</a>
            </div>
        </div>
    {% else %}

    <form id="dprForm" method="post" action="/execution/{{ project.id }}" enctype="multipart/form-data">
        <input type="hidden" name="project_id" value="{{ project.id }}">

        <div class="form-section">
            <div class="section-title">Daily Header <span class="required">*</span></div>
            <div class="help-text">Complete these fields to unlock the DPR sections.</div>

            <div class="dpr-grid" style="margin-top: 10px;">
                <div class="form-group">
                    <label>Date <span class="required">*</span></label>
                    <!-- DD/MM/YYYY: Slashes auto-inserted, 4-digit year only -->
                    <input id="report_date" name="report_date" type="text" value="{{ report_date|ddmmyyyy }}" placeholder="DD/MM/YYYY" inputmode="numeric" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}" required>
                </div>

                <div class="form-group">
                    <label>Weather <span class="required">*</span></label>
                    <select id="weather" name="weather" required>
                        {% set w = (report.weather if report else "Sunny") %}
                        {% for opt in ["Sunny","Cloudy","Rainy","Heavy Rain","Fog","Windy"] %}
                            <option value="{{ opt }}" {% if w==opt %}selected{% endif %}>{{ opt }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Shift <span class="required">*</span></label>
                    <select id="shift" name="shift" required>
                        {% set sh = (report.shift if report else "Day") %}
                        {% for opt in ["Day","Night","Double"] %}
                            <option value="{{ opt }}" {% if sh==opt %}selected{% endif %}>{{ opt }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Work Chainage From <span class="required">*</span></label>
                    <input id="work_chainage_from" name="work_chainage_from" type="text" value="{{ report.work_chainage_from if report else (project.chainage_start or '') }}" placeholder="e.g., CH 12+300" required>
                </div>

                <div class="form-group">
                    <label>Work Chainage To <span class="required">*</span></label>
                    <input id="work_chainage_to" name="work_chainage_to" type="text" value="{{ report.work_chainage_to if report else (project.chainage_end or '') }}" placeholder="e.g., CH 13+100" required>
                </div>

                <div class="form-group">
                    <label>Engineer (auto)</label>
                    <input type="text" value="{{ user['username'] }}" disabled>
                </div>

                <div class="form-group">
                    <label>Supervisor <span class="required">*</span></label>
                    <input id="supervisor_name" name="supervisor_name" type="text" value="{{ report.supervisor_name if report else '' }}" placeholder="Site supervisor" required>
                </div>
            </div>
        </div>

        <div id="dprGated">

            <div class="form-section" id="plannedTodaySection">
                <div class="section-title">Today's Planned Work</div>
                <div class="help-text">Auto-calculated from the activity schedule for the selected date.</div>
                {% set can_unlock = user and (user["role"] in ["admin", "superadmin"]) %}
                {% if planned_today and planned_today|length > 0 %}
                    <table class="dpr-table" style="margin-top:10px;">
                        <thead>
                            <tr>
                                <th style="width:40%">Activity</th>
                                <th>Planned Today</th>
                                <th>Unit</th>
                                <th>Plan Window</th>
                                <th style="width:180px">Actions</th>
                                <th style="width:140px">Approval</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pa in planned_today %}
                                {% set days = (pa.end_date - pa.start_date).days + 1 %}
                                {% set per_day = (pa.planned_quantity / (days if days > 0 else 1)) %}
                                {% set ap_status = approval_status_by_activity.get(pa.activity_id, "Changed") %}
                                <tr data-activity-id="{{ pa.activity_id }}" data-activity-name="{{ pa.activity.name }}">
                                    <td><strong>{{ pa.activity.name }}</strong></td>
                                    <td>{{ "%.3f"|format(per_day) }}</td>
                                    <td>{{ pa.unit|unit_sup }}</td>
                                    <td>{{ pa.start_date }} ‚Üí {{ pa.end_date }}</td>
                                    <td style="display:flex; gap:6px;">
                                        <button type="button" class="btn-approve-activity" data-activity-id="{{ pa.activity_id }}" style="padding:5px 10px; font-size:12px;">Approve</button>
                                        <button type="button" class="btn-update-activity" data-activity-id="{{ pa.activity_id }}" data-activity-name="{{ pa.activity.name }}" style="padding:5px 10px; font-size:12px;">Update</button>
                                    </td>
                                    <td>
                                        <span class="pill approval-badge" data-activity-id="{{ pa.activity_id }}">{{ ap_status }}</span>
                                        {% if can_unlock %}
                                            <button type="button" class="btn-secondary btn-sm btn-unlock-activity" data-activity-id="{{ pa.activity_id }}" style="margin-left:6px;">Unlock</button>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <details open style="margin-top:12px;">
                        <summary>Planned Materials (by Activity)</summary>
                        <div class="help-text">Auto-calculated from planned quantities and activity consumption rates.</div>
                        <table class="dpr-table" style="margin-top:10px;">
                            <thead>
                                <tr>
                                    <th style="width:30%">Activity</th>
                                    <th style="width:30%">Material</th>
                                    <th>Planned Qty</th>
                                    <th>Unit</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody id="plannedMaterialsBody">
                                <tr>
                                    <td colspan="5" style="opacity:0.7; padding:10px;">Loading planned materials‚Ä¶</td>
                                </tr>
                            </tbody>
                        </table>
                    </details>
                {% else %}
                    <div class="help-text" style="margin-top:8px;">No planned activities for this date.</div>
                {% endif %}
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
                    <button id="applyPlannedBtn" type="button" class="btn-secondary">Use Today's Plan</button>
                    <button id="approvePlannedBtn" type="submit" name="action" value="approve" class="btn-success">Approve as Planned</button>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Planned vs Executed (Activities)</div>
                <div class="help-text">Rule: Executed today must not exceed remaining balance. Remarks required if executed is 0 or status is Delayed.</div>

                <table class="dpr-table" style="margin-top: 10px;">
                    <thead>
                        <tr>
                            <th style="width:26%">Activity</th>
                            <th>Planned</th>
                            <th>Cumulative (before)</th>
                            <th>Executed today</th>
                            <th>Cumulative (after)</th>
                            <th>Balance</th>
                            <th>Planned (time)</th>
                            <th>Executed today (time)</th>
                            <th>Cumulative (time)</th>
                            <th>Balance (time)</th>
                            <th>Status</th>
                            <th>Approval</th>
                            <th style="width:22%">Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pa in planned %}
                            {% set ap = progress_by_activity.get(pa.activity_id) %}
                            {% set planned_end = (ap.planned_end if ap else pa.end_date) %}
                            {% set cum = (cum_before.get(pa.activity_id, 0) or 0) %}
                            {% set ex = (executed_today.get(pa.activity_id, 0) or 0) %}
                            {% set t = (time_by_activity_id.get(pa.activity_id) if time_by_activity_id is defined else None) %}
                            {% set ap_status = approval_status_by_activity.get(pa.activity_id, "Changed") %}
                            <tr
                                data-activity-id="{{ pa.activity_id }}"
                                data-planned="{{ pa.planned_quantity }}"
                                data-cum-other="{{ cum }}"
                                data-planned-end="{{ planned_end }}"
                                data-planned-hours="{{ (t.planned_hours if t else 0) }}"
                                data-cum-other-hours="{{ (t.cum_before_hours if t else 0) }}"
                                data-display-unit="{{ (t.display_unit if t else 'hours') }}"
                                data-hours-per-day="{{ (t.hours_per_day if t else 8) }}"
                                data-approval-status="{{ ap_status }}"
                            >
                                <td>
                                    <strong>{{ pa.activity.name }}</strong>
                                    <div class="meta">Plan: {{ pa.start_date }} ‚Üí {{ pa.end_date }}</div>
                                    <input type="hidden" name="activity_ids" value="{{ pa.activity_id }}">
                                    <input type="hidden" name="act_status_{{ pa.activity_id }}" value="{{ ap_status }}">
                                </td>
                                <td>{{ "%.3f"|format(pa.planned_quantity) }} {{ pa.unit|unit_sup }}</td>
                                <td>{{ "%.3f"|format(cum) }}</td>
                                <td><input class="activity-executed" name="act_exec_{{ pa.activity_id }}" type="number" min="0" step="0.001" value="{{ ex }}"></td>
                                <td class="cell-cumulative">{{ "%.3f"|format(cum + ex) }}</td>
                                <td class="cell-balance">{{ "%.3f"|format((pa.planned_quantity - (cum + ex)) if (pa.planned_quantity - (cum + ex)) > 0 else 0) }}</td>

                                <!-- Time (base stored as hours) -->
                                <td>
                                    <span class="cell-time-planned">{{ "%.3f"|format((t.planned_display if t else 0) ) }}</span>
                                    <span class="pill" title="Time tracking unit (does not affect stored hours)">
                                        <select class="activity-time-unit" name="act_time_unit_{{ pa.activity_id }}" style="padding:2px 6px">
                                            {% set u = (t.display_unit if t else 'hours') %}
                                            <option value="hours" {% if u=='hours' %}selected{% endif %}>hrs</option>
                                            <option value="days" {% if u=='days' %}selected{% endif %}>days</option>
                                        </select>
                                    </span>
                                    <div class="meta" title="Conversion rule">
                                        1 day = <span class="cell-hpd">{{ (t.hours_per_day if t else 8) }}</span> hrs
                                    </div>
                                </td>
                                <td>
                                    <input
                                        class="activity-executed-time"
                                        name="act_exec_time_{{ pa.activity_id }}"
                                        type="number"
                                        min="0"
                                        step="0.001"
                                        value="{{ (t.executed_today_display if t else 0) }}"
                                        title="Enter executed time in the selected unit. Stored internally as hours."
                                    >
                                    <input class="activity-executed-hours" type="hidden" name="act_exec_hours_{{ pa.activity_id }}" value="{{ (t.executed_today_hours if t else 0) }}">
                                </td>
                                <td class="cell-time-cumulative">{{ "%.3f"|format((t.cum_after_display if t else 0)) }}</td>
                                <td class="cell-time-balance">{{ "%.3f"|format((t.balance_display if t else 0)) }}</td>
                                <td class="cell-status">‚Äî</td>
                                <td>
                                    <span class="pill approval-badge" data-activity-id="{{ pa.activity_id }}">{{ ap_status }}</span>
                                </td>
                                <td><input class="activity-remarks" name="act_rem_{{ pa.activity_id }}" type="text" value="{{ remarks_today.get(pa.activity_id,'') }}" placeholder="Required if 0 / delayed"></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <details open>
                <summary>Materials (Auto-linked)</summary>
                <div class="help-text">Planned consumption is auto-calculated from executed quantities and activity consumption rates.</div>
                <table class="dpr-table" style="margin-top: 10px;">
                    <thead>
                        <tr>
                            <th style="width:26%">Material</th>
                            <th>Available</th>
                            <th>Planned today</th>
                            <th>Unit</th>
                            <th>Issued today</th>
                            <th>Consumed today</th>
                            <th>Source</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if materials and materials|length > 0 %}
                            {% for m in materials %}
                                {% set stock = (material_stock.get(m.id, 0) or 0) %}
                                {% set exr = existing_materials.get(m.id) %}
                                {% set selected_unit = (exr.unit if exr and exr.unit else m.get_standard_unit()) %}
                                <tr data-material-id="{{ m.id }}" data-stock="{{ stock }}">
                                    <td>
                                        <strong>{{ m.name }}</strong>
                                        <div class="meta">Base unit: {{ m.unit|unit_sup }}</div>
                                        <input type="hidden" name="material_ids" value="{{ m.id }}">
                                        <input class="mat-planned-hidden" type="hidden" name="mat_planned_{{ m.id }}" value="{{ exr.planned_today if exr else 0 }}">
                                    </td>
                                    <td>{{ "%.3f"|format(stock) }}</td>
                                    <td class="cell-mat-planned">0.000</td>
                                    <td>
                                        {% set allowed = m.get_allowed_units() %}
                                        <select name="mat_unit_{{ m.id }}">
                                            {% for u in allowed %}
                                                <option value="{{ u }}" {% if selected_unit==u %}selected{% endif %}>{{ u }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td><input class="mat-issued" name="mat_issued_{{ m.id }}" type="number" min="0" step="0.001" value="{{ exr.issued_today if exr else 0 }}"></td>
                                    <td><input class="mat-consumed" name="mat_consumed_{{ m.id }}" type="number" min="0" step="0.001" value="{{ exr.consumed_today if exr else 0 }}"></td>
                                    <td><input name="mat_source_{{ m.id }}" type="text" value="{{ exr.source if exr and exr.source else '' }}" placeholder="Plant / Quarry / Store"></td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="7" style="opacity:0.8; padding:12px;">
                                    No materials are linked to activities yet.
                                    <a href="/activity-material-planning/{{ project.id }}">Link materials</a>
                                    or update
                                    <a href="/stock/current?project_id={{ project.id }}">stock</a>.
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </details>

            <details>
                <summary>Labour</summary>
                <div style="margin-top:10px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                    <div class="help-text">Add labour by category and hours.</div>
                    <button id="addLabourRow" type="button" class="btn-primary">+ Add row</button>
                </div>
                <table id="labourTable" class="dpr-table" style="margin-top: 10px;">
                    <thead><tr><th>Category</th><th>Workers</th><th>Hours</th><th>OT</th><th>Agency</th><th></th></tr></thead>
                    <tbody>
                        {% if report and report.labour_rows %}
                            {% for r in report.labour_rows %}
                            <tr>
                                <td>
                                    <select class="lab-category">
                                        {% for opt in ["Skilled","Unskilled","Operator","Supervisor"] %}
                                            <option {% if r.category==opt %}selected{% endif %}>{{ opt }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td><input type="number" min="0" class="lab-workers" value="{{ r.workers }}"></td>
                                <td><input type="number" min="0" step="0.5" class="lab-hours" value="{{ r.hours }}"></td>
                                <td><input type="number" min="0" step="0.5" class="lab-ot" value="{{ r.overtime_hours }}"></td>
                                <td><input type="text" class="lab-agency" value="{{ r.agency or '' }}"></td>
                                <td><button type="button" class="btn-danger btn-sm remove-row">Remove</button></td>
                            </tr>
                            {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </details>

            <details>
                <summary>Machinery</summary>
                <div style="margin-top:10px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                    <div class="help-text">Track equipment usage and breakdowns.</div>
                    <button id="addMachRow" type="button" class="btn-primary">+ Add row</button>
                </div>
                <table id="machineryTable" class="dpr-table" style="margin-top: 10px;">
                    <thead><tr><th>Equipment</th><th>Hours used</th><th>Idle</th><th>Fuel</th><th>Breakdown</th><th>Remarks</th><th></th></tr></thead>
                    <tbody>
                        {% if report and report.machinery_rows %}
                            {% for r in report.machinery_rows %}
                            <tr>
                                <td><input type="text" class="mach-name" value="{{ r.equipment_name }}"></td>
                                <td><input type="number" min="0" step="0.5" class="mach-hours" value="{{ r.hours_used }}"></td>
                                <td><input type="number" min="0" step="0.5" class="mach-idle" value="{{ r.idle_hours }}"></td>
                                <td><input type="number" min="0" step="0.1" class="mach-fuel" value="{{ r.fuel_consumed }}"></td>
                                <td>
                                    <select class="mach-breakdown">
                                        <option value="No" {% if not r.breakdown %}selected{% endif %}>No</option>
                                        <option value="Yes" {% if r.breakdown %}selected{% endif %}>Yes</option>
                                    </select>
                                </td>
                                <td><input type="text" class="mach-break-remarks" value="{{ r.breakdown_remarks or '' }}"></td>
                                <td><button type="button" class="btn-danger btn-sm remove-row">Remove</button></td>
                            </tr>
                            {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </details>

            <details>
                <summary>Quality Control (QC)</summary>
                <div style="margin-top:10px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                    <div class="help-text">Record tests performed today.</div>
                    <button id="addQcRow" type="button" class="btn-primary">+ Add row</button>
                </div>
                <table id="qcTable" class="dpr-table" style="margin-top: 10px;">
                    <thead><tr><th>Test</th><th>Location</th><th>Value</th><th>Result</th><th>Engineer</th><th></th></tr></thead>
                    <tbody>
                        {% if report and report.qc_rows %}
                            {% for r in report.qc_rows %}
                            <tr>
                                <td>
                                    <select class="qc-type">
                                        {% for opt in ["Compaction","Gradation","Cube","Slump","Bitumen Content","Other"] %}
                                            <option {% if r.test_type==opt %}selected{% endif %}>{{ opt }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td><input type="text" class="qc-location" value="{{ r.location or '' }}"></td>
                                <td><input type="text" class="qc-value" value="{{ r.test_value or '' }}"></td>
                                <td>
                                    <select class="qc-result">
                                        <option value="Pass" {% if r.result=="Pass" %}selected{% endif %}>Pass</option>
                                        <option value="Fail" {% if r.result=="Fail" %}selected{% endif %}>Fail</option>
                                    </select>
                                </td>
                                <td><input type="text" class="qc-engineer" value="{{ r.engineer_name or '' }}"></td>
                                <td><button type="button" class="btn-danger btn-sm remove-row">Remove</button></td>
                            </tr>
                            {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </details>

            <details>
                <summary>Delays / Hindrances</summary>
                <div style="margin-top:10px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                    <div class="help-text">Capture delay type, time window and impact.</div>
                    <button id="addDelayRow" type="button" class="btn-primary">+ Add row</button>
                </div>
                <table id="delayTable" class="dpr-table" style="margin-top: 10px;">
                    <thead><tr><th>Type</th><th>Start</th><th>End</th><th>Responsible</th><th>Impact (hrs)</th><th>Impact (qty)</th><th>Remarks</th><th></th></tr></thead>
                    <tbody>
                        {% if report and report.delay_rows %}
                            {% for r in report.delay_rows %}
                            <tr>
                                <td>
                                    <select class="delay-type">
                                        {% for opt in ["Rain","Utility","Material","Labour","Land"] %}
                                            <option {% if r.delay_type==opt %}selected{% endif %}>{{ opt }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td><input type="time" class="delay-start" value="{{ r.start_time or '' }}"></td>
                                <td><input type="time" class="delay-end" value="{{ r.end_time or '' }}"></td>
                                <td><input type="text" class="delay-party" value="{{ r.responsible_party or '' }}"></td>
                                <td><input type="number" min="0" step="0.25" class="delay-impact-hours" value="{{ r.impact_hours or 0 }}"></td>
                                <td><input type="number" min="0" step="0.01" class="delay-impact-qty" value="{{ r.impact_quantity or 0 }}"></td>
                                <td><input type="text" class="delay-remarks" value="{{ r.remarks or '' }}"></td>
                                <td><button type="button" class="btn-danger btn-sm remove-row">Remove</button></td>
                            </tr>
                            {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </details>

            <details>
                <summary>Safety</summary>
                <div class="dpr-grid" style="margin-top: 10px;">
                    <div class="form-group">
                        <label><input type="checkbox" name="toolbox_talk_conducted" {% if report and report.toolbox_talk_conducted %}checked{% endif %}> Toolbox Talk Conducted</label>
                    </div>
                    <div class="form-group">
                        <label>PPE Compliance (%)</label>
                        <input type="number" min="0" max="100" step="0.1" name="ppe_compliance_percent" value="{{ report.ppe_compliance_percent if report and report.ppe_compliance_percent is not none else '' }}" placeholder="0-100">
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" name="incident_or_near_miss" {% if report and report.incident_or_near_miss %}checked{% endif %}> Any Incident / Near Miss</label>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Incident Description</label>
                        <textarea name="incident_description" rows="2" placeholder="Describe incident/near miss">{{ report.incident_description if report else '' }}</textarea>
                    </div>
                </div>
            </details>

            <details>
                <summary>Uploads</summary>
                <div class="dpr-grid" style="margin-top: 10px;">
                    <div class="form-group">
                        <label>Category</label>
                        <select name="upload_category">
                            {% for opt in ["Before","During","After","Issue","QC","Safety","Docs"] %}
                                <option value="{{ opt }}">{{ opt }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Files</label>
                        <input type="file" name="uploads" multiple>
                        <div class="help-text">Files are saved to <span style="color:#ffffff;opacity:0.85">data/uploads/dpr/</span></div>
                    </div>
                </div>
                {% if report and report.uploads and report.uploads|length > 0 %}
                    <div class="help-text" style="margin-top:10px;">Existing uploads:</div>
                    <ul>
                        {% for u in report.uploads %}
                            <li class="meta">{{ u.category }} ‚Äî {{ u.original_name }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </details>

            <details open>
                <summary>Summary</summary>
                <div class="dpr-grid" style="margin-top: 10px;">
                    <div class="card" style="padding:12px;">
                        <div class="meta">Total executed quantity (all activities)</div>
                        <div style="font-size:18px;"><strong id="summary_total_qty">0.000</strong></div>
                    </div>
                    <div class="card" style="padding:12px;">
                        <div class="meta">Total planned material consumption</div>
                        <div style="font-size:18px;"><strong id="summary_total_mat">0.000</strong></div>
                    </div>
                    <div class="card" style="padding:12px;">
                        <div class="meta">Man-hours (approx.)</div>
                        <div style="font-size:18px;"><strong id="summary_man_hours">0.00</strong></div>
                    </div>
                    <div class="card" style="padding:12px;">
                        <div class="meta">Delay hours</div>
                        <div style="font-size:18px;"><strong id="summary_delay_hours">0.00</strong></div>
                    </div>
                </div>
            </details>

            <div class="form-section">
                <div class="section-title">Engineer Remarks</div>
                <textarea name="engineer_remarks" rows="3" placeholder="Overall summary / notes">{{ report.engineer_remarks if report else '' }}</textarea>
            </div>

            <input type="hidden" id="labour_json" name="labour_json" value="[]">
            <input type="hidden" id="machinery_json" name="machinery_json" value="[]">
            <input type="hidden" id="qc_json" name="qc_json" value="[]">
            <input type="hidden" id="delays_json" name="delays_json" value="[]">

            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top: 14px; flex-wrap: wrap;">
                <button class="btn-secondary" type="submit" name="action" value="save">Save Draft</button>
                <button class="btn-success" type="submit" name="action" value="submit">Submit for Review</button>
            </div>

        </div>

        <!-- Modal for updating activity information -->
        <div id="updateActivityModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-title">Update Activity Status</div>
                <div class="form-group">
                    <label>Activity Name:</label>
                    <div style="padding: 10px; background: rgba(255,255,255,0.04); border-radius: 6px;" id="modalActivityName"></div>
                </div>
                <div class="form-group">
                    <label for="modalDelayReason">Reason for Delay/Change:</label>
                    <input type="text" id="modalDelayReason" placeholder="e.g., Weather, Resource shortage, etc." />
                </div>
                <div class="form-group">
                    <label for="modalCompleteDate">Complete Date:</label>
                    <input type="text" id="modalCompleteDate" placeholder="DD/MM/YYYY" maxlength="10" />
                </div>
                <div class="form-group">
                    <label for="modalUpdateRemarks">Additional Remarks:</label>
                    <textarea id="modalUpdateRemarks" placeholder="Provide details about the delay or any changes needed..."></textarea>
                </div>
                <div class="form-group">
                    <label for="modalNewQuantity">New Planned Quantity (optional):</label>
                    <input type="number" id="modalNewQuantity" placeholder="Leave empty to keep original" step="0.001" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-modal-cancel" id="modalCancelBtn">Cancel</button>
                    <button type="button" class="btn-modal-save" id="modalSaveBtn">Save Update</button>
                </div>
            </div>
        </div>

    </form>
    {% endif %}
    
    <!-- Download Modal -->
    <div class="modal-overlay" id="downloadModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-title">Download DPR</div>
            <p style="opacity: 0.8; font-size: 13px; margin-bottom: 20px;">
                Choose your preferred format to download the Daily Work Execution Report
            </p>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <a href="/execution/{{ project.id }}/download-excel?date={{ report_date.isoformat() }}" class="download-option">
                    <div class="download-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        üìä
                    </div>
                    <div class="download-info">
                        <div class="download-title">Download as Excel</div>
                        <div class="download-desc">Get an editable spreadsheet with all DPR data</div>
                    </div>
                </a>
                <a href="/execution/{{ project.id }}/download-pdf?date={{ report_date.isoformat() }}" class="download-option">
                    <div class="download-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                        üìÑ
                    </div>
                    <div class="download-info">
                        <div class="download-title">Download as PDF</div>
                        <div class="download-desc">Get a formatted PDF document for printing</div>
                    </div>
                </a>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal-cancel" onclick="closeDownloadModal()">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
    <script id="amMapJson" type="application/json">{{ activity_material_map_json | safe }}</script>
    <script id="plannedTodayJson" type="application/json">{{ planned_today_json | safe }}</script>
    <script id="materialsJson" type="application/json">{{ materials_json | safe }}</script>
    <script>
        // Download modal functions
        function openDownloadModal() {
            document.getElementById('downloadModal').classList.add('active');
        }
        
        function closeDownloadModal() {
            document.getElementById('downloadModal').classList.remove('active');
        }
        
        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('downloadModal');
            if (event.target === modal) {
                closeDownloadModal();
            }
        });
        
        function changeProject(projectId) {
            if (projectId && projectId !== '{{ project.id }}') {
                // Get current date from URL if exists, or use today's date
                const urlParams = new URLSearchParams(window.location.search);
                const currentDate = urlParams.get('date') || '';
                
                // Redirect to the new project with the same date
                let newUrl = '/execution/' + projectId;
                if (currentDate) {
                    newUrl += '?date=' + currentDate;
                }
                window.location.href = newUrl;
            }
        }
    </script>
    <script src="/static/js/activity_units.js"></script>
    <script src="/static/js/daily_execution.js"></script>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<!-- Project Selection Dropdown -->
<form method="get" action="" id="project-select-form" style="margin-bottom:24px;">
    <label for="project-select"><strong>Select Project:</strong></label>
    <select id="project-select" name="project_id" onchange="if(this.value) window.location.href='/project/' + this.value + '/materials';">
        <option value="">-- Choose Project --</option>
        {% for proj in projects %}
            <option value="{{ proj.id }}" {% if project and proj.id == project.id %}selected{% endif %}>{{ proj.name }}</option>
        {% endfor %}
    </select>
</form>

<h1 class="page-title">Material & Vendor Management – {{ project.name }}</h1>
<div class="card card--page" style="max-width:1100px;margin:auto;">
    <!-- Project Context -->
    <div style="margin-bottom:18px;">
        <strong>Location:</strong> {{ project.location }} | <strong>Timeline:</strong> {{ project.planned_start_date }} – {{ project.planned_end_date }} | <strong>Status:</strong> {{ project.status }}
    </div>

    <!-- Material Creation Form -->
    <form method="post" action="/project/{{ project.id }}/materials/add" style="margin-bottom:32px;">
        <h3>Add New Material</h3>
        <div class="form-grid" style="display:grid; grid-template-columns: repeat(4, 1fr); gap: 16px; align-items:end;">
            <div style="display:flex; flex-direction:column; gap:4px;">
                <label for="material_name" style="font-weight:600;">Material Name</label>
                <input type="text" id="material_name" name="material_name" placeholder="e.g., GSB, WMM, Bitumen" required>
            </div>
            <div style="display:flex; flex-direction:column; gap:4px;">
                <label for="material-category-select" style="font-weight:600;">Category</label>
                <div style="display:flex; flex-direction:column; gap:4px; min-height:76px;">
                    <select name="material_category" id="material-category-select" required onchange="toggleCustomCategoryInput()" style="width:100%;">
                        <option value="">Select Category</option>
                        <option>Earthwork</option><option>Aggregate</option><option>Bitumen</option><option>Cement</option><option>Steel</option><option value="Custom">Custom</option>
                    </select>
                    <input type="text" name="custom_material_category" id="custom-material-category" placeholder="Type here for custom category (optional, required if Custom selected)" style="width:100%; background:#181c2a; height:36px; margin-top:2px; opacity:1;" />
                </div>
                <script>
                function toggleCustomCategoryInput() {
                    var select = document.getElementById('material-category-select');
                    var customInput = document.getElementById('custom-material-category');
                    if (select.value === 'Custom') {
                        customInput.required = true;
                        customInput.placeholder = 'Enter custom category (required)';
                    } else {
                        customInput.required = false;
                        customInput.placeholder = 'Type here for custom category (optional, required if Custom selected)';
                    }
                }
                document.addEventListener('DOMContentLoaded', function() {
                    toggleCustomCategoryInput();
                });
                </script>
            </div>
            <div style="display:flex; flex-direction:column; gap:4px;">
                <label for="unit-select" style="font-weight:600;">Unit</label>
                <select name="unit" id="unit-select" required>
                    <option value="">Select Unit</option>
                    <option>MT</option><option>m³</option><option>Bags</option><option>Litres</option><option>Nos</option>
                </select>
            </div>
            <div style="display:flex; flex-direction:column; gap:4px;">
                <label for="type-select" style="font-weight:600;">Type</label>
                <select name="material_type" id="type-select" required>
                    <option value="">Select Type</option>
                    <option>Consumable</option><option>Non-consumable</option>
                </select>
            </div>
            <div style="grid-column: 1 / span 2;">
                <label style="display:block;margin-bottom:4px;font-weight:600;">Map to Activities</label>
                <select name="activity_mapping" required style="width:100%;">
                    <option value="">Select Activity</option>
                    {% for activity in activities %}
                    <option value="{{ activity.id }}">{{ activity.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="grid-column: 3 / span 2;">
                <label style="display:block;margin-bottom:4px;font-weight:600;">Map to Stretches</label>
                <select name="stretch_mapping" required style="width:100%;">
                    <option value="">Select Stretch</option>
                    {% for stretch in stretches %}
                    <option value="{{ stretch.id }}">{{ stretch.stretch_name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <h4 style="margin-top:18px;">Opening Stock (Optional)</h4>
        <div class="form-grid">
            <div><input type="number" name="opening_stock" placeholder="Opening Stock Quantity"></div>
            <div>
                <select name="stock_location">
                    <option value="">Stock Location</option>
                    <option>Site</option><option>Yard</option><option>Plant</option>
                </select>
            </div>
            <div><input type="text" name="stock_date" id="stock_date" placeholder="DD/MM/YYYY" maxlength="10" oninput="formatDateInput(this)"></div>
        </div>
        <button type="submit" class="btn-primary" style="margin-top:18px">Add Material</button>
        <script>
        function toggleCustomCategoryInput() {
            var select = document.getElementById('material-category-select');
            var customInput = document.getElementById('custom-material-category');
            if (select.value === 'Custom') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }
        // In case of browser autofill or back navigation
        document.addEventListener('DOMContentLoaded', function() {
            toggleCustomCategoryInput();
        });
        </script>
    </form>

    <!-- Vendor Creation Form -->
    <form method="post" action="/vendors/add" style="margin-bottom:32px;">
        <h3>Add New Vendor</h3>
        <div class="form-grid">
            <div>
                <label for="vendor_name" style="display:block;margin-bottom:4px;font-weight:600;">Vendor Name</label>
                <input type="text" id="vendor_name" name="vendor_name" placeholder="Vendor Name" required>
            </div>
            <div>
                <label for="vendor_contact" style="display:block;margin-bottom:4px;font-weight:600;">Vendor Contact</label>
                <input type="text" id="vendor_contact" name="vendor_contact" placeholder="Vendor Contact" required>
            </div>
            <div>
                <label for="vendor_email" style="display:block;margin-bottom:4px;font-weight:600;">Vendor Email</label>
                <input type="email" id="vendor_email" name="vendor_email" placeholder="Vendor Email" required>
            </div>
            <div>
                <label for="materials_supplied" style="display:block;margin-bottom:4px;font-weight:600;">Materials Supplied</label>
                <select id="materials_supplied" name="materials_supplied" required>
                    {% for material in materials %}
                    <option value="{{ material.id }}">{{ material.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="lead_time" style="display:block;margin-bottom:4px;font-weight:600;">Lead Time (days)</label>
                <input type="number" id="lead_time" name="lead_time" placeholder="Lead Time (days)">
            </div>
            <div>
                <label for="supply_capacity" style="display:block;margin-bottom:4px;font-weight:600;">Supply Capacity</label>
                <input type="text" id="supply_capacity" name="supply_capacity" placeholder="Supply Capacity (e.g., 100 MT/day)">
            </div>
            <div>
                <label for="vendor_location" style="display:block;margin-bottom:4px;font-weight:600;">Vendor Location</label>
                <input type="text" id="vendor_location" name="vendor_location" placeholder="Vendor Location">
            </div>
            <div>
                <label style="display:block;margin-bottom:4px;font-weight:600;">Contract Validity</label>
                <input type="text" name="contract_start" id="contract_start" placeholder="DD/MM/YYYY" maxlength="10" oninput="formatDateInput(this)"> to <input type="text" name="contract_end" id="contract_end" placeholder="DD/MM/YYYY" maxlength="10" oninput="formatDateInput(this)">
                    <script>
                    function formatDateInput(input) {
                        let value = input.value.replace(/[^0-9]/g, '');
                        if (value.length > 2 && value.length <= 4) {
                            value = value.slice(0,2) + '/' + value.slice(2);
                        } else if (value.length > 4) {
                            value = value.slice(0,2) + '/' + value.slice(2,4) + '/' + value.slice(4,8);
                        }
                        input.value = value.slice(0, 10);
                    }
                    </script>
            </div>
            <div>
                <label for="vendor_priority" style="display:block;margin-bottom:4px;font-weight:600;">Priority</label>
                <select id="vendor_priority" name="vendor_priority">
                    <option selected>Primary</option>
                    <option>Secondary</option>
                    <option>Backup</option>
                </select>
            </div>
        </div>
        <h4 style="margin-top:18px;">Rate per Unit (Material-wise)</h4>
        <div style="display: flex; gap: 16px; margin-bottom: 12px;">
            <div style="flex:1; display:flex; flex-direction:column;">
                <label for="vendor_rate" style="font-weight:600;">Unit Price</label>
                <input type="number" name="vendor_rate" id="vendor_rate" placeholder="Enter unit price for selected material" required>
            </div>
            <div style="flex:1; display:flex; flex-direction:column;">
                <label for="vendor_quantity" style="font-weight:600;">Per Unit Quantity</label>
                <input type="number" name="vendor_quantity" id="vendor_quantity" placeholder="Enter per unit quantity for selected material" required>
            </div>
        </div>
        <button type="submit" class="btn-primary" style="margin-top:18px">Add Vendor</button>
    </form>

    <!-- Material–Vendor Linking Table -->
    <h3>
        Material–Vendor Linking
        <span title="Link vendors to each material. Click Edit to manage vendors for a material." style="cursor:help;font-size:16px;color:#4f8cff;vertical-align:middle;">&#9432;</span>
    </h3>
    <table class="table" style="width:100%;margin-bottom:24px;">
        <thead>
            <tr>
                <th>Material <span title="Material name" style="cursor:help;">&#9432;</span></th>
                <th>Linked Vendors <span title="All vendors linked to this material" style="cursor:help;">&#9432;</span></th>
                <th>Contact <span title="Vendor contact numbers" style="cursor:help;">&#9432;</span></th>
                <th>Email <span title="Vendor email addresses" style="cursor:help;">&#9432;</span></th>
                <th>Preferred Vendor <span title="Preferred vendor for this material" style="cursor:help;">&#9432;</span></th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for material in materials %}
            <tr>
                <td>{{ material.name }}</td>
                <td>
                    {% if material.vendors %}
                        {% for vendor in material.vendors %}
                            <span class="badge badge-info" title="Vendor: {{ vendor.vendor_name }}&#10;Priority: {{ vendor.priority }}&#10;Lead Time: {{ vendor.lead_time }}d&#10;Unit Price: {{ vendor.unit_price }}">{{ vendor.vendor_name }}</span>{% if not loop.last %} {% endif %}
                        {% endfor %}
                    {% else %}
                        <span class="badge badge-danger" title="No vendors linked">No vendors linked</span>
                        <button class="btn-add-vendor" onclick="openVendorModal('{{ material.id }}', '{{ material.name }}')">+ Add Vendor</button>
                    {% endif %}
                </td>
                <td>
                    {% for vendor in material.vendors %}
                        <span class="badge badge-secondary" title="Contact: {{ vendor.vendor_contact or '-' }}">{{ vendor.vendor_contact or '-' }}</span>{% if not loop.last %} {% endif %}
                    {% endfor %}
                </td>
                <td>
                    {% for vendor in material.vendors %}
                        <span class="badge badge-secondary" title="Email: {{ vendor.vendor_email or '-' }}">{{ vendor.vendor_email or '-' }}</span>{% if not loop.last %} {% endif %}
                    {% endfor %}
                </td>
                <td><!-- Preferred vendor logic here --></td>
                <td><button title="Edit vendors for {{ material.name }}" class="btn-info btn-sm" onclick="openVendorModal('{{ material.id }}', '{{ material.name }}')">✏️ Edit</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Stretch & Activity Linking Table -->
    <h3>
        Material–Stretch & Activity Linking
        <span title="Link stretches and activities to each material. Click Edit to manage links." style="cursor:help;font-size:16px;color:#4f8cff;vertical-align:middle;">&#9432;</span>
    </h3>
    <table class="table" style="width:100%;margin-bottom:24px;">
        <thead>
            <tr>
                <th>Material <span title="Material name" style="cursor:help;">&#9432;</span></th>
                <th>Stretches <span title="Stretches linked to this material" style="cursor:help;">&#9432;</span></th>
                <th>Activities <span title="Activities linked to this material" style="cursor:help;">&#9432;</span></th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for material in materials %}
            <tr>
                <td>{{ material.name }}</td>
                <td>
                    {% if material.stretches %}
                        {% for stretch in material.stretches %}
                            <span class="badge badge-stretch" title="Stretch: {{ stretch.stretch_name }}">{{ stretch.stretch_name }}</span>{% if not loop.last %} {% endif %}
                        {% endfor %}
                    {% else %}
                        <span class="badge badge-danger" title="No stretches linked">No stretches linked</span>
                    {% endif %}
                </td>
                <td>
                    {% if material.activities %}
                        {% for activity in material.activities %}
                            <span class="badge badge-activity" title="Activity: {{ activity.name }}">{{ activity.name }}</span>{% if not loop.last %} {% endif %}
                        {% endfor %}
                    {% else %}
                        <span class="badge badge-danger" title="No activities linked">No activities linked</span>
                    {% endif %}
                </td>
                <td><button title="Edit stretches and activities for {{ material.name }}" class="btn-info btn-sm" onclick="openStretchActivityModal('{{ material.id }}', '{{ material.name }}')">✏️ Edit</button></td>
            </tr>
            {% endfor %}
        </tbody>
        </table>

        <!-- Vendor Modal -->
        <div id="vendorModal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="close" onclick="closeVendorModal()">&times;</span>
                <h4>Edit Vendors for <span id="vendorModalMaterialName"></span></h4>
                <form id="vendorForm">
                    <label>Select Vendors:</label>
                    <select id="vendorSelect" name="vendors" multiple style="width:100%;margin-bottom:10px;">
                        {% for v in all_vendors %}
                            <option value="{{ v.id }}">{{ v.vendor_name }} ({{ v.priority }}, {{ v.lead_time }}d, {{ v.unit_price }})</option>
                        {% endfor %}
                    </select>
                    <div class="modal-warning" id="vendorModalWarning" style="display:none;color:#d44545;margin:8px 0 0 0;"></div>
                    <div style="margin-top:14px;display:flex;gap:10px;justify-content:flex-end;">
                        <button type="button" onclick="closeVendorModal()">Cancel</button>
                        <button type="submit">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Stretch & Activity Modal -->
        <div id="stretchActivityModal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="close" onclick="closeStretchActivityModal()">&times;</span>
                <h4>Edit Stretches & Activities for <span id="stretchActivityModalMaterialName"></span></h4>
                <form id="stretchActivityForm">
                    <label>Select Stretches:</label>
                    <select id="stretchSelect" name="stretches" multiple style="width:100%;margin-bottom:10px;">
                        {% for s in all_stretches %}
                            <option value="{{ s.id }}">{{ s.stretch_name }}</option>
                        {% endfor %}
                    </select>
                    <label>Select Activities:</label>
                    <select id="activitySelect" name="activities" multiple style="width:100%;margin-bottom:10px;">
                        {% for a in all_activities %}
                            <option value="{{ a.id }}">{{ a.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="modal-warning" id="stretchActivityModalWarning" style="display:none;color:#d44545;margin:8px 0 0 0;"></div>
                    <div style="margin-top:14px;display:flex;gap:10px;justify-content:flex-end;">
                        <button type="button" onclick="closeStretchActivityModal()">Cancel</button>
                        <button type="submit">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <style>
        .badge-vendor { background: #3b82f6; color: #fff; border-radius: 8px; padding: 2px 10px; margin: 0 2px 2px 0; display: inline-block; }
        .badge-stretch { background: #22c55e; color: #fff; border-radius: 8px; padding: 2px 10px; margin: 0 2px 2px 0; display: inline-block; }
        .badge-activity { background: #a855f7; color: #fff; border-radius: 8px; padding: 2px 10px; margin: 0 2px 2px 0; display: inline-block; }
        .badge-empty { background: #64748b; color: #fff; border-radius: 8px; padding: 2px 10px; margin: 0 2px 2px 0; display: inline-block; }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100vw; height: 100vh; overflow: auto; background: rgba(0,0,0,0.45); display: flex; align-items: center; justify-content: center; }
        .modal-content { background: #181c2a; padding: 28px 32px 24px 32px; border-radius: 14px; min-width: 340px; max-width: 98vw; box-shadow: 0 8px 32px 0 rgba(0,0,0,0.18); position: relative; }
        .close { position: absolute; right: 18px; top: 12px; font-size: 22px; color: #b8c1ec; cursor: pointer; }
        .btn-info.btn-sm, .btn-add-vendor { background: #3b82f6; color: #fff; border: none; border-radius: 7px; padding: 6px 14px; font-size: 13px; cursor: pointer; }
        .btn-info.btn-sm:hover, .btn-add-vendor:hover { filter: brightness(1.08); }
        </style>

        <script>
        let currentMaterialId = null;
        function openVendorModal(materialId, materialName) {
            document.getElementById('vendorModal').style.display = 'flex';
            document.getElementById('vendorModalMaterialName').textContent = materialName;
            currentMaterialId = materialId;
            // TODO: Pre-select current vendors for this material (requires JS data or AJAX)
        }
        function closeVendorModal() {
            document.getElementById('vendorModal').style.display = 'none';
            currentMaterialId = null;
        }
        function openStretchActivityModal(materialId, materialName) {
            document.getElementById('stretchActivityModal').style.display = 'flex';
            document.getElementById('stretchActivityModalMaterialName').textContent = materialName;
            currentMaterialId = materialId;
            // Fetch and pre-select stretches/activities
            fetch(`/material/${materialId}/stretches`).then(r => r.json()).then(data => {
                let stretchSelect = document.getElementById('stretchSelect');
                Array.from(stretchSelect.options).forEach(opt => {
                    opt.selected = data.stretch_ids.includes(parseInt(opt.value));
                });
            });
            fetch(`/material/${materialId}/activities`).then(r => r.json()).then(data => {
                let activitySelect = document.getElementById('activitySelect');
                Array.from(activitySelect.options).forEach(opt => {
                    opt.selected = data.activity_ids.includes(parseInt(opt.value));
                });
            });
        }
        function closeStretchActivityModal() {
            document.getElementById('stretchActivityModal').style.display = 'none';
            currentMaterialId = null;
        }

        // Modal form submit handlers (AJAX, validation)
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('vendorForm').onsubmit = function(e) {
                e.preventDefault();
                var selected = Array.from(document.getElementById('vendorSelect').selectedOptions).map(o => o.value);
                if (selected.length === 0) {
                    document.getElementById('vendorModalWarning').textContent = 'Select at least one vendor.';
                    document.getElementById('vendorModalWarning').style.display = 'block';
                    return false;
                }
                document.getElementById('vendorModalWarning').style.display = 'none';
                // TODO: AJAX POST to backend, then update table in-place
                closeVendorModal();
                return false;
            };
            document.getElementById('stretchActivityForm').onsubmit = function(e) {
                e.preventDefault();
                var stretches = Array.from(document.getElementById('stretchSelect').selectedOptions).map(o => parseInt(o.value));
                var activities = Array.from(document.getElementById('activitySelect').selectedOptions).map(o => parseInt(o.value));
                if (stretches.length === 0 && activities.length === 0) {
                    document.getElementById('stretchActivityModalWarning').textContent = 'Select at least one stretch or activity.';
                    document.getElementById('stretchActivityModalWarning').style.display = 'block';
                    return false;
                }
                document.getElementById('stretchActivityModalWarning').style.display = 'none';
                // Save stretches
                fetch(`/material/${currentMaterialId}/stretches`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stretch_ids: stretches })
                }).then(r => r.json()).then(data => {
                    // Optionally update UI
                });
                // Save activities
                fetch(`/material/${currentMaterialId}/activities`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ activity_ids: activities })
                }).then(r => r.json()).then(data => {
                    // Optionally update UI
                });
                closeStretchActivityModal();
                return false;
            };
        });
        </script>
        </tbody>
    </table>

    <!-- Inventory Intelligence Table -->
    <h3>Inventory Status</h3>
    <table class="table" style="width:100%;margin-bottom:24px;">
        <thead><tr><th>Material</th><th>Opening</th><th>Incoming</th><th>Issued</th><th>Closing</th><th>Status</th></tr></thead>
        <tbody>
            {% for material in materials %}
            <tr>
                <td>{{ material.name }}</td>
                <td>{{ material.opening_stock }}</td>
                <td>{{ material.incoming_stock }}</td>
                <td>{{ material.issued_stock }}</td>
                <td>{{ material.closing_stock }}</td>
                <td><!-- Status indicator: Safe/Alert/Critical --></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Procurement Intelligence Table -->
    <h3>Procurement Planning</h3>
    <table class="table" style="width:100%;margin-bottom:24px;">
        <thead><tr><th>Material</th><th>Min Stock</th><th>Buffer</th><th>Lead Time</th><th>Next Procurement</th><th>Suggested Vendor</th><th>Actions</th></tr></thead>
        <tbody>
            {% for material in materials %}
            <tr>
                <td>{{ material.name }}</td>
                <td>{{ material.minimum_stock }}</td>
                <td>{{ material.buffer_stock }}</td>
                <td>{{ material.lead_time_days }}</td>
                <td>{{ material.next_procurement_date }}</td>
                <td>{{ material.suggested_vendor }}</td>
                <td><button>Edit</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Alerts Table -->
    <h3>Alerts & Intelligence</h3>
    <table class="table" style="width:100%;margin-bottom:24px;">
        <thead><tr><th>Type</th><th>Material</th><th>Message</th><th>Date</th><th>Action</th></tr></thead>
        <tbody>
            {% for alert in alerts %}
            <tr>
                <td>{{ alert.type }}</td>
                <td>{{ alert.material }}</td>
                <td>{{ alert.message }}</td>
                <td>{{ alert.date }}</td>
                <td><button>{{ alert.action }}</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Export Buttons -->
    <div style="margin-top:24px;">
        <button class="btn-secondary">Export to Excel</button>
        <button class="btn-secondary">Export to PDF</button>
    </div>
</div>
{% endblock %}

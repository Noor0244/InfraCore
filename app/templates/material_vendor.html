{% extends "base.html" %}
{% block content %}
<style>
    /* Enhanced Form Styling with Hover & Glow Effects */
    .material-vendor-page {
        animation: fadeIn 0.4s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Project Select Dropdown Enhancement */
    #project-select {
        background: linear-gradient(135deg, #1a1f2e 0%, #242b3d 100%);
        border: 2px solid rgba(79, 140, 255, 0.3);
        border-radius: 8px;
        padding: 10px 16px;
        color: #fff;
        font-weight: 500;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    #project-select:hover {
        border-color: rgba(79, 140, 255, 0.6);
        box-shadow: 0 4px 16px rgba(79, 140, 255, 0.3), 0 0 20px rgba(79, 140, 255, 0.2);
        transform: translateY(-2px);
    }
    
    #project-select:focus {
        outline: none;
        border-color: #4f8cff;
        box-shadow: 0 0 0 4px rgba(79, 140, 255, 0.2), 0 0 30px rgba(79, 140, 255, 0.4);
    }
    
    /* Form Input Enhancements */
    input[type="text"],
    input[type="email"],
    input[type="number"],
    select,
    textarea {
        background: linear-gradient(135deg, #1a1f2e 0%, #242b3d 100%);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 10px 14px;
        color: #fff;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    input[type="text"]:hover,
    input[type="email"]:hover,
    input[type="number"]:hover,
    select:hover,
    textarea:hover {
        border-color: rgba(79, 140, 255, 0.4);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2), 0 0 12px rgba(79, 140, 255, 0.15);
    }
    
    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
        outline: none;
        border-color: #4f8cff;
        box-shadow: 0 0 0 3px rgba(79, 140, 255, 0.2), 0 0 20px rgba(79, 140, 255, 0.3);
        transform: scale(1.01);
    }
    
    /* Label Enhancements */
    label {
        color: #a8b3cf;
        font-weight: 600;
        font-size: 13px;
        letter-spacing: 0.3px;
        transition: color 0.2s ease;
    }
    
    label:hover {
        color: #4f8cff;
    }
    
    /* Button Enhancements with Glow */
    .btn-primary {
        background: linear-gradient(135deg, #4f8cff 0%, #3a6fd8 100%);
        border: none;
        border-radius: 10px;
        padding: 12px 32px;
        color: #fff;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 15px rgba(79, 140, 255, 0.4), 0 0 30px rgba(79, 140, 255, 0.2);
        position: relative;
        overflow: hidden;
    }
    
    .btn-primary::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }
    
    .btn-primary:hover::before {
        width: 300px;
        height: 300px;
    }
    
    .btn-primary:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 25px rgba(79, 140, 255, 0.6), 0 0 50px rgba(79, 140, 255, 0.4);
    }
    
    .btn-primary:active {
        transform: translateY(-1px) scale(1.02);
    }
    
    /* Secondary Button Styles */
    .btn-info {
        background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        color: #fff;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(56, 189, 248, 0.3);
    }
    
    .btn-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(56, 189, 248, 0.5), 0 0 20px rgba(56, 189, 248, 0.3);
    }
    
    .btn-add-vendor {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
        border-radius: 8px;
        padding: 6px 12px;
        color: #fff;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 13px;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }
    
    .btn-add-vendor:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.5), 0 0 20px rgba(16, 185, 129, 0.3);
    }
    
    /* Card Enhancements */
    .card--page {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%) !important;
        border: 1px solid rgba(79, 140, 255, 0.1) !important;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 80px rgba(79, 140, 255, 0.05) !important;
        transition: all 0.3s ease;
    }
    
    .card--page:hover {
        border-color: rgba(79, 140, 255, 0.2) !important;
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5), 0 0 100px rgba(79, 140, 255, 0.1) !important;
    }
    
    /* Override global card class for material-vendor page */
    .card.card--page {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%) !important;
    }
    
    /* Form Section Dividers */
    h3 {
        color: #4f8cff;
        font-weight: 700;
        font-size: 20px;
        margin-bottom: 16px;
        position: relative;
        padding-bottom: 8px;
        text-shadow: 0 0 20px rgba(79, 140, 255, 0.3);
    }
    
    h3::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 60px;
        height: 3px;
        background: linear-gradient(90deg, #4f8cff 0%, transparent 100%);
        border-radius: 2px;
        box-shadow: 0 0 10px rgba(79, 140, 255, 0.5);
    }
    
    /* Table Enhancements */
    .table {
        background: rgba(30, 41, 59, 0.5);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }
    
    .table thead th {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        color: #4f8cff;
        font-weight: 600;
        padding: 14px 16px;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 0.5px;
        border-bottom: 2px solid rgba(79, 140, 255, 0.3);
    }
    
    .table tbody tr {
        transition: all 0.3s ease;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .table tbody tr:hover {
        background: rgba(79, 140, 255, 0.1);
        transform: scale(1.01);
        box-shadow: 0 4px 12px rgba(79, 140, 255, 0.2);
    }
    
    .table tbody td {
        padding: 14px 16px;
        color: #cbd5e1;
    }
    
    /* Badge Enhancements */
    .badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        display: inline-block;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    
    .badge:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .badge-info {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: #fff;
    }
    
    .badge-info:hover {
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5), 0 0 20px rgba(59, 130, 246, 0.3);
    }
    
    .badge-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: #fff;
    }
    
    .badge-danger:hover {
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5), 0 0 20px rgba(239, 68, 68, 0.3);
    }
    
    .badge-secondary {
        background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        color: #fff;
    }
    
    .badge-secondary:hover {
        box-shadow: 0 4px 12px rgba(100, 116, 139, 0.5);
    }
    
    /* Help Icon Enhancements */
    span[title] {
        cursor: help;
        transition: all 0.3s ease;
        display: inline-block;
    }
    
    span[title]:hover {
        color: #4f8cff;
        transform: scale(1.2);
        filter: drop-shadow(0 0 8px rgba(79, 140, 255, 0.8));
    }
    
    /* Form Grid Animation */
    .form-grid > div {
        animation: slideIn 0.5s ease forwards;
        opacity: 0;
    }
    
    .form-grid > div:nth-child(1) { animation-delay: 0.1s; }
    .form-grid > div:nth-child(2) { animation-delay: 0.2s; }
    .form-grid > div:nth-child(3) { animation-delay: 0.3s; }
    .form-grid > div:nth-child(4) { animation-delay: 0.4s; }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    /* Page Title Enhancement */
    .page-title {
        background: linear-gradient(135deg, #4f8cff 0%, #3a6fd8 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: 28px;
        font-weight: 800;
        margin-bottom: 24px;
        text-shadow: 0 0 40px rgba(79, 140, 255, 0.3);
        animation: titlePulse 3s ease-in-out infinite;
    }
    
    @keyframes titlePulse {
        0%, 100% { filter: brightness(1); }
        50% { filter: brightness(1.2); }
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
    
    /* Smooth Scroll */
    html {
        scroll-behavior: smooth;
    }
</style>

<div class="material-vendor-page">
<!-- Project Selection Dropdown -->
<form method="get" action="" id="project-select-form" style="margin-bottom:24px;">
    <label for="project-select"><strong>Select Project:</strong></label>
    <select id="project-select" name="project_id" onchange="if(this.value) window.location.href='/project/' + this.value + '/materials';">
        <option value="">-- Choose Project --</option>
        {% for proj in projects %}
            <option value="{{ proj.id }}" {% if project and proj.id == project.id %}selected{% endif %}>{{ proj.name }}</option>
        {% endfor %}
    </select>
</form>

<h1 class="page-title">Material & Vendor Management ‚Äì {{ project.name }}</h1>
<div class="card card--page" style="max-width:1100px;margin:auto;">
    <!-- Project Context -->
    <div style="margin-bottom:18px;">
        <strong>Location:</strong> {{ project.location }} | <strong>Timeline:</strong> {{ project.planned_start_date }} ‚Äì {{ project.planned_end_date }} | <strong>Status:</strong> {{ project.status }}
    </div>

    <!-- Action Buttons -->
    <div style="margin-bottom: 32px; display: flex; gap: 16px;">
        <button onclick="openAddMaterialModal()" class="btn-primary" style="padding: 12px 24px; font-size: 16px;">
            ‚ûï Add Material
        </button>
        <button onclick="openAddVendorModal()" class="btn-primary" style="padding: 12px 24px; font-size: 16px;">
            ‚ûï Add Vendor
        </button>
    </div>

    <!-- All Vendors Section - Card Based UI -->
    <div style="margin-top:48px;">
        <h3>
            All Vendors
            <span title="View and manage all vendors in the system with an easy-to-use card interface" style="cursor:help;font-size:16px;color:#4f8cff;vertical-align:middle;">&#9432;</span>
        </h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; margin-bottom: 48px;">
            {% for material in materials %}
                {% for vendor in material.vendors %}
                <div data-vendor-id="{{ vendor.id }}" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 1px solid rgba(79, 140, 255, 0.2); border-radius: 16px; padding: 20px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3); transition: all 0.3s ease;" onmouseenter="this.style.boxShadow='0 8px 32px rgba(79, 140, 255, 0.3)'; this.style.borderColor='rgba(79, 140, 255, 0.4)'" onmouseleave="this.style.boxShadow='0 4px 16px rgba(0, 0, 0, 0.3)'; this.style.borderColor='rgba(79, 140, 255, 0.2)'">
                    
                    <!-- Header with Vendor Name and Status -->
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px; border-bottom: 2px solid rgba(79, 140, 255, 0.3); padding-bottom: 12px;">
                        <div>
                            <h4 style="margin: 0 0 4px 0; color: #4f8cff; font-size: 16px; font-weight: 700;">
                                üè¢ {{ vendor.vendor_name }}
                            </h4>
                        </div>
                        <span style="background: {% if vendor.is_active %}linear-gradient(135deg, #10b981 0%, #059669 100%){% else %}linear-gradient(135deg, #ef4444 0%, #dc2626 100%){% endif %}; color: #fff; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 600; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);">
                            {% if vendor.is_active %}‚úì Active{% else %}‚úï Inactive{% endif %}
                        </span>
                    </div>
                    
                    <!-- Material Badge -->
                    <div style="margin-bottom: 16px;">
                        <span style="font-size: 12px; color: #94a3b8; font-weight: 600;">üì¶ Material</span>
                        <div style="margin-top: 6px;">
                            <span style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);">
                                {{ material.name }}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Contact Information Grid -->
                    <div style="display: grid; gap: 12px; margin-bottom: 16px;">
                        <!-- Contact Person -->
                        <div>
                            <span style="font-size: 12px; color: #94a3b8; font-weight: 600;">üë§ Contact Person</span>
                            <p style="margin: 6px 0 0 0; color: #cbd5e1; font-size: 13px;">
                                {{ vendor.contact_person or vendor.phone or '‚Äî' }}
                            </p>
                        </div>
                        
                        <!-- Email -->
                        <div>
                            <span style="font-size: 12px; color: #94a3b8; font-weight: 600;">üìß Email</span>
                            <p style="margin: 6px 0 0 0; color: #cbd5e1; font-size: 13px; word-break: break-all;">
                                {{ vendor.email or '‚Äî' }}
                            </p>
                        </div>
                    </div>
                    
                    <!-- Specifications -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; padding: 12px; background: rgba(79, 140, 255, 0.05); border-radius: 8px;">
                        <div>
                            <span style="font-size: 11px; color: #94a3b8; font-weight: 600; text-transform: uppercase;">‚è±Ô∏è Lead Time</span>
                            <p style="margin: 6px 0 0 0; color: #4f8cff; font-size: 16px; font-weight: 700;">
                                {{ vendor.lead_time_days if vendor.lead_time_days is not none else '0' }} <span style="font-size: 11px; color: #94a3b8;">days</span>
                            </p>
                        </div>
                        <div>
                            <span style="font-size: 11px; color: #94a3b8; font-weight: 600; text-transform: uppercase;">üì¶ Min Order</span>
                            <p style="margin: 6px 0 0 0; color: #4f8cff; font-size: 16px; font-weight: 700;">
                                {{ vendor.min_order_qty if vendor.min_order_qty is not none else '‚Äî' }}
                            </p>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px; border-top: 1px solid rgba(79, 140, 255, 0.2); padding-top: 12px;">
                        <button class="btn-info btn-sm" onclick="editVendor({{ vendor.id }}, '{{ vendor.vendor_name }}', '{{ vendor.contact_person or '' }}', '{{ vendor.email or '' }}', {{ material.id }}, {{ vendor.lead_time_days or 0 }}, {{ vendor.min_order_qty or 0 }}, {{ 'true' if vendor.is_active else 'false' }})" title="Edit vendor details" style="flex: 1; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; border-radius: 8px; padding: 10px 12px; color: #fff; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.3s ease;"
                            onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'"
                            onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="btn-toggle-status" onclick="toggleVendorStatus({{ vendor.id }}, {{ 'true' if vendor.is_active else 'false' }})" title="Toggle active status" style="flex: 1; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none; border-radius: 8px; padding: 10px 12px; color: #fff; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.3s ease;"
                            onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.4)'"
                            onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            {{ 'üîí Deactivate' if vendor.is_active else '‚úÖ Activate' }}
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% endfor %}
        </div>
    </div>

    <!-- Edit Vendor Modal -->
    <div id="editVendorModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeEditVendorModal()">&times;</span>
            <h3 style="margin-top: 0;">Edit Vendor Details</h3>
            <form id="editVendorForm" method="post" onsubmit="return submitEditVendor(event)">
                <input type="hidden" id="edit_vendor_id" name="vendor_id">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label for="edit_vendor_name" style="display:block;margin-bottom:4px;font-weight:600;">Vendor Name</label>
                        <input type="text" id="edit_vendor_name" name="vendor_name" required>
                    </div>
                    <div>
                        <label for="edit_vendor_contact" style="display:block;margin-bottom:4px;font-weight:600;">Contact Person</label>
                        <input type="text" id="edit_vendor_contact" name="contact_person">
                    </div>
                    <div>
                        <label for="edit_vendor_email" style="display:block;margin-bottom:4px;font-weight:600;">Email</label>
                        <input type="email" id="edit_vendor_email" name="email">
                    </div>
                    <div>
                        <label for="edit_materials_supplied" style="display:block;margin-bottom:4px;font-weight:600;">Material</label>
                        <select id="edit_materials_supplied" name="material_id" required>
                            {% for material in materials %}
                            <option value="{{ material.id }}">{{ material.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="edit_lead_time" style="display:block;margin-bottom:4px;font-weight:600;">Lead Time (days)</label>
                        <input type="number" id="edit_lead_time" name="lead_time_days" min="0">
                    </div>
                    <div>
                        <label for="edit_min_order_qty" style="display:block;margin-bottom:4px;font-weight:600;">Min Order Qty</label>
                        <input type="number" id="edit_min_order_qty" name="min_order_qty" step="0.01" min="0">
                    </div>
                </div>
                <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                    <button type="button" onclick="closeEditVendorModal()" style="background: #64748b; border: none; border-radius: 8px; padding: 10px 20px; color: #fff; font-weight: 500; cursor: pointer;">Cancel</button>
                    <button type="submit" class="btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        .btn-toggle-status:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.5), 0 0 20px rgba(245, 158, 11, 0.3);
        }
    </style>

    <script>
        // Show success/error messages from URL params
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const success = urlParams.get('success');
            const error = urlParams.get('error');
            
            if (success) {
                showNotification(success, 'success');
                // Scroll to vendors section
                setTimeout(() => {
                    const vendorsSection = document.querySelector('#vendorsTableBody');
                    if (vendorsSection) {
                        vendorsSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
            if (error) {
                showNotification(error, 'error');
            }
        });
        
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'success' ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'};
                color: white;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3), 0 0 40px ${type === 'success' ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'};
                z-index: 10000;
                font-weight: 600;
                animation: slideInRight 0.3s ease;
            `;
            notification.textContent = message.replace(/\+/g, ' ');
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        function editVendor(id, name, contact, email, materialId, leadTime, minOrderQty, isActive) {
            document.getElementById('edit_vendor_id').value = id;
            document.getElementById('edit_vendor_name').value = name;
            document.getElementById('edit_vendor_contact').value = contact || '';
            document.getElementById('edit_vendor_email').value = email || '';
            document.getElementById('edit_materials_supplied').value = materialId;
            document.getElementById('edit_lead_time').value = leadTime || 0;
            document.getElementById('edit_min_order_qty').value = minOrderQty || 0;
            document.getElementById('editVendorModal').style.display = 'flex';
        }

        function closeEditVendorModal() {
            document.getElementById('editVendorModal').style.display = 'none';
        }

        function submitEditVendor(event) {
            event.preventDefault();
            const form = document.getElementById('editVendorForm');
            const formData = new FormData(form);
            const vendorId = document.getElementById('edit_vendor_id').value;
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            console.log('Submitting edit for vendor:', vendorId);
            console.log('Form data:', Object.fromEntries(formData));
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';
            
            fetch(`/vendors/${vendorId}/update`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    closeEditVendorModal();
                    showNotification('Vendor updated successfully', 'success');
                    // Reload after a short delay
                    setTimeout(() => window.location.reload(), 500);
                } else {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    showNotification(data.error || 'Failed to update vendor', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                showNotification('An error occurred: ' + error.message, 'error');
            });
            
            return false;
        }

        function toggleVendorStatus(vendorId, currentStatus) {
            const action = currentStatus ? 'deactivate' : 'activate';
            const button = event.target;
            const originalText = button.textContent;
            
            if (confirm(`Are you sure you want to ${action} this vendor?`)) {
                button.disabled = true;
                button.textContent = 'Updating...';
                
                fetch(`/vendors/${vendorId}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`Vendor ${action}d successfully`, 'success');
                        
                        // Update card UI - find the vendor card and update status badge
                        const vendorCard = document.querySelector(`[data-vendor-id="${vendorId}"]`);
                        if (vendorCard) {
                            // Update status badge in the header
                            const statusBadge = vendorCard.querySelector('span[style*="linear-gradient"]');
                            if (statusBadge) {
                                if (data.is_active) {
                                    statusBadge.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                                    statusBadge.textContent = '‚úì Active';
                                } else {
                                    statusBadge.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                                    statusBadge.textContent = '‚úï Inactive';
                                }
                            }
                        }
                        
                        // Update button text and onclick
                        button.textContent = data.is_active ? 'üîí Deactivate' : '‚úÖ Activate';
                        button.onclick = () => toggleVendorStatus(vendorId, data.is_active);
                        button.disabled = false;
                    } else {
                        button.textContent = originalText;
                        button.disabled = false;
                        showNotification('Failed to update vendor status', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    button.textContent = originalText;
                    button.disabled = false;
                    showNotification('An error occurred. Please try again.', 'error');
                });
            }
        }

        // Add Material Modal Functions
        function openAddMaterialModal() {
            document.getElementById('addMaterialModal').style.display = 'flex';
        }

        function closeAddMaterialModal() {
            document.getElementById('addMaterialModal').style.display = 'none';
            document.getElementById('addMaterialForm').reset();
        }

        // Toggle custom category input
        function toggleCustomCategoryInput() {
            var categorySelect = document.getElementById('modal_material-category-select');
            var customInput = document.getElementById('modal_custom-material-category');
            
            if (!categorySelect || !customInput) return;
            
            if (categorySelect.value === 'Custom') {
                customInput.required = true;
                customInput.placeholder = 'Enter custom category (required)';
            } else {
                customInput.required = false;
                customInput.placeholder = 'Type here for custom category (optional)';
            }
        }

        // Add Vendor Modal Functions
        function openAddVendorModal() {
            document.getElementById('addVendorModal').style.display = 'flex';
        }

        function closeAddVendorModal() {
            document.getElementById('addVendorModal').style.display = 'none';
            document.getElementById('addVendorForm').reset();
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            var addMaterialModal = document.getElementById('addMaterialModal');
            var addVendorModal = document.getElementById('addVendorModal');
            
            if (event.target == addMaterialModal) {
                addMaterialModal.style.display = 'none';
            }
            if (event.target == addVendorModal) {
                addVendorModal.style.display = 'none';
            }
        }

        // Format date input to DD/MM/YYYY
        function formatDateInput(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value.length > 2 && value.length <= 4) {
                value = value.slice(0,2) + '/' + value.slice(2);
            } else if (value.length > 4) {
                value = value.slice(0,2) + '/' + value.slice(2,4) + '/' + value.slice(4,8);
            }
            input.value = value.slice(0, 10);
        }
    </script>

    <!-- Material‚ÄìVendor Linking Table -->
    <h3>
        Material‚ÄìVendor Linking
        <span title="Link vendors to each material. Click Edit to manage vendors for a material." style="cursor:help;font-size:16px;color:#4f8cff;vertical-align:middle;">&#9432;</span>
    </h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 20px; margin-bottom: 48px;">
        {% for material in materials %}
        <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 1px solid rgba(79, 140, 255, 0.2); border-radius: 16px; padding: 20px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3); transition: all 0.3s ease;" onmouseenter="this.style.boxShadow='0 8px 32px rgba(79, 140, 255, 0.3)'; this.style.borderColor='rgba(79, 140, 255, 0.4)'" onmouseleave="this.style.boxShadow='0 4px 16px rgba(0, 0, 0, 0.3)'; this.style.borderColor='rgba(79, 140, 255, 0.2)'">
            
            <!-- Material Header -->
            <div style="margin-bottom: 16px; border-bottom: 2px solid rgba(79, 140, 255, 0.3); padding-bottom: 12px;">
                <h4 style="margin: 0; color: #4f8cff; font-size: 16px; font-weight: 700;">
                    üì¶ {{ material.name }}
                </h4>
            </div>
            
            <!-- Vendors Section -->
            <div style="margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <span style="color: #3b82f6; font-size: 14px; font-weight: 600;">üè¢ Linked Vendors</span>
                    <span style="font-size: 12px; color: #94a3b8; background: rgba(59, 130, 246, 0.1); padding: 2px 8px; border-radius: 12px;">
                        {% if material.vendors %}{{ material.vendors|length }}{% else %}0{% endif %}
                    </span>
                </div>
                <div style="min-height: 40px; display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                    {% if material.vendors %}
                        {% for vendor in material.vendors %}
                            <span style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: #fff; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 500; box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);" title="Vendor: {{ vendor.vendor_name }}&#10;Lead Time: {{ vendor.lead_time_days }}d">
                                {{ vendor.vendor_name }}
                            </span>
                        {% endfor %}
                    {% else %}
                        <span style="color: #ef4444; font-size: 12px; font-weight: 600; background: rgba(239, 68, 68, 0.1); padding: 4px 8px; border-radius: 6px;">
                            ‚ö†Ô∏è No vendors linked
                        </span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Contact Information Grid -->
            {% if material.vendors %}
            <div style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.1); border-radius: 10px; padding: 12px; margin-bottom: 16px;">
                <div style="font-size: 12px; color: #94a3b8; margin-bottom: 8px; font-weight: 600;">
                    üìã Contact Information
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    {% for vendor in material.vendors %}
                        <div style="font-size: 11px;">
                            <div style="color: #64748b; margin-bottom: 2px;">{{ vendor.vendor_name }}</div>
                            <div style="color: #94a3b8;">üë§ {{ vendor.contact_person or '-' }}</div>
                            <div style="color: #94a3b8;">üìß {{ vendor.email or '-' }}</div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Lead Time Specs -->
            {% if material.vendors %}
            <div style="background: rgba(168, 85, 247, 0.05); border: 1px solid rgba(168, 85, 247, 0.1); border-radius: 10px; padding: 12px; margin-bottom: 16px;">
                <div style="font-size: 12px; color: #94a3b8; margin-bottom: 8px; font-weight: 600;">
                    ‚è±Ô∏è Supply Details
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    {% for vendor in material.vendors %}
                        <div style="font-size: 11px; color: #cbd5e1;">
                            <span style="font-weight: 600;">{{ vendor.vendor_name }}</span><br>
                            Lead: <span style="color: #a855f7;">{{ vendor.lead_time_days }}d</span> | Min: <span style="color: #a855f7;">{{ vendor.min_order_qty }}</span>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Action Button -->
            <button onclick="openVendorModal('{{ material.id }}', '{{ material.name }}')" style="width: 100%; background: linear-gradient(135deg, #4f8cff 0%, #3a6fd8 100%); color: #fff; border: none; border-radius: 10px; padding: 12px 16px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(79, 140, 255, 0.3);" onmouseover="this.style.boxShadow='0 6px 20px rgba(79, 140, 255, 0.5)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 4px 12px rgba(79, 140, 255, 0.3)'; this.style.transform='translateY(0)'">
                ‚úèÔ∏è Manage Vendors
            </button>
        </div>
        {% endfor %}
    </div>

    <!-- Stretch & Activity Linking Section -->
    <h3>
        Material‚ÄìStretch & Activity Linking
        <span title="Easily link stretches and activities to materials using an intuitive card interface" style="cursor:help;font-size:16px;color:#4f8cff;vertical-align:middle;">&#9432;</span>
    </h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-bottom: 48px;">
        {% for material in materials %}
        <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 1px solid rgba(79, 140, 255, 0.2); border-radius: 16px; padding: 20px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3); transition: all 0.3s ease; cursor: pointer;" onmouseenter="this.style.boxShadow='0 8px 32px rgba(79, 140, 255, 0.3)'; this.style.borderColor='rgba(79, 140, 255, 0.4)'" onmouseleave="this.style.boxShadow='0 4px 16px rgba(0, 0, 0, 0.3)'; this.style.borderColor='rgba(79, 140, 255, 0.2)'">
            <!-- Material Name Header -->
            <div style="margin-bottom: 16px; border-bottom: 2px solid rgba(79, 140, 255, 0.3); padding-bottom: 12px;">
                <h4 style="margin: 0; color: #4f8cff; font-size: 16px; font-weight: 700;">
                    üì¶ {{ material.name }}
                </h4>
            </div>
            
            <!-- Stretches Section -->
            <div style="margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <span style="color: #22c55e; font-size: 14px; font-weight: 600;">üõ£Ô∏è Stretches</span>
                    <span style="font-size: 12px; color: #94a3b8; background: rgba(34, 197, 94, 0.1); padding: 2px 8px; border-radius: 12px;">
                        {% if material.stretches %}{{ material.stretches|length }}{% else %}0{% endif %} linked
                    </span>
                </div>
                <div style="min-height: 40px; display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                    {% if material.stretches %}
                        {% for stretch in material.stretches %}
                            <span style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: #fff; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 500; box-shadow: 0 2px 6px rgba(34, 197, 94, 0.3);">
                                {{ stretch.stretch_name }}
                            </span>
                        {% endfor %}
                    {% else %}
                        <span style="color: #64748b; font-size: 12px; font-style: italic;">No stretches linked yet</span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Activities Section -->
            <div style="margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <span style="color: #a855f7; font-size: 14px; font-weight: 600;">‚öôÔ∏è Activities</span>
                    <span style="font-size: 12px; color: #94a3b8; background: rgba(168, 85, 247, 0.1); padding: 2px 8px; border-radius: 12px;">
                        {% if material.activities %}{{ material.activities|length }}{% else %}0{% endif %} linked
                    </span>
                </div>
                <div style="min-height: 40px; display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                    {% if material.activities %}
                        {% for activity in material.activities %}
                            <span style="background: linear-gradient(135deg, #a855f7 0%, #7e22ce 100%); color: #fff; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 500; box-shadow: 0 2px 6px rgba(168, 85, 247, 0.3);">
                                {{ activity.name }}
                            </span>
                        {% endfor %}
                    {% else %}
                        <span style="color: #64748b; font-size: 12px; font-style: italic;">No activities linked yet</span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Edit Button -->
            <div style="margin-top: 16px; border-top: 1px solid rgba(79, 140, 255, 0.2); padding-top: 12px;">
                <button 
                    onclick="openStretchActivityModal('{{ material.id }}', '{{ material.name }}')" 
                    style="width: 100%; background: linear-gradient(135deg, #4f8cff 0%, #3a6fd8 100%); color: #fff; border: none; border-radius: 8px; padding: 10px 16px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(79, 140, 255, 0.3);"
                    onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(79, 140, 255, 0.5)'"
                    onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(79, 140, 255, 0.3)'">
                    ‚úèÔ∏è Configure Links
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

        <!-- Vendor Modal - Improved Checkbox Interface -->
        <div id="vendorModal" class="modal" style="display:none;">
            <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                <span class="close" onclick="closeVendorModal()">&times;</span>
                <h3 style="margin-top: 0; margin-bottom: 24px; color: #4f8cff;">
                    üè¢ Select Vendors for Material
                </h3>
                
                <div style="background: rgba(79, 140, 255, 0.05); border-left: 4px solid #4f8cff; padding: 12px 16px; border-radius: 8px; margin-bottom: 24px;">
                    <p style="margin: 0; color: #cbd5e1; font-size: 14px;">
                        <strong>Material:</strong> <span id="vendorModalMaterialName" style="color: #4f8cff; font-weight: 600;"></span>
                    </p>
                </div>
                
                <form id="vendorForm">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                        <span style="color: #a8b3cf; font-weight: 600; font-size: 14px;">üìã Linked Vendors</span>
                        <span id="vendorCount" style="font-size: 12px; color: #94a3b8; background: rgba(59, 130, 246, 0.1); padding: 2px 8px; border-radius: 12px;">0 selected</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; margin-bottom: 24px;">
                        <!-- Vendors will be populated by JavaScript -->
                    </div>
                    
                    <div class="modal-warning" id="vendorModalWarning" style="display:none; color: #ef4444; background: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px;"></div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closeVendorModal()" style="background: #64748b; border: none; border-radius: 8px; padding: 10px 20px; color: #fff; font-weight: 500; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='#475569'" onmouseout="this.style.background='#64748b'">Cancel</button>
                        <button type="submit" style="background: linear-gradient(135deg, #4f8cff 0%, #3a6fd8 100%); border: none; border-radius: 8px; padding: 10px 20px; color: #fff; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(79, 140, 255, 0.3); transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 6px 20px rgba(79, 140, 255, 0.5)'" onmouseout="this.style.boxShadow='0 4px 12px rgba(79, 140, 255, 0.3)'">Save Vendors</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Stretch & Activity Modal - Improved UI -->
        <div id="stretchActivityModal" class="modal" style="display:none;">
            <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                <span class="close" onclick="closeStretchActivityModal()">&times;</span>
                <h3 style="margin-top: 0; margin-bottom: 24px; color: #4f8cff;">
                    üîó Link Material to Stretches & Activities
                </h3>
                
                <div style="background: rgba(79, 140, 255, 0.05); border-left: 4px solid #4f8cff; padding: 12px 16px; border-radius: 8px; margin-bottom: 24px;">
                    <p style="margin: 0; color: #cbd5e1; font-size: 14px;">
                        <strong>Material:</strong> <span id="stretchActivityModalMaterialName" style="color: #4f8cff; font-weight: 600;"></span>
                    </p>
                </div>
                
                <form id="stretchActivityForm">
                    <!-- Stretches Section -->
                    <div style="margin-bottom: 32px;">
                        <h4 style="margin-bottom: 16px; color: #22c55e; display: flex; align-items: center; gap: 8px;">
                            üõ£Ô∏è Select Road Stretches
                            <span style="font-size: 12px; background: rgba(34, 197, 94, 0.2); padding: 4px 8px; border-radius: 8px; color: #22c55e;">
                                <span id="stretchCount">0</span> selected
                            </span>
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">
                            {% for s in all_stretches %}
                            <label style="display: flex; align-items: center; padding: 12px; background: rgba(30, 41, 59, 0.5); border: 2px solid rgba(34, 197, 94, 0.2); border-radius: 8px; cursor: pointer; transition: all 0.3s ease;" 
                                   onmouseenter="this.style.background='rgba(34, 197, 94, 0.1)'; this.style.borderColor='rgba(34, 197, 94, 0.5)'"
                                   onmouseleave="this.style.background='rgba(30, 41, 59, 0.5)'; this.style.borderColor='rgba(34, 197, 94, 0.2)'">
                                <input type="checkbox" name="stretches" value="{{ s.id }}" style="width: 16px; height: 16px; cursor: pointer; margin-right: 8px;" onchange="updateStretchCount()">
                                <span style="color: #cbd5e1; font-weight: 500; font-size: 13px;">{{ s.stretch_name }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        {% if not all_stretches %}
                        <div style="color: #64748b; font-style: italic; padding: 16px; text-align: center; background: rgba(30, 41, 59, 0.3); border-radius: 8px;">
                            No stretches available
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Activities Section -->
                    <div style="margin-bottom: 24px;">
                        <h4 style="margin-bottom: 16px; color: #a855f7; display: flex; align-items: center; gap: 8px;">
                            ‚öôÔ∏è Select Activities
                            <span style="font-size: 12px; background: rgba(168, 85, 247, 0.2); padding: 4px 8px; border-radius: 8px; color: #a855f7;">
                                <span id="activityCount">0</span> selected
                            </span>
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">
                            {% for a in all_activities %}
                            <label style="display: flex; align-items: center; padding: 12px; background: rgba(30, 41, 59, 0.5); border: 2px solid rgba(168, 85, 247, 0.2); border-radius: 8px; cursor: pointer; transition: all 0.3s ease;"
                                   onmouseenter="this.style.background='rgba(168, 85, 247, 0.1)'; this.style.borderColor='rgba(168, 85, 247, 0.5)'"
                                   onmouseleave="this.style.background='rgba(30, 41, 59, 0.5)'; this.style.borderColor='rgba(168, 85, 247, 0.2)'">
                                <input type="checkbox" name="activities" value="{{ a.id }}" style="width: 16px; height: 16px; cursor: pointer; margin-right: 8px;" onchange="updateActivityCount()">
                                <span style="color: #cbd5e1; font-weight: 500; font-size: 13px;">{{ a.name }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        {% if not all_activities %}
                        <div style="color: #64748b; font-style: italic; padding: 16px; text-align: center; background: rgba(30, 41, 59, 0.3); border-radius: 8px;">
                            No activities available
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Buttons -->
                    <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end; border-top: 1px solid rgba(79, 140, 255, 0.2); padding-top: 24px;">
                        <button type="button" onclick="closeStretchActivityModal()" style="background: #64748b; border: none; border-radius: 8px; padding: 12px 24px; color: #fff; font-weight: 500; cursor: pointer; transition: all 0.3s ease;"
                                onmouseenter="this.style.background='#475569'; this.style.transform='translateY(-2px)'"
                                onmouseleave="this.style.background='#64748b'; this.style.transform='translateY(0)'">
                            Cancel
                        </button>
                        <button type="submit" style="background: linear-gradient(135deg, #4f8cff 0%, #3a6fd8 100%); border: none; border-radius: 8px; padding: 12px 32px; color: #fff; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(79, 140, 255, 0.3);"
                                onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(79, 140, 255, 0.5)'"
                                onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(79, 140, 255, 0.3)'">
                            ‚úì Save Links
                        </button>
                    </div>
                    <div class="modal-warning" id="stretchActivityModalWarning" style="display:none;color:#d44545;margin:12px 0 0 0; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;"></div>
                </form>
            </div>
        </div>

        <style>
        .badge-vendor { background: #3b82f6; color: #fff; border-radius: 8px; padding: 2px 10px; margin: 0 2px 2px 0; display: inline-block; }
        .badge-stretch { background: #22c55e; color: #fff; border-radius: 8px; padding: 2px 10px; margin: 0 2px 2px 0; display: inline-block; }
        .badge-activity { background: #a855f7; color: #fff; border-radius: 8px; padding: 2px 10px; margin: 0 2px 2px 0; display: inline-block; }
        .badge-empty { background: #64748b; color: #fff; border-radius: 8px; padding: 2px 10px; margin: 0 2px 2px 0; display: inline-block; }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100vw; height: 100vh; overflow: auto; background: rgba(0,0,0,0.45); display: flex; align-items: center; justify-content: center; }
        .modal-content { background: #181c2a; padding: 28px 32px 24px 32px; border-radius: 14px; min-width: 340px; max-width: 98vw; box-shadow: 0 8px 32px 0 rgba(0,0,0,0.18); position: relative; }
        .close { position: absolute; right: 18px; top: 12px; font-size: 22px; color: #b8c1ec; cursor: pointer; }
        .btn-info.btn-sm, .btn-add-vendor { background: #3b82f6; color: #fff; border: none; border-radius: 7px; padding: 6px 14px; font-size: 13px; cursor: pointer; }
        .btn-info.btn-sm:hover, .btn-add-vendor:hover { filter: brightness(1.08); }
        </style>

        <script>
        let currentMaterialId = null;
        function openVendorModal(materialId, materialName) {
            document.getElementById('vendorModal').style.display = 'flex';
            document.getElementById('vendorModalMaterialName').textContent = materialName;
            currentMaterialId = materialId;
            
            // Clear any previous vendor checkboxes
            const vendorGrid = document.querySelector('#vendorForm > div:nth-child(2)');
            if (vendorGrid) {
                vendorGrid.innerHTML = '';
            }
            
            // Fetch vendors for this specific material
            fetch(`/material/${materialId}/vendors`)
                .then(r => r.json())
                .then(data => {
                    // Build vendor checkboxes for only this material's vendors
                    const vendorGrid = document.querySelector('#vendorForm > div:nth-child(2)');
                    if (vendorGrid && data.vendors && data.vendors.length > 0) {
                        vendorGrid.innerHTML = data.vendors.map(vendor => `
                            <label style="background: rgba(30, 41, 59, 0.8); border: 2px solid rgba(79, 140, 255, 0.1); border-radius: 12px; padding: 14px; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; gap: 8px;" onmouseover="this.style.borderColor='rgba(79, 140, 255, 0.4)'; this.style.background='rgba(30, 41, 59, 0.95)'; this.style.boxShadow='0 4px 12px rgba(79, 140, 255, 0.15)'" onmouseout="this.style.borderColor='rgba(79, 140, 255, 0.1)'; this.style.background='rgba(30, 41, 59, 0.8)'; this.style.boxShadow='none'">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" name="vendors" value="${vendor.id}" style="width: 18px; height: 18px; cursor: pointer;" onchange="updateVendorCount()" checked>
                                    <span style="color: #4f8cff; font-weight: 600; flex: 1;">${vendor.vendor_name}</span>
                                </div>
                                <div style="font-size: 12px; color: #94a3b8; display: grid; gap: 4px;">
                                    <div>üë§ <span>${vendor.contact_person || 'N/A'}</span></div>
                                    <div>üìß <span>${vendor.email || 'N/A'}</span></div>
                                    <div style="background: rgba(168, 85, 247, 0.1); padding: 4px 6px; border-radius: 6px;">‚è±Ô∏è Lead Time: <span style="color: #a855f7; font-weight: 600;">${vendor.lead_time_days}d</span></div>
                                </div>
                            </label>
                        `).join('');
                        updateVendorCount();
                    } else if (vendorGrid) {
                        vendorGrid.innerHTML = '<div style="grid-column: 1 / -1; padding: 20px; text-align: center; color: #94a3b8;">No vendors linked to this material yet. Add vendors via the Manage Vendors button.</div>';
                    }
                }).catch(err => {
                    console.error('Error fetching vendors:', err);
                });
        }
        function closeVendorModal() {
            document.getElementById('vendorModal').style.display = 'none';
            currentMaterialId = null;
        }
        function openStretchActivityModal(materialId, materialName) {
            document.getElementById('stretchActivityModal').style.display = 'flex';
            document.getElementById('stretchActivityModalMaterialName').textContent = materialName;
            currentMaterialId = materialId;
            
            // Reset all checkboxes
            document.querySelectorAll('#stretchActivityForm input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateStretchCount();
            updateActivityCount();
            
            // Fetch and pre-select stretches
            fetch(`/material/${materialId}/stretches`).then(r => r.json()).then(data => {
                document.querySelectorAll('#stretchActivityForm input[name="stretches"]').forEach(cb => {
                    cb.checked = data.stretch_ids.includes(parseInt(cb.value));
                });
                updateStretchCount();
            });
            
            // Fetch and pre-select activities
            fetch(`/material/${materialId}/activities`).then(r => r.json()).then(data => {
                document.querySelectorAll('#stretchActivityForm input[name="activities"]').forEach(cb => {
                    cb.checked = data.activity_ids.includes(parseInt(cb.value));
                });
                updateActivityCount();
            });
        }
        
        function closeStretchActivityModal() {
            document.getElementById('stretchActivityModal').style.display = 'none';
            currentMaterialId = null;
        }
        
        // Update selected vendor count
        function updateVendorCount() {
            const count = document.querySelectorAll('#vendorForm input[name="vendors"]:checked').length;
            document.getElementById('vendorCount').textContent = count + ' selected';
        }
        
        // Update selected stretch count
        function updateStretchCount() {
            const count = document.querySelectorAll('#stretchActivityForm input[name="stretches"]:checked').length;
            document.getElementById('stretchCount').textContent = count;
        }
        
        // Update selected activity count
        function updateActivityCount() {
            const count = document.querySelectorAll('#stretchActivityForm input[name="activities"]:checked').length;
            document.getElementById('activityCount').textContent = count;
        }

        // Modal form submit handlers (AJAX, validation)
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('vendorForm').onsubmit = function(e) {
                e.preventDefault();
                var selected = Array.from(document.querySelectorAll('#vendorForm input[name="vendors"]:checked')).map(cb => cb.value);
                if (selected.length === 0) {
                    document.getElementById('vendorModalWarning').textContent = '‚ö†Ô∏è Please select at least one vendor.';
                    document.getElementById('vendorModalWarning').style.display = 'block';
                    return false;
                }
                document.getElementById('vendorModalWarning').style.display = 'none';
                
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
                
                // Send vendor selections to backend
                fetch(`/material/${currentMaterialId}/vendors`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vendor_ids: selected })
                }).then(r => r.json()).then(data => {
                    if (data.success) {
                        showNotification('Vendors updated successfully!', 'success');
                        setTimeout(() => location.reload(), 800);
                    } else {
                        document.getElementById('vendorModalWarning').textContent = '‚ùå Error: ' + (data.error || 'Failed to update vendors');
                        document.getElementById('vendorModalWarning').style.display = 'block';
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                }).catch(err => {
                    console.error('Error:', err);
                    document.getElementById('vendorModalWarning').textContent = '‚ùå Error: ' + err.message;
                    document.getElementById('vendorModalWarning').style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                });
                
                return false;
            };
            document.getElementById('stretchActivityForm').onsubmit = function(e) {
                e.preventDefault();
                var stretches = Array.from(document.querySelectorAll('#stretchActivityForm input[name="stretches"]:checked')).map(cb => parseInt(cb.value));
                var activities = Array.from(document.querySelectorAll('#stretchActivityForm input[name="activities"]:checked')).map(cb => parseInt(cb.value));
                
                if (stretches.length === 0 && activities.length === 0) {
                    document.getElementById('stretchActivityModalWarning').textContent = '‚ö†Ô∏è Please select at least one stretch or activity.';
                    document.getElementById('stretchActivityModalWarning').style.display = 'block';
                    return false;
                }
                
                document.getElementById('stretchActivityModalWarning').style.display = 'none';
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
                
                // Save stretches
                fetch(`/material/${currentMaterialId}/stretches`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stretch_ids: stretches })
                })
                .then(r => r.json())
                .then(data => {
                    // Save activities
                    return fetch(`/material/${currentMaterialId}/activities`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ activity_ids: activities })
                    });
                })
                .then(r => r.json())
                .then(data => {
                    showNotification('Links saved successfully!', 'success');
                    setTimeout(() => {
                        closeStretchActivityModal();
                        window.location.reload();
                    }, 800);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('stretchActivityModalWarning').textContent = '‚ùå Error saving links. Please try again.';
                    document.getElementById('stretchActivityModalWarning').style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                });
                
                return false;
            };
        });
        </script>
        </tbody>
    </table>

    <!-- Inventory Intelligence - Card Grid -->
    <h3>
        üìä Inventory Status
        <span title="Current stock levels for all materials" style="cursor:help;font-size:16px;color:#4f8cff;vertical-align:middle;">&#9432;</span>
    </h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 20px; margin-bottom: 48px;">
        {% for material in materials %}
        <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 1px solid rgba(79, 140, 255, 0.2); border-radius: 16px; padding: 20px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3); transition: all 0.3s ease;" onmouseenter="this.style.boxShadow='0 8px 32px rgba(79, 140, 255, 0.3)'; this.style.borderColor='rgba(79, 140, 255, 0.4)'" onmouseleave="this.style.boxShadow='0 4px 16px rgba(0, 0, 0, 0.3)'; this.style.borderColor='rgba(79, 140, 255, 0.2)'">
            
            <!-- Material Name Header -->
            <div style="margin-bottom: 16px; border-bottom: 2px solid rgba(79, 140, 255, 0.3); padding-bottom: 12px;">
                <h4 style="margin: 0; color: #4f8cff; font-size: 16px; font-weight: 700;">
                    üì¶ {{ material.name }}
                </h4>
            </div>
            
            <!-- Inventory Metrics Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <!-- Opening Stock -->
                <div style="background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.1); border-radius: 10px; padding: 12px;">
                    <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px; font-weight: 600;">üì• Opening</div>
                    <div style="font-size: 20px; font-weight: 700; color: #22c55e;">{{ material.opening_stock or '0' }}</div>
                </div>
                
                <!-- Incoming Stock -->
                <div style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.1); border-radius: 10px; padding: 12px;">
                    <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px; font-weight: 600;">üì¶ Incoming</div>
                    <div style="font-size: 20px; font-weight: 700; color: #3b82f6;">{{ material.incoming_stock or '0' }}</div>
                </div>
                
                <!-- Issued Stock -->
                <div style="background: rgba(168, 85, 247, 0.05); border: 1px solid rgba(168, 85, 247, 0.1); border-radius: 10px; padding: 12px;">
                    <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px; font-weight: 600;">üì§ Issued</div>
                    <div style="font-size: 20px; font-weight: 700; color: #a855f7;">{{ material.issued_stock or '0' }}</div>
                </div>
                
                <!-- Closing Stock -->
                <div style="background: rgba(236, 72, 153, 0.05); border: 1px solid rgba(236, 72, 153, 0.1); border-radius: 10px; padding: 12px;">
                    <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px; font-weight: 600;">üíæ Closing</div>
                    <div style="font-size: 20px; font-weight: 700; color: #ec4899;">{{ material.closing_stock or '0' }}</div>
                </div>
            </div>
            
            <!-- Status Badge -->
            <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 10px; padding: 12px; text-align: center;">
                <span style="color: #22c55e; font-weight: 600; font-size: 14px;">‚úÖ Status: Balanced</span>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Procurement Intelligence - Card Grid -->
    <h3>
        üìã Procurement Planning
        <span title="Manage procurement schedules and suggest vendors" style="cursor:help;font-size:16px;color:#4f8cff;vertical-align:middle;">&#9432;</span>
    </h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 20px; margin-bottom: 48px;">
        {% for material in materials %}
        <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 16px; padding: 20px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3); transition: all 0.3s ease;" onmouseenter="this.style.boxShadow='0 8px 32px rgba(168, 85, 247, 0.3)'; this.style.borderColor='rgba(168, 85, 247, 0.4)'" onmouseleave="this.style.boxShadow='0 4px 16px rgba(0, 0, 0, 0.3)'; this.style.borderColor='rgba(168, 85, 247, 0.2)'">
            
            <!-- Material Name Header -->
            <div style="margin-bottom: 16px; border-bottom: 2px solid rgba(168, 85, 247, 0.3); padding-bottom: 12px;">
                <h4 style="margin: 0; color: #a855f7; font-size: 16px; font-weight: 700;">
                    üì¶ {{ material.name }}
                </h4>
            </div>
            
            <!-- Procurement Details Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <!-- Min Stock -->
                <div style="background: rgba(168, 85, 247, 0.05); border: 1px solid rgba(168, 85, 247, 0.1); border-radius: 10px; padding: 12px;">
                    <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px; font-weight: 600;">üìç Min Stock</div>
                    <div style="font-size: 18px; font-weight: 700; color: #a855f7;">{{ material.minimum_stock or '-' }}</div>
                </div>
                
                <!-- Buffer Stock -->
                <div style="background: rgba(236, 72, 153, 0.05); border: 1px solid rgba(236, 72, 153, 0.1); border-radius: 10px; padding: 12px;">
                    <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px; font-weight: 600;">üõ°Ô∏è Buffer</div>
                    <div style="font-size: 18px; font-weight: 700; color: #ec4899;">{{ material.buffer_stock or '-' }}</div>
                </div>
                
                <!-- Lead Time -->
                <div style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.1); border-radius: 10px; padding: 12px;">
                    <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px; font-weight: 600;">‚è±Ô∏è Lead Time</div>
                    <div style="font-size: 18px; font-weight: 700; color: #3b82f6;">{{ material.lead_time_days or '0' }}d</div>
                </div>
                
                <!-- Next Procurement -->
                <div style="background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.1); border-radius: 10px; padding: 12px;">
                    <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px; font-weight: 600;">üìÖ Next Order</div>
                    <div style="font-size: 14px; font-weight: 700; color: #22c55e;">{{ material.next_procurement_date or 'TBD' }}</div>
                </div>
            </div>
            
            <!-- Suggested Vendor -->
            <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 10px; padding: 12px; margin-bottom: 16px;">
                <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px; font-weight: 600;">üè¢ Suggested Vendor</div>
                <div style="color: #22c55e; font-weight: 600; font-size: 14px;">{{ material.suggested_vendor or 'No vendor assigned' }}</div>
            </div>
            
            <!-- Action Button -->
            <button style="width: 100%; background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); color: #fff; border: none; border-radius: 10px; padding: 12px 16px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);" onmouseover="this.style.boxShadow='0 6px 20px rgba(168, 85, 247, 0.5)'" onmouseout="this.style.boxShadow='0 4px 12px rgba(168, 85, 247, 0.3)'">
                ‚úèÔ∏è Edit Procurement
            </button>
        </div>
        {% endfor %}
    </div>

    <!-- Alerts & Intelligence - Card Grid -->
    <h3>
        üö® Alerts & Intelligence
        <span title="Critical alerts and recommendations" style="cursor:help;font-size:16px;color:#4f8cff;vertical-align:middle;">&#9432;</span>
    </h3>
    {% if alerts %}
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 20px; margin-bottom: 48px;">
        {% for alert in alerts %}
        <div style="background: linear-gradient(135deg, {% if alert.type == 'critical' %}#7f1d1d{% elif alert.type == 'warning' %}#78350f{% else %}#1e3a1f{% endif %} 0%, {% if alert.type == 'critical' %}#450a0a{% elif alert.type == 'warning' %}#451a03{% else %}#0f2817{% endif %} 100%); border: 1px solid {% if alert.type == 'critical' %}rgba(239, 68, 68, 0.2){% elif alert.type == 'warning' %}rgba(245, 158, 11, 0.2){% else %}rgba(34, 197, 94, 0.2){% endif %}; border-radius: 16px; padding: 20px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3); transition: all 0.3s ease;" onmouseenter="this.style.boxShadow='0 8px 32px {% if alert.type == 'critical' %}rgba(239, 68, 68, 0.3){% elif alert.type == 'warning' %}rgba(245, 158, 11, 0.3){% else %}rgba(34, 197, 94, 0.3){% endif %}'" onmouseleave="this.style.boxShadow='0 4px 16px rgba(0, 0, 0, 0.3)'">
            
            <!-- Alert Type Badge -->
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 2px solid {% if alert.type == 'critical' %}rgba(239, 68, 68, 0.3){% elif alert.type == 'warning' %}rgba(245, 158, 11, 0.3){% else %}rgba(34, 197, 94, 0.3){% endif %};">
                <span style="font-weight: 600; color: {% if alert.type == 'critical' %}#ef4444{% elif alert.type == 'warning' %}#f59e0b{% else %}#22c55e{% endif %}; font-size: 14px;">
                    {% if alert.type == 'critical' %}üî¥ CRITICAL{% elif alert.type == 'warning' %}üü° WARNING{% else %}üü¢ INFO{% endif %}
                </span>
            </div>
            
            <!-- Alert Material -->
            <div style="margin-bottom: 12px;">
                <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px; font-weight: 600;">Material</div>
                <div style="color: #cbd5e1; font-weight: 600;">{{ alert.material }}</div>
            </div>
            
            <!-- Alert Message -->
            <div style="margin-bottom: 12px;">
                <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px; font-weight: 600;">Message</div>
                <div style="color: #cbd5e1; font-size: 14px; line-height: 1.5;">{{ alert.message }}</div>
            </div>
            
            <!-- Alert Date -->
            <div style="margin-bottom: 16px;">
                <div style="font-size: 12px; color: #94a3b8;">üìÖ {{ alert.date }}</div>
            </div>
            
            <!-- Action Button -->
            <button style="width: 100%; background: linear-gradient(135deg, {% if alert.type == 'critical' %}#ef4444{% elif alert.type == 'warning' %}#f59e0b{% else %}#22c55e{% endif %} 0%, {% if alert.type == 'critical' %}#dc2626{% elif alert.type == 'warning' %}#d97706{% else %}#16a34a{% endif %} 100%); color: #fff; border: none; border-radius: 10px; padding: 10px 16px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                {{ alert.action or '‚úÖ Acknowledge' }}
            </button>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%); border: 2px dashed rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 40px 20px; text-align: center; margin-bottom: 48px;">
        <div style="font-size: 48px; margin-bottom: 12px;">‚úÖ</div>
        <div style="color: #22c55e; font-weight: 600; font-size: 16px; margin-bottom: 8px;">All Systems Green</div>
        <div style="color: #94a3b8; font-size: 14px;">No critical alerts at this time. Your inventory is healthy!</div>
    </div>
    {% endif %}

    <!-- Export Buttons -->
    <div style="margin-top:24px;">
        <button class="btn-secondary">Export to Excel</button>
        <button class="btn-secondary">Export to PDF</button>
    </div>
</div>

<!-- Add Material Modal -->
<div id="addMaterialModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 1100px; max-height: 90vh; overflow-y: auto; border: 2px solid rgba(79, 140, 255, 0.3); background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);">
        <div style="position: sticky; top: 0; z-index: 10; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); margin: -28px -32px 24px -32px; padding: 24px 32px; border-bottom: 2px solid rgba(79, 140, 255, 0.2); border-radius: 12px 12px 0 0;">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px;">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <span style="font-size: 32px;">üì¶</span>
                    <div>
                        <h2 style="margin: 0; color: #4f8cff; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                            Add New Material
                            <span style="font-size: 16px; color: #a855f7; background: rgba(168, 85, 247, 0.2); padding: 4px 12px; border-radius: 20px; font-weight: 600; font-size: 12px;">STEP BY STEP</span>
                        </h2>
                        <p style="margin: 6px 0 0 0; color: #94a3b8; font-size: 14px;">Define construction materials, configure inventory settings, and link to activities & stretches</p>
                    </div>
                </div>
                <button class="close" onclick="closeAddMaterialModal()" style="position: static; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); width: 40px; height: 40px; border-radius: 8px; cursor: pointer; color: #ef4444; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'; this.style.borderColor='rgba(239, 68, 68, 0.5)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'; this.style.borderColor='rgba(239, 68, 68, 0.3)'">&times;</button>
            </div>
        </div>
        
        <form method="post" action="/project/{{ project.id }}/materials/add" id="addMaterialForm">
            <!-- Basic Information Section -->
            <div style="background: linear-gradient(135deg, rgba(79, 140, 255, 0.08) 0%, rgba(79, 140, 255, 0.03) 100%); border: 2px solid rgba(79, 140, 255, 0.2); border-left: 4px solid #4f8cff; padding: 20px; border-radius: 12px; margin-bottom: 24px; position: relative; overflow: hidden;">
                <div style="position: absolute; top: -40px; right: -40px; width: 150px; height: 150px; background: radial-gradient(circle, rgba(79, 140, 255, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
                <div style="position: relative; z-index: 1;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 2px solid rgba(79, 140, 255, 0.15);">
                        <span style="font-size: 24px;">üìã</span>
                        <h4 style="margin: 0; color: #4f8cff; font-size: 16px; font-weight: 700;">Basic Information</h4>
                        <span style="margin-left: auto; font-size: 12px; color: #94a3b8; background: rgba(79, 140, 255, 0.1); padding: 4px 10px; border-radius: 6px;">1 of 3</span>
                    </div>
                    <div class="form-grid" style="display:grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 16px;">
                        <!-- Material Name - Full Width -->
                        <div style="grid-column: 1 / -1;">
                            <label for="modal_material_name" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1;font-size:14px;">Material Name <span style="color:#ef4444;">*</span></label>
                            <input type="text" id="modal_material_name" name="material_name" placeholder="e.g., OPC Cement, TMT Steel Bar, Fine Aggregate" required style="width: 100%; padding: 11px 14px; border-radius: 8px; border: 2px solid rgba(79, 140, 255, 0.2); background: rgba(30, 41, 59, 0.6); color: #fff; font-size: 14px; transition: all 0.3s ease;" onfocus="this.style.borderColor='rgba(79,140,255,0.5)'; this.style.boxShadow='0 0 12px rgba(79,140,255,0.2)'" onblur="this.style.borderColor='rgba(79,140,255,0.2)'; this.style.boxShadow='none'">
                            <small style="color: #94a3b8; font-size: 12px; margin-top: 4px; display: block;">Provide a descriptive name for easy identification</small>
                        </div>
                        <!-- Material Code & Category -->
                        <div>
                            <label for="modal_material_code" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1;font-size:14px;">Material Code</label>
                            <input type="text" id="modal_material_code" name="material_code" placeholder="Auto-generated" readonly style="width: 100%; padding: 11px 14px; border-radius: 8px; border: 2px solid rgba(79, 140, 255, 0.1); background: rgba(30, 41, 59, 0.4); color: #94a3b8; font-size: 14px; cursor: not-allowed;">
                            <small style="color: #94a3b8; font-size: 12px; margin-top: 4px; display: block;">Generated automatically</small>
                        </div>
                        <div>
                            <label for="modal_material_category" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1;font-size:14px;">Category <span style="color:#ef4444;">*</span></label>
                            <select name="material_category" id="modal_material_category" required onchange="toggleCustomCategoryInput()" style="width: 100%; padding: 11px 14px; border-radius: 8px; border: 2px solid rgba(79, 140, 255, 0.2); background: rgba(30, 41, 59, 0.6); color: #fff; font-size: 14px; transition: all 0.3s ease;" onfocus="this.style.borderColor='rgba(79,140,255,0.5)'; this.style.boxShadow='0 0 12px rgba(79,140,255,0.2)'" onblur="this.style.borderColor='rgba(79,140,255,0.2)'; this.style.boxShadow='none'">
                                <option value="">Select Category</option>
                                <option value="Cement">Cement</option>
                                <option value="Aggregate">Aggregate</option>
                                <option value="Steel">Steel</option>
                                <option value="Sand">Sand</option>
                                <option value="Chemical">Chemical</option>
                                <option value="Other">Other (Custom)</option>
                            </select>
                        </div>
                        <!-- Custom Category Input -->
                        <div id="customCategoryDiv" style="display:none;">
                            <label for="modal_custom_category" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1;font-size:14px;">Custom Category</label>
                            <input type="text" name="custom_material_category" id="modal_custom_category" placeholder="Specify your custom category" style="width: 100%; padding: 11px 14px; border-radius: 8px; border: 2px solid rgba(79, 140, 255, 0.2); background: rgba(30, 41, 59, 0.6); color: #fff; font-size: 14px; transition: all 0.3s ease;" onfocus="this.style.borderColor='rgba(79,140,255,0.5)'; this.style.boxShadow='0 0 12px rgba(79,140,255,0.2)'" onblur="this.style.borderColor='rgba(79,140,255,0.2)'; this.style.boxShadow='none'">
                        </div>
                        <!-- Type & Unit -->
                        <div>
                            <label for="modal_type" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1;font-size:14px;">Material Type <span style="color:#ef4444;">*</span></label>
                            <select name="material_type" id="modal_type" required style="width: 100%; padding: 11px 14px; border-radius: 8px; border: 2px solid rgba(79, 140, 255, 0.2); background: rgba(30, 41, 59, 0.6); color: #fff; font-size: 14px; transition: all 0.3s ease;" onfocus="this.style.borderColor='rgba(79,140,255,0.5)'; this.style.boxShadow='0 0 12px rgba(79,140,255,0.2)'" onblur="this.style.borderColor='rgba(79,140,255,0.2)'; this.style.boxShadow='none'">
                                <option value="">Select Type</option>
                                <option value="Consumable">Consumable (Used up during project)</option>
                                <option value="Non-Consumable">Non-Consumable (Reusable/Salvageable)</option>
                            </select>
                        </div>
                        <div>
                            <label for="modal_unit" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1;font-size:14px;">Unit of Measurement <span style="color:#ef4444;">*</span></label>
                            <select name="unit" id="modal_unit" required style="width: 100%; padding: 11px 14px; border-radius: 8px; border: 2px solid rgba(79, 140, 255, 0.2); background: rgba(30, 41, 59, 0.6); color: #fff; font-size: 14px; transition: all 0.3s ease;" onfocus="this.style.borderColor='rgba(79,140,255,0.5)'; this.style.boxShadow='0 0 12px rgba(79,140,255,0.2)'" onblur="this.style.borderColor='rgba(79,140,255,0.2)'; this.style.boxShadow='none'">
                                <option value="">Select Unit</option>
                                <option value="Bags">Bags</option>
                                <option value="Kg">Kg (Kilogram)</option>
                                <option value="MT">MT (Metric Ton)</option>
                                <option value="Cum">Cum (Cubic Meter - m¬≥)</option>
                                <option value="Nos">Nos (Number/Pieces)</option>
                                <option value="Liters">Liters</option>
                            </select>
                        </div>
                        <!-- Specification & Consumption Type -->
                        <div>
                            <label for="modal_specification" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1;font-size:14px;">Specification / Grade</label>
                            <input type="text" id="modal_specification" name="specification" placeholder="e.g., OPC 43, Fe500, 20mm, 53 Grade" style="width: 100%; padding: 11px 14px; border-radius: 8px; border: 2px solid rgba(79, 140, 255, 0.2); background: rgba(30, 41, 59, 0.6); color: #fff; font-size: 14px; transition: all 0.3s ease;" onfocus="this.style.borderColor='rgba(79,140,255,0.5)'; this.style.boxShadow='0 0 12px rgba(79,140,255,0.2)'" onblur="this.style.borderColor='rgba(79,140,255,0.2)'; this.style.boxShadow='none'">
                            <small style="color: #94a3b8; font-size: 12px; margin-top: 4px; display: block;">Optional - used for vendor quotes</small>
                        </div>
                        <div>
                            <label for="modal_consumption_type" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1;font-size:14px;">Consumption Model <span style="color:#ef4444;">*</span></label>
                            <select name="consumption_type" id="modal_consumption_type" required style="width: 100%; padding: 11px 14px; border-radius: 8px; border: 2px solid rgba(79, 140, 255, 0.2); background: rgba(30, 41, 59, 0.6); color: #fff; font-size: 14px; transition: all 0.3s ease;" onfocus="this.style.borderColor='rgba(79,140,255,0.5)'; this.style.boxShadow='0 0 12px rgba(79,140,255,0.2)'" onblur="this.style.borderColor='rgba(79,140,255,0.2)'; this.style.boxShadow='none'">
                                <option value="">Select Model</option>
                                <option value="BOQ-based">üìã BOQ-based (Quantity from BOQ)</option>
                                <option value="Daily Consumption">üìÖ Daily Consumption (Per day rate)</option>
                                <option value="Lump Sum">üéØ Lump Sum (Fixed total)</option>
                            </select>
                        </div>
                    </div>
            </div>

            <!-- Mapping Section -->
            <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.08) 0%, rgba(34, 197, 94, 0.03) 100%); border: 2px solid rgba(34, 197, 94, 0.2); border-left: 4px solid #22c55e; padding: 20px; border-radius: 12px; margin-bottom: 24px; position: relative; overflow: hidden;">
                <div style="position: absolute; top: -40px; right: -40px; width: 150px; height: 150px; background: radial-gradient(circle, rgba(34, 197, 94, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
                <div style="position: relative; z-index: 1;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 2px solid rgba(34, 197, 94, 0.15);">
                        <span style="font-size: 24px;">üîó</span>
                        <h4 style="margin: 0; color: #22c55e; font-size: 16px; font-weight: 700;">Map to Activities & Stretches</h4>
                        <span style="margin-left: auto; font-size: 12px; color: #94a3b8; background: rgba(34, 197, 94, 0.1); padding: 4px 10px; border-radius: 6px;">2 of 3</span>
                    </div>
                    <div class="form-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                        <div>
                            <label for="modal_activity_mapping" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1;font-size:14px;">Map to Activities <span style="color:#ef4444;">*</span></label>
                            <select name="activity_mapping" id="modal_activity_mapping" multiple required style="width: 100%; padding: 11px 14px; border-radius: 8px; border: 2px solid rgba(34, 197, 94, 0.2); background: rgba(30, 41, 59, 0.6); color: #fff; font-size: 14px; min-height: 140px; transition: all 0.3s ease;" onfocus="this.style.borderColor='rgba(34,197,94,0.5)'; this.style.boxShadow='0 0 12px rgba(34,197,94,0.2)'" onblur="this.style.borderColor='rgba(34,197,94,0.2)'; this.style.boxShadow='none'">
                                {% for activity in activities %}
                                <option value="{{ activity.id }}" style="background: #1e293b; color: #fff; padding: 8px;">{{ activity.name }}</option>
                                {% endfor %}
                            </select>
                            <small style="color: #94a3b8; font-size: 12px; margin-top: 6px; display: block; padding: 6px 8px; background: rgba(34, 197, 94, 0.05); border-radius: 4px;">‚å®Ô∏è Hold <strong>Ctrl</strong> (Windows) or <strong>Cmd</strong> (Mac) to select multiple activities</small>
                        </div>
                        <div>
                            <label for="modal_stretch_mapping" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1;font-size:14px;">Map to Road Stretches <span style="color:#ef4444;">*</span></label>
                            <select name="stretch_mapping" id="modal_stretch_mapping" multiple required style="width: 100%; padding: 11px 14px; border-radius: 8px; border: 2px solid rgba(34, 197, 94, 0.2); background: rgba(30, 41, 59, 0.6); color: #fff; font-size: 14px; min-height: 140px; transition: all 0.3s ease;" onfocus="this.style.borderColor='rgba(34,197,94,0.5)'; this.style.boxShadow='0 0 12px rgba(34,197,94,0.2)'" onblur="this.style.borderColor='rgba(34,197,94,0.2)'; this.style.boxShadow='none'">
                                {% for stretch in stretches %}
                                <option value="{{ stretch.id }}" style="background: #1e293b; color: #fff; padding: 8px;">{{ stretch.stretch_name }} ({{ stretch.length_m }}m)</option>
                                {% endfor %}
                            </select>
                            <small style="color: #94a3b8; font-size: 12px; margin-top: 6px; display: block; padding: 6px 8px; background: rgba(34, 197, 94, 0.05); border-radius: 4px;">‚å®Ô∏è Hold <strong>Ctrl</strong> (Windows) or <strong>Cmd</strong> (Mac) to select multiple stretches</small>
                        </div>
                    </div>
            </div>

            <!-- Inventory Settings (Collapsible) -->
            <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.08) 0%, rgba(168, 85, 247, 0.03) 100%); border: 2px solid rgba(168, 85, 247, 0.2); border-left: 4px solid #a855f7; border-radius: 12px; margin-bottom: 24px; overflow: hidden; position: relative;">
                <div style="position: absolute; top: -40px; right: -40px; width: 150px; height: 150px; background: radial-gradient(circle, rgba(168, 85, 247, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
                <div onclick="toggleInventorySection()" style="padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 1; border-bottom: 2px solid rgba(168, 85, 247, 0.15);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 24px;">üìä</span>
                        <h4 style="margin: 0; color: #a855f7; font-size: 16px; font-weight: 700;">Inventory Settings</h4>
                        <span style="font-size: 12px; color: #94a3b8; background: rgba(168, 85, 247, 0.1); padding: 4px 10px; border-radius: 6px;">3 of 3 ‚Ä¢ Optional</span>
                    </div>
                    <span id="inventoryToggleIcon" style="color: #a855f7; font-size: 20px; transition: transform 0.3s; padding: 8px; background: rgba(168, 85, 247, 0.1); border-radius: 6px;">‚ñº</span>
                </div>
                <div id="inventorySection" style="display: none; padding: 0 20px 20px 20px; position: relative; z-index: 1;">
                    <p style="color: #94a3b8; font-size: 13px; margin: 16px 0; padding: 12px; background: rgba(168, 85, 247, 0.05); border-left: 3px solid #a855f7; border-radius: 6px;">üí° <strong>Tip:</strong> Initialize inventory tracking with opening stock and set alert thresholds. These settings are optional and can be configured later.</p>
                    <div class="form-grid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div>
                            <label for="modal_opening_stock" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1;font-size:14px;">üì¶ Opening Stock</label>
                            <input type="number" id="modal_opening_stock" name="opening_stock" placeholder="0" min="0" step="0.01" style="width: 100%; padding: 11px 14px; border-radius: 8px; border: 2px solid rgba(168, 85, 247, 0.2); background: rgba(30, 41, 59, 0.6); color: #fff; font-size: 14px; transition: all 0.3s ease;" onfocus="this.style.borderColor='rgba(168,85,247,0.5)'; this.style.boxShadow='0 0 12px rgba(168,85,247,0.2)'" onblur="this.style.borderColor='rgba(168,85,247,0.2)'; this.style.boxShadow='none'">
                            <small style="color: #94a3b8; font-size: 12px; margin-top: 6px; display: block;">Initial quantity in inventory</small>
                        </div>
                        <div>
                            <label for="modal_stock_location" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1;font-size:14px;">üìç Storage Location</label>
                            <select name="stock_location" id="modal_stock_location" style="width: 100%; padding: 11px 14px; border-radius: 8px; border: 2px solid rgba(168, 85, 247, 0.2); background: rgba(30, 41, 59, 0.6); color: #fff; font-size: 14px; transition: all 0.3s ease;" onfocus="this.style.borderColor='rgba(168,85,247,0.5)'; this.style.boxShadow='0 0 12px rgba(168,85,247,0.2)'" onblur="this.style.borderColor='rgba(168,85,247,0.2)'; this.style.boxShadow='none'">
                                <option value="">Select Location</option>
                                <option value="Site">Site</option>
                                <option value="Store">Store/Yard</option>
                                <option value="Warehouse">Warehouse</option>
                            </select>
                        </div>
                        <div>
                            <label for="modal_stock_date" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1;font-size:14px;">üìÖ Stock Date</label>
                            <input type="date" id="modal_stock_date" name="stock_date" style="width: 100%; padding: 11px 14px; border-radius: 8px; border: 2px solid rgba(168, 85, 247, 0.2); background: rgba(30, 41, 59, 0.6); color: #fff; font-size: 14px; transition: all 0.3s ease;" onfocus="this.style.borderColor='rgba(168,85,247,0.5)'; this.style.boxShadow='0 0 12px rgba(168,85,247,0.2)'" onblur="this.style.borderColor='rgba(168,85,247,0.2)'; this.style.boxShadow='none'">
                            <small style="color: #94a3b8; font-size: 12px; margin-top: 6px; display: block;">Defaults to today</small>
                        </div>
                        <div>
                            <label for="modal_min_stock" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1;font-size:14px;">‚ö†Ô∏è Minimum Stock Level</label>
                            <input type="number" id="modal_min_stock" name="minimum_stock" placeholder="0" min="0" step="0.01" style="width: 100%; padding: 11px 14px; border-radius: 8px; border: 2px solid rgba(168, 85, 247, 0.2); background: rgba(30, 41, 59, 0.6); color: #fff; font-size: 14px; transition: all 0.3s ease;" onfocus="this.style.borderColor='rgba(168,85,247,0.5)'; this.style.boxShadow='0 0 12px rgba(168,85,247,0.2)'" onblur="this.style.borderColor='rgba(168,85,247,0.2)'; this.style.boxShadow='none'">
                            <small style="color: #94a3b8; font-size: 12px; margin-top: 6px; display: block;">Triggers low-stock alerts when breached</small>
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1;font-size:14px;">üîî Low Stock Alert</label>
                            <div style="display: flex; align-items: center; gap: 12px; padding: 8px 0;">
                                <label class="toggle-switch" style="position: relative; display: inline-block; width: 50px; height: 26px;">
                                    <input type="checkbox" id="modal_low_stock_alert" name="low_stock_alert" style="opacity: 0; width: 0; height: 0;">
                                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #475569; transition: 0.3s ease; border-radius: 26px; display: block; border: 2px solid rgba(168, 85, 247, 0.2);"></span>
                                    <span style="position: absolute; content: ''; height: 18px; width: 18px; left: 4px; bottom: 2px; background: white; transition: 0.3s ease; border-radius: 50%; display: block;"></span>
                                </label>
                                <span style="color: #cbd5e1; font-size: 13px; font-weight: 500;">Enable notifications</span>
                            </div>
                            <small style="color: #94a3b8; font-size: 12px; display: block;">Get alerts when stock falls below minimum</small>
                        </div>
                        <div>
                            <label for="modal_wastage_percentage" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1;font-size:14px;">üìä Expected Wastage %</label>
                            <input type="number" id="modal_wastage_percentage" name="wastage_percentage" placeholder="0" min="0" max="100" step="0.1" style="width: 100%; padding: 11px 14px; border-radius: 8px; border: 2px solid rgba(168, 85, 247, 0.2); background: rgba(30, 41, 59, 0.6); color: #fff; font-size: 14px; transition: all 0.3s ease;" onfocus="this.style.borderColor='rgba(168,85,247,0.5)'; this.style.boxShadow='0 0 12px rgba(168,85,247,0.2)'" onblur="this.style.borderColor='rgba(168,85,247,0.2)'; this.style.boxShadow='none'">
                            <small style="color: #94a3b8; font-size: 12px; margin-top: 6px; display: block;">Typical: 2-5% for aggregates</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Info Note -->
            <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%); border: 2px solid rgba(59, 130, 246, 0.25); border-left: 4px solid #3b82f6; border-radius: 10px; padding: 14px 16px; margin-bottom: 20px; display: flex; gap: 12px; align-items: flex-start;">
                <span style="font-size: 22px; flex-shrink: 0;">üí°</span>
                <div style="flex: 1;">
                    <p style="margin: 0; color: #cbd5e1; font-size: 13px; line-height: 1.6;">
                        <strong style="color: #3b82f6; font-weight: 700;">Pro Tips:</strong>
                        <br>‚Ä¢ Material pricing & vendor rates are managed separately in the vendor section
                        <br>‚Ä¢ Opening stock is optional and used only to initialize inventory tracking
                        <br>‚Ä¢ You can map materials to activities and stretches anytime after creation
                    </p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display:flex;gap:12px;justify-content:flex-end;position:sticky;bottom:0;margin:-24px -32px -24px -32px;padding:20px 32px;background:linear-gradient(180deg,transparent 0%,rgba(15,23,42,0.95) 60%,rgba(15,23,42,0.98) 100%);border-top:2px solid rgba(79,140,255,0.1);">
                <button type="button" onclick="closeAddMaterialModal()" style="background: rgba(100, 116, 139, 0.2); border: 1px solid rgba(100, 116, 139, 0.4); border-radius: 10px; padding: 12px 28px; color: #cbd5e1; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='rgba(100, 116, 139, 0.3)'; this.style.borderColor='rgba(100, 116, 139, 0.6)'" onmouseout="this.style.background='rgba(100, 116, 139, 0.2)'; this.style.borderColor='rgba(100, 116, 139, 0.4)'">
                    ‚úï Cancel
                </button>
                <button type="submit" style="background: linear-gradient(135deg, #4f8cff 0%, #3a6fd8 100%); border: none; border-radius: 10px; padding: 12px 28px; color: #fff; font-weight: 600; cursor: pointer; font-size: 14px; box-shadow: 0 4px 15px rgba(79, 140, 255, 0.4), 0 0 20px rgba(79, 140, 255, 0.2); transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.boxShadow='0 6px 25px rgba(79, 140, 255, 0.6), 0 0 30px rgba(79, 140, 255, 0.3)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 4px 15px rgba(79, 140, 255, 0.4), 0 0 20px rgba(79, 140, 255, 0.2)'; this.style.transform='translateY(0)'">
                    <span>‚úì</span> Add Material
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    /* Toggle switch styling */
    .toggle-switch input:checked + span {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;
        border-color: rgba(34, 197, 94, 0.4) !important;
    }
    .toggle-switch input:checked + span + span {
        transform: translateX(24px);
    }
    .toggle-switch span:first-of-type {
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
    }
</style>

<script>
    // Set today's date as default for stock date
    document.addEventListener('DOMContentLoaded', function() {
        const stockDateInput = document.getElementById('modal_stock_date');
        if (stockDateInput) {
            const today = new Date().toISOString().split('T')[0];
            stockDateInput.value = today;
        }
    });

    // Toggle inventory section
    function toggleInventorySection() {
        const section = document.getElementById('inventorySection');
        const icon = document.getElementById('inventoryToggleIcon');
        if (section.style.display === 'none') {
            section.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
        } else {
            section.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    }

    // Show/hide custom category input
    function toggleCustomCategoryInput() {
        const categorySelect = document.getElementById('modal_material_category');
        const customDiv = document.getElementById('customCategoryDiv');
        if (categorySelect && customDiv) {
            if (categorySelect.value === 'Other') {
                customDiv.style.display = 'block';
            } else {
                customDiv.style.display = 'none';
            }
        }
    }

    // Auto-generate material code based on category and name
    document.getElementById('modal_material_name')?.addEventListener('input', generateMaterialCode);
    document.getElementById('modal_material_category')?.addEventListener('change', generateMaterialCode);

    function generateMaterialCode() {
        const name = document.getElementById('modal_material_name')?.value || '';
        const category = document.getElementById('modal_material_category')?.value || '';
        const codeInput = document.getElementById('modal_material_code');
        
        if (name && category && codeInput) {
            const prefix = category.substring(0, 3).toUpperCase();
            const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            codeInput.value = `${prefix}-${randomNum}`;
        }
    }
</script>

<!-- Add Vendor Modal -->
<div id="addVendorModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 1100px; max-height: 90vh; overflow-y: auto;">
        <span class="close" onclick="closeAddVendorModal()">&times;</span>
        <h3 style="margin-top: 0; color: #4f8cff; display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 24px;">üè¢</span>
            Add New Vendor
        </h3>
        <p style="color: #94a3b8; font-size: 14px; margin: -8px 0 24px 0;">Register suppliers, define rates, lead times, and commercial terms</p>
        
        <form method="post" action="/vendors/add" id="addVendorForm">
            <!-- Basic Information Section -->
            <div style="background: rgba(79, 140, 255, 0.05); border-left: 4px solid #4f8cff; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <h4 style="margin: 0 0 16px 0; color: #4f8cff; font-size: 16px;">üìã Basic Information</h4>
                <div class="form-grid" style="display:grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                    <div>
                        <label for="vendor_name" style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;">Vendor Name <span style="color:#ef4444;">*</span></label>
                        <input type="text" id="vendor_name" name="vendor_name" placeholder="e.g., ABC Cement Suppliers" required style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 2px solid rgba(79, 140, 255, 0.2); background: rgba(30, 41, 59, 0.5); color: #fff;">
                    </div>
                    <div>
                        <label for="vendor_type" style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;">Vendor Type <span style="color:#ef4444;">*</span></label>
                        <select name="vendor_type" id="vendor_type" required style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 2px solid rgba(79, 140, 255, 0.2); background: rgba(30, 41, 59, 0.5); color: #fff;">
                            <option value="">Select Type</option>
                            <option value="Manufacturer">Manufacturer</option>
                            <option value="Distributor">Distributor</option>
                            <option value="Local Supplier">Local Supplier</option>
                            <option value="Transporter">Transporter</option>
                        </select>
                    </div>
                    <div>
                        <label for="vendor_contact" style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;">Contact Number <span style="color:#ef4444;">*</span></label>
                        <input type="tel" id="vendor_contact" name="vendor_contact" placeholder="+91 98765 43210" required style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 2px solid rgba(79, 140, 255, 0.2); background: rgba(30, 41, 59, 0.5); color: #fff;">
                    </div>
                    <div>
                        <label for="vendor_email" style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;">Email Address</label>
                        <input type="email" id="vendor_email" name="vendor_email" placeholder="vendor@example.com" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 2px solid rgba(79, 140, 255, 0.2); background: rgba(30, 41, 59, 0.5); color: #fff;">
                    </div>
                    <div>
                        <label for="vendor_location" style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;">Vendor Location <span style="color:#ef4444;">*</span></label>
                        <input type="text" id="vendor_location" name="vendor_location" placeholder="City, State" required style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 2px solid rgba(79, 140, 255, 0.2); background: rgba(30, 41, 59, 0.5); color: #fff;">
                    </div>
                    <div>
                        <label for="service_area" style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;">Service Area / Reach</label>
                        <input type="text" id="service_area" name="service_area" placeholder="e.g., 50 km radius, City-wide" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 2px solid rgba(79, 140, 255, 0.2); background: rgba(30, 41, 59, 0.5); color: #fff;">
                    </div>
                    <div>
                        <label for="vendor_priority" style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;">Priority</label>
                        <select id="vendor_priority" name="vendor_priority" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 2px solid rgba(79, 140, 255, 0.2); background: rgba(30, 41, 59, 0.5); color: #fff;">
                            <option value="Primary">Primary</option>
                            <option value="Secondary">Secondary</option>
                            <option value="Backup">Backup</option>
                        </select>
                        <small style="color: #94a3b8; font-size: 11px;">Used for purchase suggestions</small>
                    </div>
                    <div>
                        <label for="reliability_rating" style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;">Reliability Rating</label>
                        <select id="reliability_rating" name="reliability_rating" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 2px solid rgba(79, 140, 255, 0.2); background: rgba(30, 41, 59, 0.5); color: #fff;">
                            <option value="High">High</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="Low">Low</option>
                        </select>
                        <small style="color: #94a3b8; font-size: 11px;">Internal rating for tracking</small>
                    </div>
                </div>
            </div>

            <!-- Commercial Details Section -->
            <div style="background: rgba(34, 197, 94, 0.05); border-left: 4px solid #22c55e; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <h4 style="margin: 0 0 16px 0; color: #22c55e; font-size: 16px;">üí∞ Commercial Details</h4>
                <div class="form-grid" style="display:grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                    <div>
                        <label for="payment_terms" style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;">Payment Terms <span style="color:#ef4444;">*</span></label>
                        <select name="payment_terms" id="payment_terms" required onchange="toggleCreditPeriod()" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 2px solid rgba(34, 197, 94, 0.2); background: rgba(30, 41, 59, 0.5); color: #fff;">
                            <option value="">Select Payment Terms</option>
                            <option value="Advance">Advance</option>
                            <option value="COD">COD (Cash on Delivery)</option>
                            <option value="Credit">Credit</option>
                        </select>
                    </div>
                    <div id="creditPeriodDiv" style="display:none;">
                        <label for="credit_period" style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;">Credit Period (Days)</label>
                        <input type="number" id="credit_period" name="credit_period" placeholder="e.g., 30, 45, 60" min="0" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 2px solid rgba(34, 197, 94, 0.2); background: rgba(30, 41, 59, 0.5); color: #fff;">
                        <small style="color: #94a3b8; font-size: 11px;">Days allowed for payment</small>
                    </div>
                    <div>
                        <label for="gst_number" style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;">GST Number</label>
                        <input type="text" id="gst_number" name="gst_number" placeholder="22AAAAA0000A1Z5" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 2px solid rgba(34, 197, 94, 0.2); background: rgba(30, 41, 59, 0.5); color: #fff;">
                    </div>
                    <div>
                        <label for="gst_percentage" style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;">GST Percentage (%)</label>
                        <input type="number" id="gst_percentage" name="gst_percentage" placeholder="18" min="0" max="100" step="0.1" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 2px solid rgba(34, 197, 94, 0.2); background: rgba(30, 41, 59, 0.5); color: #fff;">
                    </div>
                </div>
            </div>

            <!-- Materials Supplied Section (Repeatable) -->
            <div style="background: rgba(168, 85, 247, 0.05); border-left: 4px solid #a855f7; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h4 style="margin: 0; color: #a855f7; font-size: 16px;">üì¶ Materials Supplied</h4>
                    <button type="button" onclick="addMaterialRow()" style="background: linear-gradient(135deg, #a855f7 0%, #7e22ce 100%); border: none; border-radius: 8px; padding: 8px 16px; color: #fff; font-weight: 600; cursor: pointer; font-size: 13px;">+ Add Material</button>
                </div>
                <div id="materialsSuppliedContainer">
                    <!-- Material Row 1 (Default) -->
                    <div class="material-row" style="background: rgba(30, 41, 59, 0.5); border: 2px solid rgba(168, 85, 247, 0.2); border-radius: 12px; padding: 16px; margin-bottom: 16px; position: relative;">
                        <button type="button" onclick="removeMaterialRow(this)" style="position: absolute; top: 12px; right: 12px; background: #ef4444; border: none; border-radius: 6px; padding: 6px 10px; color: #fff; font-weight: 600; cursor: pointer; font-size: 12px;">‚úï Remove</button>
                        <div class="form-grid" style="display:grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;font-size:13px;">Material <span style="color:#ef4444;">*</span></label>
                                <select name="materials_supplied[]" required style="width: 100%; padding: 8px 10px; border-radius: 8px; border: 2px solid rgba(168, 85, 247, 0.2); background: rgba(30, 41, 59, 0.8); color: #fff; font-size: 13px;">
                                    <option value="">Select Material</option>
                                    {% for material in materials %}
                                    <option value="{{ material.id }}">{{ material.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;font-size:13px;">Unit Price <span style="color:#ef4444;">*</span></label>
                                <input type="number" name="unit_prices[]" placeholder="‚Çπ 380" min="0" step="0.01" required style="width: 100%; padding: 8px 10px; border-radius: 8px; border: 2px solid rgba(168, 85, 247, 0.2); background: rgba(30, 41, 59, 0.8); color: #fff; font-size: 13px;">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;font-size:13px;">Per Unit Qty <span style="color:#ef4444;">*</span></label>
                                <input type="number" name="per_unit_quantities[]" placeholder="50" min="0" step="0.01" required style="width: 100%; padding: 8px 10px; border-radius: 8px; border: 2px solid rgba(168, 85, 247, 0.2); background: rgba(30, 41, 59, 0.8); color: #fff; font-size: 13px;">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;font-size:13px;">Lead Time (days)</label>
                                <input type="number" name="lead_times[]" placeholder="7" min="0" style="width: 100%; padding: 8px 10px; border-radius: 8px; border: 2px solid rgba(168, 85, 247, 0.2); background: rgba(30, 41, 59, 0.8); color: #fff; font-size: 13px;">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;font-size:13px;">Supply Capacity</label>
                                <input type="number" name="supply_capacities[]" placeholder="1000" min="0" style="width: 100%; padding: 8px 10px; border-radius: 8px; border: 2px solid rgba(168, 85, 247, 0.2); background: rgba(30, 41, 59, 0.8); color: #fff; font-size: 13px;">
                            </div>
                        </div>
                        <small style="color: #94a3b8; font-size: 11px; display: block; margin-top: 8px;">Example: ‚Çπ380 per 50 kg bag, 7 days lead time, 1000 bags/month capacity</small>
                    </div>
                </div>
            </div>

            <!-- Contract Details (Collapsible) -->
            <div style="background: rgba(245, 158, 11, 0.05); border-left: 4px solid #f59e0b; border-radius: 8px; margin-bottom: 24px; overflow: hidden;">
                <div onclick="toggleContractSection()" style="padding: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                    <h4 style="margin: 0; color: #f59e0b; font-size: 16px;">üìÑ Contract Details (Optional)</h4>
                    <span id="contractToggleIcon" style="color: #f59e0b; font-size: 20px; transition: transform 0.3s;">‚ñº</span>
                </div>
                <div id="contractSection" style="display: none; padding: 0 16px 16px 16px; border-top: 1px solid rgba(245, 158, 11, 0.1);">
                    <div class="form-grid" style="display:grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 12px;">
                        <div>
                            <label for="contract_start_date" style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;">Contract Start Date</label>
                            <input type="date" id="contract_start_date" name="contract_start_date" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 2px solid rgba(245, 158, 11, 0.2); background: rgba(30, 41, 59, 0.5); color: #fff;">
                        </div>
                        <div>
                            <label for="contract_end_date" style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;">Contract End Date</label>
                            <input type="date" id="contract_end_date" name="contract_end_date" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 2px solid rgba(245, 158, 11, 0.2); background: rgba(30, 41, 59, 0.5); color: #fff;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Document Upload (Optional) -->
            <div style="background: rgba(59, 130, 246, 0.05); border-left: 4px solid #3b82f6; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <h4 style="margin: 0 0 16px 0; color: #3b82f6; font-size: 16px;">üìé Document Upload (Optional)</h4>
                <div class="form-grid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                    <div>
                        <label for="quotation_pdf" style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;">Quotation PDF</label>
                        <input type="file" id="quotation_pdf" name="quotation_pdf" accept=".pdf" style="width: 100%; padding: 8px; border-radius: 8px; border: 2px solid rgba(59, 130, 246, 0.2); background: rgba(30, 41, 59, 0.5); color: #fff; font-size: 13px;">
                    </div>
                    <div>
                        <label for="agreement_pdf" style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;">Agreement / Contract</label>
                        <input type="file" id="agreement_pdf" name="agreement_pdf" accept=".pdf" style="width: 100%; padding: 8px; border-radius: 8px; border: 2px solid rgba(59, 130, 246, 0.2); background: rgba(30, 41, 59, 0.5); color: #fff; font-size: 13px;">
                    </div>
                    <div>
                        <label for="gst_certificate" style="display:block;margin-bottom:6px;font-weight:600;color:#cbd5e1;">GST Certificate</label>
                        <input type="file" id="gst_certificate" name="gst_certificate" accept=".pdf,.jpg,.jpeg,.png" style="width: 100%; padding: 8px; border-radius: 8px; border: 2px solid rgba(59, 130, 246, 0.2); background: rgba(30, 41, 59, 0.5); color: #fff; font-size: 13px;">
                    </div>
                </div>
            </div>

            <!-- Info Note -->
            <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px; padding: 12px 16px; margin-bottom: 24px; display: flex; gap: 12px; align-items: start;">
                <span style="font-size: 20px;">üí°</span>
                <div style="flex: 1;">
                    <p style="margin: 0; color: #cbd5e1; font-size: 13px;">
                        <strong style="color: #3b82f6;">Note:</strong> One vendor can supply multiple materials. Pricing is vendor-material specific and does not modify material master data. Vendor priority is used during purchase suggestions.
                    </p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display:flex;gap:12px;justify-content:flex-end;">
                <button type="button" onclick="closeAddVendorModal()" style="background: #64748b; border: none; border-radius: 10px; padding: 12px 24px; color: #fff; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;" onmouseover="this.style.background='#475569'" onmouseout="this.style.background='#64748b'">
                    Cancel
                </button>
                <button type="submit" style="background: linear-gradient(135deg, #4f8cff 0%, #3a6fd8 100%); border: none; border-radius: 10px; padding: 12px 24px; color: #fff; font-weight: 600; cursor: pointer; font-size: 14px; box-shadow: 0 4px 12px rgba(79, 140, 255, 0.3); transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 6px 20px rgba(79, 140, 255, 0.5)'" onmouseout="this.style.boxShadow='0 4px 12px rgba(79, 140, 255, 0.3)'">
                    ‚úì Add Vendor
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Toggle credit period field
    function toggleCreditPeriod() {
        const paymentTerms = document.getElementById('payment_terms');
        const creditDiv = document.getElementById('creditPeriodDiv');
        if (paymentTerms && creditDiv) {
            if (paymentTerms.value === 'Credit') {
                creditDiv.style.display = 'block';
            } else {
                creditDiv.style.display = 'none';
            }
        }
    }

    // Toggle contract section
    function toggleContractSection() {
        const section = document.getElementById('contractSection');
        const icon = document.getElementById('contractToggleIcon');
        if (section.style.display === 'none') {
            section.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
        } else {
            section.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    }

    // Add material row
    function addMaterialRow() {
        const container = document.getElementById('materialsSuppliedContainer');
        const newRow = container.querySelector('.material-row').cloneNode(true);
        
        // Clear input values
        newRow.querySelectorAll('input').forEach(input => input.value = '');
        newRow.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
        
        container.appendChild(newRow);
    }

    // Remove material row
    function removeMaterialRow(button) {
        const container = document.getElementById('materialsSuppliedContainer');
        if (container.querySelectorAll('.material-row').length > 1) {
            button.closest('.material-row').remove();
        } else {
            alert('At least one material row is required');
        }
    }
</script>

{% endblock %}

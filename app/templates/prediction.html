{% extends "base.html" %}
{% block content %}

<style>
  .pred-shell{max-width:1280px;margin:0 auto}
  .pred-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;margin-bottom:14px}
  .pred-title{margin:0}
  .pred-sub{opacity:.78;font-size:13px;margin-top:6px}

  .hidden{display:none !important}

  .pred-grid{display:grid;grid-template-columns:380px 1fr;gap:12px}
  @media (max-width: 1100px){.pred-grid{grid-template-columns:1fr}}

  .pred-card{border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02);border-radius:14px;padding:14px}
  .pred-card h3{margin:0 0 10px 0}

  .mode-row{display:flex;gap:8px;flex-wrap:wrap}
  .mode-btn{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.10);background:rgba(255,255,255,0.03);cursor:pointer;font-size:12px}
  .mode-btn.active{border-color:rgba(30,111,216,.55);background:rgba(30,111,216,.18)}

  .form-grid{display:grid;grid-template-columns:1fr;gap:10px}
  .row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width: 520px){.row-2{grid-template-columns:1fr}}

  .kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
  .kpi{border:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.18);border-radius:12px;padding:12px}
  .kpi .k{font-size:12px;opacity:.75}
  .kpi .v{font-size:18px;font-weight:900;margin-top:2px}

  .badge{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.03);font-size:12px}
  .badge.low{border-color:rgba(25,135,84,.45);background:rgba(25,135,84,.18)}
  .badge.medium{border-color:rgba(255,193,7,.45);background:rgba(255,193,7,.18)}
  .badge.high{border-color:rgba(214,69,69,.55);background:rgba(214,69,69,.18)}

  .alerts{display:flex;flex-direction:column;gap:8px}
  .alert{border:1px solid rgba(255,255,255,0.10);background:rgba(255,255,255,0.02);border-radius:12px;padding:10px}
  .alert .msg{font-weight:700}
  .alert .meta{opacity:.75;font-size:12px;margin-top:4px}

  .chart-wrap{border:1px solid rgba(255,255,255,0.08);border-radius:14px;background:rgba(255,255,255,0.02);padding:12px}
  .chart-title{font-weight:800;margin:0 0 8px 0}

  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn-ghost{border:1px solid rgba(255,255,255,0.12);background:transparent;color:var(--text-primary);padding:9px 12px;border-radius:10px;cursor:pointer}
  .btn-ghost:hover{background:rgba(255,255,255,0.06)}
</style>

<div class="pred-shell" id="predShell" data-project-id="{{ project.id }}" data-is-road="{{ '1' if is_road else '0' }}" data-project-type="{{ project_type }}">
  <div class="pred-header">
    <div>
      <h1 class="page-title pred-title">Prediction</h1>
      <div class="pred-sub">
        {{ project.name }} · <span class="badge">{{ project_type }}</span>
      </div>
    </div>
    <div class="actions">
      <a class="btn-secondary" href="/execution/{{ project.id }}">Daily Execution</a>
      <a class="btn-secondary" href="/dashboard?project_id={{ project.id }}">Back to Dashboard</a>
    </div>
  </div>

  <div class="pred-grid">
    <!-- LEFT: INPUTS -->
    <div class="pred-card">
      <h3>Mode</h3>
      <div class="mode-row" id="modeRow">
        <button type="button" class="mode-btn active" data-mode="Inventory">Inventory</button>
        <button type="button" class="mode-btn" data-mode="Delay">Delay</button>
        <button type="button" class="mode-btn" data-mode="Cost">Cost</button>
        <button type="button" class="mode-btn" data-mode="Combined">Combined Risk</button>
      </div>

      <hr style="margin:12px 0; opacity:.35">

      <h3>Inputs</h3>
      <div class="form-grid">
        <div class="row-2 {% if not is_road %}hidden{% endif %}" id="roadInputs">
          <div>
            <label>Chainage progress rate (km/day)</label>
            <input type="number" step="0.01" min="0" id="chainageRate" value="0.50">
          </div>
          <div>
            <label>Road layer</label>
            <select id="roadLayer">
              <option value="">All layers</option>
              <option value="Subgrade">Subgrade</option>
              <option value="GSB">GSB</option>
              <option value="WMM">WMM</option>
              <option value="DBM">DBM</option>
              <option value="BC">BC</option>
            </select>
          </div>
          <div>
            <label>Lead time buffer (days)</label>
            <input type="number" step="1" min="0" id="leadBufferRoad" value="2">
          </div>
          <div>
            <label>Safety stock (%)</label>
            <input type="number" step="1" min="0" max="80" id="safetyPctRoad" value="20">
          </div>
          <div style="grid-column:1/-1">
            <label>Weather impact factor (0–1)</label>
            <input type="number" step="0.05" min="0" max="1" id="weatherImpact" value="0.20">
            <div class="help-text">Higher value reduces progress rate and increases risk.</div>
          </div>
        </div>

        <div class="row-2 {% if is_road %}hidden{% endif %}" id="buildingInputs">
          <div>
            <label>Floor progress rate (floors/day)</label>
            <input type="number" step="0.01" min="0" id="floorRate" value="0.10">
          </div>
          <div>
            <label>Activity type</label>
            <select id="activityId">
              <option value="">All activities</option>
              {% for a in activities %}
                <option value="{{ a.id }}">{{ a.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label>Lead time buffer (days)</label>
            <input type="number" step="1" min="0" id="leadBufferBldg" value="2">
          </div>
          <div>
            <label>Safety stock (%)</label>
            <input type="number" step="1" min="0" max="80" id="safetyPctBldg" value="20">
          </div>
        </div>

        <div class="row-2">
          <div>
            <label>Horizon (days)</label>
            <input type="number" step="1" min="7" max="60" id="horizonDays" value="14">
          </div>
          <div>
            <label>Auto-refresh</label>
            <select id="autoRefresh">
              <option value="on" selected>On</option>
              <option value="off">Off</option>
            </select>
          </div>
        </div>

        <button type="button" class="btn-primary" id="btnRecalc">Recalculate</button>
      </div>

      <hr style="margin:12px 0; opacity:.35">

      <h3>History</h3>
      <div class="help-text">Last 25 prediction runs for this project.</div>
      <div id="historyList" class="alerts" style="margin-top:8px"></div>
    </div>

    <!-- RIGHT: OUTPUTS -->
    <div class="pred-card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <h3 style="margin:0">Results</h3>
        <span id="riskBadge" class="badge low">Low Risk</span>
      </div>

      <div class="kpi-row" style="margin-top:10px">
        <div class="kpi"><div class="k">Predicted Stockout Date</div><div class="v" id="kpiStockout">–</div></div>
        <div class="kpi"><div class="k">Reorder Recommendation</div><div class="v" id="kpiReorder">–</div></div>
        <div class="kpi"><div class="k">Delay Impact</div><div class="v" id="kpiDelay">–</div></div>
        <div class="kpi"><div class="k">Cost Impact (₹)</div><div class="v" id="kpiCost">–</div></div>
      </div>

      <hr style="margin:12px 0; opacity:.35">

      <h3>Alerts & Recommendations</h3>
      <div id="alerts" class="alerts"></div>

      <div class="actions" style="margin-top:10px">
        <button type="button" class="btn-ghost" data-action="Reorder now" id="actReorder">Reorder now</button>
        <button type="button" class="btn-ghost" data-action="Increase safety stock" id="actSafety">Increase safety stock</button>
        <button type="button" class="btn-ghost" data-action="Change supplier" id="actSupplier">Change supplier</button>
      </div>

      <hr style="margin:12px 0; opacity:.35">

      <div class="chart-wrap">
        <div class="chart-title">Inventory vs Time <span style="opacity:.7" id="chartMaterial"></span></div>
        <canvas id="chartInventoryTime" height="120"></canvas>
      </div>

      <div class="chart-wrap" style="margin-top:12px">
        <div class="chart-title">Predicted vs Actual Consumption <span style="opacity:.7" id="chartMaterial2"></span></div>
        <canvas id="chartConsumption" height="120"></canvas>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
  <script src="/static/js/prediction.js"></script>
{% endblock %}

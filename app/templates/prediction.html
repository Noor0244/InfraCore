{% extends "base.html" %}
{% block content %}

<style>
  @import url('https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&display=swap');

  .pred-shell{max-width:1240px;margin:0 auto;padding:10px 8px 28px;position:relative;font-family:"Sora", "Segoe UI", sans-serif}
  .pred-shell::before{content:"";position:absolute;inset:-40px -20px auto -20px;height:220px;background:radial-gradient(120% 140% at 10% 10%, rgba(59,130,246,0.16), transparent 55%),radial-gradient(120% 140% at 80% 0%, rgba(16,185,129,0.14), transparent 55%);pointer-events:none}
  .pred-shell::after{content:"";position:absolute;inset:0;background-image:linear-gradient(rgba(148,163,184,0.06) 1px, transparent 1px),linear-gradient(90deg, rgba(148,163,184,0.06) 1px, transparent 1px);background-size:36px 36px;opacity:.25;pointer-events:none}
  .pred-shell > *{position:relative;z-index:1}

  .pred-header{display:flex;justify-content:space-between;align-items:flex-start;gap:14px;flex-wrap:wrap;margin-bottom:18px;padding:12px 14px;border:1px solid rgba(148,163,184,0.18);border-radius:16px;background:linear-gradient(135deg, rgba(15,23,42,0.92), rgba(8,15,28,0.85))}
  .pred-title{margin:0;letter-spacing:-0.4px}
  .pred-sub{opacity:.75;font-size:13px;margin-top:4px}

  .hidden{display:none !important}

  .pred-grid{display:grid;grid-template-columns:360px 1fr;gap:20px}
  @media (max-width: 1100px){.pred-grid{grid-template-columns:1fr}}

  .pred-card{border:1px solid rgba(56,189,248,0.22);background:rgba(7,14,30,0.92);border-radius:20px;padding:18px 18px 20px;backdrop-filter:blur(8px);box-shadow:0 14px 34px rgba(2,6,23,0.4);animation:rise .35s ease both}
  .pred-card:nth-child(2){animation-delay:.04s}
  .pred-card h3{margin:0 0 10px 0;font-size:14px;letter-spacing:.2px}

  .mode-row{display:flex;gap:8px;flex-wrap:wrap}
  .mode-btn{padding:8px 14px;border-radius:999px;border:1px solid rgba(148,163,184,0.24);background:rgba(2,6,23,0.55);cursor:pointer;font-size:12px;color:var(--text-primary)}
  .mode-btn.active{border-color:rgba(59,130,246,.85);background:rgba(59,130,246,.22)}

  .form-grid{display:grid;grid-template-columns:1fr;gap:12px}
  .row-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width: 520px){.row-2{grid-template-columns:1fr}}

  .form-grid input,.form-grid select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(148,163,184,0.2);background:rgba(2,6,23,0.6);color:var(--text-primary);font-size:12.5px}
  .form-grid input:focus,.form-grid select:focus{outline:none;border-color:rgba(59,130,246,0.7);box-shadow:0 0 0 3px rgba(59,130,246,0.15)}

  .kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
  .kpi{border:1px solid rgba(148,163,184,0.2);background:rgba(2,6,23,0.6);border-radius:14px;padding:12px}
  .kpi .k{font-size:11px;opacity:.7;text-transform:uppercase;letter-spacing:.4px}
  .kpi .v{font-size:18px;font-weight:700;margin-top:4px}

  .badge{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid rgba(148,163,184,0.2);background:rgba(2,6,23,0.5);font-size:11px}
  .badge.low{border-color:rgba(25,135,84,.45);background:rgba(25,135,84,.18)}
  .badge.medium{border-color:rgba(255,193,7,.45);background:rgba(255,193,7,.18)}
  .badge.high{border-color:rgba(214,69,69,.55);background:rgba(214,69,69,.18)}

  .alerts{display:flex;flex-direction:column;gap:8px}
  .alert{border:1px solid rgba(148,163,184,0.2);background:rgba(2,6,23,0.6);border-radius:12px;padding:10px}
  .alert .msg{font-weight:700}
  .alert .meta{opacity:.75;font-size:12px;margin-top:4px}

  .chart-wrap{border:1px solid rgba(148,163,184,0.2);border-radius:16px;background:rgba(2,6,23,0.6);padding:12px}
  .chart-title{font-weight:700;margin:0 0 8px 0}

  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn-ghost{border:1px solid rgba(148,163,184,0.2);background:rgba(2,6,23,0.4);color:var(--text-primary);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn-ghost:hover{background:rgba(59,130,246,0.12)}

  .pred-header .btn-secondary{
    background:rgba(2,6,23,0.55);
    color:var(--text-primary);
    border:1px solid rgba(148,163,184,0.22);
    box-shadow:none;
  }
  .pred-header .btn-secondary:hover{
    background:rgba(59,130,246,0.12);
    border-color:rgba(59,130,246,0.45);
  }

  .req-table{width:100%;border-collapse:collapse;font-size:12.5px}
  .req-table th,.req-table td{padding:10px 12px;border-bottom:1px solid rgba(148,163,184,0.18);text-align:left;vertical-align:top}
  .req-table th{font-size:11px;text-transform:uppercase;letter-spacing:.4px;color:rgba(226,232,240,0.7)}
  .req-table tr:hover{background:rgba(59,130,246,0.08)}
  .req-meta{font-size:11px;opacity:.7}

  @keyframes rise{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

  html:not(.dark) .pred-shell::before{background:radial-gradient(120% 140% at 10% 10%, rgba(59,130,246,0.18), transparent 55%),radial-gradient(120% 140% at 80% 0%, rgba(16,185,129,0.16), transparent 55%)}
  html:not(.dark) .pred-shell::after{opacity:.18}
  html:not(.dark) .pred-header{background:linear-gradient(135deg, rgba(248,250,252,0.98), rgba(241,245,249,0.96));border-color:rgba(148,163,184,0.35)}
  html:not(.dark) .pred-card{background:rgba(255,255,255,0.98);border-color:rgba(148,163,184,0.35);box-shadow:0 12px 26px rgba(15,23,42,0.08)}
  html:not(.dark) .mode-btn{background:rgba(248,250,252,0.95);border-color:rgba(148,163,184,0.35);color:#0f172a}
  html:not(.dark) .mode-btn.active{background:rgba(59,130,246,0.12);border-color:rgba(59,130,246,0.6)}
  html:not(.dark) .form-grid input,html:not(.dark) .form-grid select{background:#ffffff;border-color:rgba(148,163,184,0.45);color:#0f172a}
  html:not(.dark) .kpi,html:not(.dark) .alert,html:not(.dark) .chart-wrap{background:#ffffff;border-color:rgba(148,163,184,0.35)}
  html:not(.dark) .badge{background:#f8fafc;border-color:rgba(148,163,184,0.35);color:#0f172a}
  html:not(.dark) .btn-ghost{background:#ffffff;border-color:rgba(148,163,184,0.45);color:#0f172a}
  html:not(.dark) .btn-ghost:hover{background:rgba(59,130,246,0.08)}
  html:not(.dark) .pred-header .btn-secondary{background:#ffffff;border-color:rgba(148,163,184,0.45);color:#0f172a}
  html:not(.dark) .pred-header .btn-secondary:hover{background:rgba(59,130,246,0.08);border-color:rgba(59,130,246,0.45)}
  html:not(.dark) .req-table th{color:rgba(15,23,42,0.7)}
  html:not(.dark) .req-table tr:hover{background:rgba(59,130,246,0.06)}
</style>

<div class="pred-shell" id="predShell" data-project-id="{{ project.id }}" data-is-road="{{ '1' if is_road else '0' }}" data-project-type="{{ project_type }}">
  <div class="pred-header">
    <div>
      <h1 class="page-title pred-title">Prediction</h1>
      <div class="pred-sub">
        {{ project.name }} · <span class="badge">{{ project_type }}</span>
      </div>
    </div>
    <div class="actions">
      <a class="btn-secondary" href="/execution/{{ project.id }}">Daily Execution</a>
      <a class="btn-secondary" href="/dashboard?project_id={{ project.id }}">Back to Dashboard</a>
    </div>
  </div>

  <div class="pred-grid">
    <!-- LEFT: INPUTS -->
    <div class="pred-card">
      <h3>Mode</h3>
      <div class="mode-row" id="modeRow">
        <button type="button" class="mode-btn active" data-mode="Inventory">Inventory</button>
        <button type="button" class="mode-btn" data-mode="Delay">Delay</button>
        <button type="button" class="mode-btn" data-mode="Cost">Cost</button>
        <button type="button" class="mode-btn" data-mode="Combined">Combined Risk</button>
      </div>

      <hr style="margin:12px 0; opacity:.35">

      <h3>Inputs</h3>
      <div class="form-grid">
        <div class="row-2 {% if not is_road %}hidden{% endif %}" id="roadInputs">
          <div>
            <label>Chainage progress rate (km/day)</label>
            <input type="number" step="0.01" min="0" id="chainageRate" value="0.50">
          </div>
          <div>
            <label>Road layer</label>
            <select id="roadLayer">
              <option value="">All layers</option>
              <option value="Subgrade">Subgrade</option>
              <option value="GSB">GSB</option>
              <option value="WMM">WMM</option>
              <option value="DBM">DBM</option>
              <option value="BC">BC</option>
            </select>
          </div>
          <div>
            <label>Lead time buffer (days)</label>
            <input type="number" step="1" min="0" id="leadBufferRoad" value="2">
          </div>
          <div>
            <label>Safety stock (%)</label>
            <input type="number" step="1" min="0" max="80" id="safetyPctRoad" value="20">
          </div>
          <div style="grid-column:1/-1">
            <label>Weather impact factor (0–1)</label>
            <input type="number" step="0.05" min="0" max="1" id="weatherImpact" value="0.20">
            <div class="help-text">Higher value reduces progress rate and increases risk.</div>
          </div>
        </div>

        <div class="row-2 {% if is_road %}hidden{% endif %}" id="buildingInputs">
          <div>
            <label>Floor progress rate (floors/day)</label>
            <input type="number" step="0.01" min="0" id="floorRate" value="0.10">
          </div>
          <div>
            <label>Activity type</label>
            <select id="activityId">
              <option value="">All activities</option>
              {% for a in activities %}
                <option value="{{ a.id }}">{{ a.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label>Lead time buffer (days)</label>
            <input type="number" step="1" min="0" id="leadBufferBldg" value="2">
          </div>
          <div>
            <label>Safety stock (%)</label>
            <input type="number" step="1" min="0" max="80" id="safetyPctBldg" value="20">
          </div>
        </div>

        <div class="row-2">
          <div>
            <label>Horizon (days)</label>
            <input type="number" step="1" min="7" max="60" id="horizonDays" value="14">
          </div>
          <div>
            <label>Auto-refresh</label>
            <select id="autoRefresh">
              <option value="on" selected>On</option>
              <option value="off">Off</option>
            </select>
          </div>
        </div>

        <button type="button" class="btn-primary" id="btnRecalc">Recalculate</button>
      </div>

      <hr style="margin:12px 0; opacity:.35">

      <h3>History</h3>
      <div class="help-text">Last 25 prediction runs for this project.</div>
      <div id="historyList" class="alerts" style="margin-top:8px"></div>
    </div>

    <!-- RIGHT: OUTPUTS -->
    <div class="pred-card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <h3 style="margin:0">Results</h3>
        <span id="riskBadge" class="badge low">Low Risk</span>
      </div>

      <div class="kpi-row" style="margin-top:10px">
        <div class="kpi"><div class="k">Predicted Stockout Date</div><div class="v" id="kpiStockout">–</div></div>
        <div class="kpi"><div class="k">Reorder Recommendation</div><div class="v" id="kpiReorder">–</div></div>
        <div class="kpi"><div class="k">Delay Impact</div><div class="v" id="kpiDelay">–</div></div>
        <div class="kpi"><div class="k">Cost Impact (₹)</div><div class="v" id="kpiCost">–</div></div>
      </div>

      <hr style="margin:12px 0; opacity:.35">

      <h3>Alerts & Recommendations</h3>
      <div id="alerts" class="alerts"></div>

      <div class="actions" style="margin-top:10px">
        <button type="button" class="btn-ghost" data-action="Reorder now" id="actReorder">Reorder now</button>
        <button type="button" class="btn-ghost" data-action="Increase safety stock" id="actSafety">Increase safety stock</button>
        <button type="button" class="btn-ghost" data-action="Change supplier" id="actSupplier">Change supplier</button>
      </div>

      <hr style="margin:12px 0; opacity:.35">

      <h3>Next Material Requirements</h3>
      {% if next_requirements and next_requirements.material_orders and next_requirements.material_orders|length > 0 %}
      <div style="overflow:auto">
        <table class="req-table">
          <thead>
            <tr>
              <th>Status</th>
              <th>Order By</th>
              <th>Activity</th>
              <th>Material</th>
              <th>Required</th>
              <th>In Stock</th>
              <th>Order Qty</th>
              <th>Vendor</th>
              <th>Usage</th>
              <th>Stock Cover</th>
            </tr>
          </thead>
          <tbody>
            {% for r in next_requirements.material_orders %}
            <tr>
              <td>
                <span class="badge{% if r.status_kind == 'LATE' %} high{% elif r.status_kind in ['DUE','DUE_SOON'] %} medium{% else %} low{% endif %}">
                  {{ r.status_label }}
                </span>
              </td>
              <td>{{ r.order_by }}</td>
              <td>
                {% if r.activity_code %}<strong>{{ r.activity_code }}</strong> — {% endif %}{{ r.activity_name }}
                <div class="req-meta">Start: {{ r.activity_start }}</div>
              </td>
              <td>
                {% if r.material_code %}<strong>{{ r.material_code }}</strong> — {% endif %}{{ r.material_name }}
                <div class="req-meta">Unit: {{ r.unit }}</div>
              </td>
              <td>{{ r.required_qty }}</td>
              <td>{{ r.available_qty }}</td>
              <td><strong>{{ r.to_order_qty }}</strong></td>
              <td>
                {% if r.recommended_vendor %}
                  <div><strong>{{ r.recommended_vendor.vendor_name }}</strong></div>
                  <div class="req-meta">LT: {{ r.recommended_vendor.lead_time_days }}d{% if r.recommended_vendor.unit_price %} · {{ r.recommended_vendor.unit_price }}/unit{% endif %}</div>
                {% else %}
                  <span class="req-meta">No vendor</span>
                {% endif %}
              </td>
              <td>
                {% if r.avg_daily_usage %}
                  {{ r.avg_daily_usage }} / day
                {% else %}
                  <span class="req-meta">n/a</span>
                {% endif %}
              </td>
              <td>
                {% if r.stock_days %}
                  {{ r.stock_days }} days
                {% else %}
                  <span class="req-meta">n/a</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="req-meta">No upcoming material requirements found.</div>
      {% endif %}

      <hr style="margin:12px 0; opacity:.35">

      <div class="chart-wrap">
        <div class="chart-title">Inventory vs Time <span style="opacity:.7" id="chartMaterial"></span></div>
        <canvas id="chartInventoryTime" height="120"></canvas>
      </div>

      <div class="chart-wrap" style="margin-top:12px">
        <div class="chart-title">Predicted vs Actual Consumption <span style="opacity:.7" id="chartMaterial2"></span></div>
        <canvas id="chartConsumption" height="120"></canvas>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
  <script src="/static/js/prediction.js"></script>
{% endblock %}

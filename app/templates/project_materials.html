{% extends "base.html" %}
{% block content %}

<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;margin-bottom:16px">
  <div>
    <h1 class="page-title">Materials — {{ project.name }}</h1>
    <div style="opacity:0.8;font-size:13px">Project Type: <span class="badge">{{ project.project_type or '—' }}</span></div>
  </div>
  <div style="display:flex;gap:10px;flex-wrap:wrap">
    <a href="/projects/{{ project.id }}/activity-materials" class="btn">Activity → Material Map</a>
    <a href="/execution/{{ project.id }}" class="btn">Daily Entry</a>
    <!-- <a href="/project/{{ project.id }}/materials/linker/1" class="btn btn-primary" style="background:#4f8cff;">MS Link</a> -->
  </div>
</div>

<div class="card" style="padding:16px;max-width:1100px">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
    <div>
      <strong>Planned Materials</strong>
      <div class="help-text">These are the project’s material register items (used for planning, stock, daily entry unit dropdowns).</div>
    </div>
  </div>
  <!-- The rest of the planned materials table and add forms remain unchanged -->
  {% if can_edit %}
  <div style="margin-top:14px;display:grid;grid-template-columns:1.2fr 0.8fr;gap:12px">
    <div style="border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:12px;background:rgba(255,255,255,0.02)">
      <div style="font-weight:600;margin-bottom:8px">Add from presets</div>
      <form method="post" action="/projects/{{ project.id }}/materials/add" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <select name="preset_material_name" style="min-width:340px;max-width:100%">
          <option value="">Select a preset material…</option>
          {% for m in suggested_material_defs %}
            <option value="{{ m.name }}">{{ m.name }} ({{ m.default_unit }})</option>
          {% endfor %}
        </select>
        <button class="btn-primary btn-sm" type="submit">+ Add</button>
      </form>
      {% if suggested_material_defs|length == 0 %}
        <div class="help-text" style="margin-top:8px">No additional preset materials to add for this classification.</div>
      {% endif %}
    </div>
    <div style="border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:12px;background:rgba(255,255,255,0.02)">
      <div style="font-weight:600;margin-bottom:8px">Add custom</div>
      <form method="post" action="/projects/{{ project.id }}/materials/add" style="display:flex;flex-direction:column;gap:8px">
        <input name="custom_name" type="text" placeholder="Material name (e.g., Diesel, Admixture, Duct…)" />
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input name="custom_unit" type="text" placeholder="Default unit (e.g., MT / kg / m3 / nos)" style="flex:1;min-width:160px" />
          <input name="custom_allowed_units" type="text" placeholder="Allowed units (comma-separated)" style="flex:2;min-width:200px" />
        </div>
        <button class="btn-secondary btn-sm" type="submit">+ Add custom</button>
      </form>
    </div>
  </div>
  {% endif %}
  <div style="margin-top:14px">
    {% if planned_materials and planned_materials|length > 0 %}
      <table class="table" style="margin:0">
        <thead>
          <tr>
            <th style="width:34%">Material</th>
            <th style="width:18%">Units</th>
            <th style="width:18%">Planned Qty</th>
            <th style="width:14%">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for pm in planned_materials %}
          <tr>
            <td>
              <strong>{{ pm.name }}</strong>
              <div class="meta">Base: {{ pm.unit or '—' }}</div>
            </td>
            <td>
              <div style="display:flex;gap:6px;flex-wrap:wrap">
                {% if pm.standard_unit %}<span class="badge">Std: {{ pm.standard_unit }}</span>{% endif %}
                {% if pm.allowed_units %}<span class="badge badge-info">{{ pm.allowed_units|length }} allowed</span>{% endif %}
              </div>
            </td>
            <td>
              {% if can_edit %}
              <form method="post" action="/projects/{{ project.id }}/materials/update" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <input type="hidden" name="planned_material_id" value="{{ pm.planned_material_id }}" />
                <input name="planned_quantity" type="number" step="0.001" min="0" value="{{ '%.3f'|format(pm.planned_quantity) }}" style="max-width:180px" />
                <button class="btn-primary btn-sm" type="submit">Save</button>
              </form>
              {% else %}
                {{ '%.3f'|format(pm.planned_quantity) }}
              {% endif %}
            </td>
            <td>
              {% if can_edit %}
              <form method="post" action="/projects/{{ project.id }}/materials/remove" onsubmit="return confirm('Remove this material from the project?')">
                <input type="hidden" name="planned_material_id" value="{{ pm.planned_material_id }}" />
                <button class="btn-danger btn-sm" type="submit">Remove</button>
              </form>
              {% else %}
                —
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div style="padding:16px;opacity:0.75">No planned materials yet. Add from presets above.</div>
    {% endif %}
  </div>
</div>

{% endblock %}
